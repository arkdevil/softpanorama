               Уважаемые читатели Софтпанорамы !

     Вашему вниманию представлен небольшой драйвер  -  расшири-
тель форматов гибких дисков:  PU_1700.COM опытной (Beta) версии
1.9 с подробной инструкцией PU_1700.DOC.

     А также:

    PU_1700.COM  - версии Beta 2.0, умеющий оптимально располо-
                   жить сектора  на  треках при форматировании,
                   что в свою очередь позволяет повысить произ-
                   водительность Вашего дисковода на 50 - 100%.
                   При этом, стандартная утилита DISKCOPY рабо-
                   тает значительно быстрее со всеми  форматами
                   носителей (новый параметр "/SM).

    PU_tmfd.COM  - тестирование времени абсолютного чтения гиб-
                   кого диска на физическом уровне.

    PU_tmfdm.COM - тестирование времени абсолютного чтения гиб-
                   кого диска на логическом уровне.

     INSTALL     - запоминание состояния операционной системы.
     REMOVE      - восстановление  состояния  операционной сис-
                   темы.

     К сожалению,  PU_1700  V1.6,  распостраненная  мною  через
Софтпанораму,  совсем "сырая", поэтому и работает только на не-
которых машинах.





    P.S.

     И раз уж мне представился такой случай,  то позвольте  мне
поделиться  своими  результатами  по работе таких известных Вам
программ как 800 и FDFORMAT (есть в Софтпанораме N 8  1991 г.).


                      1. Пакет FDFORMAT.
                     ────────────────────
     Содержит все исходные тексты программ и подробную докумен-
тацию.
     Утилита FDFORMAT  предназначена  для форматирования дискет
самым разнообразным набором форматов, для чего имеет достаточно
опций  (параметров).  Очень  хорошая  утилита и,  очень хорошее
средство для первичного изучения процессов форматирования и ра-
боты с всевозможными форматами дискет в среде MS DOS.

     Последняя версия FDFORMATа имеет новые параметры:  "/Xn" и
"/Yn",  позволяющие (по заявлению автора) оптимизировать  время
позиционирования  головки,  а значит и увеличить быстродействие
на всех операциях, после реформатирования носителя, на 50-100%.
     Ниже дан  дословный перевод описания применения этих пара-
метров:

"Xnnn : прокрутка nnn секторов при смене головки
 Ynnn : прокрутка nnn секторов при смене трека

Опции X и Y для прокрутки секторов
----------------------------------

     Эти опции могут быть использованы для повышения производи-
тельности Вашего диска до 100 %.  Это затруднительно объяснить.
Представьте  себе стандартный 360 Кб диск.  Он имеет 9 секторов
на каждый трек,  пронумерованных от 1 до 9. Обыкновенно сектора
на  всех треках упорядочены следующим образом " 1 2 3 4 5 6 7 8
9".
     С одним  прокручиванием сектора будут упорядочены на нуле-
вом треке "1 2 3 4 5 6 7 8 9",  "9 1 2 3 4 5 6 7 8"  на  первом
треке, "8 9 1 2 3 4 5 6 7" на втором треке и так далее.

     Вы можете  просто представить,  что из-за этого происходит
выигрыш по времени,  когда головка дисковода пошагово перемеща-
ется  от  одного  трека к другому.  Но Ваша дискетта продолжает
вращаться.  Без секторной прокрутки Ваша дискетта позиционирует
2  или  3 сектор на следующий трек,  когда пошаговое премещение
головки окончено.  Это требует почти полного прохода 1  сектора
до  тех  пор  пока следующий трек не будет прочитан.  С 1 или 2
секторной прокруткой Ваша  дискетта  позиционируется  точно  на
один сектор, когда происходит повторное чтение.
     DOS-Format программы  всегда  форматируют  с  0  секторной
прокруткой. FDFORMAT программа предоставляет два ппараметра для
выполнения секторной прокрутки. /Xn прокручивает n секторов при
смене головки,  но не трека.  /Ym прокручивает m  секторов  при
смене трека. Обучно используют параметр /Y, но в некоторых сис-
темах,  главным образом XT,  Вы можете повысить быстродействие,
используя параметр /X.
     Итак, как правильно определить значение параметра для сек-
торной прокрутки? Оптимальные значения параметра /X: 0-2, а для
параметра /Y :  0-4.  По умолчанию принимаются нулевые значения
для /X и /Y. Можно поэкспериментировать с Вашей конфигурацией и
подобрать оптимальные значения параметров."

     Для оценки повышения  производительности гикбих  носителей
форматированных FDFORMATом с оптимальным расположением секторов
на треках,  мною  были  разработаны  две  небольшие  программки
PU_tmfd.COM и PU_tmfdm.COM,  тестирующие абсолютное чтение гиб-
кого диска на физическом и логическом уровнях,  которые я также
представляю Вашему  вниманию.  Часть  результатов  тестирования
всевозможных форматов дискет приведена ниже:

┌────────┬────────┬───────┬────────────────┬──────────────────┐
│Носитель│ Формат │ Объем │   Параметры    │ Абсолютное время │
│        │        │       │ форматирования │   чтения диска   │
│        │        │  KB   │   x:  y:       │      в сек       │
├────────┼────────┼───────┼────────────────┼──────────────────┤
│        │        │       │  стандарт      │     19.8         │
│ 360 KB │ 40:9   │ 360   │   x:1 y:3      │     15.5  !!     │
│        │        │       │   x:2 y:3      │     17.0         │
├────────┼────────┼───────┼────────────────┼──────────────────┤
│        │        │       │  стандарт      │     53.0         │
│ 360 KB │ 80:10  │ 800   │   x:1 y:3      │     31.9  !!     │
│        │        │       │   x:2 y:3      │     33.2         │
├────────┼────────┼───────┼────────────────┼──────────────────┤
│        │        │       │  стандарт      │     39.0         │
│ 1.2 MB │ 80:15  │ 1200  │   x:1 y:3      │     30.1  !      │
│        │        │       │   x:2 y:3      │     31.0         │
├────────┼────────┼───────┼────────────────┼──────────────────┤
│        │        │       │  стандарт      │     79.5         │
│ 1.2 MB │ 80:18  │ 1440  │   x:1 y:3      │     57.2  !      │
│        │        │       │   x:2 y:3      │     56.8         │
├────────┼────────┼───────┼────────────────┼──────────────────┤
│        │        │       │  стандарт      │     63.7         │
│1.44 MB │ 80:18  │ 1440  │   x:1 y:3      │     35.5  !!     │
│        │        │       │   x:2 y:3      │     36.4         │
├────────┼────────┼───────┼────────────────┼──────────────────┤
│        │        │       │  стандарт      │     79.6         │
│1.44 MB │ 80:21  │ 1740  │   x:1 y:3      │     66.9  !      │
│        │        │       │   x:2 y:3      │     67.6         │
└────────┴────────┴───────┴────────────────┴──────────────────┘
     Выигрыш производительности носителей отформатированных оп-
тимально достигает 90% по сравнению со стандартным.

     Отформатированные FDFORMATом  дискеты  "понимает" MS DOS с
драйвером 800.  Автор FDFORMATа несколько иного мнения,  и  для
работы  со  своими  дискетами  рекомендует  драйвер FDREAD (или
FDR88), исходный текст которого также прилагает.
     FDREAD -  резидентная программа,  которая при наличии QEMM
или QRAM автоматически грузится в верхнюю память,  поэтому  при
автовызове  он должен быть загружен первой TSR программой.  Все
бы и хорошо но:
     Анализ исходного  текста драйвера FDREAD показал,  что это
ТРОЯНСКИЙ КОНЬ !  Драйвер удовлетворительно обслуживает качест-
венные носители и работает как "разрушитель" с некачественными.
Алгоритм переключения форматов, при обслуживании дисководов 1.2
MB форматами 360/720 KB довольно примитивен:
             ....................
             ....................    ;все комментарии мои:
             ....................
             call      old13          ;выполнить операцию
             IFIS286   %CPU
             jnc       okexit         ;══════OK════════════
             pop       ax             ;аварийное завершение:
             push      ds             ; готовится смена
             push      bx             ; шага позиционирования
             push      40h            ; и повторение операции
             pop       ds
             mov       bx,90h
             add       bl,dl
             cmp       ch,43
             ja        nodstep              ;     ЭТО
             xor       byte ptr ds:[bx],20h ; <============
             jmp       short stepend        ;   НЕХОРОШО !
nodstep:     and       byte ptr ds:[bx],0dfh; <============
stepend:     pop       bx
             pop       ds
             jmp       short endrout2
exit:        pop       ds
             pop       bx
             pop       ax
endrout2:    pushf
endrout:     call      old13          ;повторение операции !!!
             ....................
             ....................
             ....................
     - производится переключение форматов после  любой аварийно
закончившейся операции и повторная попытка выполнения !
     Нетрудно себе  представить процесс записи файла на дискету
удовлетворительного качества - при переключении  формата  могут
быть запорчены любые другие файлы !
     Но и  это  еще не все.  Шаговый двигатель позиционирования
головок при этом сильно "гудит" и быстро  изнашивается. Драйвер
800 имеет более тонкий алгоритм переключения форматов - не пор-
тит произвольные сектора и позволяет уменьшить  "гудение"  (или
"грохот") шагового двигателя примерно в 2 раза.
     Забегая вперед сообщу,  что PU_1700 - переключает  форматы
только  после смены носителя в дисководе или при переформатиро-
вании, и позволяет в тех же условиях "грохот" шагового двигате-
ля свести до минимума.

     И эще одно маленькое замечание не в пользу FDFORMATа.  От-
форматированная  программой  FDFORMAT дискета содержит в "Boot"
подпись на английском языке:

db 'FDBOOT Version 1.8',10,13
db 'No Systemdisk. Booting from harddisk.',10,13,0
db 'Cannot load from harddisk.',10,13
db 'Insert Systemdisk and press any key.',10,13,0

 или на немецком:
db 'FDBOOT Version 1.8',10,13
db 'Keine Systemdiskette. Starten von Festplatte.',10,13,0
db 'Kann nicht von der Festplatte starten.',10,13
db 'System-Diskette in Laufwerk A: einlegen',10,13
db 'Anschlieсend eine Taste drБcken',10,13,0

     Некоторые специальные утилиты,  работающие с такими диске-
тами "ругаются".
     FDFORMAT позволяет изготавливать и загрузочные дискеты, но
не может их сделать лучше стандартных - изготовленных стандарт-
ной утилитой FORMAT.

     Но надо  признать,  что  FDFORMAT  является на сегодняшний
день лучшей программой -  форматером  гибких  дисков.  Алгоритм
форматирования,  реализованный  в  FDFORMAT,:  последовательное
форматирование с последующей записью (а не верификации) начиная
с  конца  носителя,  позволяет совместить несколько завершающих
операций и делает FDFORMAT и самым быстрым.


                        2. Драйвер 800.
                       ─────────────────
     У меня было много версий  драйвера  800.COM.  Версию  1.68
получил через Софтпанораму. Алгоритм работы драйвера не меняет-
ся уже несколько последних лет. Программа же становится короче,
версия 1.68  уже  сжата  PKLIT ом - кто то из народных умельцев
уже сжал, у меня есть не сжатый вариант в 29 килобайт.
     800 версии 1.68 по прежнему не поддерживает форматирование
большиех форматов: 1.5 MB на дисководах 1.2 MB и 1.7 MB на дис-
ководах 1.44 MB.

     "Улучшенная" утилита FORMAT только коммерческой  версии MS
DOS 5.0 и только этой версии соместно с драйвером 800 не очища-
ют FAT длиною больше 9 секторов. Она прекрасно форматирует дис-
кеты большого формата. Но если размер FAT превышает 9 секторов,
то весь конец FAT прописывает каким-то  мусором.  После  такого
"форматирования"  часть диска оказывается уже "распределенной".
Привести в порядок такую дискету нетрудно:  надо очистить конец
1-ой  и  2-ой  FAT после 9 их сектора любой имеющейся у Вас под
руками утилитой:  PCTOOLS, NDD, CHKDSK и др. Можно написать ма-
ленькую программу,  которая очищает концы 1-ой и 2-ой FAT после
9 их сектора.
     Описанный эффект  может иметь место на форматах более 1.44
MB.  Ответить на вопрос - кто же тут неправ: утилита FORMAT или
драйвер 800 затруднительно, на мой взгляд обе программы работа-
ют некорректно. Драйвер 800 на больших форматах безусловно выс-
тавляет размер FAT в 9 секторов утилите FORMAT, даже если нужно
больше или меньше.  Старые утилиты FORMAT "молча" пересчитывали
этот  параметр после форматирования,  если он оказывался меньше
заданного, и формировали "очищенный" FAT. Утилита FORMAT коммер-
ческой версии MS DOS 5.0 тоже пересчитывает длину FAT, и опять
в случае если он меньше заданного,  но очищает  ровно  столько,
сколько выставил драйвер 800.

     Поклонники драйвера 800!
     Утилита FORMAT  Beta версии MS DOS 5.0 работает по старому
"корректно" под коммерческой версией MS DOS 5.0  независимо  от
установленного драйвера 800 или PU_1700!

     Драйвер 800 не поддерживает форматирование  дискет больших
форматов  с  "чередованием  секторов"  (Interleave factor > 1).
Дискеты больших форматов с "чередованием"  хорошо  читаются  на
дисководах со "старыми" низкоскоростными контроллерами,  а дис-
кеты без "чередования" не читаются на таких вообще.

     Драйвер 800 не только не поддерживает оптимальное формати-
рование дискет с целью увеличения  их  производительности  (см.
выше), но  может ухудшить все временные характеристики контрол-
лера гибких дисков - безусловно выставляя "устаревшие" значения
временных параметров  в BPB.  Последние просто напросто не надо
трогать.

     Драйвер 800 имеет доволно запутанный список ключей  в  ко-
мандной строке. И никакой HELP английский или итальянский Вам в
этом не поможет.



                        3. Драйвер PU_1700.
                       ─────────────────────
     Создавался с целью объединить в одном драйвере все лучшее,
что есть в драйвере 800 и пакете FDFORMAT. Что из этого получи-
лось - смотрите сами. PU_1700 начиная с версии 2.0 поддерживает
оптимальное расположение секторов при форматировании,  а значит
и максимальную  производительность  гибких носителей.  Параметр
/SM позволяет переключать режим форматирования только для  вер-
сии 2.0.


     Работайте на здоровье !


                        4. Приложение.
                       ─────────────────
     А. О максимально возможных форматах носителей.

     Для носителей HD 5" (1.2 MB),  неформатированный объём ко-
торых равен 1.6 MB,  максимальный формат, работу с которым под-
держивает MS DOS достигнут:

     83 трека по 18 секторов длиной в 512 байт - 1.512.960 байт.

     По 512 байт на каждом треке ушло на межсекторные промежут-
ки,  уменьшить которые уже некуда. Это предельный формат для HD
5" с которым можно работать на уровне MS DOS.

     Для носителей HD 3" (1.44 MB),  неформатированный объём ко-
торых равен 2.0 MB,  максимальный формат, работу с которым под-
держивает MS DOS  сейчас составляет:

     83 трека по 21 сектор длиной в 512 байт - 1.765.888 байт.

     По 758 байт на каждом треке ушло на межсекторные промежут-
ки, это многовато. Поэтому это не предельный формат для HD 5" с
которым можно работать на уровне MS DOS.  Я, например, уже сей-
час умею форматировать HD 3" дискеты на максимальный  объем  за
1.8 MB (11 секторов по 11 kb на треке - это предел).  Но с ними
пока не работает MS DOS.

        Б. О "чередовании секторов" при форматировании.

     При форматировании  трека  носителя  немаловажное значение
имеет так называемый "Interleave Factor",  определяющий порядок
следования секторов на треке ( в дальнейшем IF).
     Если IF = 1, то порядок следования секторов последователь-
ный: 1-ый, 2-ой, ... . При IF = 2 сектора располагаются в чере-
дующемся кольцевом порядке. Например, если на треке расположить
10 секторов с IF = 2,  то они должны быть расположены следующим
образом:
     1, 6, 2, 7, 3, 8, 4, 9, 5, 10
     Таким образом увеличивается межсекторный  промежуток между
последовательными номерами секторов.  Прямое чтение, запись или
форматирование такого трека производится контроллером за 2 обо-
рота двигателя.  А при IF = 3 - за 3. Таким образом можно попы-
таться обойти скоростные ограничения контроллера.
     Форматирование дискет на высшие форматы,  без IF >= 2  не-
возможно, иначе  контроллер не успевает обрабатывать межсектор-
ные промежутки,  где хранятся угловые метки и  другая  полезная
информация.

        В. О снятии TSR программ.

     Мне очень часто сообщают,  что мои TSR программы  без  PSP
плохо снимаются программами типа RELEASE. На самом деле все на-
оборот: программы типа RELEASE не могут работать с TSR програм-
мами  без  PSP.  Предлагаю  Вам вместо RELEASE использовать две
очень  маленьеие  надежно  работающие  программки:  INSTALL   и
REMOVE, которые работают вполне корректно с любыми TSR програм-
мами и под любой версией DOS.




           Желаю успехов!             Панков Ю.И.    04.11.91г.
           г. Сергиев Посад           тел. в Москве: 252-43-94
             (Загорск)                               252-63-23


