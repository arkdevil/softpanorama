                    Описание системы MKEY.
      Краснов М.М. ИПМ им. М.В.Келдыша АН СССР, 16 отд.
                     <19 декабря 1990 г.>
				тел. (7-095)333-8055.

     MKEY - система, предназначенная для работы с макроклави-
шами.  Она  позволяет  заменять произвольное число нажатий на
клавиши нажатием на одну-единственную клавишу (макроклавишу).
Такая  система  может  быть полезна,  например,  при работе в
текстовых редакторах для набора или исправления текстов прог-
рамм,  когда для набора определенного оператора требуется на-
жатие определенной фиксированной  последовательности  клавиш,
например,  операторы break;  или if (){} в языке C.  При этом
можно сделать набор макроклавиш,  который будет работать оди-
наково во многих текстовых редакторах и,  таким образом, соз-
давать однородную  среду.  Макроклавиши  можно  определять  в
текстовом  виде  файле на диске с последующей компиляцией или
непосредственно с помощью  клавиш  с  последующей  записью  в
файл.
     Чтобы вызвать макроопределение, нужно нажать клавиши Alt
и  Ctrl и затем, оставляя их в нажатом состоянии, нажать тре-
буемую макроклавишу.
     В системе есть возможность определять макро путем непос-
редственного нажатия на клавиши. Это можно делать только, ес-
ли клавиша Ins не определена как макроклавиша. Для этого нуж-
но нажать одновременно на клавиши Alt, Ctrl и Ins,  при  этом
должен  прозвучать  высокий  гудок-сигнал, затем одновременно
нажать на клавиши Alt, Ctrl и ту клавишу, которую  Вы  хотите
определить  как макроклавишу, при этом должен прозвучать низ-
кий гудок-сигнал, затем нужно набрать  макроопределение,  при
этом при нажатии на каждую клавишу будут раздаваться короткие
гудки и после набора макроопределения повторно нажать на кла-
виши Alt, Ctrl и ту клавишу, которую Вы хотите определить как
макроклавишу,  при  этом  должен  снова прозвучать низкий гу-
док-сигнал. Если Вы введете пустое  макро  (два  раза  подряд
одновременно с клавишами Alt и Ctrl нажмете на макроклавишу),
то клавиша перестанет быть макроклавишей (пустое макро  опре-
делить нельзя). Таким образом, макроклавиши можно как опреде-
лять, так и удалять.
     Есть возможность немедленно прекратить выполнение текуще-
го макро. Для этого нужно нажать комбинацию клавиш Ctrl+Break.
Эта возможность полезна для  прекращения  выполнения  ошибочно
вызванных макро.
     Еще одно свойство системы - с целью защиты от случайного
перевызова  системы  нажатием на клавиши Alt, Ctrl и Del (что
довольно часто случается при пользовании системой MKEY,  нап-
ример, при использовании в качестве макроклавиши серой клави-

                            - 2 -
ши [+]) система при нажатии на эти клавиши перехватывает  пе-
ревызов системы и выдает предупредительный гудок. Для перевы-
зова  системы  нужно при нажатых клавишах Alt и Ctrl два раза
подряд нажать на клавишу Del.

     В систему входят следующие файлы:
     MKEY.COM  - резидентная программа, исполняющая макропос-
ледовательности при нажатии макроклавиш;
     MKEYMAC.COM  - компилятор макроопределений, который про-
изводит преобразование макроопределений из текстового  предс-
тавления  (на  специальном языке, который будет описан ниже),
удобного для пользователей, во внутренний  код,  удобный  для
исполнения макропоследовательностей;
     MKEYTXT.COM -    декомпилятор   макрофайлов   (выполняет
действия, обратные программе MKEYMAC.COM).
     MKEY.MK -  файл,  содержащий  текст макроопределений для
языка C;
     MKEY.MCK - файл,  содержащий оттранслированные с помощью
программы MKEYMAC.COM макроопределения из файла MKEY.MK.

     Вызов программы MKEYMAC из среды MS DOS:

     MKEYMAC Файл_с_макро

     Файл_с_макро - файл с текстом макроопределений, написан-
ных на специальном языке (описан ниже).  Подразумеваемое зна-
чение расширения файла - ".mk".  Программа MKEYMAC производит
компиляцию файла. Выходной файл с откомпилированными макрооп-
ределениями будет записан в текущий  каталог  и  будет  иметь
расширение ".mck". Строки файла с макроопределениями не могут
быть больше 255 символов.  Одно макроопределение может  зани-
мать  несколько  строк,  в  этом случае в конце каждой строки
макроопределения,  кроме последней,  должен стоять  символ  \
(обратная косая черта) а строки продолжения должны начинаться
с пробела или табуляции.  Компиляция каждого макроопределения
осуществляется  до обнаружения одной ошибки,  при обнаружении
ошибки в макроопределении выдается диагностика  об  ошибке  и
делается  переход  на компиляцию следующего макроопределения.
Если при компиляции файла с макроопределениями  найдена  хотя
бы одна ошибка, выходной файл не записывается. Текст макрооп-
ределения должен иметь следующий вид:

     Имя_клавиши: Текст макроопределения

или:


                            - 3 -
     Имя_клавиши: Текст макроопределения \
        Текст макроопределения \
        ...
        Текст макроопределения

     Пример:

     I: "if (){" Enter "}" Up End rep 2 Left end

     Вызов программы MKEYTXT из среды MS DOS:

     MKEYTXT Файл_с_макро

     Файл_с_макро -  файл с откомпилированными макроопределе-
ниями,  полученный с помощью программы  MKEYMAC.COM  или  за-
писанный с помощью программы MKEY.COM (опция -f).  Подразуме-
ваемое значение расширения файла - ".mck".  Программа MKEYTXT
производит декомпиляцию файла. Выходной файл с текстом макро-
определений на специальном языке (описан ниже) будет  записан
в текущий каталог и будет иметь расширение ".mk".

     Вызов программы MKEY из среды MS DOS:

     MKEY ? -hufnedwlptm -rРезерв [Файл_с_макро]

     Опции:
     ?, -h - запрос информации по использованию программы;
     -u -  изъять  из  оперативной памяти ранее установленную
программу MKEY;
     -f -  записать  макроопределения  из ранее установленной
программы MKEY в файл на диске;
     -n - не загружать файл с макро (по умолчанию файл с мак-
ро загружается);
     -e - при установке освободить память под переменные сре-
ды (environment  space)  (по  умолчанию память под переменные
среды не освобождается);
     -d - восстановить исходные значения параметров по  умол-
чанию;
     -w - сохранить установочную информацию в файле MKEY.COM.
Сохраняются следующие параметры: 1) нужно или нет при загруз-
ке программы  в память загружать файл с макро - опция -n;  2)
при загрузке программы в память нужно или нет освобождать па-
мять под  переменные  среды  (environment  space) - опция -e;
3) язык,  на  котором программа выдает сообщения (русский или
английский) - опция -l; 4) делать ли задержку между символами
при вводе макро (нужно для редактора Multi Edit);  5) исполь-

                            - 4 -
зовать или нет клавишу MACRO для ввода макро;  6) размер  ре-
зерва  памяти - опция -r;  7) имя и расширение файла с макро,
загружаемого по умолчанию (т.  е.  если имя файла не  указано
явно в командной строке).  Для восстановления исходных значе-
ний параметров по умолчанию используйте опцию -d.
     -l - выдавать сообщения на английском языке;
     -l- -  выдавать сообщения на русском языке (действует по
умолчанию);
     -p - Делать задеpжку (паузу) между символами  при  вводе
макро (нужно  для  работы  с некоторыми редакторами (например,
Multi Edit, Turbo C++, Norton Editor);
     -pЧисло -  Делать задержку между символами,  Число задает
размер паузы между символами.  Опция -p задает  размер  паузы,
который был в последний раз записан с помощью опции -w. Исход-
ное значение паузы - 6.
     -p- - Не делать задеpжку  между  символами  (эквивалентна
-p0);
     -t -
     -t - Отслеживать паузы между клавишами пpи вводе макpо с
клавиатуры;
     -t- - Не отслеживать паузы  между  клавишами  пpи  вводе
макpо с клавиатуры;
     -m - Использовать клавишу MACRO для ввода макpо (полезно
при работе с новыми клавиатурами, у которых есть такая клави-
ша,  т.к.  эта клавиша все равно ни кем  не  используется,  и
освобождаются клавиши Alt и Ctrl);
     -m- - Не использовать клавишу MACRO;
     -rРезерв - оставить в оперативной памяти резерв для  оп-
ределения  макроклавиш  с помощью клавиатуры.  Размер резерва
задается в байтах.
     Файл_с_макро - имя файла с откомпилированными макроопре-
делениями или файла,  в который будут записаны макроопределе-
ния в случае, если указана опция -f. Если имя файла не указа-
но,  то в качестве файла с макроопределениями будет взят файл
"mkey.mck" (если он найден). Если файл указан без расширения,
то подразумевается расширение .mck. Файл с макроопределениями
ищется в пути (в начале в текущем каталоге, а затем в катало-
гах, на которые указывает переменная среды PATH).

     Список  имен  клавиш,  которые могут быть использованы в
качестве макроклавиш:

     1   2    3       4     5    6    7     8       9     0
     A   B    C       D     E    F    G     H       I     J
     K   L    M       N     O    P    Q     R       S     T
     U   V    W       X     W    Z    Space PrtSc   Minus Plus

                            - 5 -
     Up  Down Right   Left  PgUp PgDn Home  End     Ins   Del
     F1  F2   F3      F4    F5   F6   F7    F8      F9    F10
     Ecs Bksp Tab     Enter -    =    [     ]       [5]
     ;   '    `       /     ,    .    /
     CapsLock NumLock ScrollLock SysReq
     Alt Ctrl L_Shift R_Shift
     F11 F12  Key45

     Итого 87 клавиш. Последние три клавиши (F11, F12, Key45)
доступны только на клавиатуре с новым стандартом расположения
клавиш.

            Описание языка для макроопределений.

     Строки, начинающиеся с пробела или табуляции,  считаются
комментариями  (кроме строк, являющихся продолжением макрооп-
ределения, такие строки должны начинаться с пробела или табу-
ляции).
     В тексте макроопределения  могут  встречаться  следующие
элементы языка:

     - текстовые строки, заключенные в двойные кавычки ( " );

     - функциональные клавиши, возможно, совмещенные с регис-
трами Shift, Ctrl, Alt. Они имеют следующие названия:

       F1   F2   F3   F4   F5   F6   F7   F8   F9   F10   F11   F12
     S_F1 S_F2 S_F3 S_F4 S_F5 S_F6 S_F7 S_F8 S_F9 S_F10 S_F11 S_F12
     C_F1 C_F2 C_F3 C_F4 C_F5 C_F6 C_F7 C_F8 C_F9 C_F10 C_F11 C_F12
     A_F1 A_F2 A_F3 A_F4 A_F5 A_F6 A_F7 A_F8 A_F9 A_F10 A_F11 A_F12

     Клавиши  с префиксом "S_" совмещены с регистром Shift, с
префиксом "C_" совмещены с регистром Ctrl, с  префиксом  "A_"
совмещены с регистром Alt;

     -  цифры и латинские буквы, совмещенные с регистром Alt.
Они имеют названия:

     A_0  A_1  A_2  A_3  A_4  A_5  A_6  A_7  A_8  A_9
     A_A  A_B  A_C  A_D  A_E  A_F  A_G  A_H  A_I  A_J
     A_K  A_L  A_M  A_N  A_O  A_P  A_Q  A_R  A_S  A_T
     A_U  A_V  A_W  A_X  A_Y  A_Z

     -  латинские  буквы,  совмещенные  с регистром Ctrl. Они
имеют названия:


                            - 6 -
     A_A  C_B  C_C  C_D  C_E  C_F  C_G  C_H  C_I  C_J
     C_K  C_L  C_M  C_N  C_O  C_P  C_Q  C_R  C_S  C_T
     C_U  C_V  C_W  C_X  C_Y  C_Z

     - клавиши, расположенные в правой части клавиатуры, воз-
можно, совмещенные с регистрами Ctrl и Alt. Они имеют  назва-
ния:

       Up   Down   Left   Right   PgUp   PgDn   Home   End   Ins   Del   [5]
     C_Up C_Down C_Left C_Right C_PgUp C_PgDn C_Home C_End C_Ins C_Del C_[5]
     A_Up A_Down A_Left A_Right A_PgUp A_PgDn A_Home A_End A_Ins A_Del

     - "серые" клавиши, возможно,  совмещенные  с  регистрами
Shift, Ctrl, Alt. Они имеют названия:

       Esc   Bksp   Tab   Enter   Minus   Plus   Star   Slash
                  S_Tab
                  C_Tab         C_Minus C_Plus C_Star C_Slash
     A_Esc A_Bksp A_Tab A_Enter A_Minus        A_Star A_Slash

     - некоторые другие клавиши:

     A_;   A_'   A_`   A_\   A_,   A_.   A_/   A_-   A_=  A_[  A_]
     C_G-  A_G-  C_G+  A_G+  C_G*  A_G*  C_G/  A_G/
     A_G_Up  A_G_Down A_G_Left A_G_Right A_G_PgDn  A_G_PgUp  A_G_Home  A_G_End
     A_G_Ins A_G_Del  C_Break  A_Enter   A_G_Enter Null
     A_Esc   A_Bksp   S_Tab    C_Tab     A_Tab     C_PrtSc

     Префикс G_ означает "серую" клавишу;

     - оператор цикла, который имеет вид:

     rep Число_повторений Последовательность_клавиш end

     Число_повторений - десятичная константа в диапазоне от 1
до 254;
     Последовательность_клавиш   -  любая  последовательность
элементов языка.
     Допускаются вложенные операторы цикла. Максимальный уро-
вень  вложенности циклов - 50. Если максимальный уровень пре-
вышен, происходит аварийный выход  из  макроопределений  всех
уровней;

     - оператор Date. Служит для выдачи текущей даты. Он име-
ет вид:


                            - 7 -
     Date [day] [rus | lat]

     Может  применяться без параметров, с одним или двумя па-
раметрами. Если указан параметр day, то в дате выдается  день
недели  (на русском или английском языках). Если ни одного из
параметров rus или lat нет, то дата будет  выдана  в  формате
"ЧЧ-ММ-ГГГГ"  или "Ддд ЧЧ-ММ-ГГГГ", если указан параметр day.
Месяц будет выдан цифрами а день недели - на английском  язы-
ке. Если указан один из параметров rus или lat, то дата будет
выдана  в  формате  "ЧЧ ммм ГГГГ" или "Ддд ЧЧ ммм ГГГГ", если
указан параметр day. Если указан параметр  rus,  то  месяц  и
день  недели будут выданы на русском языке, а если указан па-
раметр lat, то на английском.

     - оператор Time. Служит для выдачи текущего времени.  Он
имеет вид:

     Time [sec | hund]

     Может применяться без параметра или с одним из  парамет-
ров sec или hund. Если параметр не указан, то время будет вы-
дано в формате "ЧЧ:ММ" Если указан параметр sec, то время бу-
дет выдано в формате "ЧЧ:ММ:СС", а если указан параметр hund,
то в формате "ЧЧ:ММ:СС.ДД" (с сотыми долями секунды).

     - оператор CDir.  Служит для выдачи текущего каталога на
текущем или указанном диске. Он имеет вид:

     CDir [d:]

     Если диск указан, то выдается текущий каталог на указан-
ном диске,  иначе выдается каталог на текущем диске.  Текущий
каталог выдается в формате:

     D:\PATH

     - оператор Pause.  Служит для вставки временной задержки
перед тем, как следующий символ можно будет считать из буфера
клавиатуры. Временной интервал задается в тактах (в одной се-
кунде содержится 18.2 такта. Оператор имеет вид:

     Pause число_тактов

     Оператор бывает  полезен  при написании демонстрационных
пакетов к различным системам, когда нужно, чтобы символы вво-
дились не слишком быстро,  так, чтобы человек успевал просле-

                            - 8 -
дить за вводом символов.

     - обращения к другим макроопределениям. Они имеют вид:

     M_Имя_макроклавиши

     Имя_макроклавиши  - это одно из имен клавиш, перечислен-
ных выше в списке клавиш, которые могут быть  использованы  в
качестве  макроклавиш. Максимальное число вложений макровызо-
вов - 50. Если максимальный уровень превышен, происходит ава-
рийный выход из макроопределений всех уровней;

     -  комментарии  -  любые символы, заключенные в фигурные
скобки {}.

     Различные элементы языка должны быть разделены пробелами
и (или) табуляциями.

     Элементы, которые могут встречаться в текстовых строках:
     - любые символы, кроме символа \ (обратная косая черта);
     - если встретился символ \ (обратная  косая  черта),  то
следующие за ним символы интерпретируются следующим образом:
     \bBin - символ, код которого определяется двоичной конс-
тантой Bin;
     \Octal  или  \oOctal - символ, код которого определяется
восьмеричной константой Octal;
     \dDec или \iDec - символ, код которого определяется  де-
сятичной константой Dec;
     \xHex  -  символ, код которого определяется шестнадцати-
ричной константой Hex;
     \n - символ перевода строки (New Line);
     \r - символ возврата каретки (Carrige Return);
     \t - символ табуляции (Tab);
     \e - символ Ecs
     \\ - символ \ (обратная  косая  черта);
     \" - символ двойная кавычка ( " );
     \Sym  - символ Sym, отличный от других символов, следую-
щих за символом \ (обратная косая черта), перечисленных выше.
