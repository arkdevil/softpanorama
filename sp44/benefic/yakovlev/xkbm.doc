			ДРАЙВЕР КЛАВИАТУРЫ XKBM
			=======================

			   1. ОБЩЕЕ ОПИСАНИЕ

     XKBM - универсальный драйвер клавиатуры, предназначенный для рабо-
ты с русским или другим национальным алфавитом на стандартной клавиату-
ре IBM PC. Драйвер способен загружаться в расширенную память, не зани-
мая ни одного байта из дефицитных 640К.
     Драйвер XKBM был разработан как иллюстрация возможностей работы с
расширенной памятью под управлением XVBIOS. Поэтому он не претендует на
многофункциональность, присущую драйверам Л.Бунича, Д.Гуртяка и другим.
Тем не менее он в основном соответствует сложившемуся (благодаря глав-
ным образом "Софтпанораме") стандарту. Имеются следующие возможности:
	- определение клавиш, переключающих регистры;
	- световая и звуковая индикация регистров;
	- загрузка плана нестандартной клавиатуры;
	- отработка знаков препинания в режиме NumLock;
	- программный интерфейс.



			  2. ВЫЗОВ И ПАРАМЕТРЫ

     Для вызова XKBM введите командную строку следующего вида:

	XKBM [переключатели]

     Переключатели и их аргументы могут вводиться как заглавными, так и
строчными буквами. Пробелы между переключателями не обязательны. Между
переключателем и аргументом не должно быть пробелов.
     При первом вызове XKBM загружается в расширенную память, если ус-
тановлен XVBIOS, либо в основную память, если XVBIOS не установлен или
расширенной памяти недостаточно. Повторные вызовы могут использоваться
для изменения параметров драйвера. При загрузке в основную память XKBM
занимает всего 0.5К.
     Допустимые переключатели перечислены ниже.

	/R=xx	Определяет клавишу, включающую русский регистр.
		xx - шестнадцатеричное число, задающее скан-код нужной
		клавиши. По умолчанию 36 (правый Shift). Термин "рус-
		ский регистр" здесь и далее употребляется только для
		определенности, поскольку можно определить клавиатуру
		для любого алфавита.

	/L=xx	Определяет клавишу, включающую латинский регистр.
		xx - шестнадцатеричное значение скан-кода. По умолчанию
		2A (левый Shift). При ключах /R и /L можно задать одно
		и то же значение; в этом случае указанная клавиша будет
		работать как переключатель.

	/B=xx	Задает цвет рамки для индикации русского регистра.
		xx - шестнадцатеричное число, задающее код цвета. Для
		CGA цвет кодируется четырьмя битами в формате IRGB; для
		EGA и VGA - шестью битами в формате rgbRGB. Значение 0
		запрещает включение рамки. По умолчанию значение цвета
		равно 0A для CGA и 12 для EGA/VGA, т.е. ярко-зеленый
		цвет.

	/M=x	Определяет маску переключателя.
		Используется в тех случаях, когда для включения какого-
		-либо регистра назначается не одиночная клавиша, а ком-
		бинация клавиш: допустим, Ctrl-Alt-F1 для латинского
		регистра и Ctrl-Alt-F2 для русского. Маска задается
		шестнадцатеричной цифрой, которая может принимать сле-
		дующие значения:
			1 - нажат правый Shift;
			2 - нажат левый Shift;
			4 - нажата клавиша Ctrl;
			8 - нажата клавиша Alt.
		Кроме того, можно задавать любые комбинации из этих
		четырех клавиш. Переключение регистра будет выполнено
		только в том случае, если нажаты ВСЕ заданные маской
		клавиши плюс клавиша, заданная ключом /R или /L. Если
		для переключения назначена одиночная клавиша, то пере-
		ключение выполняется не при нажатии, а при отпускании
		этой клавиши; в то же время комбинация клавиш срабаты-
		вает при нажатии заданной клавиши.
		По умолчанию маска равна 0, т.е. переключение регистров
		выполняется одиночными клавишами.

	/K=файл	Загружает план нестандартной клавиатуры из указанного
		файла. Файл должен иметь размер 106 байт, описывающих
		клавиши со скан-кодами от 1 до 53 (35h). Первая полови-
		на файла соответствует клавишам нижнего регистра, вто-
		рая - верхнего регистра. Обычно такой файл можно соз-
		дать с помощью текстового редактора; не забывайте толь-
		ко, что все символы должны располагаться в одной строке.
		Символ с кодом 255 (FFh) означает, что данная клавиша
		не обрабатывается драйвером и ее код не зависит от ре-
		гистра.
		В качестве примера приведены два файла: STD.KB - план
		стандартной русской клавиатуры, и GRAPH.KB - план кла-
		виатуры с символами псевдографики. Ее раскладка имеет
		следующий вид:
		    нижний регистр		    верхний регистр
		1 2 3 4 5 6 7 8 9 0 - =		! ; : " % , . * ( ) _ +
		 ┌ ┬ ┐ ▌ ▐ ╒ ╤ ╕ ░ █ [ ]	 ╔ ╦ ╗ ▌ ▐ ╓ ╥ ╖ ░ █ { }
		  ├ ┼ ┤ ─ │ ╞ ╪ ╡ ▒ ; '		  ╠ ╬ ╣ ═ ║ ╟ ╫ ╢ ▒ ; "
		   └ ┴ ┘ ▄ ▀ ╘ ╧ ╛ ▓ /		   ╚ ╩ ╝ ▄ ▀ ╙ ╨ ╜ ▓ ?

	/S	Задает звуковую индикацию русского регистра.
		В этом режиме русский регистр индицируется не рамкой на
		экране, а потрескиванием при нажатии клавиш. Переключа-
		тели /S и /B отменяют друг друга.

	/N	Нестандартная отработка режима NumLock.
		Изменяет отработку цифровых клавиш верхнего ряда. В ре-
		жиме NumLock на русском регистре эти клавиши выдают не
		цифры, а знаки препинания, согласно следующей раскладке:
			' 1 2 3 4 5 6 7 8 9 0 - =
			~ ! ; : " % , . * ( ) _ +
		Для получения цифр эти клавиши необходимо нажимать с
		клавишей Shift.

	/D	Отмена ключа /N.
		Клавиши верхнего ряда после указания этого ключа отра-
		батываются стандартным образом.

	/X	Загрузка в расширенную память.
		Этот ключ имеет смысл только при первом вызове XKBM.
		Он указывает, что драйвер должен загружаться только в
		расширенную память. Если XVBIOS не установлен, или рас-
		ширенной памяти недостаточно, XKBM выдаст сообщение об
		ошибке и не загрузится.

			3. ПРОГРАММНЫЙ ИНТЕРФЕЙС

     Драйвер XKBM позволяет программе пользователя устанавливать ре-
гистр клавиатуры, включать и выключать индикацию регистра, а также бло-
кировать ручное переключение регистров. Программное обращение к XKBM
выполняется следующим образом:

		MOV	AH,20h
		MOV	AL,Flags
		INT	16h

	где Flags - байт флагов, имеющий следующий формат:
	┌───┬───┬───┬───┬───┬───┬───┬───┐
	│ 0 │ 0 │ 0 │ 0 │   │   │   │   │
	└───┴───┴───┴───┴─╥─┴─╥─┴─╥─┴─╥─┘
			  ║   ║   ║   ╚═════> 0 - латинский регистр
			  ║   ║   ║	      1 - русский регистр
			  ║   ║   ║
			  ║   ║   ╚═════════> 0 - индикации нет
			  ║   ║		      1 - индикация есть
			  ║   ║
			  ║   ╚═════════════> 0 - ручное переключение разрешено
			  ║		      1 - ручное переключение запрещено
			  ║
			  ╚═════════════════> 0 - установить флаги
					      1 - прочитать флаги

     Если AL при вызове содержит значение от 0 до 7, то данная функция
устанавливает флаги согласно содержимому AL. Если же AL содержит 8, то
функция возвращает в AL текущее значение флагов. Старшие 5 бит возвра-
щаемого значения всегда равны 0; по этому признаку можно определить,
установлен ли XKBM. Значения AL, большие 8, считаются ошибкой и не от-
рабатываются.
     Кстати, господа: вам не кажется, что с этой анархией надо что-то
делать? Предлагаемый стандарт программного интерфейса - уже третий,
если не четвертый! В свое оправдание могу сказать лишь то, что этот
стандарт был реализован в драйвере RUSKBM задолго до опубликования
стандартов Бунича и Гуртяка, и многие мои программы привязаны к нему.

				Яковлев Мирослав Аркадьевич
				г.Тула, Бухоновский пер., д.8, кв.27
				тел. (0872) 31-53-08
