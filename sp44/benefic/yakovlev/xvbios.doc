			ДРАЙВЕР ЭКРАНА XVBIOS
			=====================

			  1. ОБЩЕЕ ОПИСАНИЕ

     XVBIOS - это драйвер экрана для работы с русским и другими нацио-
нальными алфавитами, ориентированный на работу с расширенной памятью и
не имеющий сколько-нибудь известных аналогов.
     Все до сих пор известные видеодрайверы основаны на одном и том же
принципе: драйвер, находясь резидентно в памяти, перехватывает видео-
прерывание BIOS INT 10h и отслеживает функции, которые могут изменить
шрифт в знакогенераторе (установка режима, загрузка шрифта и др.). Пос-
ле отработки такой функции драйвер - опять-таки средствами BIOS - за-
гружает требуемый шрифт. При такой организации трудно учесть все воз-
можные манипуляции со шрифтами; кроме того, неизбежно приходится идти
на компромисс между объемом программы и ее "всеохватностью". Опыт экс-
плуатации многих видеодрайверов показывает, что те или иные конфликты
практически неизбежны.
     Особенность XVBIOS в том, что он не выполняет никакого слежения за
работой BIOS и не вмешивается в нее (за исключением вспомогательной
функции - коррекции печати экрана). Вместо этого XVBIOS копирует содер-
жимое ПЗУ видео-BIOS в расширенную (extended) память и изменяет скопи-
рованные из ПЗУ шрифты. В результате пользователь фактически получает
ПЗУ с нужными ему шрифтами, что делает В ПРИНЦИПЕ невозможными любые
конфликты.
     Автор выражает свою признательность Андрею Е. Борзенко, опублико-
вавшему в "Софтпанораме" методику работы с расширенной памятью и драй-
вером HIMEM.SYS.

			2. ВЫЗОВ ПРОГРАММЫ

     Для работы XVBIOS необходима расширенная (extended) память объемом
не менее 64К; кроме того, необходимо установить в системе драйвер
HIMEM.SYS, обычно поставляемый в составе ДОС. Для этого включите в файл
CONFIG.SYS строку:

	DEVICE = HIMEM.SYS

     Командная строка для вызова XVBIOS имеет вид:

	XVBIOS [ключи] [файл1 файл2 ... файлN]

     Квадратные скобки показывают, что все параметры в командной строке
являются необязательными и могут быть опущены при вызове.
     Допускаются следующие переключатели:
	/C:файл		- коррекция BIOS при установке
	/A		- вывод альтернативных шрифтов
	/R		- программный сброс шрифтов

     Подробное описание переключателей см. далее по тексту.
     Файл1 ... файлN - это один или несколько файлов, содержащих опре-
деленные пользователем шрифты. Они также необязательны: при их отсутст-
вии XVBIOS использует свои встроенные шрифты. Для шрифтовых файлов рас-
ширение по умолчанию - .FNT; для файла коррекции (при ключе /C) расши-
рение по умолчанию отсутствует.

     При первом вызове XVBIOS выполняет процедуру установки, т.е. копи-
рует ПЗУ BIOS в расширенную память и модифицирует шрифты. Повторные
вызовы могут использоваться для изменения шрифтов.
     XVBIOS не устанавливается, если прерывание INT 10h перехвачено
другой программой. Поэтому в файле AUTOEXEC.BAT XVBIOS должен вызывать-
ся раньше, чем драйвер "мыши" и другие программы, перехватывающие это
прерывание.

			3. КОДИРОВАНИЕ ШРИФТОВ

     В процессе своей установки XVBIOS формирует шрифты на основе стан-
дартных шрифтов из ПЗУ, изменяя в них только символы, соответствующие
русским буквам. Используя внешние файлы шрифтов, можно изменить любые
символы в любом шрифте и адаптировать свой компьютер для работы с любым
национальным алфавитом. На пользовательские шрифты не накладывается
никаких ограничений: изменять можно не только "национальные", но и лю-
бые стандартные символы, если в этом есть необходимость.
     Стандартный видео-BIOS VGA содержит три основных шрифта (8*8, 8*14
и 8*16) и два альтернативных (9*14 и 9*16). Основные шрифты содержат
поразрядную кодировку для всех 256 символов набора ASCII. Альтернатив-
ные шрифты содержат кодировку только отдельных символов; обычно это
"широкие" буквы типа M или W. Предназначены они для использрвания в
текстовых режимах, в которых ширина символа составляет 9 точек растра.
     Первый байт любого шрифтового файла должен содержать тип шрифта в
соответствии со стандартом BIOS:
	2 - 8*14
	3 - 8*8
	5 - альтернативный 9*14
	6 - 8*16
	7 - альтернативный 9*16
     Шрифт не будет загружен, если его тип указан неправильно или дан-
ный шрифт отсутствует в ПЗУ: например, при попытке загрузить шрифт 8*16
для EGA.
     Файл шрифта (даже основного) не обязан содержать все 256 символов:
достаточно указать только те символы, которые вы хотите изменить. Поэ-
тому информация, следующая за байтом типа, организована в виде последо-
вательности записей. Для основных шрифтов запись имеет переменную длину
и содержит кодировку для N символов, расположенных подряд. Структура
записи следующая:
	┌───┐
	│   │	ASCII-код первого символа
	├───┤
	│   │	ASCII-код последнего символа
	├───┤
	│ . │
	  .	Кодировка N символов
	│ . │
	└───┘
     Если запись содержит только один символ, то коды первого и послед-
него символов должны совпадать.

     Для альтернативных шрифтов структура записи иная. Каждая запись
здесь имеет фиксированную (для данного шрифта) длину и содержит коди-
ровку только одного символа. При загрузке такой символ ЗАМЕЩАЕТ какой-
либо символ в альтернативном шрифте. Поэтому запись имеет следующую
структуру:
	┌───┐
	│   │	ASCII-код загружаемого символа
	├───┤
	│   │	ASCII-код замещаемого символа
	├───┤
	│ . │
	  .	Кодировка загружаемого символа
	│ . │
	└───┘
     Таким образом, для разработки альтернативного шрифта необходимо
решить, какие из стандартных символов будут замещены на пользователь-
ские. При вызове XVBIOS с ключом /A на экран выводится состав найденных
в ПЗУ альтернативных шрифтов, т.е. список ASCII-кодов символов, входя-
щих в эти шрифты. Выбирать замещаемые символы можно только из этого
списка; при указании несуществующего замещаемого кода символ не будет
загружен.
     Лучше всего, если коды загружаемого и замещаемого символов будут
совпадать. Если же нужного кода в списке нет, то придется пожертвовать
одним из стандартных альтернативных символов. Это не значит, что заме-
щенный символ будет отображаться неправильно: при установке и загрузке
основных шрифтов XVBIOS автоматически корректирует альтернативные шриф-
ты в соответствии с основными. Собственно говоря, альтернативные шрифты
нужны только для улучшения внешнего вида символов, и всегда можно обой-
тись без них.
     Переключатель /R выполняет "программный сброс" шрифтов. При этом
уничтожаются все шрифты, загруженные из файлов, и восстанавливаются
первоначальные шрифты на основе шрифтов ПЗУ и XVBIOS. В командной стро-
ке за ключом /R могут следовать файлы шрифтов: они будут загружены пос-
ле сброса.

			4. УСТАНОВКА ПРОГРАММЫ

     К сожалению, с установкой XVBIOS в расширенную память дело обстоит
не так просто, как хотелось бы. Причина тому - "глупый BIOS", по выра-
жению Л.Бунича. А именно: многие версии BIOS содержат в программном
коде СВОЙ сегментный адрес (обычно C000), в результате чего в знакоге-
нератор загружается шрифт из ПЗУ, а не из расширенной памяти. Зачем
понадобилось разработчикам BIOS жестко привязываться к сегментному ад-
ресу - одному богу известно, однако с этим приходится считаться.
     Способ избавиться от этих прелестей только один: заменить в прог-
раммном коде BIOS все вхождения сегментного адреса ПЗУ на сегментный
адрес расширенной памяти. С этим XVBIOS справляется. Но прежде чем за-
менять, нужно определить, ЧТО заменять, а вот этот процесс практически
не поддается формализации. Для этого требуется знакомство с системой
команд процессора и умение работать с отладчиком.
     Несколько облегчить эту задачу могут две вспомогательные програм-
мы, XVFIND и XVDEBUG. XVFIND находит в ПЗУ BIOS все вхождения сегмент-
ного адреса ПЗУ. Однако это еще не значит, что по всем найденным адре-
сам следует выполнять замену: найденное слово вполне может оказаться
частью шрифта или - еще хуже - частью команды процессора.

     Программа XVDEBUG вызывает какую-либо другую программу и в процес-
се ее работы отслеживает команды, загружающие в сегментные регистры
адрес ПЗУ. По завершении работы вызванной программы XVDEBUG выдает спи-
сок адресов таких команд в программном коде BIOS.
     Вызов:

	XVDEBUG ком_стр

     В командной строке указывается имя вызываемой программы и при не-
обходимости - параметры.
     Таким образом, для поиска адресов, требующих коррекции, рекоменду-
ются следующие действия:
	1. Определите с помощью XVFIND (в отсутствие XVBIOS) адреса,
	   содержащие сегментный адрес ПЗУ.
	2. Запустите XVBIOS и убедитесь, что установка прошла нормаль-
	   но, но нужных шрифтов нет.
	3. Запустите через XVDEBUG какую-нибудь программу, о которой
	   вам заведомо известно, что она обращается к BIOS и изменяет
	   шрифты. Можно использовать для этого тот же XVBIOS:
		XVDEBUG xvbios /r
	4. С помощью любого отладчика (Debug, CodeView, Quaid Analyzer
	   и др.) установите точку останова в РАСШИРЕННОЙ памяти (сег-
	   ментный адрес FFFF) по одному или нескольким адресам, най-
	   денным программой XVDEBUG.
	5. Вновь запустите вызванную ранее программу, но уже без
	   XVDEBUG.
	6. После выхода на точку останова определите по содержимому
	   регистров исполнительный адрес команды и убедитесь, что
	   этот адрес был найден программой XVFIND.

     С помощью приведенного алгоритма обычно удается определить все
корректируемые адреса. Конечно, и при этом возможны трудности: загрузка
сегментного адреса может выполняться безадресными командами типа POP ES
или MOV DS,AX. Здесь уже приходится полагаться на интуицию. Но такие
случаи редки.
     Для установки с коррекцией используется переключатель /C, имеющий
своим аргументом имя файла коррекции. Это обычный текстовый файл, со-
держащий список адресов, по которым требуется выполнить замену. Адреса
записываются в шестнадцатеричном формате и разделяются любым числом
пробелов, табуляций и переходов на новую строку. "Буквенные" цифры от A
до F должны быть заглавными. В файл можно включать комментарии: любая
последовательность символов, не являющаяся шестнадцатеричным числом,
игнорируется. Переключатель /C может быть указан только при первом вы-
зове XVBIOS и должен быть первым параметром в командной строке.
     Как видите, коррекция - дело непростое, но, в конце концов, для
вашего компьютера ее требуется выполнить всего один раз. К тому же,
как показывает опыт, установка XVBIOS для VGA обычно не требует коррек-
ции.
     Существует и еще одно противопоказание: некоторые системы, напри-
мер, AutoCAD, не признают никаких соглашений по использованию расширен-
ной памяти и пытаются распоряжаться ею монопольно. При контакте такой
программы с XVBIOS система будет немедленно разрушена. Драйверы VDISK
и RAMDRIVE также конфликтуют с HIMEM (а следовательно, и с XVBIOS). В
ближайшем будущем планируется выпуск "бесконфликтного" драйвера вирту-
ального диска.

			5. ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ

     Драйвер XVBIOS реализует две дополнительные функции. Одна из них -
коррекция печати экрана. Состоит она в том, что при печати экрана все
непечатные символы (с кодами 00 - 1F и 7F) заменяются на печатные, наи-
более близкие к ним по внешнему виду. В результате гарантируется от-
сутствие неприятных сюрпризов, характерных для обычной печати экрана.
     Кроме того, XVBIOS выполняет функцию диспетчера расширенной памя-
ти. Из 64К расширенной памяти, предоставляемых драйвером HIMEM, копия
видео-BIOS занимает 32К; оставшиеся 32К могут использоваться для заг-
рузки других программ. Обращение к диспетчеру памяти имеет вид:

		MOV	AH,0EAh
		MOV	AL,SubFn
		INT	2Fh

     SubFn - подфункция:
	00 - получение адреса свободной памяти
	 Возврат: CX	- базовый адрес (8000h)
		  DX	- адрес свободной памяти
	 Если XVBIOS не установлен, то содержимое CX и DX не изменяется.
	01 - запрос памяти для загрузки программы
	 Вызов:   DX	- число требуемых байтов
	 Возврат: CF	- сброшен, если памяти достаточно
			  установлен, если недостаточно

     XVBIOS не загружает программу в расширенную память, а только сооб-
щает ей, достаточно ли памяти, и фиксирует факт загрузки. Программа
должна сама скопировать свою резидентную часть в расширенную память,
используя полученный от диспетчера адрес свободной памяти. Сегментный
адрес расширенной памяти - FFFFh.
     Программы, загружаемые в расширенную память, должны быть позиционно
-независимыми, т.е. их работа не должна зависеть от адреса загрузки.
Обычные COM- и EXE-программы таким свойством не обладают. Самое важное
следствие отсюда - недопустимость прямой адресации к переменным, распо-
ложенным внутри программы. Рекомендуется поместить базовый адрес прог-
раммы в регистр и адресовать все переменные относительно этого регистра.
Кроме того, функции ДОС ведут себя весьма странно, если в качестве ар-
гумента указан адрес расширенной памяти. Причина пока не выяснена.

				Яковлев Мирослав Аркадьевич
				г.Тула, Бухоновский пер., д.8, кв.27
				тел. (0872) 31-53-08
