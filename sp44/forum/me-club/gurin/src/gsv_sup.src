$macro_file gsv_sup;
{ –ú–∞–∫—Ä–æ—Å—ã —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π }


$macro gsv_exit from EDIT DUMP;
{ –í—ã—Ö–æ–¥ –∏–∑ Multi-Edit'–∞: –∑–∞–ø–∏—Å—å –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤, —É–¥–∞–ª–µ–Ω–∏–µ meerr.tmp
  –≤—ã–∑–æ–≤ –º–∞–∫—Ä–æ—Å–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞
}
  def_int(win);
  def_str(fn);
  make_message('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ: –∑–∞–ø–∏—Å—å –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤');
  refresh := FALSE;
  win := window_count;
  while (win <> 0) do
    switch_window(win);
    if file_changed then
      fn := lower(truncate_path(file_name));
      if    (fn = 'mefind.tmp')   then ;
      elsif (fn = 'meconfig.db')  then save_file;
      elsif (fn = 'gsv_dict.dic') then save_file;
      elsif (fn = 'gsv_tree.grf') then save_file;
      else                             run_macro('userin^checkfile');
      end;
      file_changed := FALSE;
    end;
    --win;
  end; {while}
  run_macro('userin^xmenu /B=1/T=1/L= –í—ã—Ö–æ–¥ –∏–∑ Multi-Edit /M=1. –ù–µ –≤—ã—Ö–æ–¥–∏—Ç—å()2. –í—ã–π—Ç–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞()3. –í—ã–π—Ç–∏ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞()');
  if    (return_int < 2) then make_message(''); goto exit;
  elsif (return_int = 2) then set_global_int('restore', TRUE);
  elsif (return_int = 3) then set_global_int('restore', FALSE);
  end;
  run_macro('gsv_restore all');
  del_file('status.me');
  del_file('meerr.tmp');
  del_file('mefind.tmp');
  del_file(me_path + '!buf.0');
  run_macro('setup^check_setup');
  rest_dos_screen;
  r_ax := $1003; r_bx := 1; intr($10);
  run_macro('exit^exit');
exit:
end_macro;


$macro gsv_norton from ALL;
{ –í—ã–∑–æ–≤ Norton Commander }
  def_int(x, y);
  if mode = dos_shell then
    run_macro('gsv_shel^gsvds_change_dir');
    run_macro('gsv_shel^gsvds_save_parm');
  end;
  x := wherex;
  y := wherey;
  save_box(1, 1, screen_width, screen_length);
  clear_screen(7);
  write('–î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –úulti-Edit –Ω–∞–∂–º–∏—Ç–µ F10 –∏ Enter',
         20, screen_length - 2, black, lightgreen);
  gotoxy(1, screen_length);
  return_str := 'nc';
  run_macro('gsv_exec /CMD=1');
  kill_box;
  update_status_line;
  gotoxy(x, y);
  if mode = dos_shell then
    run_macro('gsv_shel^gsvds_create_win');
  end;
end_macro;


$macro gsv_print from EDIT;
{ –í—ã–∑–æ–≤ –º–µ–Ω—é –ø–µ—á–∞—Ç–∏ —Å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º "–∑–≤–µ–∑–¥–Ω–æ–≥–æ –Ω–µ–±–∞" }
  def_int(flag);
  make_message('–ú–µ–Ω—é –ø–µ—á–∞—Ç–∏ —Å –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º "–∑–≤–µ–∑–¥–Ω–æ–≥–æ –Ω–µ–±–∞"');
  flag := global_int('gsv_flag_star');
  set_global_int('gsv_flag_star', FALSE);
  run_macro('meutil3^print /H=pr' + mparm_str);
  while (box_count > 0) do
    kill_box;
  end;
  set_global_int('gsv_flag_star', flag);
end_macro;


$macro gsv_search from ALL TRANS; { 29-—è–Ω–≤-92 }
{ –ü–æ–∏—Å–∫ –≤ —Ç–µ–∫—É—â–µ–º —Ñ–∞–π–ª–µ –æ—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏. –ü–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º
  –º–∞–∫—Ä–æ—Å–æ–º –ø–æ–∏—Å–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
  –í—ã–∑–æ–≤ –º–∞–∫—Ä–æ—Å–∞:
    gsv_search        - –ø–æ–∏—Å–∫ –≤–ø–µ—Ä–µ–¥
    gsv_search REPEAT - –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –≤–ø–µ—Ä–µ–¥
    gsv_search WORD   - –ø–æ–∏—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞
  –ú–∞–∫—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
    gsv_search_case   - —Ñ–ª–∞–≥ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞
    gsv_search_reg    - —Ñ–ª–∞–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
    gsv_search_str    - –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–∏—Å–∫–∞
}
  def_int(fc, fr, count);
  def_str(sword);
  fc := ignore_case;
  fr := reg_exp_stat;
  count := 0;
  goto start;

search:
  right;
  if (search_fwd(global_str('gsv_search_str'), 0) = FALSE) then
    left;
    if (count = 0) then
      beep;
      make_message('–°—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    else
      make_message('–°—á–µ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ = ' + str(count));
    end; {if}
  else
    ++count;
    make_message('–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞: <Enter> –∏–ª–∏ –ª–µ–≤–∞—è –∫–ª–∞–≤–∏—à–∞ –º—ã—à–∫–∏');
    read_key;
    if (((key1 = 13) and (key2 = 28)) or ((key1 = 0) and (key2 = 250))) then
      goto search;
    else
      make_message('–ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
    end; {if}
  end; {if}
  ret;

start:
  if (caps(mparm_str) = 'REPEAT') then
    ignore_case  := global_int('gsv_search_case');
    reg_exp_stat := global_int('gsv_search_reg');
    call search;
  elsif (caps(mparm_str) = 'WORD') then
    mark_pos; {–≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞}
    right;
    word_left;
    sword := get_word(word_delimits);
    goto_mark;
    if (sword = '') then
      beep;
      make_message('–ù–µ—Ç —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞');
    else
      set_global_str('gsv_search_str',  sword);
      ignore_case  := FALSE;
      reg_exp_stat := FALSE;
      call search;
    end; {if}
  else
    set_global_str('istr_1',  global_str('gsv_search_str'));
    set_global_int('iint_2',  global_int('gsv_search_reg'));
    set_global_int('iint_3',  global_int('gsv_search_case'));
    set_global_str('iparm_1', '/W=42/ML=256/GO=1');
    set_global_str('iparm_2', '/TP=13/T=–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π/L=2/C=2/H=gsv_sup^REGEXP');
    set_global_str('iparm_3', '/TP=13/T=–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –±—É–∫–≤/L=3/C=2');
    run_macro('userin^data_in /#=3/H=gsv_sup^SEARCH/T= –ü–æ–∏—Å–∫ ');
    set_global_str('gsv_search_str',  global_str('istr_1'));
    set_global_int('gsv_search_reg',  global_int('iint_2'));
    set_global_int('gsv_search_case', global_int('iint_3'));
    if (return_int <> 0) then
      ignore_case  := global_int('gsv_search_case');
      reg_exp_stat := global_int('gsv_search_reg');
      call search;
    end; {if}
  end; {if}

  ignore_case  := fc;
  reg_exp_stat := fr;
end_macro; { gsv_search }


$macro gsvds from EDIT TRANS;
{ –ó–∞–ø—É—Å–∫–∞—é—â–∏–π –º–∞–∫—Ä–æ—Å Dir Shell. –í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –º–∞–∫—Ä–æ—Ñ–∞–π–ª–æ–≤, –∑–∞–ø—É—Å–∫
  —Ñ–∞–π–ª–æ–≤–æ–π –æ–±–æ–ª–æ—á–∫–∏ –∏ –≤—ã–≥—Ä—É–∑–∫—É –º–∞–∫—Ä–æ—Å–æ–≤. –¢–∞–∫–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–∫—Ä–æ—Å–æ–≤,
  –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∞—Ç—Ä–∏–±—É—Ç–æ–≤ trans, trans2 –∏ dump, –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç
  –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ Dir Shell –∏ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é
  —Å—Ç–µ–ø–µ–Ω—å —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏ –≤ –º–æ–¥–µ EDIT.
}
  if (inq_macro('gsv_dos') = -1) then
    load_macro_file(me_path + 'gsv_dos');
    if (error_level <> 0) then
      run_macro('meerror');
      goto exit1;
    end; { if error }
  end; {if}
  if (inq_macro('gsv_dir_shell') = -1) then
    load_macro_file(me_path + 'gsv_shel');
    if (error_level <> 0) then
      run_macro('meerror');
      goto exit2;
    end; { if error }
  end; {if}
  if (inq_macro('gsvds_viewer') = -1) then
    load_macro_file(me_path + 'gsv_dsmf');
    if (error_level <> 0) then
      run_macro('meerror');
      goto exit3;
    end; { if error }
  end; {if}

  run_macro('gsv_dir_shell');

exit3: { gsv_dsmf }
  unload_macro('gsvds_viewer');
  unload_macro('gsvds_menu');
  unload_macro('gsvds_view');
  unload_macro('gsvds_menu_view');
  unload_macro('gsvds_edit');
  unload_macro('gsvds_copy');
  unload_macro('gsvds_rename');
  unload_macro('gsvds_mkdir');
  unload_macro('gsvds_delete');
  unload_macro('gsvds_run');
  unload_macro('gsvds_sort');
  unload_macro('gsvds_mask');
  unload_macro('gsvds_drive');
  unload_macro('gsvds_attr');
  unload_macro('gsvds_tree');
exit2: { gsv_shell }
  unload_macro('gsv_dir_shell');
  unload_macro('gsvds_change_dir');
  unload_macro('gsvds_setcur');
  unload_macro('gsvds_save_parm');
  unload_macro('gsvds_color');
  unload_macro('gsvds_draw');
  unload_macro('gsvds_open_win');
  unload_macro('gsvds_tgwin');
  unload_macro('gsvds_tgmode');
  unload_macro('gsvds_create_win');
  unload_macro('gsvds_pgup');
  unload_macro('gsvds_pgdown');
  unload_macro('gsvds_num_mark');
  unload_macro('gsvds_select_pan');
  unload_macro('gsvds_enter');
  unload_macro('gsvds_left_mouse');
exit1: { gsv_dos }
  unload_macro('gsv_dos');
exit:
  error_level := 0;
  while (box_count) do
    kill_box;
  end; {while}
end_macro; { gsvds }


$macro gsvisp from EDIT TRANS;
{ –ó–∞–ø—É—Å–∫–∞—é—â–∏–π –º–∞–∫—Ä–æ—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.
}
  if (inq_macro('gsv_dos') = -1) then
    load_macro_file(me_path + 'gsv_dos');
    if (error_level <> 0) then
      run_macro('meerror');
      goto exit1;
    end; { if error }
  end; {if}
  if (inq_macro('gsvisp_menu') = -1) then
    load_macro_file(me_path + 'gsv_isp');
    if (error_level <> 0) then
      run_macro('meerror');
      goto exit2;
    end; { if error }
  end; {if}

  run_macro('gsvisp_menu');

exit2: { gsv_isp }
  unload_macro('gsvisp_menu');
  unload_macro('gsvisp_compile');
  unload_macro('gsvisp_run');
  unload_macro('gsvisp_profile');
  unload_macro('gsvisp_debug');
  unload_macro('gsvisp_project');
exit1: { gsv_dos }
  unload_macro('gsv_dos');
exit:
  error_level := 0;
end_macro; { gsvisp }


$macro gsv_user from EDIT TRANS;
{ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞-
  —Ç–µ–ª—å—Å–∫–æ–≥–æ –º–µ–Ω—é, –≤ –æ–ø–∏—Å–∞—Ç–µ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö meconfig.db -> user.db –≤–≤–µ–¥–µ–Ω
  –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç: "–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è".
  –ó–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–æ–ª—è —Ä–∞–∑–ª–∏—á–Ω–æ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º –∏ –º–∞–∫—Ä–æ—Å–æ–≤. –ï—Å–ª–∏ —Ç–∏–ø -
  "–ø—Ä–æ–≥—Ä–∞–º–º–∞", –∏ –æ–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, —Ç–æ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã —ç–∫—Ä–∞–Ω DOS
  —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, –≤ –Ω–∏–∂–Ω–µ–π —Å—Ç—Ä–æ–∫–µ —ç–∫—Ä–∞–Ω–∞ –≤—ã–≤–æ–¥–∏—Ç—Å—è –Ω–∞–¥–ø–∏—Å—å "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é
  –∫–ª–∞–≤–∏—à—É ..." –∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è –Ω–∞–∂–∞—Ç–∏–µ. –ï—Å–ª–∏ —Ç–∏–ø - "–º–∞–∫—Ä–æ" –∏ –æ–∂–∏–¥–∞–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ,
  —Ç–æ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –º–∞–∫—Ä–æ—Å–∞ –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–≤–µ–∑–¥–Ω–æ–≥–æ –Ω–µ–±–∞,
  –∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞–∫—Ä–æ—Å–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ñ–ª–∞–≥ –∑–≤–µ–∑–¥–Ω–æ–≥–æ –Ω–µ–±–∞.
  –ö—Ä–æ–º–µ —Ç–æ–≥–æ, –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ
  –Ω–∞—á–∞–ª—å–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–Ω–∞—á–µ–Ω–∏–µ –±–∏—Ç–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ü–≤–µ—Ç–∞ —ç–∫—Ä–∞–Ω–∞.
  –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–π –∫–ª–∞–≤–∏—à–µ, –∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ -
  —á–µ—Ä–µ–∑ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: Main Menu -> Other -> User Menu
}
  def_int(type, x);
  def_str(par[500], command[128]);
  run_macro('userin^db /F=meconfig.db/HPT=USER.DB/NDF=1/NDH=1' +
            '/PRE=gsv_/GLO=gsv_return_str/LO=1/ABT=–ó–∞–ø—É—Å–∫/CBT=–í—ã—Ö–æ–¥/2TOP=1' +
            '/LT= –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é GSVUM /DT= –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é ' +
            '/H=USER');
  if return_int <> 0 then
    par     := global_str('gsv_return_str');
    type    := parse_int('TYPE=', par);
    command := parse_str('CMD=', par);
    make_message(command);
    if    type = 1 then
      return_str := par;
      run_macro('gsv_run_db');
    elsif type = 2 then
      return_str := par;
      run_macro('gsv_exec_db ' + file_name);
      save_box(1, message_row, screen_width, message_row);
      new_screen;
      kill_box;
    elsif type = 3 then
      x := xpos('^', command, 1);
      if (x = 0) then
        make_message('–ù–µ –∑–∞–¥–∞–Ω –∏–Ω–¥–µ–∫—Å –≤ help-—Ñ–∞–π–ª–µ ' + command);
      else
        run_macro('mehelp^mehelp /CX=1/F=' + copy(command, 1,     x - 1) +
                                '/LK='     + copy(command, x + 1, 2048)  );
      end;
    elsif type = 4 then
      return_str := command;
      run_macro('gsv_load');
    end;
  end;
end_macro;


$macro gsv_draw from EDIT trans; { 18-–¥–µ–∫-91 }
{ –≠—Ç–æ—Ç –º–∞–∫—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–π –∏–ª–∏ —Ä–∞–º–æ–∫ –ø–æ —Å—Ç–æ–ª–±—Ü–æ–≤–æ–º—É –±–ª–æ–∫—É:
  - –µ—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω —Å—Ç–æ–ª–±—Ü–æ–≤—ã–π –±–ª–æ–∫ –≤—ã—Å–æ—Ç–æ–π –≤ 1 —Å–∏–º–≤–æ–ª, —Ç–æ —Ä–∏—Å—É–µ—Ç—Å—è
    –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è,
  - –µ—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω —Å—Ç–æ–ª–±—Ü–æ–≤—ã–π –±–ª–æ–∫ —à–∏—Ä–∏–Ω–æ–π –≤ 1 —Å–∏–º–≤–æ–ª, —Ç–æ —Ä–∏—Å—É–µ—Ç—Å—è
    –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è,
  - –µ—Å–ª–∏ –æ—Ç–º–µ—á–µ–Ω —Å—Ç–æ–ª–±—Ü–æ–≤—ã–π –±–ª–æ–∫ —à–∏—Ä–∏–Ω–æ–π –∏ –≤—ã—Å–æ—Ç–æ–π –±–æ–ª–µ–µ 1 —Å–∏–º–≤–æ–ª–∞, —Ç–æ
    —Ä–∏—Å—É–µ—Ç—Å—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫.
  –¢–∏–ø –ª–∏–Ω–∏–∏ –∏–ª–∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –ø–æ –º–µ–Ω—é. –ü—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏ –ª–∏–Ω–∏–π
  –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å–∏–º–≤–æ–ª–æ–≤ –ª–∏–Ω–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è—Ö.

  –ú–∞–∫—Ä–æ—Å –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Ä–∞–±–æ—Ç—É —Å –º—ã—à–∫–æ–π, —Ö–æ—Ç—è –µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è
  –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º. –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã –ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∫–∏ –∞—Å—Å–æ—Ü–∏–∏—Ä—É–µ—Ç—Å—è —Å
  –æ—Ç–º–µ—Ç–∫–æ–π —Å—Ç–æ–ª–±—Ü–æ–≤–æ–≥–æ –±–ª–æ–∫–∞, –∞ –ø—Ä–∞–≤–∞—è - —Å –≤—ã–∑–æ–≤–æ–º –º–∞–∫—Ä–æ—Å–∞ gsv_draw.

  –ï—Å–ª–∏ –±–ª–æ–∫ –Ω–µ –æ—Ç–º–µ—á–µ–Ω, —Ç–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤—ã–≤–æ–¥ –º–µ–Ω—é –ø—Å–µ–≤–¥–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤.
  –î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ —Å–∏–º–≤–æ–ª–∞ –≤ —Ç–µ–∫—Å—Ç –Ω—É–∂–Ω–æ –ø–æ–¥–≤–µ—Å—Ç–∏ –∫ –Ω–µ–º—É —Ç–µ–∫—Å—Ç–æ–≤—ã–π
  –∏–ª–∏ –º—ã—à–∏–Ω—ã–π –º–∞—Ä–∫–µ—Ä –∏ –Ω–∞–∂–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ Enter –∏–ª–∏ –ª–µ–≤—É—é –∫–ª–∞–≤–∏—à—É –º—ã—à–∫–∏.
  –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä–∫—É –ø—Å–µ–≤–¥–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ –º–æ–∂–Ω–æ Esc –∏–ª–∏ –ø—Ä–∞–≤–æ–π –∫–ª–∞–≤–∏—à–µ–π
  –º—ã—à–∫–∏.
}
  def_int(tmp_ins_mode, tmp_col, tmp_line, tmp_row);
  def_str(border1[8] := '‚îå‚îÄ‚îê‚îÇ‚îÇ‚îî‚îÄ‚îò',
          border2[8] := '‚ïî‚ïê‚ïó‚ïë‚ïë‚ïö‚ïê‚ïù',
          border3[8] := '‚îå‚îÄ‚ïñ‚ïë‚îÇ‚ïò‚ïê‚ïù',
          border4[8] := '‚ñà‚ñÄ‚ñà‚ñà‚ñà‚ñà‚ñÑ‚ñà'
       );
  def_str(s1 := '‚îå‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚ï•‚îÄ‚îê  ‚ïî‚ïê‚ïê‚ïê‚ï§‚ïê‚ï¶‚ïê‚ïó  ‚ïì‚îÄ‚îÄ‚îÄ‚ïñ  
   ',
          s2 := '‚îÇ   ‚îÇ ‚ïë ‚îÇ  ‚ïë   ‚îÇ ‚ïë ‚ïë  ‚ïô‚îÄ‚îÄ‚îÄ‚ïú  ‚Ññ‚àô¬∑  ',
          s3 := '‚îú‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚ï´‚îÄ‚î§  ‚ïü‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚ï´‚îÄ‚ï¢          ',
          s4 := '‚ïû‚ïê‚ïê‚ïê‚ï™‚ïê‚ï¨‚ïê‚ï°  ‚ï†‚ïê‚ïê‚ïê‚ï™‚ïê‚ï¨‚ïê‚ï£  ‚ïí‚ïê‚ïê‚ïê‚ïï  ‚ñë‚ñí‚ñì‚ñà‚ñÑ‚ñå‚ñê‚ñÄ‚ñ†  ',
          s5 := '‚îî‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚ï®‚îÄ‚îò  ‚ïö‚ïê‚ïê‚ïê‚ïß‚ïê‚ï©‚ïê‚ïù  ‚ïò‚ïê‚ïê‚ïê‚ïõ  –Å—ë–Ñ—î–á—ó–é—û¬∞‚àö¬§'
         );

  tmp_ins_mode := insert_mode;
  tmp_col      := c_col;
  tmp_line     := c_line;
  tmp_row      := c_row;
  refresh      := FALSE;
  if (block_stat = 2) then
    if    ((block_line1  = block_line2) and (block_col1 <> block_col2)) then
      call horizont_line;
    elsif ((block_line1 <> block_line2) and (block_col1 =  block_col2)) then
      call vertical_line;
    elsif ((block_line1 <> block_line2) and (block_col1 <> block_col2)) then
      call border;
    end; {if}
    { –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–∏–¥–∏–º–æ–≥–æ –æ–∫–Ω–∞ }
    goto_col(tmp_col); goto_line(tmp_line);
    if    (c_row > tmp_row) then while (c_row <> tmp_row) do
                                   run_macro('scrollup'); up;
                                 end; {while}
    elsif (c_row < tmp_row) then while (c_row <> tmp_row) do
                                   run_macro('scrolldn'); down;
                                 end; {while}
    end; {if}
    block_off;
  elsif (block_stat = 0) then
    call table;
  end; {if}
  goto exit;

protect: { –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–ª–æ–∂–µ–Ω–∏—è –∑–∞ –∫–æ–Ω—Ü–æ–º —Ñ–∞–π–ª–∞ }
  goto_col(block_col2);
  goto_line(block_line2 + 1);
  if (at_eof) then
    text(' ');
  end; {if}
  goto_col(block_col1);
  goto_line(block_line1);
  ret;

{ ************************ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ ****************** }

horizont_line:
  run_macro('userin^xmenu /B=1/T=0/L= –¢–∏–ø –ª–∏–Ω–∏–∏ ' +
            '/M= 1‚îÄ () 2‚ïê () 3‚ñë () 4‚ñí () 5‚ñì () 6‚ñà () 7‚ñÑ () 8‚ñÄ ()');
  if (return_int <> 0) then
    insert_mode := FALSE;
    push_undo;
    call protect;
    if    (return_int = 3) then return_str := '‚ñë';
    elsif (return_int = 4) then return_str := '‚ñí';
    elsif (return_int = 5) then return_str := '‚ñì';
    elsif (return_int = 6) then return_str := '‚ñà';
    elsif (return_int = 7) then return_str := '‚ñÑ';
    elsif (return_int = 8) then return_str := '‚ñÄ';
    end;
    if (return_int = 1) then    { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω–∞—Ä–Ω–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ }
      while (c_col <= block_col2) do
        if    (c_col = block_col1) then if    (cur_char = '‚îÇ') then text('‚îú');
                                        elsif (cur_char = '‚ïë') then text('‚ïü');
                                        else                        text('‚îÄ');
                                        end; {if}
        elsif (c_col = block_col2) then if    (cur_char = '‚îÇ') then text('‚î§');
                                        elsif (cur_char = '‚ïë') then text('‚ï¢');
                                        else                        text('‚îÄ');
                                        end; {if}
        else                            if    (cur_char = '‚îÇ') then text('‚îº');
                                        elsif (cur_char = '‚ïë') then text('‚ï´');
                                        else                        text('‚îÄ');
                                        end; {if}
        end; {if}
      end; {while}
    elsif (return_int = 2) then { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ }
      while (c_col <= block_col2) do
        if    (c_col = block_col1) then if    (cur_char = '‚îÇ') then text('‚ïû');
                                        elsif (cur_char = '‚ïë') then text('‚ï†');
                                        else                        text('‚ïê');
                                        end; {if}
        elsif (c_col = block_col2) then if    (cur_char = '‚îÇ') then text('‚ï°');
                                        elsif (cur_char = '‚ïë') then text('‚ï£');
                                        else                        text('‚ïê');
                                        end; {if}
        else                            if    (cur_char = '‚îÇ') then text('‚ï™');
                                        elsif (cur_char = '‚ïë') then text('‚ï¨');
                                        else                        text('‚ïê');
                                        end; {if}
        end; {if}
      end; {while}
    else                        { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ }
      while (c_col <= block_col2) do
        text(return_str);
      end; {while}
    end; {if}
    pop_undo;
  end; {if}
  ret;

{ ************************** —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ ****************** }

vertical_line:
  run_macro('userin^xmenu /B=1/T=0/L= –¢–∏–ø –ª–∏–Ω–∏–∏ ' +
            '/M= 1‚îÇ () 2‚ïë () 3‚ñë () 4‚ñí () 5‚ñì () 6‚ñà () 7‚ñå () 8‚ñê ()');
  if (return_int <> 0) then
    insert_mode := FALSE;
    push_undo;
    call protect;
    if    (return_int = 3) then return_str := '‚ñë';
    elsif (return_int = 4) then return_str := '‚ñí';
    elsif (return_int = 5) then return_str := '‚ñì';
    elsif (return_int = 6) then return_str := '‚ñà';
    elsif (return_int = 7) then return_str := '‚ñå';
    elsif (return_int = 8) then return_str := '‚ñê';
    end;
    if    (return_int = 1) then { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω–∞—Ä–Ω–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ }
      while (c_line <= block_line2) do
        if    (c_line = block_line1) then if    (cur_char = '‚îÄ') then text('‚î¨');
                                          elsif (cur_char = '‚ïê') then text('‚ï§');
                                          else                        text('‚îÇ');
                                          end; {if}
        elsif (c_line = block_line2) then if    (cur_char = '‚îÄ') then text('‚î¥');
                                          elsif (cur_char = '‚ïê') then text('‚ïß');
                                          else                        text('‚îÇ');
                                          end; {if}
        else                              if    (cur_char = '‚îÄ') then text('‚îº');
                                          elsif (cur_char = '‚ïê') then text('‚ï™');
                                          else                        text('‚îÇ');
                                          end; {if}
        end; {if}
        left; down;
      end; {while}
    elsif (return_int = 2) then { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ }
      while (c_line <= block_line2) do
        if    (c_line = block_line1) then if    (cur_char = '‚îÄ') then text('‚ï•');
                                          elsif (cur_char = '‚ïê') then text('‚ï¶');
                                          else                        text('‚ïë');
                                          end; {if}
        elsif (c_line = block_line2) then if    (cur_char = '‚îÄ') then text('‚ï®');
                                          elsif (cur_char = '‚ïê') then text('‚ï©');
                                          else                        text('‚ïë');
                                          end; {if}
        else                              if    (cur_char = '‚îÄ') then text('‚ï´');
                                          elsif (cur_char = '‚ïê') then text('‚ï¨');
                                          else                        text('‚ïë');
                                          end; {if}
        end; {if}
        left; down;
      end; {while}
    else                        { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ }
      while (c_line <= block_line2) do
        text(return_str);
        left; down;
      end; {while}
    end; {if}
    pop_undo;
  end; {if}
  ret;

{ ************************** —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Ä–∞–º–∫–∏ ******************************* }

def_str(border[8]);

border: { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Ä–∞–º–∫–∏ }
  run_macro('userin^xmenu /B=1/T=1/L= –¢–∏–ø —Ä–∞–º–∫–∏-–±–æ–∫—Å–∞ ' +
            '/M= 1   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò() 2   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù() 3   ‚ïò‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù() 4   ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà() 5   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚ñë‚ñë  () 6   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë  () 7   ‚ïò‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë  () 8   ‚ñà‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñë‚ñë  ()');
  if (return_int <> 0) then
    insert_mode := FALSE;
    push_undo;
    call protect;
    if    ((return_int = 1) or (return_int = 5)) then border := border1;
    elsif ((return_int = 2) or (return_int = 6)) then border := border2;
    elsif ((return_int = 3) or (return_int = 7)) then border := border3;
    elsif ((return_int = 4) or (return_int = 8)) then border := border4;
    end; {if}
    mark_pos;
    text(str_char(border, 1));
    while (c_col < block_col2) do
      text(str_char(border, 2));
    end; {while}
    text(str_char(border, 3));
    down; left;
    while (c_line < block_line2) do
      text(str_char(border, 4));
      down; left;
    end; {while}
    goto_mark;
    down;
    while (c_line < block_line2) do
      text(str_char(border, 5));
      down; left;
    end; {while}
    text(str_char(border, 6));
    while (c_col < block_col2) do
      text(str_char(border, 7));
    end; {while}
    text(str_char(border, 8));
    if (return_int > 4) then { —Ä–∏—Å–æ–≤–∞–Ω–∏–µ —Ç–µ–Ω–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞ }
      goto_col(block_col1 + 2);
      goto_line(block_line2 + 1);
      while (c_col < (block_col2 + 3)) do
        text('‚ñë');
      end; {while}
      left; left; up;
      while (c_line > block_line1) do
        text('‚ñë‚ñë');
        left; left; up;
      end; {while}
    end; {if}
    pop_undo;
  end; {if}
  ret;

{ ********************** —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –ø—Å–µ–≤–¥–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ ************** }

def_int(x, y, xmin, ymin, xmax, ymax, wid, len);

table:
  mark_pos;
  wid := svl(s1);
  len := 5;
  x := ((screen_width  - wid - 4) / 2) + 2;
  y := ((screen_length - len - 2) / 2) + 1;
  xmin := x;
  ymin := y;
  xmax := x + wid - 1;
  ymax := y + len - 1;
  put_box(x - 2, y - 1, x + wid + 3, y + len + 1, 0, m_b_color,
          ' –ü—Å–µ–≤–¥–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Å–∏–º–≤–æ–ª—ã ', 1);
  write(s1, x, y    , 0, m_t_color);
  write(s2, x, y + 1, 0, m_t_color);
  write(s3, x, y + 2, 0, m_t_color);
  write(s4, x, y + 3, 0, m_t_color);
  write(s5, x, y + 4, 0, m_t_color);
  gotoxy(x, y);
  while (1) do { —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∞–≤–∏—à –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è, –≤—ã–±–æ—Ä–∞ –∏ –æ—Ç–º–µ–Ω—ã }
    read_key;
    if    ((key1 = 13) and (key2 =  28)) then { Enter      }
      goto end_loop;
    elsif ((key1 =  0) and (key2 = 250)) then { Left Mouse }
      mou_check_status;   { —Å–æ–≤–º–µ—â–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞ —Å –º—ã—à–∏–Ω—ã–º }
      gotoxy(mou_last_x, mou_last_y);
      goto end_loop;
    elsif (((key1 = 27) and (key2 =   1))  or   { Esc }
           ((key1 =  0) and (key2 = 251))) then { Right Mouse }
      kill_box;   { –æ—Ç–∫–∞–∑ –æ—Ç –≤—ã–±–æ—Ä–∞ –ø—Å–µ–≤–¥–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —Å–∏–º–≤–æ–ª–∞ }
      goto_mark;
      ret;
    elsif ((key1 = 0) and (key2 = 75)) then { Left }
      if (x > xmin) then --x; end; {if}
    elsif ((key1 = 0) and (key2 = 77)) then { Right }
      if (x < xmax) then ++x; end; {if}
    elsif ((key1 = 0) and (key2 = 72)) then { Up }
      if (y > ymin) then --y; end; {if}
    elsif ((key1 = 0) and (key2 = 80)) then { Down }
      if (y < ymax) then ++y; end; {if}
    elsif ((key1 = 0) and (key2 = 71)) then { Home }
      x := xmin; y := ymin;
    elsif ((key1 = 0) and (key2 = 79)) then { End }
      x := xmax;
    end; {if}
    gotoxy(x, y);
  end; {while}
  end_loop:
    r_ax := $800; { –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ BIOS –¥–ª—è –ø—Ä–∏–µ–º–∞ —Å–∏–º–≤–æ–ª–∞ –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ }
    r_bx := 0;    { —Å —ç–∫—Ä–∞–Ω–∞                                            }
    intr($10);
    return_str := char(r_ax and $FF);
    kill_box;
    goto_mark;
    insert_mode := FALSE;
    text(char(r_ax and $FF));
  ret;

exit:
  refresh := TRUE;
  insert_mode := tmp_ins_mode;
  redraw;
end_macro; { gsv_draw }
