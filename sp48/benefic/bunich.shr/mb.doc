






                     M  a  c  r  o  B  a  t
                     ----------------------

            Монитор-макропроцессор для пакетов MS-DOS
            -----------------------------------------


                 Редакция.... 2.0  (сентябрь 1992)

          (C) 1992 by L.G.Bunich.  ALL RIGHTS RESERVED.




   Система MacroBat распространяется на  принципах ShareWare.  Это
значит,  что разрешается свободное ее распространение и апробация;
если Вы приняли решение использовать MacroBat, переведите автору 2
доллара или 100 рублей.


   Замечания, предложения и взносы благодарных пользователей можно
присылать по адресу:

      143013 Московская обл., Одинцовский район, пос.Немчиновка-1
      ул. Агрохимиков дом 7 кв. 100  Буничу Л.Г.
      Тел. для справок:   591-93-09 дом.


   Система должна распространяться в неизмененном виде  и в полном
комплекте.  Коммерческое использование и/или доработки возможны по
согласованию с автором.


   Автор благодарен участникам СофтПанорамы (гл. редактор Н.Н.Без-
руков).  Некоторые из опубликованных в этом издании статей и мате-
риалов помогли при разработке MacroBat.


                           Москва 1992



  ------------------- С О Д Е Р Ж А Н И Е -----------------------

  1. О б щ и е   с в е д е н и я.

     1.1.  Назначение системы.
     1.2.  Пример "интеллектуального" BAT-файла.
     1.3.  Как запустить MacroBat.
     1.4.  Символические параметры.

  2. М а к р о я з ы к.

     2.1.  Макропеременные.
     2.2.  Оператор присваивания.

          2.1.1. Присваивание явно заданного значения.
          2.1.2. Присваивание арифметического выражения.
          2.1.3. Присваивание значения функции.

     2.3.  Условный оператор.
     2.4.  Метки и переходы.
     2.5.  Запуск внешних программ.
     2.6.  EXIT - завершение работы MacroBat.
     2.7.  LOAD - закрепить программу в памяти.
     2.8.  Оператор цикла.

  3. С р е д с т в а   д и а л о г а.

     3.1.  ECHO - вывод сообщения на экран.
     3.2.  COLOR - установка текущих цветов.
     3.3.  CLS - очистка экрана.
     3.4.  CURSOR - определение формы курсора.
     3.5.  BOX - вывод прямоугольной плитки.
     3.6.  PUT - вывод текста в произвольное место экрана.
     3.7.  GETCH - функция ввода символа.
     3.8.  GETSTR - функция ввода текста.
     3.9.  SOUND - генерация звука.
     3.10. DELAY - ожидание временного интервала.

  Приложение 1. Таблица музыкальных нот.
  Приложение 2. Некоторые расширенные клавишные коды.
  Приложение 3. Протокол изменений.



                 1. О б щ и е   с в е д е н и я.
                 -------------------------------

                    1.1. Назначение системы.
                    ------------------------

                - Леонтий Сергеевич сам написал пьесу!
                - А зачем?- тревожно спросила Настасья Ивановна.
                - Как зачем? Гм... гм...
                - Разве уж и пьес не  стало?-  ласково-укоризненно
            спросила Настасья Ивановна.- Какие хорошие пьесы есть.
            И сколько их!  Начнешь играть - в двадцать лет всех не
            переиграешь. Зачем же вам тревожиться сочинять?

            М.А.Булгаков "Записки покойника" ("Театральный роман")


   Вероятно,  каждый, кто составлял программы,  составлял и пакеты
для их вызова (BAT-файлы),  и неоднократно сетовал при этом на ог-
раниченность макросредств MS-DOS. Примеры:

        - условные операторы и циклы крайне примитивны;
        - нет вычислительных и диалоговых средств;
        - нет манипуляций с текстом (для анализа параметров);
        - нет средств адаптации к текущему  оборудованию,  и наст-
          ройку,  скажем,  на черно-белый экран приходится встраи-
          вать в прикладные программы

и многое другое.

   Кроме того, хотелось бы иметь открытую систему,  допускающую ее
развитие усилиями пользователя.

   Предлагаемая система MacroBat  (сокращенно:  MB)  содержит ком-
пактные,  быстрые  и удобные средства для создания "интеллектуаль-
ных" пакетов MS-DOS с самой сложной логикой управления. Это позво-
лит Вам без труда решать многие практические задачи, например:

     - создание установочных и рекламных систем;
     - разработка красивых диалоговых оболочек чужих систем;
     - реализация иерархии вторичных меню Norton Commander;
     - привязка чужих программ к Вашему  оборудованию  и  файловой
       структуре, к дате выполнения, ко дню недели,  к содержимому
       Ваших баз данных и т.д.;
     - автоматизация ручного труда и сокращение диалога;
     - просто уменьшение числа пакетов ДОС, задание параметров для
       них наиболее удобным и компактным способом.

   Это, конечно, не исчерпывающий перечень.

   От  многочисленных  аналогов  (4DOS/NDOS,  BATCHMAN,  BE,  MBE,
PANDORA, WHAT и др.) MacroBat отличается в  первую  очередь  своим
ОТКРЫТЫМ характером. Это значит, что пользователь может подключать
к системе неограниченное  количество  своих  собственных  программ
(функций),  написанных на любом языке.  Пример: функция DPERIOD.C,
входящая в поставку; она вычисляет число дней между двумя заданны-
ми датами.

   Кроме того,  макроязык  и комплект стандартных средств MacroBat
по своему уровню значительно превосходят средства аналогов. Приве-
дем краткий перечень стандартных возможностей системы.


УПРАВЛЕНИЕ........запуск произвольных программ;
                  анализ их кода завершения;
                  нормальный   многострочный   условный   оператор
                    IF/ELSE (допускающий неограниченное вложение);
                  циклы по чему угодно -  по файлам,  строкам тек-
                    стового  файла,  строчкам экрана,  дисководам,
                    помеченным   файлам  панели  Norton  Commander
                    и  т.п.  (вложенность - до семи уровней);  для
                    организации  нестандартного  цикла  достаточно
                    написать его управляющую функцию;
                  переходы на метки;
                  хранение, если надо, всего макрофайла (MB-проце-
                    дуры) в оперативной памяти;
                  генерация нужного кода завершения  перед оконча-
                    нием работы;

МАКРОВОЗМОЖНОСТИ..локальные макропеременные;
                  целочисленная арифметика (5 действий)  для чисел
                    и числовых переменных, не превышающих по абсо-
                    лютной величине (примерно) 2 миллиардов;
                  вызов произвольных макрофункций;
                  закрепление  макрофункций  в оперативной  памяти
                    для ускорения их вызова;
                  подстановка параметров и функций (вложенность не
                    ограничена);
                  все виды сравнения чисел и текстов;
                  выделение из строки  произвольных текстовых под-
                    строк слева или справа;
                  поиск вхождения подстроки в строку;
                  вычисление длины текстовой строки;
                  преобразование текста в заглавный  или  строчный
                    регистр (кириллица поддерживается);
                  для  отладки макросов  можно протоколировать  их
                    выполнение;

ЗАПРОСЫ К СРЕДЕ...определение состава оборудования:
                    - тип процессора:  8086...80486;
                    - тип видеоадаптера: MDA,HGC,CGA,EGA,MCGA,VGA;
                    - наличие сопроцессора;
                    - число подключенных логических дисководов;
                    - наличие и тип заданного дисковода;
                    - наличие и готовность принтера;
                    - тип клавиатуры (стандартная/расширенная);
                    - наличие и тип манипулятора "мышь";
                    - наличие драйвера ANSI.SYS;
                    - наличие среды WINDOWS 3.0;
                  выяснение версии ДОС;
                  определение  текущей даты,  времени,  дня недели
                    в различных форматах;
                  определение имени текущего оглавления;
                  определение кода текущего диска;
                  определение размера свободной памяти:  оператив-
                    ной, дисковой или в области окружения ДОС;
                  обслуживание среды Norton Commander 3.0:
                    - выяснение наличия NC;
                    - определение устройства, пути и/или имени те-
                      кущего файла на обеих панелях;
                    - цикл по помеченным файлам;

ДИАЛОГ............очистка экрана;
                  ввод  с клавиатуры  строк  (с редактированием) и
                    отдельных символов; 
                  вывод цветных строк в произвольное место экрана,
                    с абсолютной или относительной адресацией;
                  вывод цветных плиток (boxes) всех видов - с рам-
                    ками или без,  с произвольным заполнителем или
                    "прозрачных";
                  получение номеров текущей строки и колонки;
                  формирование или отключение курсора;
                  подача звуков любой частоты и длительности;
                  ожидание временного интервала;
                  поддерживается  25,30,33,43,50 строк,  40,80,132
                    и любое другое число колонок на экране;

РАБОТА С ФАЙЛАМИ..редактирование имени файла по заданному формату:
                    выделение  устройства, пути, имени, расширения
                    в любом сочетании;
                  поиск файла по трафарету или префиксу;
                  выяснение,  существует ли  файл  (конкретный или
                    заданный с помощью трафарета имени);
                  ввод, вывод, обработка записей текстовых файлов;
                  выяснение атрибутов, длины и даты изменения нуж-
                    ного файла;
                  удаление файла.


   Большинство перечисленных средств MacroBat делает доступными на
уровне любых BAT-файлов MS-DOS. Свобода Ваших действий значительно
расширится,  и Вам не понадобится для этого  капризная 4DOS!  Пол-
ностью спектр возможностей системы доступен при написании программ
на собственном макроязыке системы (MB-процедур).  Этот язык быстро
развивается.

   Система  работает  под управлением  MS-DOS  (начиная с редакции
3.30), на любых IBM-совместимых персональных компьютерах. Провере-
на работа в DR-DOS, 4DOS (NDOS), HiDOS и в среде WINDOWS 3.0.

   Занимаемая память:  около тринадцати килобайтов,  никаких рези-
дентных программ не требуется.

   Язык программирования:  100% Ассемблер.

   В состав системы сейчас входят следующие файлы:

      - настоящая инструкция................ MB.DOC
      - описание стандартных функций........ MBLIB.DOC
      - монитор-макропроцессор.............. MB.EXE
      - комплект сервисных функций.......... DOS.COM
      - комплект файловых функций........... FILE.COM
      - исходный текст конвертора
        ANSI-картинок в формат MacroBat..... ANSI2MB.C
      - демонстрационный пакет.............. DEMO.BAT, DEMO.MB
                                             и FRUITS.MB
      - пример макрофункции пользователя.... DPERIOD.C
      - примеры пакетов MS-DOS и MacroBat... MBBAT.ARJ

   Для демонстрации возможностей системы запустите пакет DEMO.BAT.



                                    - Кароши люблю, плохой - нет,-
                                      сурово говорил иностранец.

                                 М.А.Булгаков "Мастер и Маргарита"



           1.2. Пример "интеллектуального" BAT-файла.
           ------------------------------------------

   Приведем для иллюстрации простейший пример пакета ДОС,  исполь-
зующего  средства  MacroBat.  Более  изощренные примеры будут даны
позже.

   -- Интеллектуальная распаковка любых архивов: пакет UA.BAT --

       @echo off
         if "%1"=="" goto :Notfound
         MB F=FILE(FindPfx %1)
         if "%F%"=="" goto :NotFound
         MB EXT=Ext(%F%)
         if "%EXT%"=="ARJ" goto :ARJ
               .............
         if "%EXT%"=="ZIP" goto :ZIP
         Echo UA: %F% is not archive
         goto :End
       :NotFound
         Echo UA: archive %1 missing or not found
         goto :End
       :ARJ
         arj x %F% %2 %3 %4
         goto :Fin
         .................
       :ZIP
         pkunzip %F% %2 %3 %4
       :Fin
         set EXT=
         set F=
       :End

   Прокомментируем этот пакет. Аргументом  для  него  служит  либо
полное имя архива (например, ZARPL.ARJ), либо  имя  без расширения
(просто ZARPL, расширение определяется автоматически). Более того,
можно даже набирать имя не до конца,  ограничившись  любым префик-
сом,  однозначно определяющим файл.  Например,  если на дискете A:
есть файлы NALOGI.DAT, ZARPL.ARJ и ZENY.DBF,  то можно вызвать па-
кет так:

        ua a:za

   Как это делается? Сначала пакет проверяет, не забыли ли мы ука-
зать аргумент (префикс имени файла).  Если аргумент имеется, нахо-
дим первый файл с этим префиксом (третья строка) и присваиваем его
имя  переменной F.  В данном случае  MacroBat хранит значения всех
переменной   в  главной   области   окружения   ДОС   (Master  DOS
Environment) активного командного процессора.

   Поиск файла по префиксу выполняет функция FindPfx  из комплекта
FILE.  Если таких файлов нет, переменная F получает  пустое значе-
ние, которое проверяется в четвертой строке.  Если же файл найден,
определяется его расширение (строка 5)  и вызывается соответствую-
щий архиватор.

   Вы можете этот же пакет переписать на макроязыке MacroBat. Тог-
да он будет запускаться командой:

        MB UA аргументы         (имя пакета:  UA.MB)

и примет более благородный вид:

       If "%1" = ""
         Echo "UA: пропущен аргумент"; Exit;  Endif
       F=FILE( FindPfx %1 )
       If "%F" = ""
         Echo "UA: не найден файл %1"; Exit;  Endif
       Ext=Ext(%F)
       If "%Ext" = "ARJ"
         arj x %F %2 %3 %4 %5 %6; Exit; endif
       if "%Ext" = "ZIP"
         pkunzip -d %F %2 %3 %4 %5 %6; Exit;  Endif
       -- сюда вставьте обработку прочих архивов (PAK,ZOO,ARC,...)
       Echo "UA: %F is not an archive"


   Теперь несколько замечаний.

   Емкость окружения ДОС ограничена (по умолчанию обычно  256 бай-
тов  или даже меньше,  в зависимости от вида и версии ДОС).  Этого
может оказаться недостаточно для сложных пакетов.  В MacroBat пре-
дусмотрена возможность создания собственных пакетов (MB-процедур),
в которых сняты ограничения ДОС (процедуры по умолчанию используют
дополнительную область окружения).

   Рекомендуется указывать в CONFIG.SYS увеличенный размер области
окружения, например:

          Shell = C:\SYS\DOS\COMMAND.COM /e:512 /p

   Кроме того, надо иметь в виду, что пакеты, запущенные из Norton
Commander, получают область окружения стандартной длины,  т.е. все
те же злосчастные 256 или менее байтов, невзирая на CONFIG.SYS.



                  1.3. Как запустить MacroBat.
                  ----------------------------

   Запустить систему MacroBat можно двумя способами.

   (1) Если Вам нужно выполнить всего  один  оператор  макроязыка,
можно встроить его прямо в команду запуска:

         MB  текст_оператора

   Можно  выполнить  оператор  присваивания или один из диалоговых
операторов. См. пример в предыдущем параграфе.

   (2) Если нужно выполнить программу,  записанную  на  макроязыке
MacroBat  (MB-процедуру),  надо  подготовить  эту программу в виде
текстового файла с расширением .MB  и дать команду:

         MB  режимы  имя_файла_процедуры  аргументы

   Р е ж и м ы   (необязательный операнд).

        /BIOS  - выводить на экран через INT 10h,  а не прямой за-
             сылкой в видеопамять. Этот способ работает медленнее,
             и его следует применять, если у Вас проблемы с экран-
             ным выводом (неполноценный видеоадаптер).

        /L:файл  -  выводить протокол работы (журнал) MacroBat.

                Ф а й л: спецификация файла для протокола  (до  60
             символов); она может быть опущена (вместе с двоеточи-
             ем),  тогда протокол выводится на экран.  Если вы ис-
             пользуете средства диалога (PUT, BOX и др.), то выво-
             дить протокол на экран, конечно, не следует.
                Протокол содержит копии  интерпретируемых операто-
             ров (после всех макроподстановок)  и может быть очень
             полезен при отладке процедур -  например, если вы за-
             трудняетесь определить, почему условие неверно,  хотя
             должно быть верно.

        /M  -  хранить всю процедуру в оперативной памяти.

                Это значительно ускоряет выполнение  оператора пе-
             рехода. Если файл процедуры хранится  на  винчестере,
             вряд ли Вы заметите это ускорение, но при  запуске  с
             дискеты разница  будет  весьма  существенной.  Нельзя
             хранить в памяти процедуры длиной более 32760 байтов.

   ВНИМАНИЕ: режимы: если они заданы, должны стоять  ПЕРЕД  именем
процедуры!

   П р о ц е д у р а - это программа на макроязыке.  Для  файла  с
процедурой можно не указывать  расширение  (подразумевается  .MB).
Имя процедуры не должно совпадать с  ключевыми  словами макроязыка
(IF, ECHO, SOUND и др.). Можно указать путь к файлу.

   Файл процедуры состоит из операторов макроязыка.  Он обычно со-
держит символические параметры, подробно описанные в следующем па-
раграфе. Например, запись %1% означает "подставить значение перво-
го аргумента вызова".

   А р г у м е н т ы - произвольные тексты,  разделенные пробелами
или запятыми. Если аргумент содержит пробелы или запятые, надо за-
ключить его в кавычки (если в нем есть и кавычки, то каждую из них
в этом случае следует удвоить).

   Значение первого аргумента будут подставляться вместо параметра
%1%, значение второго - вместо %2% и т.д.  Окаймляющие кавычки при
подстановке удаляются.  Число аргументов при вызове из ДОС ограни-
чено только длиной строки ДОС,  а при рекурсивном вызове (MacroBat
из MacroBat) не ограничено.



                 1.4.  Символические параметры.
                 ------------------------------

   В  тексте процедуры (в произвольных местах) могут быть подстав-
ляемые  параметры,  формат  которых  аналогичен формату параметров
ДОС:

         %имя_параметра%

   Будем называть такие параметры простыми.  Разновидность простых
параметров - ссылки на аргументы вызова. Есть два отличия от ДОС:

   A. Число аргументов вызова не ограничено (в ДОС - до девяти).
   Б. Символ процента справа, вообще говоря, нужен и здесь:

        %1%   %2%   %3%   %4%  ...

   Однако  если после имени (любого) простого параметра стоит один
из нижеперечисленных специальных символов:

        пробел , + - * / # ; [ ] = ) " < >

то знак процента справа можно не ставить.

   Кроме  простых,  имеются  вычисляемые параметры,  у которых два
возможных формата:

        (1)  %(арифметическое_выражение)
        (2)  %имя_функции(аргументы)

   В первом случае подставляется значение выражения, а во втором -
значение,  возвращаемое  указанной  макрофункцией (стандартной или
пользовательской).  Синтаксис  выражения  и  перечень  стандартных
функций описаны ниже.  Даже если аргументы  у функции отсутствуют,
скобки все равно надо указать, например:

        Put %Cline(),2 "====="

   Выражение и аргументы в скобках могут,  в свою очередь,  содер-
жать параметры; вложенность их может быть произвольна.

   ВНИМАНИЕ: имеются следующие ограничения.

   (а) Среди аргументов функции  символ  правой скобки  может быть
только внутри строки (в кавычках).
   (б) Перед открывающей скобкой не должно быть пробела.
   (в) Вычисляемые параметры нельзя использовать для генерации ме-
ток операторов и следующих ключевых слов:

        IF  ELSE  ENDIF  DO  ENDDO

   В случае такой нужды  надо присвоить вычисляемый параметр прос-
тому, который и использовать для генерации.

   Примеры вычисляемых параметров:

                %( 10 * (%L + 1) )
                %Sub(1,1,%DOS( Check vid ))

   Перед исполнением любого оператора все содержащиеся в нем пара-
метры заменяются на соответствующие значения. Для простых парамет-
ров значения должны быть определены в области окружения (локальной
или главной,  см. ниже),  иначе параметр игнорируется и вся конст-
рукция %имя_параметра% уничтожается.

   З а м е ч а н и я.

   1. Если символ процента используется в процедуре буквально, его
надо удвоить, например:

        echo "Договор выполнен на %P%%%"

   Этот оператор выведет строку вида "Договор выполнен на 78%".

   2. Рекомендуется поместить MB.EXE и его макрофункции  на элект-
ронный диск, это ускорит их вызов.

   П р и м е р:  надо принять с клавиатуры фамилию, затем преобра-
зовать ответ так, чтобы первая буква была заглавной, а остальные -
строчными. Для этого можно запустить такой пакет:

        @echo off
        MB R=GetStr( "Фамилия?" )
        MB Capitalz %R%
        echo ==%W%==

   Здесь CAPITALZ.MB - файл, содержащий следующую процедуру:

        -- выделим первый символ и сделаем его заглавным
        W1=Upper( "%Sub(1,1,"%1")" )
        -- выделим прочие символы и сделаем их строчными
        W2=Lower( "%Sub(2,99,"%1")" )
        -- сформируем слово и запишем его в главную область
        M.W="%W1%%W2"

   Можно записать процедуру и короче, в одну строку:

     M.W="%Upper( "%Sub(1,1,"%1")" )%Lower( "%Sub(2,99,"%1")" )"

   Результат работы процедуры сохраняется в переменной W,  которую
можно использовать после вызова. Приставка "M." перед именем пере-
менной W  означает,  что значение W заносится не в локальную,  а в
главную область окружения,  и ее можно  использовать  по окончании
процедуры (в BAT-файле).

   Одна и та же процедура может, разумеется,  использоваться в не-
скольких пакетах ДОС или процедурах MacroBat.



                      2. М а к р о я з ы к.
                      ---------------------

   В  этой  главе описываются операторы макроязыка (кроме диалого-
вых, выделенных в отдельную главу). В процедуре MacroBat допустимы
все операторы,  а в пакете ДОС (BAT-файле) - только оператор прис-
ваивания и средства диалога.

   Текст любого оператора может быть набран заглавными  или строч-
ными буквами.  Исключение: текстовые константы в кавычках,  внутри
которых заглавные и строчные буквы различаются.

   Синтаксис записи достаточно свободный.  Слова языка  отделяются
одно от другого пробелами.  Элементы различных списков  (например,
аргументы функций) разделяются запятыми и/или пробелами.

   Оператор не может  занимать  несколько  строк  файла  процедуры
(исключение - условный оператор). В одной строке разрешается запи-
сывать несколько операторов, разделенных  символами ";"  (точка  с
запятой). Пустые строки файла процедуры игнорируются.

   Среди операторов процедуры могут произвольно располагаться ком-
ментарии - строки, начинающиеся с двух черточек. Комментарии могут
быть и в конце строки, но тогда они должны отделяться от предшест-
вующих операторов точками с запятой. Примеры комментариев:

        -- начало цикла перебора устройств
        endif;  -- конец главной ветви

   З а м е ч а н и я.
   1. Числовые константы могут иметь  знак минус;  максимально до-
пустимое число: 2**32 (около двух миллиардов).

   2. Текстовые строки заключаются в кавычки.  Если внутри тексто-
вой строки находится кавычка, ее следует удвоить, например:

        Книга = "Э.Т.А.Гофман ""Записки кота Мурра"""

   При  подстановке значения MacroBat проверяет количество кавычек
слева (от начала выражения до места подстановки); если оно нечетно
(подстановка внутри текстовой строки),  то кавычки, содержащиеся в
значении, удваиваются.

   Максимальная длина текстовой строки: 250 символов.

   3. В  случае  синтаксической  ошибки   в  операторе  макроязыка
MacroBat прекращает работу. Формируется код завершения 2.

   Возможны также сообщения системы MacroBat:

     EndIf or EndDo statement missing
        Причина: не закрыт условный оператор или оператор цикла

     Local environment area overflow
        Причина: слишком много места  занимают  локальные перемен-
        ные.  Рекомендации:

          - укоротите их имена и, по возможности, значения;
          - удаляйте переменные, когда они больше не нужны
            (присвоив им пустое значение);
          - используйте рекурсивный вызов MacroBat;
          - разделите процедуру MacroBat на несколько процедур.

     Macro statement syntax error
        Причина: ошибка в синтаксисе макроязыка

     MacroBat builtin function: syntax error
        Причина: ошибка в аргументе встроенной функции

     MacroBat: incorrect DOS version
        Причина: используется ДОС старой редакции (ранее 3.30)

     MacroBat: invalid option ignored
        Причина: неверный режим в команде запуска MacroBat

     MacroBat: not found file <имя>
        Причина: не найдена указанная MB-программа

     MacroBat: not found macro-function <имя>
        Причина: в оглавлении MacroBat нет указанной функции

     Macrostatement: <текст оператора>
        Эта строка дополняет другие сообщения об ошибках

     Master environment area overflow
        Причина: слишком много места занимают  глобальные перемен-
        ные. Рекомендации:

          - перенесите их в локальную область окружения;
          - удаляйте переменные, когда они больше не нужны
            (присвоив им пустое значение);
          - укоротите их имена и, по возможности, значения;
          - укажите в CONFIG.SYS большую длину области и запускай-
            те пакет не через Norton Commander.

     No memory for program <имя>
        Причина: нехватает памяти  для загрузки  указанного  файла
                 (программы или функции)

     Not found label
        Не найдена метка, указанная в операторе перехода



                      2.1. Макропеременные.
                      ---------------------

   Как известно,  перед исполнением операторов пакета ДОС происхо-
дит макрогенерация: подстановка значений макропеременных.

   Эти макропеременные делятся на две категории: параметры запуска
(%1... %9) и Set-переменные, значения  которых  хранятся  в специ-
альной области, называемой областью окружения.

   Уже говорилось, что емкость области окружения ДОС невелика. По-
этому MacroBat предусматривает дополнительную  область  окружения,
которую,  однако,  можно  использовать  только   внутри   процедур
MacroBat. Рекомендуем хранить в области ДОС (главной области окру-
жения) небольшое количество переменных с короткими  именами, кото-
рые используются в пакете ДОС.  Все рабочие  переменные  и сложные
действия  с  ними,  вероятно,  разумнее  описать   как   процедуру
MacroBat.

   Описывать  макропеременные  не  нужно.  Простая макропеременная
создается автоматически,  как только в тексте пакета или процедуры
встречается ее имя (в левой части оператора присваивания).  Пустые
значения не хранятся, поэтому присваивание пустого значения удаля-
ет  переменную  из области окружения.  Этим можно пользоваться для
экономии места в области (ненужные переменные лучше удалять).

   Имена могут состоять из латинских букв,  цифр и знака подчерки-
вания.  В  процедурах допускаются и русские буквы.  Другие символы
употреблять не следует. Заглавные и строчные буквы не различаются.
Длина имени не ограничена, но MacroBat принимает во внимание толь-
ко первые 12 символов имени.  Поэтому первые 12 символов всех имен
должны различаться между собой.

   Значения переменных - произвольные тексты  длиной до 250 симво-
лов каждый.

   З а м е ч а н и я.
   1. При подстановке значений простых переменных внутри процедуры
MacroBat  поиск их производится сначала в локальной области.  Если
там  переменная с нужным именем отсутствует,  поиск продолжается в
главной области окружения. Если же и там переменная не найдена, ее
значение считается пустым.

   2. Поскольку синтаксический анализ строки происходит после всех
макроподстановок,  генерировать можно все что угодно.  Исключением
являются следующие конструкции, которые генерировать нельзя:

        - разделительные точки с запятой;
        - непарные кавычки.

   Кроме того,  некоторые ключевые слова можно генерировать только
с помощью простых (не вычисляемых) параметров, см. выше.



                   2.2. Оператор присваивания.
                   ---------------------------

   Назначение оператора присваивания: определить значение одной из
макропеременных. Значение хранится в одной из  областей окружения.
Если оператор присваивания был встроен в команду запуска MacroBat,
то используется  главная  область окружения  (текущего  командного
процессора).  Если же оператор находится в процедуре MacroBat,  то
по умолчанию значение заносится в локальную область окружения.

   Поскольку, однако, по окончании работы процедуры  все  значения
из локальной области пропадают, они не могут быть  использованы  в
пакете ДОС.  Поэтому некоторые процедурные значения можно объявить
как хранимые в главной области окружения;  для этого перед их име-
нем надо указать приставку "M." . См. выше в качестве примера про-
цедуру CAPITALZ.

   Допускается пустое значение, которое изображается так:  "" .

   Перед присваиванием незначащие пробелы в конце значения  удаля-
ются. Значение, состоящее из одних пробелов, считается пустым.

   Есть несколько разновидностей оператора присваивания.


          2.1.1. Присваивание явно заданного значения.
          --------------------------------------------

   Синтаксис:

        переменная = "текст"

   Указанной переменной  присваивается текстовая константа,  кото-
рая, впрочем, может содержать подстановки макропеременных.

   Примеры:
       Firm = "MMM"
       Concat="%Name /%Opt1 /%Opt2"
       M.W="%Upper( "%Sub(1,1,"%1")" )%Lower( "%Sub(2,99,"%1")" )"
       Null=""


          2.1.2. Присваивание арифметического выражения.
          ----------------------------------------------

   Этот оператор выполняет  целочисленные  вычисления  по заданной
формуле. Синтаксис у него обычный:

       переменная = арифметическое_выражение

   В арифметическом выражении  должны быть  один или более операн-
дов, соединенные знаками операций:

     + (сложение)          - (вычитание)             * (умножение)
     / (деление нацело)    # (получение остатка от деления нацело)

   Заданные действия выполняются слева направо, с учетом приорите-
тов операций. Например, 2+3*4*7 равно 86. Для  группировки операн-
дов можно использовать круглые скобки.

   Результат вычисления выражения редактируется  (незначащие  нули
слева не хранятся). Максимальное допустимое значение: около 2 мил-
лиардов. Промежуточные результаты могут иметь знак,  но  результат
должен быть положителен.

   Примеры:

      L=14
      k = %k + 1        (прибавить 1 к значению переменной k)
      REM=%REM # 10     (получить последнюю цифру переменной REM)
      M.fi=2 * %K + 1   (значение заносится в главную область)
      Q = 17 * (( %k + 1 ) / 2 )

   ВНИМАНИЕ: слева от знака присваивания признак подстановки (про-
цент) не нужен, а справа, наоборот, для переменных необходим.


              2.1.3. Присваивание значения функции.
              -------------------------------------

   В результате выполнения этого  оператора  указанная  переменная
получает значение, сформированное вызванной функцией. Синтаксис:

   (А) Простая функция:

       переменная=функция(/директивы/,аргументы)

   (Б) Функция из комплекта:

       переменная=комплект(функция /директивы/,аргументы)

   К о м п л е к т   ф у н к ц и й,  с точки зрения MacroBat,  ни-
чем не отличается от простой  функции.  Единственная  причина  для
создания комплекта - желание уменьшить число мелких функций. Реко-
мендуется объединять в комплекты тематически связанные функции.

   Функция может быть встроенной  (полный список таковых  приведен
ниже)  или  внешней,  т.е. оформленной  в виде отдельной программы
(COM- или EXE-файла).

   Внешняя функция может динамически вызываться:

   - из текущего оглавления;
   - если  ее  там нет,   то из того же оглавления,  где находится
MacroBat;
   - если и там ее нет,  поиск ведется в оглавлениях, определенных
переменной ДОС с именем PATH.

   Число внешних функций не ограничено.

   И м е н а   ф у н к ц и й   подчиняются тем же правилам,  что и
имена переменных, но длина их - до 8 символов. Имя внешней функции
совпадает  с именем  соответствующего  файла.  Расширение (COM или
EXE) MacroBat определит сам,  но можно указать его и в явном виде,
например:

        Признак = CLIPFUN.EXE (ZARPL.DBF)

   А р г у м е н т ы   ф у н к ц и и - это текстовая строка произ-
вольного вида,  длина ее в пакетах ДОС ограничена стандартами ДОС.
Перед аргументом может быть поле  директив,  заключенное  в  косые
черточки: '/' и отделенное от последующего текста запятой или про-
белом.

   Рекомендуется придерживаться подобного формата  и  для  функций
пользователя.

   Если функция не имеет аргументов, скобки можно опускать.

   Д и р е к т и в ы  не обязательны и указываются при необходимо-
сти. Они зависят от вида вызываемой функции  и  задают специальные
режимы ее выполнения. Поле директив состоит из подполей, разделен-
ных косыми черточками.

   Примеры вызова простых функций:

      Len=StrPos(".","%1")
      D = CURDIR()
      c=getch(/u/n/,"Введите код формы: ")

   Пример вызова функций из комплекта DOS:

      Дата = DOS ( GetDate d.m.y )



                     2.3. Условный оператор.
                     -----------------------

   Условный оператор позволяет принимать решение внутри процедуры,
т.е. выполнять ту или иную ветку, в зависимости от условия.
   Синтаксис:

        IF условие THEN
           ветка_да
        ELSE
           ветка_нет
        ENDIF

   В первой строке стоит  условие;  если  оно  верно,  выполняется
<ветка_да>, иначе -  <ветка_нет>.  Последняя  может  отсутствовать
(вместе с ключевым словом ELSE).  Слово  THEN  служит  целям чита-
бельности текста и также может быть опущено.

   Виды условий:

   (A) Сравнение текстов:

         "текст" =  "текст"     (два текста равны)
         "текст" == "текст"     (то же самое)
         "текст" <  "текст"     (первый текст меньше)
         "текст" >  "текст"     (первый текст больше)

   Здесь сравниваются два текстовых операнда.

   (Б) Сравнение чисел:

         число =  число     (два числа равны)
         число == число     (то же самое)
         число <  число     (первое число меньше)
         число >  число     (первое число больше)

   (В) Проверка, имеются ли (необслуженные) нажатые клавиши:

        KEYPRESSED


   Кроме того, перед любым условием может стоять слово  NOT (нет).
Например,  IF NOT "%C" > "A"  означает  сравнение  на  "меньше или
равно".

   Примеры:

   (1)  if "%1" = "no"              (2)  IF NOT "%k" = "0" THEN
          echo "Отменяется"                k = %k - 1
          режим = 4                      ELSE
        endif                              k = 0; EndIf

   (3)  if Not "%char" < "А"
          if Not "%char" > "Я"      (4)  If KeyPressed then
             goto Буква                     goto Continue
          endif                          EndIf
        endif

   Внутри веток условного оператора  могут  быть  любые  операторы
макроязыка, в том числе другие условные операторы  (вложенность не
ограничена). Количество операторов в ветке также не ограничено.

   З а м е ч а н и я.

   1. Текстовое сравнение отличается от числового,  даже если опе-
ранды содержат числовые значения. Например, "2" больше, чем "19".

   2. Ключевые слова ELSE и ENDIF могут занимать  отдельную строку
файла процедуры, но могут также записываться в одной строке с ВЕТ-
КОЙ-ДА или ВЕТКОЙ-НЕТ (см. выше пример).  В  последнем случае  они
должны  отделяться от предыдущих операторов точкой с запятой.  До-
пускаются также запись текста ВЕТКИ-ДА  в одной строке  с условием
(точку с запятой между ними можно не ставить)  и даже запись всего
условного оператора в одной строке. Примеры:

        IF %k=0 then goto LoopEnd; endif
        IF %k=0 goto LoopEnd; else exit; endif



                     2.4. Метки и переходы.
                     ----------------------

   Любой оператор процедуры может быть помечен, например:

        Следующий_диск:
            нд = %нд + 1

   Метка занимает отдельную строку файла и состоит  из  имени,  за
которым следует двоеточие. Имя метки может состоять из тех же сим-
волов, что и имя переменной.  Все имена меток  в процедуре  должны
быть различными.  Имя метки не может  генерироваться  в результате
макроподстановки.

   Метки используются в операторе перехода:

        GOTO метка

   Этот оператор, как всегда, означает переход к исполнению опера-
тора, перед которым стоит указанная метка.

   Пример цикла,  выясняющего,  есть  ли  на  компьютере  RAM-диск
(электронный диск):

          -- Выясним конечный код диска
          Dmax=DOS(Check LD)
          k = 1
          -- цикл по всем дисководам
        Loop:
          D=Sub(%k,1,"ABCDEFGHIJKLMNOPQRSTUVWXYZ")
          -- выясним тип очередного диска
          Тип=DOS(Check LD=%D)
          if "%Тип" == "R"
            goto Есть_RAM_диск;  endif
          if NOT "%D" == "%Dmax"
            goto Loop;  endif

        Нет_RAM_диска:
          ....................
          goto Finish;

        Есть_RAM_диск:
          ....................



                  2.5. Запуск внешних программ.
                  -----------------------------

   Программы (EXE- и COM-файлы) запускаются так же, как  в пакетах
ДОС:

        имя_программы  аргументы

   Имя_программы может иметь расширение (EXE или  COM);  если  оно
опущено, MacroBat ищет сначала COM-файл, и если таковой не найден,
то EXE-файл. Перед именем программы могут быть префиксы устройства
и/или пути.

   Поиск программы происходит следующим образом.

   (A) Если программа была ранее загружена (командой LOAD), то вы-
полняется ее экземпляр в оперативной памяти.

   (B) Если путь к программе указан явно, то MacroBat ищет програ-
мму только в этом оглавлении.

   (C) Если путь не задан, MacroBat просматривает текущее оглавле-
ние (если задан префикс устройства,  то имеется в виду текущее ог-
лавление именно для этого устройства), затем оглавление, где нахо-
дится MacroBat, и если программа не обнаружена, то просматриваются
оглавления, определенных переменной ДОС с именем PATH.

   Примеры:

        c:\sys\norton\DS NE c:\ /s
        AidsTest /f/q %1%:
        %COMSPEC /C Format a:

   Последний пример показывает, как запускать  из  процедур произ-
вольные команды ДОС (например, BAT-файлы).

   З а м е ч а н и я.

   1. Если имя программы или путь к ней  включают один из нижепри-
веденных специальных символов:

        пробел , / % ; [ ] = ( ) " < >

то Вы должны взять первый операнд в кавычки. Пример:

        "(PREF)" /B

   Аргумент,  который содержит пробелы,  запятые или точки с запя-
той,  также  должен быть в кавычках.  Он предоставляется вызванной
программе вместе с кавычками (в отличие от функции, при вызове ко-
торой кавычки у аргумента удаляются).

   2. Можно рекурсивно вызвать MacroBat  для выполнения одной про-
цедуры внутри другой.

   3. Код завершения последней вызванной программы запоминается и
присваивается специальной макропеременной с именем _ERLEV.
   Пример проверки кода завершения:

        TASM %Name
        if %_ErLev = 0  tlink %Name,%Name;  endif

   4. Все  макрофункции  MacroBat можно вызывать  и как программы,
если возвращаемое значение нас не интересует. Пример:

        FILE ( Delete %temp )



             2.6. EXIT - завершение работы MacroBat.
             ---------------------------------------

   Синтаксис:

        EXIT код_завершения

   Оператор  EXIT прекращает работу процедуры.  Он может использо-
ваться, например, в случае обнаружения ошибки, для обхода ненужных
веток процедуры или для устранения лишних переходов.

   Код завершения, равный нулю, можно не указывать.


            2.7. LOAD - закрепить программу в памяти.
            -----------------------------------------

   Синтаксис:

        LOAD программы

   Оператор  LOAD  считывает  указанные  программные файлы (только
COM-файлы,  EXE  запрещены)  и закрепляет их в оперативной памяти.
Размер свободной памяти при этом сокращается,  но зато последующие
вызовы этих программ или функций выполнятся гораздо быстрее.

   Каждая  программа указывается именем своего файла (без расшире-
ния).  Можно  вызывать  программы  из любого доступного оглавления
(см. параграф о запуске внешних программ), но указывать путь перед
именем нельзя.

   Попытка повторного закрепления уже закрепленной программы игно-
рируется.

   Закрепленные программы  будут  удалены из памяти  по завершении
работы MacroBat.

   ВНИМАНИЕ: не всякую программу можно закреплять оператором LOAD;
см. список ограничений в главе "Интерфейс пользователя".

   Пример оператора:

        LOAD DOS, FILE

   В примере закрепляются комплекты DOS.COM и FILE.COM.


                           2.8. Циклы.
                           -----------

   MacroBat предоставляет пользователю простые, но мощные средства
организации произвольных циклов.

   Цикл имеет следующую структуру:

        DO оператор_присваивания
           операторы (тело цикла)
        ENDDO

   Обычно в первой строке присваивается значение функции. Несколь-
ко типовых функций для организации циклов  описаны в следующем па-
раграфе. Пользователь может составить свои функции - например, для
цикла по базе данных.

   ВНИМАНИЕ:  все  функции  управления  циклом  (кроме  встроенной
FNEXT)  автоматически закрепляются в памяти  в момент начала цикла
(операцию LOAD выполняет MacroBat).  Поэтому они могут быть только
COM-файлами.

   Операторы, составляющие тело цикла, выполняются до тех пор, по-
ка не произойдет одно из двух событий:

     (1) управляющая функция сообщит MacroBat о конце работы (спе-
         циальным кодом, см. главу об интерфейсе пользователя);
     (2) в теле цикла выполнится оператор BREAK.

   В  обоих случаях цикл прекращается,  а процедура продолжается с
оператора, следующего за ENDDO.

   Тело  цикла  может  состоять из произвольных операторов,  в том
числе других операторов цикла (вложенность - до семи уровней).

   Пример:  процедура  для  компиляции  всех  помеченных на панели
Norton Commander программных файлов.

          do S = FILE( NC m )
            if "%Ext(%s)" = "ASM";   -- Ассемблер?
              tasm %s;    endif
            if "%Ext(%s)" = "C";     -- Си?
              bcc -c %s;  endif
          enddo

   Иногда нужно прекратить текущий оборот цикла и перейти к следу-
ющему.  Это можно сделать переходом на метку, стоящую перед ENDDO,
но есть более простой и структурный способ - оператор:

        CYCLE

   Вне цикла операторы ENDDO, BREAK и CYCLE игнорируются.

   Оператор присваивания в первой строке может отсутствовать; цикл
тогда должен быть прекращен одним из операторов BREAK.

   Пример итеративного цикла:

        k=0
        Do
          k = %k + 1
          If %k > 10 Then Break;  EndIf
          Echo "%k   %(%k * %k)"
        EndDo

   Этот цикл выводит таблицу квадратов чисел от 1 до 10.

   З а м е ч а н и я.

   1.  Ключевые  слова  DO  и ENDDO (как IF и ENDIF) могут записы-
ваться в одной строке с другими операторами, отделяясь от них точ-
ками с запятой.

   2.  Операторы  перехода в теле цикла допускаются,  но не должны
выводить за пределы этого цикла! Не рекомендуется также переходить
извне цикла на метку внутри его.




               3. С р е д с т в а   д и а л о г а.
               -----------------------------------

   В этой главе описываются операторы вывода на экран  и генерации
звука. Ввод с клавиатуры осуществляют стандартные функции GetStr и
GetCh, описанные здесь же.

   Для удобства проектирования экранов  Вы можете использовать лю-
бой  редактор  ANSI-картинок:  ANSIPaint,  TheDraw,  USA (Ultimate
Sysop ANSIeditor) и др. После создания требуемого экрана запустите
программу-конвертор в формат MacroBat (ANSI2MB), и получится гото-
вая программа на макроязыке. Наличие драйвера ANSI.SYS при этом не
обязательно.


             3.1.  ECHO - вывод сообщения на экран.
             --------------------------------------

   Формат:

        ECHO "текст_сообщения"

   Текст выводится с текущей позиции курсора, затем курсор перехо-
дит на новую строку. Сообщение может быть опущено, тогда выводится
пустая строка.

   Оператор ECHO,  в отличие от оператора PUT,  не меняет  текущие
атрибуты цвета в выводимой строке экрана.


             3.2.  COLOR - установка текущих цветов.
             ---------------------------------------

   Оператор COLOR  устанавливает цветовые атрибуты,  которые позже
учитываются операторами вывода на экран (кроме ECHO).  Если в опе-
раторе вывода цвет не задан явно, используется цвет из COLOR.

   Оператор имеет смысл только в процедурах MacroBat,  при  вызове
из BAT-файла ДОС он не вызывает никаких последствий.
   Формат оператора:

        COLOR  цвет_текста  ON  цвет фона

   Каждый цвет указывается одним из английских слов:

    BLACK (черный)     CYAN    (голубой)      BROWN  (коричневый)
    BLUE  (синий)      RED     (красный)      WHITE  (белый)
    GREEN (зеленый)    MAGENTA (сиреневый)    YELLOW (желтый)

   Кроме  того,  перед  названием  цвета текста может стоять слово
BRIGHT  (яркий)  или  BLINK (мерцающий).  Желтый цвет всегда яркий
(BRIGHT излишне). Для краткости слово BRIGHT можно заменять плюсом
в конце цвета, например:  WHITE+ вместо BRIGHT WHITE.

   Если конструкция  ON цвет_фона  не задана,  сохраняется текущий
цвет фона;  аналогично можно опускать цвет_текста (но слово ON пе-
ред цветом фона надо оставить).

   Примеры оператора:

      Color bright red on black             COLOR GREEN
      Color cyan+ on blue                   color ON white



                   3.3.  CLS - очистка экрана.
                   ---------------------------

   Форматы:

                CLS                 (закраска текущим цветом фона)
                CLS цвета           (закраска указанным цветом)

   Курсор устанавливается в первую  колонку  первой  строки.  Если
указаны цвета  (см. оператор COLOR),  они принимаются как текущие.
Другими словами, следующие операторы эквивалентны:

        CLS цвета
   и
        COLOR цвета;  CLS

   Пример оператора:         CLS on black        (закраска черным)
   П р е д о с т е р е ж е н и е:  этот оператор  вовсе не эквива-
лентен  оператору  CLS black.  Закраска идет  цветом фона,  а цвет
текста,  если он указан, просто становится текущим (в самом опера-
торе CLS цвет текста не используется).

   Если после работы предыдущей программы  экран остался  в графи-
ческом режиме,  оператор CLS  устанавливает текстовый режим 3  (80
колонок).


            3.4.  CURSOR - определение формы курсора.
            -----------------------------------------

   Форматы:

        CURSOR OFF              (убрать курсор)
        CURSOR начальная_линия, конечная_линия

   Курсор состоит из восьми линий,  нумеруемых сверху вниз от нуля
до 7. Примеры:

        Cursor 7,7      (тонкий курсор внизу)
        Cursor 0,7      (толстый курсор)
        Cursor 0,0      (тонкий курсор вверху)



             3.5.  BOX - вывод прямоугольной плитки.
             ---------------------------------------

   Оператор BOX выводит на экран цветной  прямоугольник  (плитку),
на фоне которого можно красиво разместить тексты  оператором  PUT.
После вывода курсор устанавливается в левый верхний угол плитки.
   Формат:

        BOX высота, ширина  атрибуты

   Высота - число строк в плитке, ширина - число колонок.  Эти па-
раметры должны быть первыми после слова BOX;  остальные  параметры
не обязательны, и порядок их произволен.

   Формат необязательных параметров:

AT строка, колонка  указывает положение левого верхнего угла плит-
                    ки на экране;  нумерация строк и колонок начи-
                    нается с единицы.  Если AT не задано, MacroBat
                    разместит плитку в центре экрана, исходя из ее
                    высоты и ширины и учитывая текущее число строк
                    на экране (25, 43 или 50).
                       Номер строки может быть относительным, т.е.
                    задан относительно текущей строки. Примеры:

                        box  20,40  at +2,1
                        box  7,12   at -1,1
                        box  14,21  at +0,1    (в той же строке)

цвет_рамки ON цвет_плитки
                      Это главный атрибут цвета, определяющий цве-
                    та  плитки  (и  рамки,  если они не заданы от-
                    дельно). Обозначения цветов приведены в описа-
                    нии оператора COLOR.
                      Если атрибут не задан,  используются текущие
                    цвета  (заданные  в последнем  операторе COLOR
                    или CLS).
                      Если  цвет плитки опущен  (вместе с ключевым
                    словом ON), берется текущий цвет фона.
                      Цвета рамки можно задать  отдельно  (см. ни-
                    же), это удобно, если цвет фона рамки  не сов-
                    падает с цветом плитки.
                      ВНИМАНИЕ:  перед  цветом  плитки обязательно
                    должно стоять слово ON, даже если рамка вообще
                    не выводится.

SINGLE(цвет_рамки ON цвет_фона_рамки)
                      Вывести рамку одинарной линией.
DOUBLE(цвет_рамки ON цвет_фона_рамки)
                      Вывести рамку двойной линией.
                      Атрибуты цветов рамки можно опускать (вместе
                    со скобками), тогда берутся цвета, указанные в
                    главном атрибуте,  а если их там нет,  берутся
                    текущие цвета (из последнего COLOR или CLS).
                      Если ни SINGLE, ни DOUBLE не указаны, плитка
                    выводится без обрамления.

FILL "заполнитель"    Указать   нестандартный  заполнитель  плитки
                    (стандартный заполнитель  -  пробел,  т.е. об-
                    ласть экрана, занятая плиткой, чистится).

NOFILL                Прозрачная плитка - область  экрана, занятая
                    плиткой,  перекрашивается,  но  сохраняет свое
                    прежнее содержимое.  Этот режим удобен, напри-
                    мер, для вывода тени.

   Примеры:

        BOX 25,80  single bright white on blue
        Box 20,40  At 2,7 yellow on black
        Box 10 66  Magenta DOUBLE(Cyan+ on Blue)
        Box 15 44  single ON cyan FILL "▒"
        Box 14,19  at -1 -2  NoFill On Black



      3.6.  PUT - вывод текста в произвольное место экрана.
      -----------------------------------------------------

   Оператор  PUT  выводит  на экран  одну или несколько  текстовых
строк заданных цветов. Курсор после вывода устанавливается в пози-
цию, следующую за последним выведенным символом.
   Формат:

        PUT  атрибуты "текст"  ...

   Все параметры оператора не обязательны, но что-то надо задать.
   Допустимые атрибуты:

строка,колонка  указывает, с какого  места  экрана  начнется вывод
                текста (по умолчанию - с текущего  положения). Ну-
                мерация строк и колонок начинается с единицы.
                   Можно не указывать номер колонки, если он такой
                же,  как при выводе предыдущего текста (в этом или
                предшествующем операторе PUT).
                   Номера строки и/или колонки  могут быть относи-
                тельными,  т.е. заданными в виде смещения по отно-
                шению к текущему положению.
                   Примеры:

                  put +2,1    (через строку, колонка 1)
                  put -1,-1   (предыдущая строка и колонка)
                  put +0,+12  (та же строка, колонка+12)
                  put +1      (следующая строка, с той же колонки)

цвет            Формат атрибута:    цвет_текста ON цвет_фона

                О кодах цветов см. выше оператор COLOR. По умолча-
                нию  используются  цвета,  заданные ранее в COLOR.
                Можно задать оба цвета (текст и  фон)  или  только
                один из них (любой).

   Если ни одного текста не задано, оператор PUT просто устанавли-
вает курсор в указанную позицию.  Это удобно делать, например, пе-
ред операцией ввода, чтобы установить курсор в начало поля ввода.

   ВНИМАНИЕ:  порядок атрибутов произволен, но все они должны сто-
ять ПЕРЕД соответствующим текстом.

   Примеры вывода:

        PUT 24 30 BLINK RED "В Ы   О Ш И Б Л И С Ь!"
        Put +2,10 bright magenta on white "ПРОВЕРЬТЕ ВЕДОМОСТЬ"
        Put white "Система " red "НОРМЫ" " рада работать с Вами!"
        Put +4    "Таблица"  5,16 blue "налогов"



              3.7.  GETCH - функция ввода символа.
              ------------------------------------

   Эта функция вводит текстовый символ с клавиатуры.
   Обращение:

        переменная = GETCH ( /директивы/, "подсказка" )

   После ввода курсор обычно переводится на следующую строку экра-
на (если не задана директива /N).

   Д и р е к т и в ы,  если надо,  содержат один или несколько ко-
дов, разделенных символом "/" (косая черта):

        C - перед вводом очистить очередь нажатых клавиш (рекомен-
            дуется при вводе особо важных данных)

        L - преобразование результата в строчный регистр

        U - преобразование результата в заглавный регистр

        N - не высвечивать введенного символа  на экране  и вообще
            не сдвигать курсора

   П о д с к а з к у  можно не задавать. Текст подсказки выводится
на экран перед вводом.

   Результатом функции является:

        - введенный символ,  если нажата обычная клавиша  (имеющая
          ASCII-код), кроме ENTER и ESC;

        - строка "ENTER", если нажата клавиша ENTER;
        - строка "ESC", если нажата клавиша ESC;
        - строка "TAB", если нажата клавиша табуляции;
        - строка "BS", если нажата клавиша BackSpace;

        - прекращение  работы  MacroBat,   если  нажато  сочетание
          Ctrl-C;

        - строка  "#номер",  если  нажата  функциональная  клавиша
          (F1-F12), стрелка, INS, DEL или сочетания Ctrl/Alt/Shift
          с некоторыми клавишами.  Здесь <номер> - расширенный код
          клавиши (см. Приложение 2).

                 Примеры:

            D = GetCh
            Код=GETCH(/u/,"Нажмите Г (годовой) или М (месячный)")
            w = getch ( /C/L/N/, "Delete file (y/n)?" )



              3.8.  GETSTR - функция ввода текста.
              ------------------------------------

   Функция  GETSTR содержит мощные и удобные средства ввода с кла-
виатуры произвольных текстов (до 250 символов).
   Обращение:

        переменная = GETSTR ( атрибуты )

   Атрибуты описывают поле и процесс ввода;  все они необязательны
и могут указываться в произвольном порядке.

   Список допустимых атрибутов:

длина_поля_ввода    число; по умолчанию поле заканчивается в конце
                    текущей  строки.  MacroBat  блокирует  попытки
                    ввести символы за концом поля.  Поле ввода мо-
                    жет занимать несколько строк.

"подсказка"         произвольный текст,  выводимый с текущей пози-
                    ции  (или с позиции, указанной в атрибуте AT).
                    Поле ввода начинается за ним.  Подсказка выво-
                    дится  тем же цветом,  что и поле ввода;  если
                    нужен  другой  цвет,  выводите  подсказку не в
                    GETSTR, а оператором PUT.

AT строка,колонка   начало поля ввода  (или  поля подсказки,  если
                    оно  задано).  По  умолчанию - текущая позиция
                    курсора.  Нумерация строк и колонок начинается
                    с  единицы.
                      Как и при выводе  (см. оператор PUT), номера
                    строки  и/или колонки могут быть относительны-
                    ми,  т.е. заданными в виде смещения по отноше-
                    нию к текущему положению:  +n  или  -n .

цвет                цвет поля ввода; см. оператор COLOR.  По умол-
                    чанию - текущий цвет.

INIT  "текст"       начальное значение  поля ввода.   По умолчанию
                    поле пусто. Это значение принимается в качест-
                    ве результата ввода, если вы не ввели ни одно-
                    го символа (например, сразу нажали на ENTER).

   После ввода курсор переходит на новую строку.

   Ввод строки завершается одним из двух способов:

        - нажатием клавиши ENTER, ESC или TAB;
        - нажатием любой клавиши или сочетания клавиш, перечислен-
          ных в Приложении 2 (т.е. клавиш, не имеющих ASCII-кода).
          Исключение - клавиши редактирования (см. ниже).

   Сочетание Ctrl-C завершает работу MacroBat.

   Код клавиши, завершившей ввод, формируется в специальной систе-
мной макропеременной с именем _EXKEY.  В первом из вышеперечислен-
ных случаев это одна из строк:

        "ENTER", "ESC" или "TAB",

а во втором - строка "#номер",  где <номер> - расширенный код кла-
виши (см. Приложение 2).

   Для редактирования строки ввода можно использовать клавиши:

        Налево, направо  (передвижение курсора)
        BackSpace        (стереть предыдущий символ);
        Del              (стереть текущий символ)
        Ctrl-Home        (очистить все поле ввода)
        Ins              (переключить режим замена/вставка)

   Пояснение:  сначала  в поле  ввода действует режим "замена",  и
введенные символы замещают прежнее содержимое текущей позиции. По-
сле нажатия клавиши Ins действует режим "вставка",  в котором вве-
денный  символ  вставляется в текущее место,  отодвигая хвост поля
ввода направо. Новое нажатие клавиши Ins снова переводит нас в ре-
жим замены и т.д.

   Примеры:

        D=GetStr
        Пароль = GetStr( 6 "Введите пароль:" )
        Год = GETSTR( 4 at 4,1 init "%DOS(GetDate y)")
        Q = getstr( "Вводите>" at +2,1 black on cyan )



                 3.9.  SOUND - генерация звука.
                 ------------------------------

   Оператор SOUND воспроизводит звук заданной частоты и длительно-
сти. Синтаксис его:

        SOUND                   (писк)
        SOUND операнды          (произвольный звук)

   Операнды разделяются запятыми или пробелами.
   Допустимые операнды:

Частота,длительность   Это описание отдельного звука.  Частота из-
                       меряется в герцах, длительность - в импуль-
                       сах таймера.  За одну секунду  генерируется
                       примерно  18,2 импульсов таймера.  Эти опе-
                       ранды обязательны, остальные - нет.

Dn                     Интервал  между  звуками.  (n)  - продолжи-
                       тельность интервала в импульсах таймера.

K                      Если  указан  этот операнд,  нажатие  любой
                       клавиши прекращает генерацию звука и завер-
                       шает текущий оператор.

   Количество звуков в операторе ограничено его длиной (255 симво-
лов).

   Примеры:

        SOUND 523 18
                       (нота "до" первой октавы, звучит 1 секунду)

        Sound 350,9  D6  350,2  440,4  D4  524 4  D4
        Sound 700,2  660,2  584,2  660,2   700,9  D4
                       (начало известной мелодии)


          3.10. DELAY - ожидание временного интервала.
          --------------------------------------------

   Для создания рекламных роликов полезен оператор:

        DELAY  длина_интервала

   Он переводит ЭВМ в состояние ожидания,  пока не истечет указан-
ный интервал времени. Длина интервала задается в импульсах таймера
За одну секунду генерируется примерно 18.2 импульсов таймера.



             Приложение 1. Таблица музыкальных нот.
             --------------------------------------

   Приведем список частот (в герцах) для оператора SOUND.

        Контр- Боль-  Ма-
 Нота   октава  шая   лая   1-я    2-я    3-я
----------------------------------------------
 До       65    131   262   523   1040   2093
 До#      69    139   277   554   1103   2217
 Ре       73    147   294   587   1176   2349
 Ре#      78    156   311   622   1241   2489
 Ми       82    165   330   659   1311   2637
 Фа       87    175   349   698   1391   2794
 Фа#      92    185   370   740   1488   2960
 Соль     98    196   392   784   1568   3136
 Соль#   104    208   415   831   1662   3322
 Ля      110    220   440   880   1760   3520
 Ля#     116    233   466   932   1866   3729
 Си      123    248   494   988   1973   3951


       Приложение 2. Некоторые расширенные клавишные коды.
       ---------------------------------------------------

             (*) - только для расширенной клавиатуры

  Десяти-   Кла-        Десяти-   Кла-          Десяти-   Кла-
 чный код   виша       чный код   виша         чный код   виша

   59        F1         129      Alt-0          104      Alt-F1
   60        F2         120      Alt-1          105      Alt-F2
   61        F3         121      Alt-2          106      Alt-F3
   62        F4         122      Alt-3          107      Alt-F4
   63        F5         123      Alt-4          108      Alt-F5
   64        F6         124      Alt-5          109      Alt-F6
   65        F7         125      Alt-6          110      Alt-F7
   66        F8         126      Alt-7          111      Alt-F8
   67        F9         127      Alt-8          112      Alt-F9
   68        F10        128      Alt-9          113      Alt-F10
* 133        F11                              * 139      Alt-F11
* 134        F12                              * 140      Alt-F12

   71       Home         39      Alt-;        *  26      Alt-[
   72       Up          131      Alt-=        *  27      Alt-]
   73       PgUp         40      Alt-'        *  52      Alt-.
   75       Left         51      Alt-,        * 165      Alt-Tab
   77       Right       130      Alt--        *  14      Alt-BS
   79       End          43      Alt-\        *   1      Alt-ESC
   80       Down         53      Alt-/        *  28      Alt-Enter
   81       PgDn         41      Alt-`        *  55      Alt-Grey*
   82       Ins                               *  74      Alt-Grey-
   83       Del                               *  78      Alt-Grey+

   30      Alt-A         94      Ctrl-F1         84      Shift-F1
   48      Alt-B         95      Ctrl-F2         85      Shift-F2
   46      Alt-C         96      Ctrl-F3         86      Shift-F3
   32      Alt-D         97      Ctrl-F4         87      Shift-F4
   18      Alt-E         98      Ctrl-F5         88      Shift-F5
   33      Alt-F         99      Ctrl-F6         89      Shift-F6
   34      Alt-G        100      Ctrl-F7         90      Shift-F7
   35      Alt-H        101      Ctrl-F8         91      Shift-F8
   23      Alt-I        102      Ctrl-F9         92      Shift-F9
   36      Alt-J        103      Ctrl-F10        93      Shift-F10
   37      Alt-K      * 137      Ctrl-F11     * 135      Shift-F11
   38      Alt-L      * 138      Ctrl-F12     * 136      Shift-F12
   50      Alt-M
   49      Alt-N      * 148      Ctrl-Tab        15      Shift-Tab
   24      Alt-O
   25      Alt-P
   16      Alt-Q
   19      Alt-R
   31      Alt-S
   20      Alt-T
   22      Alt-U
   47      Alt-V
   17      Alt-W
   45      Alt-X
   21      Alt-Y
   44      Alt-Z


                Приложение 3. Протокол изменений.
                ---------------------------------

MB 1.6  (июнь 1992).
        Установлено,  что  цвет  в операторе  PUT нельзя указывать
          после текста.
        Подставлять можно значения  не  только  переменных,  но  и
          функций, а также арифметические выражения.
        Макрофункция может быть EXE-модулем.
        Условие вида IF KEYPRESSED...
        Снято запрещение генерировать ключевые слова и метки.
        Оператор SOUND: операнды Dn и K.
        Функция GETCH: добавлены директива  /C  (ввод  с  очисткой
          очереди клавиш), а также возврат кодов "TAB" и "BS".
        Функция CURDIR: коды "s" и "f" заменены на "p" и "a".
        Расширено обслуживание Norton Commander: можно получить не
          только имя текущего файла, но и полную  его спецификацию
          (с кодом диска или без), причем для обеих панелей.

MB 1.7  (июль 1992)
        Режим запуска  /L:файл_протокола.
        Допускается числовое сравнение в условном операторе.
        Введена макропеременная для кода завершения:  %_ERLEV.
          Упразднено сравнение вида  if errorlevel...
        Оператор BOX: можно задать отдельный цвет для рамки;  реа-
          лизованы  вывод  прозрачной плитки  и  произвольный сим-
          вол-заполнитель.
        Оператор PUT: номер колонки можно не указывать.
        Оператор EXIT: можно указать код завершения.
        Функция Check LD в комплекте  DOS  правильно  обрабатывает
          виртуальные диски,  созданные драйверами  (Disk Manager,
          Stacker, SpeedStore, системы телеобработки и др.). Доба-
          вился код диска "V".
        Там же добавлены функции Check Mouse и Check Windows.
        Комплект FILE: функция FNAME - редактирование спецификации
          файла по заданному формату (устройство-путь-имя).
        В поставку включен DPERIOD.C: пример функции пользователя.

MB 1.8  (август 1992)
        Новые операторы:
          DO...ENDDO (цикл), BREAK, CYCLE, LOAD файл.
        Разработаны стандартные функции для циклов.
        Функция Check LD в комплекте DOS:  добавлен код фиктивного
          диска "D"  (когда одному дискетнику назначены два кода).
          Вариант  LDE=диск  возвращает расширенную информацию для
          дискетников (емкость и код физического дисковода).
        При подстановке одной строки символов внутрь другой кавыч-
          ки, содержащиеся в значении, удваиваются.

MB 2.0  (сентябрь 1992)
        Документация разделена на два файла: MB.DOC и MBLIB.DOC.
        Макрофункции  могут  быть  теперь  не  только в оглавлении
          MacroBat (поиск их происходит так же, как и программ).
        Управляющая функция цикла автоматически закрепляется в па-
          мяти.
        Значительно усовершенствована функция ввода (GETSTR); поя-
          вилась новая системная макропеременная: _EXKEY.
        Комплект DOS:
          новая функция - Ready принтер;
          функция MemFree  при вызове из процедуры  возвращает ис-
            тинную величину свободной памяти.
        Комплект FILE:
          вывод текстовых строк - Open, Close, PutLine;
          FATTR - получить атрибуты файла;
          NC M - цикл по отмеченным на панели NC 3.0 файлам.
        При подстановке одной строки символов внутрь другой симво-
          лы процента, содержащиеся в значении, удваиваются. Реку-
          рсивная подстановка пока запрещена.
