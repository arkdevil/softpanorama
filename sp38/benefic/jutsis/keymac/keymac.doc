 
   ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒

                             KeyMac -
      резидентная программа для создания клавишных макросов
                          в ЛЮБОЙ среде
      
                             Пролог.
     Многие текстовые редакторы и другие среды (MultiEdit,  Лекси-
кон, Turbo  Debugger 2.0 и т.п.)  позволяют запоминать  последова-
тельность нажатий  клавиш и вызывать ее одним нажатием клавиши или
"аккорда".   Увы,   такие   редакторы,  как  встроенный  в  Norton
Commander, QuickC, Sidekick и  т.д.,  этого  не  могут.  Программа
KeyMac и сделана для того, чтобы "забивать" макропоследовательнос-
ти  под  клавиши  и перепрограммировать клавиатуру. С помощью этой
программы можно, в том числе, как отключить (или  перепрограммиро-
вать)  сочетания Ctrl-Alt-Del или Ctrl-Break (но тогда вы лишитесь
возможности "теплой" перезагрузки или прерывания программы), так и
ввести  такие "экзотические" комбинации, как LeftShift-RightShift-
Space или Ctrl-Alt-Ins. Макросы вводятся  через  командную  строку
или  из  текстового  файла  в специальном формате, а также в любой
среде при нажатии специальной клавиши "Определить макро" (так ска-
зать, on-line).
    Достоинства:
    - В  отличие от подобных возможностей драйвера ANSI.SYS KeyMac
оперирует более широким набором клавиш, а главное - ANSI действует
только на программы, работающие через DOS, а Norton Commander, как
и Quick C,  уже не реагируют на переназначенные клавиши. KeyMac же
работает на уровне BIOS.
    - KeyMac различает не только левый и  правый  Shift'ы,   но  и
Ctrl'ы и Alt'ы (на 101/102-клавишной клавиатуре).
    - Различает "серые" и "белые" стрелки, Ins, Home и т.д.,  пра-
вильно  обрабатывает SysRq и Pause с любыми сочетаниями Ctrl, Alt,
Shift.
    - Для  84-клавишной  клавиатуры может имитировать нажатие кла-
виш, которых там нет (F11 и F12, например), в том случае, конечно,
если это  "интересует" работающую в это момент прикладную програм-
му.
    - Нормально снимается программой RELEASE не только  "целиком",
но и "по частям" при повторной загрузке. (В  результате  ошибки  в
Release  для  этого  пришлось  принять  специальные меры. См. файл
RE-BUG.)
    - Не так много места занимает в памяти (ок.  3К без самих мак-
росов).
    Недостатки:
    - В  этой  версии  нет возможности удалять KeyMac из памяти из
командной строки (пока с этим неплохо справляется RELEASE, которым
многие пользуются).
    - Принципиально невозможно перепрограммировать "горячую клави-
шу" вызова некоторых (если не всех) резидентных  pop-up  программ,
таких как Sidekick и т.д.
    - И другие мелочи, которые я еще, наверно, не выявил.

    
                   Действие I. Макроопределения.

    KeyMac загружает из файла или прямо из командной строки макро-
определения ("пакетный режим"). Они имеют вид:
    
<левая_часть>  <правая_часть>
    
    Пример:
<csP> pkunzip <cEnter><Enter>
    означает, что при нажатии комбинации клавиш
"(любой)Ctrl-(любой)Shift-P" имитируется набор на клавиатуре слова
"pkunzip "   с  пробелом  на  конце,   затем   нажатие   сочетания
<Ctrl-Enter>, что    соответствует  в  NC  копированию имени файла
из-под курсора в командную строку, и клавиши Enter.
    В  начале  строки может быть один или несколько пробелов и/или
табуляций. Между левой и правой частями должен быть  хотя бы  один
пробел (табуляция).
    Левая часть  описывает  "горячую клавишу" вызова макро и имеет
вид:  <[префикс]клавиша> . Префикс обозначает нажатие клавиш Ctrl,
Shift, Alt (далее shift-клавиши) и состоит из букв c,s,a (соответ-
ственно Ctrl, Shift, Alt) и/или сочетаний lc, rc, ls, rs,  la,  ra
(l  - left - левый, r - right - правый). "Клавиша" - это или любой
ASCII-символ с кодом от 32 (пробел) до 126 (~), или название  спе-
циальной  клавиши:  Tab, Esc, Ins и т.д. Список всех этих названий
выводится с помощью опции /?? (можно перенаправить вывод в  файл).
Пояснение  к списку см. в разделе "Параметры". Названия можно усе-
кать до трех первых букв (или больше), кроме тех,  что  начинаются
на "Grey": их можно усекать до семи букв (три, не считая "Grey").
    В префиксе буквы могут сочетаться любым образом. Например,
<laraZ>  означает "левый Alt-правый Alt-Z", <rslcGreyUp> - "правый
Shift-левый  Ctrl-серая стрелка вверх" (на 101-клавишной клавиату-
ре). Если нет букв l и r, то это значит "любой": <caZ> сработает и
при нажатии левых Ctrl-Alt, и правого Ctrl-левого Alt и т.д.
    Правая часть описывает макропоследовательность, которую KeyMac
будет  порождать при нажатии "горячей клавиши". Она состоит из це-
почки, в которую входят:
    1) ASCII-символы: любые, кроме ASCII 0 (NUL), ASCII 13  (возв-
рат  каретки CR) и ASCII 10 (перевод строки LF), а также специаль-
ного символа '<'. (Символ '>' может входить.)
    2) Названия клавиш и "аккордов", взятые в скобки <>. Это могут
быть: символьные клавиши, специальные клавиши  и  их  сочетания  с
shift-клавишами аналогично левой части, только буква (c,a,s) может
быть  только  одна, и буквы l и r не допускаются. Чтобы включить в
макро специальный символ '<', его надо взять в скобки: <<>.
    Примечание: символы вне скобок трактуются как не имеющие скан-
кода, т.е. как бы набранные на цифровой клавиатуре с помощью  кла-
виши Alt. Я не встречал случая, чтоб это было существенно, но если
почему-либо  они не будут восприниматься, то следует каждый из них
взять в скобки <>.
    3)  Специальные  клавишные  команды,  такие как "Начать запись
макро", "Отключить KeyMac" и др. Подробнее см. в  разделе  "Коман-
ды".
    У всего,   что находится в угловых скобках <>,  кроме символов
(не букв),  обозначающих соответствующую символьную клавишу,  про-
писные и строчные буквы НЕ РАЗЛИЧАЮТСЯ.
    Особенности:
    -  Программа работает минуя буфер клавиатуры, т.е. "прозрачно"
по отношению к нему. Не знаю, достоинство ли это или недостаток.
    - На результат вызова макро не влияет текущее состояние перек-
лючателей CapsLock, NumLock, ScrollLock.
    - Код, соответствующий расширениям 101/102-клавишной клавиату-
ры ("серые"  стрелки и т.п.),  вырабатывается только тогда,  когда
прикладная программа запрашивает соответствующую функцию  прерыва-
ния BIOS INT 16 (т.е., если программа "хочет" получить такой код),
в противном случае вместо кодов "серых" клавиш вырабатываются коды
"белых". Это не касается лишь F11, F12 и их сочетаний.
    -  В  качестве  "горячей  клавиши"  можно использовать также и
shift-клавиши (указав Lt-левый, Rt-правый). При  этом,  если  есть
еще  и префикс, то клавиши из него должны нажиматься первыми. Нап-
ример, для комбинации <laRtAlt> надо, удерживая левый Alt,  нажать
правый,  а не наоборот (конечно, вы можете при этом ввести макро и
с сочетанием <raLfAlt>).
    -  Если  нажимается какая-либо клавиша, кроме shift-клавиш, то
программа считает, что эти клавиши немедленно  отпускаются  (т.е.,
обнуляет  "shift-статус").  Это сделано для редакторов с командами
типа WordStar (CtrlQ+клавиша, CtrlK+клавиша,...), таких как QuickC
или Sidekick. Таким образом, перед вызовом макро все клавиши долж-
ны быть отпущены (кроме макросов без shift-клавиш).
    -  При  повторном определении макро под той же клавишей старое
стирается.
    - При отсутствии правой части ("пустое макро") нажатие  "горя-
чей клавиши" (левой части) просто ничего не вырабатывает, и данная
комбинация "забивается" (в т.ч. Ctrl-Alt-Del и т.п.).  Чтобы  вер-
нуть  комбинации ее первоначальное значение, просто укажите правую
часть, совпадающую с левой (или вообще отключите KeyMac - см.ниже).
    - Из-за возможности сокращений в двух случаях могут быть  нак-
ладки: <caP>,  т.е. Ctrl-Alt-P, воспримется как <CapsLock>, сокра-
щенный до трех букв. То же для Shift-Ctrl-R - <scR> -<ScrollLock>.
В этих случаях используйте соответственно <acP> и <csR>.
    - Максимальная длина макроса - 256 нажатий клавиш.


                  Действие II. Командная строка.

    В командную строку можно помещать в любом порядке:
    - макросы,
    - имена входных файлов,
    - параметры (ключи), которые начинаются с символа '/' или '-'.
    Все это разделяется пробелами.
    В  командной строке и в файлах все ключи и макросы обрабатыва-
ются по очереди.
    При  запуске  без  параметров  программа   обрабатывает   файл
KEYMAC.KMC  в  текущей  директории, а если его не находит - выдает
справку.
    Макро в командной строке имеет вид, описанный выше. Оно должно
быть  заключено в кавычки "". Обычно удобнее все макросы загружать
из файла.
    Входной файл может содержать все то же, что и командная  стро-
ка.  Каждое  макро  должно  находиться  в отдельной строке. Пустые
строки игнорируются. Макросы в файле  НЕ  заключаются  в  кавычки.
Каждый  ключ тоже должен быть в отдельной строке. Как частный слу-
чай ключа, может стоять комментарий (см.  ниже).  Можно  также  из
файла вызвать другой файл, в этом случае обработка происходит так,
как  если  бы текст второго файла был вставлен на месте строки его
вызова. Рекомендуется использовать в этом случае ключ /f, чтобы не
путать вызов файла с макро (программа пытается  обработать  строку
как макро, если находит в ней пробел).
    Максимальная длина строки во входном файле - 2047 символов.
    Если в имени файла не указано расширение, то по умолчанию  да-
ется  .KMC. Если не указан путь (path) и диск, то файл ищется сна-
чала в текущей директории, потом в списке директорий, указанном  в
переменной  окружения KMCPATH, если таковая имеется, потом в своей
собственной, откуда запускался KeyMac.
    
                    Параметры командной строки:

/? или ? или любой недействительный параметр -
             Выводит справку о командной строке
/??          Выводит список всех принятых названий клавиш и команд.
          Пояснение к списку:
              <Cntr> - center - "пятерка" на доп. циф. клавиатуре;
              <Bs> - backspace - забой ("пробел назад");
              <Rt> - right, <Lf> - left, <Dn> - down, <Up> - up -
              - стрелки соответственно вправо, влево, вниз и вверх;
/fфайл       (File) Обрабатывает файл, как описано выше.
/l           (List) Выводит список загруженных на данный момент
                     макросов.
/m[n1][,n2]  (Memory) Резервирует место в памяти для помещения туда
                 макросов в будущем.
                 При каждом запуске, если требуется определить но-
                 вые макро, KeyMac оставляет резидентный кусочек с
                 этими макроопределениями. При этом к тому же тра-
                 тится лишняя память на PSP и окружение. Если же в
                 памяти  для  макросов уже было выделено место, то
                 резидентный кусок не создается, а макросы помеща-
                 ются в это место.
                     Выделяется  место для n1 макросов, в сумме на
                 n2  нажатий клавиш. (Если в памяти останется мес-
                 то, т.е. не все n2 ячеек задействованы, то  можно
                 будет  определить  и больше, чем n1 макросов.) По
                 умолчанию n1 = 2, n2 = 10*n1.
/off         Выключает KeyMac (можно временно)
/on          Включает его обратно
/b           Отключает некоторые звуковые сигналы, которые могут
                 показаться назойливыми
/            (С пробелом  или табуляцией.) Игнорируется.
             В командной строке бесполезен, а в файле за ним может
                 следовать комментарий.
                 
                 
                 Действие III. Клавишные команды.

    Наличие клавишных  команд  существенно  расширяет  возможности
KeyMac. Если в тексте  макропоследовательности  встречается  такая
команда,  то  она выполняется немедленно, не дожидаясь, пока прик-
ладная программа пожелает считать символ  с  клавиатуры  (но  лишь
после  того, как она считает предыдущий символ или выполнится пре-
дыдущая команда).
    Имена команд, кроме тех, для которых есть одноименные клавиши,
нельзя, конечно, использовать как ключи ("горячие клавиши") вызова
макросов в левой части (ввиду отсутствия таковых на клавиатуре).
    
    Команды:
    
    <NumLock>, <CapsLock>, <ScrollLock> -
делают те же переключения, что соответствующие клавиши.  Внимание,
пользователи  XT и PC: индикаторы ("лампочки") на Вашей клавиатуре
программа переключать не может (это возможно на AT), поэтому лучше
эти команды на PC и XT не использовать, т.к. состояние индикаторов
не будет соответствовать действительности.
    Выполнение этих команд никак не влияет на восприятие клавиш  в
макроопределениях:       при      указании      последовательности
"asd<CapsLock>fghj" Вы увидите набранную строку "asdfghj" и  вклю-
ченный режим CapsLock (или выключенный, если он был включен).
    
    <Break>, <Pause> и <PrtSc>(PrintScreen) -
делают то же, что соответствующие клавиши. Можно  также  использо-
вать  в  качестве тех же команд сочетания <cBreak>, <cScrollLock>,
<cNumLock>, <sPrtSc>,  <sGrey*>,  <sSysRq>.  Внимание!  <PrtSc>  и
<Break>  нельзя  использовать в левой части макроопределения, т.к.
на 84-клавишной клавиатуре "PrtSc" и "Break"  написаны  соответст-
венно  на клавишах <Grey*> и <ScrollLock>, а на 101-клавишной кла-
виатуре - на <SysRq> и <Pause>, так что используйте названия  этих
клавиш.
    Особенность: при вторичном нажатии клавиши,  определенной  как
<Pause>, режим паузы отменяется,  в отличие от "настоящей" клавиши
Pause.
     
    <Beep> -
соответствует своему названию (подача звукового сигнала). Это вве-
дено на всякий случай.
     
    <Toggle> (переключатель) -
временно  отключает  KeyMac (все делается так, как будто программа
не была запущена), а при повторном нажатии той же клавиши или ком-
бинации - снова включает. При этом подается звуковой сигнал:  нис-
ходящий - выкл., восходящий - вкл. (Опция /b отключает сигнал.)

    <Record>  (записывать) - команда немедленной диалоговой записи
макро в "прозрачном" режиме, т.е. нажатые при записи  клавиши  тут
же передаются прикладной программе. Для записи макро необходимо:
     1. Запустить KeyMac заранее с параметром /m (см.) для  резер-
вирования памяти.
     2.  Для  записи  нажать определенную Вами клавишу Record. При
этом подается звуковой сигнал (опция /b его отключает). Однотонный
сигнал говорит об отсутствии места в памяти.
     3. Нажать клавишу, под которой Вы хотите запомнить макро. По-
дается опять звуковой сигнал.
     4. Далее нажимать клавиши. Они  будут  запоминаться,  переда-
ваться программе, в которой Вы находитесь, и сопровождаться корот-
ким звуком (не отключается опцией /b).
     5. По окончании нажать опять ту же клавишу (комбинацию)
<Record>. Подается опять сигнал, и теперь при нажатии определенной
новой клавиши будет воспроизводиться эта последовательность.
     Если сигнал раздастся раньше, то это означает "исчерпано мес-
то в памяти, запись прекращена".
     Ограничения:
     Таким путем нельзя  определить  макросы  под  shift-клавишами
(такие как, напр., <laRtCtrl>), т.к. при выполнении вышеописанного
пункта 3 программа,  учитывая нажатие shift-клавиш,  ждет  нажатия
"настоящей" клавиши.
     Нельзя также включить в записываемое макро ни одну из команд,
описанных в этом разделе.
     Во время  записи  остальной KeyMac отключается,  и макросы не
срабатывают.
                                     
          
          Действие IV. Переменные окружения (environment).

    Введены две переменные, которые с помощью DOS-команды SET пе-
редают информацию KeyMac'у "за кулисами".
    
    1. SET KEYMAC=параметры
    Вводит параметры командной строки по умолчанию. Обрабатывается
при КАЖДОМ запуске программы в первую очередь (до командной  стро-
ки).  Ограничение: здесь нельзя определить макро. Но можно указать
файл.
    Пример:    set keymac=/b /l
               set keymac=auto.kmc
    
    2. SET KMCPATH=путь
    Указывает путь поиска файлов .kmc, чтобы не держать их в общей
куче. О порядке поиска см. раздел 2. Синтаксис пути аналогичен пе-
ременной DOS "path".


            Действие V. Сигналы и сообщения об ошибках.

    Однотонный гудок при нажатии любой клавиши:
было вызвано макро, и оно еще не все выполнилось (прикладная прог-
рамма чего-то  ждет).  Это связано с тем,  что программа работает,
минуя буфер,  и происходит,  когда система ждет настоящего нажатия
клавиши, несмотря на то, что уже вызвано макро. В таком случае ре-
комендуется нажать любую клавишу,  имеющую код,  (напр.,  символь-
ную), чтобы система "проснулась".

    Сообщения:
                                       
    1. Syntax error
Синтаксическая ошибка в тексте макро. В том числе: неверно набран-
ное название клавиши; пробел внутри названия клавиши  или  сочета-
ния; попытка поставить в правой части более одного префикса к кла-
више или префикс, различающий левые и правые shift-клавиши (содер-
жащий 'l' или 'r').
    2. Invalid key combination
В  правой  части макроопределения оказалось недопустимое сочетание
клавиш, не имеющее своего кода (напр., <sEsc> - Shift-Escape)  или
сочетание shift-клавиши с командой.
    3. Cannot find file
Указанный файл не найден.
    
    Предупреждение: возможные ошибочные ситуации (проверка ограни-
чений и т.п.) в этой версии не всегда вылавливаются, но таких слу-
чаев я еще не встречал.

    
                  Эпилог. Техническая информация.
     
    Программа перехватывает 9-е и 16-е прерывания. Написана на  Си
с ассемблерными вставками и специальными мерами для снижения объе-
ма резидентной части программы.

      
      Юцис Михаил (Сухарович)
      г.Черновцы, Респ.центр "Укрэкология"
      тел. 2-55-51 (д.)
           5-38-30 (сл.)
