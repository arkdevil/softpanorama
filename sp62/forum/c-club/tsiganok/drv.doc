──────────────────────────────────────────────────────────────────── 

          ┌────────────────────────────────────────────╖
          │ * Tsyganok Service * 1993 * Тесты MS DOS * ║
          ╘════════════════════════════════════════════╝

──────────────────────────────────────────────────────────────────── 

           * Tsyganok Service * 1993 * Drive Defender *

     При  написании  различных  сервисных  программ  и  в ряде других
 случаев,  довольно  часто  требуется  определить  набор   логических
 дисков доступных в данный момент пользователю. Существует  множество
 известных алгоритмов,  тем не  менее предлагаю  вашему вниманию  еще
 один.
     Начиная с версии 3.0 в MS DOS  ( и в IBM DOS тоже ),  существует
 так называемый  "ARRAY OF  CURRENT DIRECTORY  STRUCTURES" (  "МАССИВ
 СТРУКТУР  ТЕКУЩИХ  КАТАЛОГОВ"  в  котором  DOS  хранит  информацию о
 текущем  состоянии  логических  устройств.  На анализе информации из
 этой таблицы и основан данный метод.
     Размер  этой  таблицы  задается  параметром "LastDrive=" в файле
 "Config.sys".  Напомню,  что  по  умолчанию  он  равен  либо 5, либо
 количеству  физических  дисков  на  "винчестере"  (  что  больше  ).
 Получить   адресс   начала   этой    таблицы   можно   при    помощи
 недокументированной,  но  широко  известной  функции  52h прерывания
 21h. К сожалению, в  зависимости от версии системы,  меняются адреса
 указателей на начало таблицы. Более конкретно :
                 mov   ah,52h
                 int   21h
 теперь ES:BX указывает на так называемый "List of Lists". Далее в 
 зависимости от версии системы :
     DOS 3.0        : byte  : es:[bx+1bh] - число LastDrive
                      dword : es:[bx+17h] - адрес массива
     DOS 3.1 и выше : byte  : es:[bx+21h] - число LastDrive
                      dword : es:[bx+16h] - адрес массива

     Каждый элемент массива имеет следующий формат :

 Offset    Size  Description
 00h       67    ASCIZ строка - текущий путь для данного устройства
 43h       2     Атрибуты устройства :
                 биты : 15 ( 8000h ) -- это сетевое устройство
                        14 ( 4000h ) -- это физическое устройство
                        если  не  установлен  не  один из этих битов,
                        устройство не доступно.
                        13 ( 2000h ) -- Этот диск подвергся  операции
                                        JOIN, и  сейчас логически  не
                                        виден.
                        12 ( 1000h  ) -- Это  SUBST - диск.  В начале
                                        хранится    его    физическое
                                        соответсвие.
 45h       4     Указатель  на  Drive  Parameter  Block  связанный  с
                 данным  устройством.  (  Здесь  не  разбирается  его
                 формат, смотри например [2] )
 Если установлен бит 14 :
 49h       2     начальный кластер текущей директории
                 0 - root, 0FFFFh - на устройстве не работали
 4bh       2     неизвестно обычно 0FFFFh
 4dh       2     неизвестно обычно 0FFFFh
 Если установлен бит 15 :
 49h       4     Указатель на структуру REDIRIFS или 0FFFFh:0FFFFh
 4dh       2     некоторые данные пользователя
                 ( Два последних поля определены не всегда, даже если 
                   выставлен бит 15 )
 В любом случае
 4fh       2     Количество невидимых символов в пути. Для 
                 физических дисков обычно 2.
 Для DOS 4.x и выше
 51h       1     неизвестно обычно 0FFh
 52h       4     Указатель на IFS для данного драйвера, или 0:0
 56h       2     неизвестно обычно 0FFFFh

     Программа DRV обрабатывает эту информацию и выдает на консоль 
 содержимое этой таблицы, а затем список текущих доступных 
 устройств.

                    Использованная литератрура

 1. Ralf Brown & Jim Kyle
    "PC Interrupts, a programmer's reference to BIOS, DOS, and 
    third-party calls". 
    /Addison - Wesley Publishing Company,Inc. - 1991

 2. А. В. Фролов, Г. В. Фролов
    "Операционная система MS - DOS"
    том 1 ( книги 1,2 ), серия "Библиотека системного программиста"
    /Москва, "Диалог - МИФИ" - 1991

 3. А. В. Фролов, Г. В. Фролов
    "Операционная система MS - DOS"
    том 1 ( книга 3 ), серия "Библиотека системного программиста"
    /Москва, "Диалог - МИФИ" - 1992

