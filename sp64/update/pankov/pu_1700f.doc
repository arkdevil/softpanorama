
                 Фоновое форматирование дискет.

    ┌─────────────────────────────────────────────────────┐
    │  P U _ 1 7 0 0 F . C O M   Beta V 2.29 от 19.04.94  │
    └─────────────────────────────────────────────────────┘

                  программист:    Панков Ю.И.
                 дата создания:    1993-1994 г.


     PU_1700F.COM - это русский аналог известного в нашей стране
драйвера ConFormat (версии 1.04 1989г,  никакой другой версии  я
просто не видел),  с расширенными, чем у последнего возможностя-
ми.
     PU_1700F резидентная утилита - драйвер,  позволяющая произ-
водить ФОНОВОЕ форматирование дискет всех форматов, которые под-
держивает драйвер  PU_1700.  Работает  совершенно  независимо от
последнего.
     Работа PU_1700F аналогична работе DOS-овской утилите PRINT,
имеющейся во всех версиях DOS, и позволяет сэкономить уйму Ваше-
го  времени  за счет совмещения процесса форматирования дискет с
процессом редактирования текстов,  архивирования файлов, оптими-
зации жесткого диска,  компиляции файлов, игрой в ваши самые лю-
бимые Вами игры и т.п..  Работая в т.н. ФОНОВОМ режиме, PU_1700F
абсолютно  прозрачен  для  основного  процесса  (отнимает у него
очень мало времени - менее 5%  - запустите утилиту типа SysInfo,
запустите процесс ФОНОВОГО форматирования и убедитесь в этом!).
   ┌───────────────────────────────────────────────────────┐
   │             ФОНОВОЕ - не означает медленное!          │
   │    PU_1700F поддерживает достаточно высокую скорость  │
   │         форматирования дискет в фоновом режиме!       │
   └───────────────────────────────────────────────────────┘
     И вот почему.  PU_1700F на самом деле организует  "многоза-
дачный"  режим  работы MS DOS,  где задача форматирования дискет
имеет наивысший приоритет и выполняется в реальном масштабе вре-
мени, а основной процесс выполняется в достаточно больших проме-
жутках между прерываниями (на  фоне  задачи  форматирования),  и
только  поэтому сам процесс форматирования получается достаточно
скоростным. Правильнее было бы сказать, что основной процесс вы-
полняется в фоновом режиме,  но тогда меня не все правильно пой-
мут. И еще одно важное замечание:  PU_1700F работает напрямую  с
контроллером НГМД i8272 и не использует для своих нужд BIOS!

  ┌────────────────────────────────────────────────────────┐
  │ Не выбрасывайте дискеты, у которых безнадежно запорчен │
  │                     0 трек!                            │
  └────────────────────────────────────────────────────────┘
     PU_1700F позволяет их безболезненно отформатировать на  лю-
бой поддерживаемый формат, а PU_1700 обеспечит работу с ними!

     PU_1700F резидентно занимает менее 8 kb оперативной памяти,
работает под управлением DOS 3.30 и выше,  может устанавливаться
на резидентное обслуживание из любого  BAT-файла  или  командной
строки.

     PU_1700F позволяет изготовлять дискеты всех форматов,  под-
держиваемых, драйвером PU_1700:
  ┌────────────┬──────────────────────┬───────────────────────┐
  │   Формат   │    Тип дисковода     │ Объем отформатирован- │
  │  носителя  │                      │ ной дискеты в байтах  │
  ├───────┬────┼────┬──────┬────┬─────┼───────────────────────┤
  │  C=   │ S= │360к│ 720к │1.2м│1.44м│   норма   - максимум  │
  │       │    │ 5" │  3"  │ 5" │ 3"  │                       │
  ├───────┼────┼────┼──────┼────┼─────┼───────────────────────┤
  │ 40-41 │  9 │ 1  │      │ 1  │     │   362.496 -   371.712 │
  │ 40-41 │ 10 │ 2  │      │ 2  │     │   398.848 -   409.086 │
  │ 80-83 │  9 │    │   1  │ 3  │  1  │   724.480 -   752.168 │
  │ 80-83 │ 10 │    │   2  │ 4  │  2  │   806.460 -   837.120 │
  │ 80-83 │ 15 │    │      │ 5  │     │ 1.212.928 - 1.259.008 │
  │ 80-83 │ 17 │    │      │ 6  │     │ 1.376.768 - 1.427.968 │
  │ 80-83 │ 18 │    │      │ 7  │  3  │ 1.457.664 - 1.512.960 │
  │ 80-83 │ 20 │    │      │    │  4  │ 1.620.480 - 1.681.920 │
  │ 80-83 │ 21 │    │      │    │  5  │ 1.702.400 - 1.765.888 │
  └───────┴────┼────┴──────┴──────────┼───────────────────────┘
               │ NN форматов PU_1700F │
               └──────────────────────┘

     PU_1700F допускает форматирование до  83  цилиндров.  Такую
дискету нетрудно отформатировать. Задание С=41 и С=81 безопасны.
Дополнительные (или инженерные) цилиндры 82 и 83 (41 для DD) мо-
гут  хуже  читаться  или вовсе отсутствовать на Вашем дисководе.
Последнее встречается крайне редко.  В любом случае при работе с
дополнительными  цилиндрами  Вы  должны внимательно слушать,  не
ударяется ли держатель головки дисковода об ограничитель, распо-
ложенный перед валом двигателя.  Замечу, что это возможно крайне
редко,  т.к. все современные дисководы допускают свободное пере-
мещение головки до 84 цилиндра. И даже если Вы ничего не услыша-
ли подозрительного,  проверьте отформатированную Вами дискету  с
дополнительными  цилиндрами какой-либо тестирующей утилитой,  на
предмет присутствия последних (Pctools и др.).  Объем отформати-
рованной дискеты  можно немного увеличить уменьшением ее систем-
ной области (см.  параметры /C7205=2,  /C7203=2 и  /D=nnn;  а-ля
PU_edpFD).



                   1. Установка PU_1700F.COM.
                  ────────────────────────────
     PU_1700F выполнен в виде COM-файла, который может быть опи-
сан в файле начальной автозагрузки AUTOEXEC.BAT пока в формате:

              PU_1700F [/параметр[ы]]        где:

/Fn=[PU_1700F.BIN] - файл BOOT образа дискеты.  Может быть заме-
           нен любым другим файлом.
    /v40 - обслуживать BIOS на уровне INT 40h.  По умолчанию об-
           служивается прерывание 13h BIOS. Данный параметр при-
           меним только для IBM совместимых PC (и только моделей
           выше XT), и позволяет свести на нет задержки вносимые
           драйвером в обслуживание жестких дисков.
    /u   - отключение драйвера c выгрузкой его из памяти.
    /ke  - сохранить блок среды (ENV).  Увеличивает  длину рези-
           дента.
    /h|? - вызов минимальной инструкции.
    /psp - сохранить (не использовать) префикс программного сег-
           мента - PSP. Увеличивает длину резидента на 256 байт.
    /i=Y - с индикацией процесса форматирования в левом  верхнем
           углу экрана (N текущего цилиндра и время форматирова-
           ния носителя). Увеличивает длину резидента на 64 бай-
           та.
     /Ns - без звуковой индикации.  И почему  она никому не нра-
           вится? Я ее столько раз переделывал!
   /X=nn - задает координату X верхнего верхнего левого угла окна
           меню форматирования (0 - 47). По умолчанию - 24.
   /Y=nn - задает координату Y верхнего верхнего левого угла окна
           меню форматирования (0 - 9). По умолчанию - 5.
   /sm=1 - 1 оптимальное расположение секторов при форматировании
           для увеличения производительности дисковода. По умол-
           чанию принимается  "/sm=1"  (более  подробно  об этом
           можно найти в в PU_1700.DOC).
   /sm=2 - 2 оптимальное расположение секторов при форматировании
           для увеличения производительности дисковода.
 /sm=off - отключение оптимизации расположения секторов при фор-
           матировании (можно =0).
/C7205=2 - для носителей в 5" форматов: 720 - 830 kb  определяет
           размер кластера  в 2 сектора.  Говорят,  что только с
           такими носителями работает ЕС1840, сам я этого (толь-
           ко) не проверял.
/C7203=2 - для носителей в 3" форматов: 720 - 830 kb  определяет
           размер кластера  в 2 сектора.
  /D=nnn - задает размер корневого каталога для всех форматов  в
           1 - 240 элементов. По умолчанию - 224. В одном секто-
           ре может быть размещено 16 элементов оглавления.
                                   ┐
  /A=360 - 360  KB, 5" (DD) ┌───┐  │
  /B=360 - 360  KB, 5" (DD) │ " │  │  Этими  параметрами
  /A=1.2 - 1.2  MB, 5" (HD) │ 5 │  │ нельзя переназначать
  /B=1.2 - 1.2  MB, 5" (HD) └───┘  │ типы установленных у
                                   │ Вас дисководов 3" на
  /A=720 - 720  KB, 3" (DD) ╔═══╗  │ 5" и наоборот!
  /B=720 - 720  KB, 3" (DD) ║ " ║  │
  /A=1.44- 1.44 MB, 3" (HD) ║ 3 ║  │
  /B=1.44- 1.44 MB, 3" (HD) ╚═══╝  │
                                   ┘
/BootA=nn - задает  номер  цилиндра  носителя,  установленного в
            дисковод A,  где надо расположить его системную  об-
            ласть (BOOT + FAT+ ROOT),  По умолчанию - 0 цилиндр.
            Пределы перемещения: 2 - 38 цилиндры.
/BootB=nn - задает  номер  цилиндра  носителя,  установленного в
            дисковод B,  где надо расположить его системную  об-
            ласть (BOOT + FAT+ ROOT),  По умолчанию - 0 цилиндр.
            Пределы перемещения: 2 - 38 цилиндры.
  /SRT=nn - интервал  шага головки (Step Rate Time) в милисекун-
            дах. Этот параметр задает минимальную задержку между
            двумя последовательными импульсами шага.  По умолча-
            нию выбирается из рабочей области  BIOS  (для  боль-
            шинства машин = 3).  Пределы задания: 1 - 13 мс. Па-
            раметром стоит воспользоваться,  если  Ваш  дисковод
            совсем  древней модели (увеличить),  или по каким-то
            другим причинам отказывается  форматировать  большие
            форматы дискет.
    /M=ML - задает конвеерный или непрерывный режим форматирова-
            ния дискет  (любезно  предложенный  мне  Мишей  Лав-
            реньтьевым),  при котором, после завершения формати-
            рования,  драйвер ожидает в течениии примерно 30 се-
            кунд в "фоновом" режиме смену дискеты для повторения
            процесса,  помаргивая при этом лампочкой дисковода -
            "ML ожидание". Если в течении вышеуказанного периода
            Вы не замените дискету в дисководе, драйвер перейдет
            в  режим  ожидания ключевого нажатия.  К сему же еще
            тройка параметров:
  /Tr=nnn - задает максимальное время "ML ожидания" смены  носи-
            теля в секундах (30 - 999).  По умолчанию - 30.  Без
            задания параметра "/m=ML" не имеет смысла.  Принуди-
            тельный вывод  драйвера  из "ML ожидания" можно осу-
            ществить "ключевым" нажатием или повторным  запуском
            драйвера с параметром /wML=E.
   /wML=E - задает принудительный вывод драйвера из  "ML  ожида-
            ния" - иногда бывает нужен,  если "ключевое" нажатие
            по каким-либо причинам заблокировано.
     /b=Y - с индикацией бордюром результата завершения процесса
            форматирования носителя во время замены  носителя  в
            дисководе. Без задания параметра "/m=ML" или "/F=.."
            не имеет смысла. Цвет свечения бордюра (зеленый, си-
            ний и красный) определят результат завершения опера-
            ции форматирования (без плохих треков,  имеются пло-
            хие треки и носитель не отформатирован соответствен-
            но). Работает во всех режимах видеоадаптера. Не име-
            ет смысла для монохромных дисплеев.
/F=Drv:N[:C] - прямой запуск  (предложен  мне  Безруковым  Н.Н.)
            непрерывного  режима фонового форматирования дискет,
            с заданием основных  параметров  формата  непосредс-
            твенно  из командной строки,  минуя меню.  А именно,
            сразу после запуска, драйвер переходит в вышеописан-
            ный ML режим форматирования носителей. Где:

              Drv - имя драйвера A или B.  Операнд обязателен.
              N   - число секторов в треке. Операнд обязателен.
              С   - число  форматируемых  цилиндров  (80-83). По
                    умолчанию 80.


     Драйвер пока может быть запушен только из  директории,  где
находится сам  вместе  с файлом BOOT-образа дискеты!  Драйвер не
допускает изменения его параметров повторным запуском, за исклю-
чением перезапуска с параметрами "/u" или "/wML=E".


               2. Фоновое форматирование дискет.
             ─────────────────────────────────────
     Может быть  осуществлено только после установки драйвера на
Вашей машине (см. выше):

     Одновременное нажатие трех нижеуказанных ключевых клавиш:
                         ┌────╖┌───╖   ┌───╖
                   левых │Ctrl║│Alt║ и │ P ║
                         ╘════╝╘═══╝   ╘═══╝
переводит Вас в меню форматирования дискет,  если Ваш видеоадап-
тер находится в т.н.  текстовом режиме,  где достаточно подробно
описан процесс запуска их фонового форматирования. Замечу, что:

     1. PU_1700F при каждом запуске автоматически распознает ти-
пы установленных дисководов гибких дисков.  В  противном  случае
драйверу можно помочь заданием параметров: "/A=" или "/B=".

     2. Если у Вас возникают странные сообщения об ошибках расп-
ределения памяти после запуска  некоторых  программ,  попробуйте
параметры /ke и /psp при запуске PU_1700F.

     3. Форматы до 81 цилиндров (/t:81) безопасны.  А вот надеж-
ную работу с количеством цилиндров большим 81 не гарантируют да-
же изготовители дискет.  Практика показывает, что 82 и 83 допол-
нительные (или инженерные) цилиндры (если они  есть)  можно  ис-
пользовать для временного хранения информации.

     4. Для  повышения  производительности  Ваших дисководов до
70%, PU_1700F пока безусловно форматирует дискеты с  оптимальным
расположением секторов на треке гибкого носителя. Это достаточно
подробно описано в PU_1700.DOC.

     5. PU_1700F реализует алгоритм TSR программ без PSP. Работу
с такими программами не поддерживают драйверы  типа  RELEASE  (и
масса  других программ,  считающих,  что 1001:1234,  1002:1224 и
1000:1244 - представляют различные абсолютные адреса) и  некото-
рые типы ВИРУСОВ!  Последние могут быть одной из причин "зависа-
ния" Вашей ПЭВМ при установке PU_1700F.  В таких случаях  попро-
буйте  параметр  "/psp"  при запуске (при этом резидентная часть
драйвера увеличится на 256 байт) - и если это поможет Вам,  то в
99  случаях  из 100 предыдущее "зависание" можно расценивать как
результат воздействия вируса!

     6. Будьте очень  внимательны  при  использовании  параметра
"/D=", т.к. MS DOS не всегда правильно понимает Ваши пожелания!

     7. Выгрузку драйвера из памяти можно осуществить,  набрав в
командной строке: PU_1700F /u . Выгрузка драйвера возможна толь-
ко в случае его неактивности. Никаких других ограничений на заг-
рузку и выгрузку драйвера пока нет.


     8. Параметры /m=ML, /Tr=nnn, /wML=E и /b=Y введены для под-
держки  т.н.  непрерывного процесса ФОНОВОГО форматирования дис-
кет.  /M=ML - задает режим (любезно предложенный мне Мишей  Лав-
реньтьевым) работы драйвера , при котором, после завершения фор-
матирования,  драйвер ожидает в течениии примерно /Tr=nnn секунд
(но не менее 30) в "фоновом" режиме смену дискеты для повторения
процесса,  помаргивая при этом лампочкой  дисковода  и  бордюром
(если задан параметр /B=Y). При этом цвет бордюра определяет ре-
зультат завершения операции форматирования:

     - зеленый - носитель отформатирован, плохих треков нет.
     - синий   - носитель отформатирован, есть плохие треки.
     - красный - носитель не отформатирован, повторите операцию.

         Если в  течении  вышеуказанного  периода Вы не замените
дискету в дисководе, драйвер перейдет в режим ожидания ключевого
нажатия.  Принудительно из "ML режима" драйвер может вывести од-
новременное нажатие трех нижеуказанных ключевых клавиш:

                         ┌────╖┌───╖   ┌───╖
                   левых │Ctrl║│Alt║ и │ P ║  или
                         ╘════╝╘═══╝   ╘═══╝

повторный запуск драйвера с параметром /wML=E.
     ML режим форматирования работает даже, если Ваш монитор ра-
ботает в графическом режиме.  Последнее  означает,  что  процесс
форматирования  дискет уже можно проводить на фоне практически с
любого прикладного пакета и даже игры!

     9. Параметр /F=Drv:N[:C] введен тоже для запуска  непрерыв-
ного  режима (предложен мне Безруковым Н.Н.) фонового форматиро-
вания дискет,  но с заданием основных параметров формата  непос-
редственно из командной строки, минуя меню. А именно, сразу пос-
ле запуска,  драйвер переходит в вышеописанный ML режим формати-
рования носителей. Где:

   Drv - имя драйвера A или B.   Операнд обязателен.
   N   - число секторов в треке. Операнд обязателен.
   С   - число форматируемых цилиндров (80-83). По умолчанию 80.


     Например: PU_1700F /F=A:10:83/i=y/b=y/v40/Tr=900/c7205=2

     Запускает непрерывный процесс форматирования носителей фор-
мата 830 KB (10:83) с индикацией  процесса  форматирования  и  ML
ожидания (/i=y/b=y/Tr=900)... .


    10. Если при форматировании дискеты выдается сообщение:

                   Форматирование A прервано
                    не форматируется 0 трек
                         Вашей дискеты!
                        ...............
     ответьте Y, для повторения форматирования (можно это проде-
лать несколько раз).  Если это не поможет, то Ваша дискета дейс-
твительно запорчена. Как известно, DOS не может использовать но-
сители с испорченным нулевым цилиндром.  "За бугром" такие  дис-
кетки, видимо, просто выбрасывают. В условиях нашей действитель-
ности нам такое, пока, не по карману. Поэтому попробуйте:
     Запустив PU_1700F с  параметром  "/BootA=nn"  или  "/BootB=
nn",  подобрать местоположение системной области дискеты (BOOT +
FAT + ROOT - по умолчанию располагается на 0 цилиндре),  при ко-
тором  она  будет  форматироваться  на нужный Вам формат.  После
удачного форматирования запишите значение перемещения  системной
области  носителя  на его этикетке!  Для работы с такой дискетой
в Вашей системе необходимо иметь драйвер PU_1700  с  аналогичним
параметром перемещения системной области (подробнее об этом мож-
но прочесть в PU_1700.DOC).
     Учтите, что PU_1700 и PU_1700F поддерживают раздельно  зна-
чения параметров  для  каждого из дисководов.  Вам все это может
покажется неудобным,  я и сам это прекрасно понимаю,  но не  все
сразу. Ну, а если уж "ну совсем неудобно", то пишите, звоните...





                          Изменения.
                         ────────────


     V 1.00 - 2.02 Технологические версии программы.

     V 2.03 - 2.29 Технологические версии программы,  имеющие
                   право на самостоятельное существование.




                Право распространения программы.
               ────────────────────────────────
     Эта далекая от совершенства  версия  драйвера  (создавалась
факультативно ровно год), выходит в "свет" лишь затем, чтобы об-
судить его дальнеейшее развитие на страницах Софтпанорамы.  Поэ-
тому от всех,  кому понравился этот драйвер,  через Софтпанораму
жду КОНСТРУКТИВНЫХ предложений по поводу того, каким бы им хоте-
лось его видеть. Каким бы они хотели видеть диалог с пользовате-
лем,  если видеомонитор работает в графическом режиме?  Нужна ли
фоновая индикация текущего состояния фонового процесса и в каком
виде. И т.д. и т.п.. Поэтому пока:
     PU_1700F.COM вместе с настоящей инструкцией может  свободно
распространяться ТОЛЬКО в некоммерческих целях, ТОЛЬКО БЕСПЛАТНО
и без всяких ограничений. Работайте на здоровье!




           Желаю успехов!            Панков Ю.И.    26.02.94 г.
         г. Сергиев Посад
             (Загорск)
        тел. (254)-400-71 (дом)






     Я заранее  благодарен  Вам  за  сообщения типа:  "Ваш с...й
драйвер не работает с программой или ...."


   P.S.
     Я с удовольствием  выпущу  коммерческую  версию  PU_1700  и
PU_1700F, если  найдется  меценат,  поддерживающий  эту работу и
взявший на себя труд редактирования и перевода  подобной  (а  не
этой) инструкции на английский язык.  Только не надо путать бед-
ного переводчика с меценатом!


   P.S.
     С другой стороны,  я ясно себе представляю,  что по крайней
мере в России,  таких людей пока нет и быть не может,  они могут
появиться не раньше, чем через 70 - 100 лет. И попробуйте меня в
этом переубедить!  Тогда я с удовольствием уберу эти строки. Мне
пока предлагают свои услуги только переводчики! А вообще-то, ФО-
НОВЫЙ копировщик дискет не помешал бы ....


