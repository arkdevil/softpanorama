                             EC1840A 1.03

			 Ю.Д.Красильников 1991



        EC1840A -  драйвер клавиатуры  и загрузчик  знакогенератора ПЭВМ
ЕС-1840/1841 с видеоадаптером CGA для работы в альтернативной  кодировке
ГОСТ.

	Альтернативная кодировка ГОСТ стала в настоящее время стандартом
де-факто.  Однако   достаточно  распространенные   ПЭВМ   отечественного
производства ЕС1840/1841  поддерживают основную  кодировку ГОСТ.  Точнее
говоря, ЕС1840 (по  крайней мере, ранние  модели) вообще не  загружает в
знакогенератор видеоадаптера  символы верхней  половины кодовой  таблицы
ASCII.

	Другой недостаток ЕС1840/1841 - малая оперативная память  (всего
512 Кбайт), что вынуждает расходовать ее экономно.

	Эти  соображения  стали   основными  при  разработке   программы
EC1840A.

	Программа  EC1840A  при   инициализации  осуществляет   загрузку
знакогенератора  видеоадаптера  CGA  EC1840/1841  (к   счастью,   данный
видеоадаптер  это  позволяет),  и  оставляет  резидентную часть, которая
осуществляет  преобразование  кодов  вводимых  с  клавиатуры символов из
основной  кодировки  ГОСТ  в  альтернативную.  Алгоритм перекодировки по
существу состоит в вычитании из  кода символа (для символов в  диапазоне
176-224) числа  48. При  этом коды,  вводимые с  помощью "Alt-ввода", не
изменяются.  Кроме  этого,  производится  обнуление  скэн-кода  в буфере
клавиатуры,  поскольку   иначе  возможны   нежелательные  эффекты    при
использовании  зарубежных  программ  (например,  Multi-Edit отказывается
понимать русскую букву  "р"). Если по  каким-либо соображениям не  нужно
обнулять скэн-коды - см.  ниже.

	Вследствие простоты  алгоритма собственно  обработчик прерывания
имеет длину менее 50 байт (sic!). Так как программа использует (в  целях
экономии памяти) "переползание"  в префикс программного  сегмента  (PSP)
и освобождение сегмента памяти  Environment, то занимаемая   резидентной
частью память очень мала (замеры  с помощью программы SYSINFO из  пакета
Norton Utilities 5.0  дали  размер памяти  176 байт  при загрузке только
драйвера клавиатуры и 1200 байт в случае, когда загружается также  шрифт
для графических режимов).

	Использование:

	   EC1840A  [/L] [/F:<filespec>] [/G] [/S] [/R] [/H]

	Ключи программы:

		/L - только загрузка знакогенератора (драйвер клавиатуры
		     не устанавливается);
		/F:<filespec> - загрузить шрифт из внешнего файла;
		/G - поддержка графических режимов;
		/S - не обнулять скэн-коды;
		/R - только установка резидентной части (шрифт в
		     знакогенератор не загружается);
		/H - выдать подсказку.


	Для выполнения программы требуется DOS версии 2.00 или выше.

	Если   программа   EC1840A    вызвана   без   параметров,    она
проверяет,  не  была   ли  она  установлена   ранее  (не  было   ли  уже
перехвачено ей же прерывание 09h). Если программа уже установлена,   она
выдает  сообщение  об  этом   и  завершает  работу.  В противном  случае
она  загружает   в  знакогенератор   встроенный    в  нее    шрифт   для
альтернативной  кодировки  ГОСТ  и  устанавливает резидентный обработчик
прерывания  09h,  осуществляющий  перекодировку  вводимых  с  клавиатуры
символов из основной кодировки в альтернативную.

	Если задан ключ  /G, то в  резидентную часть включаются  матрицы
знакогенератора  верхней  половины  кодовой  таблицы  и  устанавливается
вектор прерывания 1Fh. При  этом размер резидентной части  увеличивается
на  1   Кбайт.  Этот   ключ  следует   задавать,  если    предполагается
использование графических режимов CGA.

	Ключ /F:<filespec> позволяет загрузить шрифт из внешнего  файла.
Файл должен иметь  длину 2048 байт  и содержать матрицы  знакогенератора
8x8  в  стандартном  представлении.

	Ключ   /L   отменяет   проверку   установленности   программы  и
предписывает только  загрузить шрифт  в знакогенератор,  не устанавливая
резидентную часть программы (драйвер  клавиатуры и, возможно, шрифт  для
графических режимов). Если он задан, ключи /G, /S и /R задавать  нельзя.
Если программа уже запускалась ранее  с ключом /G, то повторные  запуски
ее с  ключом /L  загружают шрифт  для текстовых  режимов, но не изменяют
шрифт для графических режимов CGA.

	Если задан  ключ /S,  то скэн-коды  клавиатуры для  русских букв
не обнуляются.

	Ключ  /R  отменяет  загрузку   шрифта  в  знакогенератор,   т.е.
производится только установка  резидентной части программы  (обработчика
прерываний  клавиатуры  и,  возможно,  шрифта  для графических режимов).
Программу,  запущенную   с  этим   ключом,  возможно   использовать   на
отечественных  ПЭВМ  типа  "Нейрон",  если  на  них проведена аппаратная
русификация  видеоадаптера  путем  перепрограммирования ПЗУ, содержащего
шрифт. Если этот ключ задан, то не допускается задание ключа /L.

	Ключ  /H  выдает  на  экран  краткую инструкцию по использованию
программы. Никаких других  действий не выполняется.  Инструкция выдается
на   русском   и   английском   языках,   чтобы   при  использовании  не
альтернативной  кодировки  можно  было  бы  прочитать хотя бы английский
текст. (По этой же причине сообщения программы, которые могут  появиться
до загрузки знакогенератора, также  даны на двух языках.)  Все остальные
ключи будут игнорированы.



                      Замечания по использованию

	Рекомендуется   включить   вызов   программы   EC1840A   в  файл
AUTOEXEC.BAT. Если не  предполагается использование программ,  выводящих
на экран русские символы в графических режимах CGA, то не нужно задавать
никаких ключей. Если такие программы применяются, то следует задать ключ
/G, пожертвовав при этом килобайтом оперативной памяти.

	Если внутренний шрифт программы кажется недостаточно эстетичным,
то   можно   заменить   его,   воспользовавшись   ключом   /F.  Возможно
использование шрифтов из других  драйверов (автор был восхищен  шрифтами
43a.fnt, 43b.fnt,  43c.fnt и 43d.fnt из  комплекта русификаторов де  Мон
де  Рик,   опубликованного  в  "Софтпанораме"  N  16). При использовании
шрифтов 8x8 из пакета PU   нужно удалить  из   шрифта  первые  8   байт,
содержащих  служебную   информацию (например, в  Norton Commander  нужно
нажать следующую последовательность клавиш: F4 - 8 раз Del - F2).

	Ключ  /L  можно  использовать   для  смены  шрифтов  "на   ходу"
(совместно с  ключом /F).  Для этого,  естественно, нужно  иметь внешние
шрифтовые файлы.

	Ключ  /R  следует  использовать  в  тех случаях, когда требуется
установить драйвер клавиатуры,  не загружая знакогенератор.  При задании
этот ключа,  как отмечалось  выше, программу  можно использовать  на тех
отечественных  ПЭВМ,  клавиатура  которых  выдает  коды  русских  букв в
основной  кодировке   ГОСТ,  а   шрифт  в   ПЗУ  перепрограммирован   на
альтернативную кодировку.

	Выгрузить программу EC1840A из  памяти можно с помощью  программ
UNLOAD  или   RELEASE.  Следует,   однако,  отметить,   что  при    этом
знакогенератор,  в  который  загружен  шрифт в альтернативной кодировке,
сохраняется, и после выгрузки программы возникнет рассогласование  между
клавиатурными и экранными символами.

	Примечание:   использованный   в   программе   EC1840A  алгоритм
перекодировки символьных кодов  в буфере клавиатуры  работает достаточно
устойчиво и надежно, и при работе с большинством популярных  программных
средств  проблем  при  вводе  русских  букв  не  возникает.   Исключение
представляет программа  Norton Commander,  упорно не  признающая русскую
букву  "р"  (строчную).  Желающих  исправить  эту  проблему  отсылаю   к
исчерпывающим разъяснениям Д. Гуртяка  (см. примечания в документации  к
драйверу KEYRUS, включенному в "Софтпанораму" N 15).


                                                Ю.Красильников
                                                  25/05/1991