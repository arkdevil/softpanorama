                                                   Л. Г. Б у н и ч

     Унифицированный комплект драйверов клавиатуры и экрана
     ------------------------------------------------------
                  Редакция:            UniKbd 3.3   (май 1991)
                                       UniScr 2.3b  (май 1991)

   Предлагаемая система UNI  содержит драйверы для работы с кирил-
лицей и другими национальными алфавитами.

   В состав системы входят:

      - драйвер для клавиатуры     (UNIKBD.COM);
      - драйвер экрана EGA или VGA (UNISCR.COM);
      - типовые планы клавиатуры   (UNIKALT.STD, UNIKALT.REV);
      - примеры шрифтов экрана     (файлы *.F8, *.F14, *.F16).

   Далее для определенности мы будем говорить о  русском алфавите,
хотя не представляет никакого труда описать, например, украинскую,
грузинскую, армянскую, греческую и др. клавиатуры,  а также экран-
ные шрифты для них.  Соответственно стандартный и национальный ре-
гистры букв далее обозначаются ЛАТ и РУС.

   Система  обладает  следующими  особенностями,  которые,  на мой
взгляд, делают ее лучшей из мне известных.

   1. Ошибок в системе (пока) не обнаружено. UNIKBD, в  отличие от
многих других драйверов, правильно обрабатывает  "серые"  клавиши,
русское "р" и др.  UNISCR содержат шрифты для  вывода  в текстовых
(25, 43 или 50 строк) и в графических режимах (320 или 640 точек).
Предусмотрены некоторые меры по работе драйвера на ЭВМ с не вполне
совместимыми BIOS или картами EGA/VGA.

   2. Для перехода на русский регистр и обратно пользователь может
определить любое удобное для него сочетание клавиш. При этом можно
(и даже рекомендуется) определить не одно, а два сочетания клавиш:
одно для установки русского регистра, другое - латинского. Это из-
бавляет  от необходимости  постоянно помнить,  в каком регистре мы
сейчас работаем, и соответственно снижает число ошибок. Разрешает-
ся даже динамически менять эти сочетания.

   Среди других удобств UNIKBD назовем следующие.

   (а) Текущий регистр (РУС или ЛАТ) может также, при желании, ин-
       дицироваться:

          - цветом границы (border,рамки) экрана CGA, EGA или VGA;
          - звуком (потрескиванием при нажатии русских букв).

   (б) Как уже говорилось, предусмотрена возможность работы с про-
       извольной национальной клавиатурой. Для этого  при  запуске
       пользователь должен указать файл,  описывающий  план нацио-
       нальной клавиатуры.

   (в) При вводе русского текста  знаки препинания  можно вводить,
       не нажимая клавишу Shift (так же, как на пишущей машинке).

   (г) Пользователь может выяснить и/или установить нужный регистр
       (РУС/ЛАТ) в своей программе или в пакете ДОС.

   3. Программа UNISCR позволяют загрузить любой шрифт, импонирую-
щий пользователю. Используя один из редакторов  шрифтов  (EVAFont,
FontEdit и др.), Вы можете скорректировать или создать оптимальный
(для себя) шрифт в виде файла и затем загружать его  в  нужный мо-
мент с помощью UNISCR. Более того, можно динамически перезагрузить
шрифт, т.е. заменить текущий шрифт экрана на иной  (размер свобод-
ной памяти при этом не изменяется). Можно также отменить загружен-
ный шрифт и позже восстановить его простым нажатием клавиш. Понра-
вившийся Вам шрифт можно встроить в текст программы,  чтобы он за-
гружался по умолчанию.

   Практический пример: требуется выполнить программу, которая ве-
дет диалог, используя болгарскую или основную кодировку кириллицы.
Для  этого  вы  должны  загрузить соответствующий шрифт, запустить
программу, а затем восстановить обычный шрифт.

   Стандартные шрифты обеспечивают русские буквы максимально круп-
ного размера для соответствующего типа экрана.

   4. Программы системы занимают минимум памяти  (7-11 Кб).  Любая
из них может быть отключена и затем вновь активирована. При отклю-
чении можно освободить занимаемую ими память.


   Разрешается свободное  распространение и  использование системы
UNI в некоммерческих целях и в неизмененном виде. Разрешается так-
же по согласованию с разработчиком  доработка системы при условии,
что текст и  описание всех модификаций  предоставляются; авторские
права за авторами доработок признаются без ограничений.

   Тел. для справок:   591-93-09 дом.

                       Москва

                      ┌──────────────────┐
                      │ Программа UNIKBD │
                      └──────────────────┘

   Драйвер запускается командой:

      UNIKBD [режимы]

и становится резидентным. Требуемая память: около 1К.

   Если не задано иное, для установки  русского  регистра  следует
нажать и отпустить клавишу "правый Shift";  на  латинский  регистр
аналогично переключает "левый Shift".  Лишнее  нажатие  безвредно.
Сведения о распределении некоторых символов по клавишам  приведены
в приложении 1.

   Допустимые режимы:

   /?       вывод краткой подсказки

   /D       деактивация UniKbd (память не освобождается)
   /A       активация драйвера (ранее деактивированного)

   /IB      индикация текущего регистра  цветом границы экрана:

              - черная рамка означает латинский регистр
              - зеленая рамка означает русский регистр

   /IBкод   аналогично, но вместо зеленого цвета будет использова-
            ться цвет с указанным десятичным  кодом  (1-15).  Коды
            цветов см. в приложении 3. Например, /IB1 означает си-
            ний цвет.

   /IS      индикация текущего  регистра  с  помощью  звука:  ввод
            русских букв сопровождается негромким звуком.

   /K:коды  описание нестандартных клавиш  установки регистра букв
            (вместо левого и правого Shift). <Коды> - описание од-
            ного или двух сочетаний клавиш. См. Приложение 2.

   /KS:код  описание нестандартных клавиш для запроса к  UniScr  с
            целью отмены и восстановления пользовательского шрифта
            экрана. См. замечания ниже.

   /M:файл  загрузить нестандартный план  национальной клавиатуры.
            См. Приложение 1.

   /B       создать новый программный файл UNIKBD.COM,  в  который
            нестандартный план клавиатуры или нестандартные клави-
            ши встраиваются как стандартные. Режим  /B указывается
            совместно с режимами  /M, /K или /KS.  Файл UNIKBD.COM
            создается в текущем оглавлении;  если  там был  старый
            файл с тем же именем, он заменяется на новый.

   /R       реверсирование  верхнего ряда клавиш  в режиме NumLock
            (см. ниже).

   /SC      установить сразу  русский регистр.  Этот режим полезен
            перед запуском программы, работающей с кириллицей.

   /SL      аналогично, установить латинский регистр.

   /U       завершение  UniKbd  (память освобождается,  если после
            UniKbd не загружались другие драйверы)


   Замечания и разъяснения
   -----------------------
   1. Параметры программ набираются строчными или  заглавными бук-
вами. Перед "/" могут быть пробелы (но могут и не быть).

   2. Можно указать несколько параметров одновременно, например:

        unikbd /r/ib2  /m:unimain.kbd

   Порядок параметров не играет роли. Исключение -  параметры /? и
/U, которые не должны использоваться совместно с  другими парамет-
рами.

   3. Программа работает совместно с  UNISCR  или отдельно от нее,
на любой ПЭВМ типа IBM PC.

   4. Если Вы случайно нажали на Shift и не хотите,  чтобы  он пе-
реключил регистр,  выждите около секунды  и только тогда  отожмите
Shift. В этом случае нажатие будет проигнорировано. То же  верно и
для других "одиночных" клавиш, определенных режимом /K (но сочета-
ние двух или трех клавиш срабатывает сразу).

   5. Стандартная клавиатура кириллицы имеет одно существенное не-
удобство: при вводе знаков препинания (точки, запятой и др.) необ-
ходимо каждый раз нажимать Shift.  Режим  /R  ликвидирует это неу-
добство следующим образом.  Если вы указали этот режим при запуске
UNIKBD, то клавиша NumLock переключает значения не только  на циф-
ровой клавиатуре, но и верхнем ряду. Другими словами, знаки препи-
нания в режиме NumLock вводятся без помощи Shift,  а цифры, наобо-
рот, через Shift или с цифровой клавиатуры. Это особенно удобно на
расширенной клавиатуре (101-102 клавиши).  На латинском регистре и
при отключенном NumLock все вводится как обычно.

   6. Если обе программы (UNIKBD и UNISCR) запущены,  одно сочета-
ние клавиш воспринимается как  переключатель  загруженного  шрифта
экрана. По умолчанию это комбинация  Ctrl+Alt+правый Shift. Первое
нажатие означает временную отмену загруженного  шрифта (устанавли-
вается стандартный шрифт ЭВМ, встроенный в  аппаратуру); следующее
нажатие восстанавливает загруженный шрифт и т.д.

   Режим /KS:клавиши  позволяет задать другое сочетание клавиш для
этой цели. О кодировке клавиш см. Приложение 2.

   7. Повторный запуск UniKbd безопасен и может  быть  использован
для выяснения или модификации текущих параметров драйвера: актива-
ции/деактивации, изменения цвета рамки экрана,  установки регистра
РУС/ЛАТ и т.д. (режимы A, D, I, K, KS, R, S). Режимы /M и  /B, од-
нако, можно задать лишь при ПЕРВОМ запуске. Для отмены режимов /R,
/IB, /IS надо указать соответственно: /R-, /IB-,  /IS-.  При  этом
режим /R- действует только при погашенном NumLock  (иначе отверга-
ется).

   8. UniKbd реализует три дополнительные функции  прерывания 16h,
обращение к которым имеет вид:

        mov  AX,02<nn>h
        mov  BX,"LG"
        int  16h

   Здесь <nn> - две шестнадцатиричные цифры номера функции:

     nn=00 - выяснить присутствие UniKbd и состояние клавиатуры
             Результаты:  AX=0FFFFh (признак наличия UniKbd)
                          ES=значение CS драйвера
                          BH=флажки состояния:

                             бит 7 - экран CGA(1), EGA/VGA(0)
                             бит 6 - регистр РУС (1), ЛАТ (0)
                             бит 5 - действует режим /IB  (1)
                             бит 4 - действует режим /R   (1)
                             бит 3 - действует режим /IS  (1)
                             бит 2 - UNIKBD деактивирован (1)
                             бит 1 - резерв
                             бит 0 - резерв

     nn=01 - установить регистр ввода РУС (кириллица)
     nn=02 - установить регистр ввода ЛАТ (латиница)

   Деактивация UniKbd (режим /D) не мешает использованию функций 1
и 2, хотя их действие откладывается до момента активации драйвера.
Рамка экрана, впрочем, корректируется (если действует режим /IB).

                      ┌──────────────────┐
                      │ Программа UNISCR │
                      └──────────────────┘


   Драйвер запускается командой:

      UNISCR [режимы]

и становится резидентным. Требуемая память: 6.5K  (EGA)  или 10.5К
(VGA).


   Если не указано иное, программа  использует  стандартные шрифты
(8*8, 8x14 или 8*16).

   Список допустимых режимов:

   /?        вывод подсказки

   /14:файл  загрузка нестандартного шрифта 8*14.
   /16:файл  загрузка нестандартного шрифта 8*16 (только на VGA).
   /8:файл   загрузка нестандартного шрифта 8*8.

   /B        создать новый программный файл UNISCR.COM,  в котором
             указанные шрифты будут встроены как стандартные. Файл
             создается в текущем оглавлении; если там  был  старый
             файл с тем же именем, он заменяется на новый.

   /C        улучшает работу программы на ЭВМ с не  вполне совмес-
             тимыми BIOS или картами EGA/VGA. Например,  при смене
             шрифта экран очищается.

   /U        отключить  драйвер.  Если  после него  не запускались
             другие резидентные программы, то память, ранее им за-
             нимавшаяся, освобождается.

   Замечания и разъяснения
   -----------------------
   1. Параметры программы набираются строчными или заглавными бук-
вами. Перед "/" могут быть пробелы (но могут и не быть).

   2. Можно указать несколько параметров одновременно, например:

        uniscr /b /14:courier.fnt /8:C:\FONTS\elite8.alt

   Порядок параметров не играет роли. Исключение -  параметры /? и
/U, которые не должны использоваться совместно с  другими парамет-
рами.

   3. Повторный запуск драйвера безопасен и может быть использован
для модификации его параметров (режимы /8, /14, /16, /С) или запи-
си нового варианта программы (режим /B). Для отмены режима /C надо
указать режим:  /C- .

   4. Для файлов со шрифтами можно указать пути доступа к ним (см.
пример выше);  каждая спецификация файла должна содержать не более
60 символов.

   5. Разумеется,  загружать можно  не только шрифты с кириллицей,
но и любые другие.  Поэтому большинство сообщений программа выдает
на английском языке.

   6. В комплект поставки входит набор  разнообразных  шрифтов,  в
том числе:

      UNI.F8   - стандартный шрифт 8*8
      UNIM.F8  -     крупный шрифт 8*8 для VGA
      UNI.F14  - стандартный шрифт 8*14
      UNIM.F16 - стандартный шрифт 8*16

   7. UniScr реализует три дополнительные функции  прерывания 10h,
обращение к которым имеет вид:

        mov  AH,0Fh
        mov  BX,"LG"
        mov  CX,"B<n>"
        int  10h

   Здесь <n> - номер функции:

     n=0 - выяснить присутствие UniScr
           Результаты:  AX=0FFFFh (признак наличия UniScr)
                        BX=значение CS драйвера

     n=1 - установить заводской шрифт экрана  (т.е. временно отме-
           нить шрифт пользователя)

     n=2 - восстановить загруженный шрифт пользователя

                                           П р и л о ж е н и е   1

                  П л а н   к л а в и а т у р ы

   Стандартное распределение букв по клавишам  в основном соответ-
ствует русской клавиатуре для пишущих машинок.  Буква "е"" отсутст-
вует, твердый знак есть.  Верхний ряд клавиш надо маркировать сле-
дующим образом:

   ┌─────┬───┬─────┬─────┬─────┬─────┬─────┬─────┬───┬───┬───┐
   │ ~   │ ! │ @ " │ # ' │ $ ; │ % : │ ^ , │ & . │ * │ ( │ ) │
   │ ` % │ 1 │  2  │  3  │  4  │  5  │  6  │  7  │ 8 │ 9 │ 0 │
   └─────┴───┴─────┴─────┴─────┴─────┴─────┴─────┴───┴───┴───┘

   Здесь левый символ из двух указанных  наверху  вводится  на ла-
тинском регистре, правый - на русском.  Напомним, что в режиме  /R
клавиша NumLock переключает значения десяти клавиш с цифрами. Сим-
вол процента предусмотрен на клавише с тильдой (~), нижний регистр
кириллицы.

   Нетрудно убедиться, что все знаки препинания на регистре кирил-
лицы доступны,  переходить на латиницу придется  только для знаков
"<" и ">", а также при вводе редких в русском тексте символов:

    `  @  #  $  ^  &  [  ]  {  }

   Режим /M позволяет использовать нестандартный план национальной
клавиатуры. Это должен быть файл  длиной  106  байтов,  содержащий
ASCII-коды клавиш со скэн-кодами от 1 до 53. Первая половина файла
описывает клавиши нижнего регистра (при отжатом Shift),  вторая  -
верхнего (при нажатом).

   Примеры:

     - файл UNIKALT.STD,  соответствующий стандартной клавиатуре в
альтернативной кодировке (принят по умолчанию);

     - файл UNIKALT.REV,  отличающийся  от  UNIKALT.STD  реверсным
расположением верхнего ряда клавиш (в режиме кириллицы).

                                           П р и л о ж е н и е   2

  О п р е д е л е н и е   н е с т а н д а р т н ы х   к л а в и ш

   Параметр /K может быть задан двумя способами:

      /K:рус,лат
      /K:переключатель

   В первом случае описываются (через запятую или один минус)  два
сочетания клавиш: первое устанавливает русский регистр,  второе  -
латинский. Во втором случае используется  одно  сочетание  клавиш:
при первом нажатии оно устанавливает кириллицу,  при  следующем  -
латиницу и т.д.
   В параметре  /KS  может быть задано только одно сочетание (т.е.
допускается лишь второй способ).

   Каждое сочетание клавиш задается одним из трех вариантов.

      (1) Десятичный скэн-код клавиши (см. таблицу 1).
      (2) Один или несколько (до трех) кодов специальных клавиш:

           A - клавиша Alt (любая)       LA - левая  клавиша Alt
           C - клавиша Ctrl (любая)      RA - правая клавиша Alt
          LS - клавиша левый Shift       LC - левая  клавиша Ctrl
          RS - клавиша правый Shift      RC - правая клавиша Ctrl

          Коды LA, RA, LC, RC допускаются  ТОЛЬКО  для расширенной
          клавиатуры (101-102 клавиши).

      (3) Один или два кода специальных клавиш, за которыми следу-
          ет (вплотную) скэн-код дополнительной клавиши.

   Примеры.

      /K:54,42     - значение по умолчанию (можно и так: /K:RS,LS)
      /K:RC,LC     - правый Ctrl (РУС), левый Ctrl (ЛАТ)
      /K:70        - клавиша ScrollLock
      /K:C87,C88   - сочетания Ctrl+F11 (РУС) и Ctrl+F12 (ЛАТ)
      /K:RARS,LALS - сочетания  правый Alt + правый Shift (РУС)
                                и левый Alt + левый Shift (ЛАТ)
      /K:RCRA      - переключатель:  правый Ctrl + правый Alt
      /KS:LSRS     - левый и правый Shift одновременно

   Замечания.

   1. Если задано сочетание двух или трех клавиш, порядок их нажа-
тия не играет роли. Если задана одна клавиша, то, чтобы она срабо-
тала, надо ее нажать и тут же отжать.

   2. Описанное сочетание клавиш после обработки в UniKbd  переда-
ется стандартному обработчику BIOS.  Поэтому не следует включать в
него текстовые символы и сочетания,  обрабатываемые  другими прог-
раммами (например, буквы или функциональные клавиши).

   3. Можно реализовать  довольно  изощренные  способы  управления
клавиатурой,  если комбинировать скэн-коды нажатия  и отжатия кла-
виш. Напомню, что последние получаются из первых прибавлением 128.
Пример: /K:A170; в этом случае переключение регистра букв произой-
дет при выполнении следующих действий:

         нажать левый Shift;  нажать Alt;  отжать левый Shift;
   или:  нажать и отжать левый Shift; нажать Alt.

   В обоих случаях  получается  заказанное  сочетание  Alt+отжатие
LShift (в разном порядке). Однако необходима осторожность: это со-
четание может получиться  и  в других  ситуациях,  например:

   ввести заглавную букву и отжать Shift;  ввести Alt + что-нибудь

   3. Не следует  указывать  в  сочетаниях  среди  прочих  клавишу
NumLock, если предполагается использовать режим /R.


------------------------------------------------------------------
              С к э н - к о д ы   к л а в и ш            Таблица 1

┌───────┬──────┐     ┌───────┬──────┐     ┌───────┬──────┐
│ Кла-  │ Скэн-│     │ Кла-  │ Скэн-│     │ Кла-  │ Скэн-│
│ виша  │  код │     │ виша  │  код │     │ виша  │  код │
└───────┴──────┘     └───────┴──────┘     └───────┴──────┘
   ESC      1            A      30          F1        59
    1       2            S      31          F2        60
    2       3            D      32          F3        61
    3       4            F      33          F4        62
    4       5            G      34          F5        63
    5       6            H      35          F6        64
    6       7            J      36          F7        65
    7       8            K      37          F8        66
    8       9            L      38          F9        67
    9      10            ;      39          F10       68
    0      11            '      40        NumLock     69
    -      12            `      41       ScrollLock   70
    =      13       Левый Shift 42          Home      71
BackSpace  14            \      43           Up       72
   Tab     15            Z      44          PgUp      73
    Q      16            X      45         Серый -    74
    W      17            C      46          Left      75
    E      18            V      47         Center     76
    R      19            B      48         Right      77
    T      20            N      49         Серый +    78
    Y      21            M      50          End       79
    U      22            ,      51          Down      80
    I      23            .      52          PgDn      81
    O      24            /      53          Ins       82
    P      25      Правый Shift 54          Del       83
    [      26        Серая *    55     ░░░░░░░░░░░░░░░░░░░
    ]      27          Alt      56     ░ Alt-PrtSc    84 ░ только
  Enter    28        Пробел     57     ░    F11       87 ░ расшир.
  Ctrl     29       CapsLock    58     ░    F12       88 ░ клав-ра

                                           П р и л о ж е н и е   3

               К о д ы   ц в е т о в   э к р а н а

        0      Черный                 8    Серый
        1      Синий                  9    Ярко-синий
        2      Зеленый               10    Ярко-зеленый
        3      Голубой               11    Ярко-голубой
        4      Красный               12    Ярко-красный
        5      Сиреневый             13    Ярко-сиреневый
        6      Коричневый            14    Желтый
        7      Белый                 15    Ярко-белый

                 Цвет фона должен быть от 0 до 7


                                           П р и л о ж е н и е   4

               П р о т о к о л   и з м е н е н и й

 UNIKBD (3.1)    Если определена ТОЛЬКО ОДНА клавиша установки или
               переключения регистра ЛАТ/РУС, а не  сочетание кла-
               виш, то нажатие ее дольше секунды  или одновременно
               с другими клавишами (например, Shift вместе  с Ctrl
               или Alt) не переключает регистр.
                 Рамка экрана не пропадает ни при каком переключе-
               нии видеорежима.
                 Режим /B, аналогично UNISCR, генерирует новый эк-
               земпляр UNIKBD.COM, в который встроен нестандартный
               план клавиатуры и/или нестандартные клавиши.

 UNIKBD (3.2)    Обеспечен ввод русской буквы "р" на некоторых ЭВМ
               с особо глупыми BIOS.

 UNIKBD (3.3)    При первом запуске  (а также  в каждой подсказке)
               указываются текущие клавиши смены регистра и шрифта
               экрана.
                 Режим /B можно задавать и без режима /M.
                 Операнды в параметре /K можно разделять не только
               запятой, но и минусом.  Это позволяет передавать их
               как параметры в BAT-файл  (MS-DOS запрещает запятые
               в тексте параметров пакета).

 UNISCR (2.3)    Объединены UNIEGA и UNIVGA.
                 Проверена работа  с  WORD  5.0  для разного числа
               строк на экране, исправлена ошибка.
