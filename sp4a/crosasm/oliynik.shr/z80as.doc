
I.   Введение ..................................................1
II.  Вызов и использование .....................................1
III. Лексические соглашения ....................................1
       1. Идентификаторы .......................................1
       2. Цифровые идентификаторы ..............................1
       3. Константы ............................................2
       4. Пробельные символы ...................................2
       5. Комментарии ..........................................2
       6. Ключевые слова .......................................2
IV.  Счетчик адреса ............................................2
V.   Операторы .................................................2
       1. Метки ................................................3
       2. Пустой оператор ......................................3
       3. Оператор присваивания ................................3
       4. Ключевые операторы ...................................3
VI.  Выражения .................................................3
       1. Типы выражения .......................................3
       2. Операции .............................................4
VII. Директивы ассемблера ......................................4
       1. Дирeктива .byte expr, [, expr] ... ...................4
       2. Директива .word expr, [, expr] ... ...................4
       3. Директива .ascii $str$ ...............................5
       5. Директива .blkb expr .................................5
       6. Директива .page ......................................5
       7. Директива .title str .................................5
       8. Директивы .hlist и .olist ............................5
       9. Директивы .if expr, .else и .endif ...................5
      10. Директива .end .......................................5
VIII.Машинные инструкции .......................................6
IX.  Сообщения и диагностика ошибок ............................7


                                 1

I. Введение

    Z80as  это двух проходной кросс ассемблер для микропроцессора
Zilog 80 работающий на машинах  типа IBM PC/XT/AT и совместимых с
ними в среде DOS 3.30 и выше. Входной  синтаксис  языка  в  общем
заимствован от Unix AS ассемблера.


II. Вызов и использование

    В среде DOS вызов транслятора производится командой:

    Z80as [-l] [-n] ifile

    где:

    ifile - имя файла с исходным текстом программы
    l     - необязательный ключ "генерировать листинг", если
            указан то листиг программы помещается в файл ifile.lst
    n     - необязательный ключ "не генерировать файл ifile.hex"


III. Лексические соглашения

    Строки программы разбиваются на  лексемы - последовательности
знаков, возможно разделенных пробельными символами (Tab, Space).
Лексемы имеют несколько форм: идентификаторы ('символы', 'имена'),
константы и операторы.

1. Идентификаторы

    Идентификатор    состоит   из  последовательности  алфавитно-
цифровых  символов  (включая  точку '.' и  подчеркивание '_')   и
цифра не должна быть первой. Только первые восемь символов  иден-
тификатора  являются значащими, хотя длина его может быть  любой.
Символы  нижнего  и  верхнего  регистров   различаются.  В  набор
символов входят символы  кирилицы. Все   символы  за  исключением
локальных меток являются глобальными. Идентификатор  имеет значе-
ние  и  тип, которые связываются с ним в результате  определения.
Идентификатор  может  быть  определен  одним  из  двух  способов:
посредством   символьной   метки   или   посредством    оператора
присваивания.

2. Цифровые идентификаторы

    Цифровой идентификатор это цифра, после которой стоит  символ
'f' или 'b'. Цифровые  идентификаторы  используются для ссылок  к
цифровым меткам (локальным меткам).

                                 2

3. Константы

    Десятичная  константа является последовательностю  десятичных
цифр 0,1,2,3,4,5,6,7,8,9. Диапазон ее простирается от 0 до 32768.
    Восьмеричная константа состоит из последовательности  восьме-
ричных цифр (0,1,2,3,4,5,6,7) и должна начинаться с цифры 0.
    Шестнадцатеричная  константа  состоит  из  последовательности
шестнадцатеричных цифр (0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f)  и долж-
на  начинаться  с последовательности 0x. Цифры a,b,c,d,e,f  могут
быть также записаны в верхнем регистре A,D,C,D,E,F.
    Односимвольные  константы состоят из одинарной  кавычки ( ' )
за  которой  следует  алфавитноцифровой символ (исключая  возврат
каретки).

4. Пробельные символы

    Символы горизонтальной  табуляции  и  пробелы могут  свободно
использоваться для разделения лексем и придания  тексту  програм-
мы "читабильного вида".

5. Комментарии

    Для указания что данная строка является комментарием  исполь-
зуется  символ '\', который  ставится  в  начале   этой   строки.
Строка  комментария транслятором   не  рассматривается, а  просто
переносится без изменения в листинг.  Символ  ';' игнорируется  и
может использоватся для выделения участков программы  и  разделе-
ния операторов в одной строке.

6. Ключевые слова

    Ключевые  слова применяются для обозначения  названий  машин-
ных инструкций и директив транслятора и  являются  предопределен-
ными. Пользователь не может переопределять ключевые слова.


IV. Счетчик адреса

    Специальный  идентификатор  обозначаемый '.' - точка  исполь-
зуется  в качестве счетчика адреса. Его  значение в любой  момент
времени является смещением от  начала  памяти (0x0000) до  начала
оператора, где он появляется. Ему  в  любой момент времени  можно
задать новое значение.


V. Операторы

    Программа  состоит  из  последовательности операторов  разде-
ляемых  символом  новая строка или точкой  с  запятой ';'. Опера-
торы  бывают трех типов: пустой  оператор, оператор  присваивания
и ключевой  оператор (машинная  инструкция  или директива ассемб-
лера). Перед любым оператором может быть любое число меток.

                                 3

1. Метки

    Имя  метки  состоит  из идентификатора  и  следующего за  ним
символом двоеточие ':'.
    Локальная метка состоит из цифры из диапазона 0-9,  за  кото-
рой  следует  двоеточие ':'. Такая   метка  служит   для  задания
цифровых  идентификаторов  в  форме  "nf" и  "nb", где n-цифровая
метка. В обеих  случях  метка  принимает  текущее  значение и тип
счетчика  адреса. Однако, цифровые  метки не  обязательно  должны
быть уникальными. Ссылка в форме "nf" относится  к  первой цифро-
вой  метке n: вслед за ссылкой, а ссылка  в  форме "nb" относится
к первой  метке n: до ссылки. Такие  метки   позволяют  экономить
пространство таблицы идентификаторов ассемлера.

2. Пустой оператор

    Пустой  оператор  это  всегда пустая строка, которая  тем  не
менее может иметь метку и  комментарий. Пустой  оператор  игнори-
руется.

3. Оператор присваивания

    Оператор присваивания  состоит  из  идентификатора за которым
следует  символ   равно '=' и  выражение.  Идентификатору   прис-
ваивается значение  вычисленного  выражения. Символ  определенный
опрератором присваивания может быть  переопределен   другим  опе-
ратором присваивания.

4. Ключевые операторы

    Ключевые  операторы включают в себя  все  множество  инструк-
ций  и директив ассемблера. Ключевой  оператор  начинается  одним
из  предопределенных   слов   ассемблера,   за   которым  следуют
операнды требуемые данным  оператором. Все  ключевые  слова  и их
операнды описываются в разделах VII и VIII.


VI. Выражения

    Выражение состоит  из  имен,  констант,  операций  и  скобок.
Каждое  выражение имеет  тип.  Знаки  операций  имеют  одинаковый
приоритет, и выражения  вычисляются  строго  слева направо. Поря-
док вычислений можно изменять  с  помощью  скобок "[]". Выражения
всегда вычисляются как 16-битовая величина.

1. Типы выражения

    Каждое  выражение  имеет  тип  определяемый  его операндами и
знаками  операций. На  тип  выражения  влияют  следующие типы:

    - неопределенный;
      до первого появления каждый  символ  является  неопределен-
      ным. Символ  также  может  быть  неопределенным,  если  ему
      присваивается     неопределенное     выражение.   Последнее
      является ошибкой и диагностируется транслятором.

    - абcолютный;
      абсолютный символ определяется в конечном счете константой.

                                 4

    - регистровый;
      имена   a, b, c, d, e, h, l, v, r, bc, de, hl, sp, af, af',
      ix, iy - обозначают  регистры; эти обозначения  или  имена,
      определенные через  них, должны  использоваться для обраще-
      ния к соответствующим машинным регистрам.

    - ключевой;
      каждое  ключевое  слово,  известное  ассемблеру, имеет тип,
      который   используется  для   выбора   программы  обработки
      оператора, начинающегося с этого ключевого  слова; если имя
      не  ипользуется в качестве ключевого слова, то оно абсолют-
      ное.

    Общие правила композиции типов следующие:

    - если   один  из  операндов  неопределен, то результат  тоже
      неопределен;
    - если  оба  операнда  абсолютны,  то  результат  абсолютный;
      комбинация некоторого типа с абсолютным запрещена;
    - кмбинация    ключевого   типа   с  любым  другим запрещена;

2. Операции

    Определены следующие операции:

    '+'     сложение
    '-'     вычитание
    '*'     умножение (целочисленное, 16-битное)
    '%'     целочисленное деление
    '&'     побитовое И
    '|'     побитовое ИЛИ
    '>>'    арифметический сдвиг вправо
    '<<'    арифметический сдвиг влево
    '-'     унарный минус
    '!'     инверсия битов


    Приоритет всех операций одинаков. Для изменения порядка вычи-
слений  можно  применять квадратные скобки ('[' и ']');   круглые
скобки зарезервированы  для  использования в адресных выражениях;


VII. Директивы ассемблера

    Ключевые  слова, которые  описываются ниже  используются  для
генерации данных или управления транслятором.

1. Директива .byte expr, [, expr] ...

    Используется для задания данных. За  директивой .byte  должен
следовать  список  выражений expr разделенных  запятой. Выражения
вычисляются и результаты, усеченные до 8 бит располагаются в пос-
ледовательные байты. Выражения должны быть абсолютными.


2. Директива .word expr, [, expr] ...

    Также  используется  для задания данных  и работает аналогич-
но  директиве .byte, но в отличие от нее  выражения вычисляются и
ассемблируются в последовательные слова.

                                 5

3. Директива .ascii $str$

    Служит для задания строковых данных.  Строка str  должа  быть
ограничена с двух сторон парой  знаков  $. Где  знак  $  означает
любой (кроме знака комментария /, и букв)  символ. Например: ",#.
Последовательность  символов  строки str  ассемблируется в после-
довательность байт.

4. Директива .asciz $str$

    Аналогична директиве .ascii, за исключением  того, что сгене-
рированная  последовательность   байт  будет   завершена  нулевым
байтом.

5. Директива .blkb expr

    Используется для резервирования  памяти длинной в txpr  байт.
Зарезервированные  байты содержат 0. Выражение  должно быть абсо-
лютным.

6. Директива .page

    Указывает  ассемблеру  вставить в листинг символ  перехода на
новый лист.

7. Директива .title str

    Задает строку str  в качестве  заголовка  программы,  который
выводится в листинг в первую строку каждого листа.

8. Директивы .hlist и .olist

    Управляют видом представления информации в листинге  програм-
мы: .hlist - шестнадцатеричное; .olist - восьмеричное.

9. Директивы .if expr, .else и .endif

    Директивы  условной трансляции позволяют включать в программу
секции текста, в  зависимости от выполнения заданных условий. Это
достигается использованием выше названных директив:

   .if expr - если  значение выражения  равно  0, ассемблирование
          прекращается  до тех  пор, пока  не  встретится  дирек-
          тива ".else" или ".endif".

   .else    - эта директива  "включает" или "выключает" ассембли-
          рование, есло оно было выключено и наоборот.

   .endif   - завершает блок  условной трансляции,т.е. "включает"
          ассемблирование,  если  оно было "выключено" дирек-
          тивами ".if" или ".else".

ПРИМЕЧАНИЕ! Максимальная  вложенность  директив условной трансля-
        ции не более 8.

10. Директива .end

    Применяется для  завершения текста  программы. Транслятор  на
него никак не реагирует.

                                 6

VIII. Машинные инструкции

    Полный  перечень инструкций  процессора  приводится  в  файле
Z80ins.tab. Инструкции могут быть следующих типов:

    - без аргументов
    - с одним арументом
    - с двумя аргументами

    Инструкции не имеющие арумента - это обычно инструкции управ-
ления или инструкции аргументы, которых постоянны и поэтому умал-
чиваюся. Инструкции без аргументов:

информационнго    арифметики         управления       работы с     
  обмена и                                         подпрограммами 
   поиска            daa                nop                          
    exx              com                halt         reti       
    movi             neg                di           retn
    movir            cmc                ei           ret
    movd             sec                             rcs
    movdr                            ввода/вывода    rmi
    cmpi            сдвига                           rcc
    cmpir                               ini          rne
    cmpd             rld                inir         rpl
    cmpdr            rrd                ind          rpe
                                        indr         rpo
                                        outi         req
                                        outir    
                                        outd     
                                        outdr    
 
Инструкции с одним аргументом предполагают в  качестве  аргумента
либо источник, который в тоже время может является и  приемником,
либо некоторый модификатор  или  адресное  выражение.  Инструкции
с одним аргументом:

 арифметики        управления        работы с        переходов
                                   подпрограммами                    
    inc              im                              jmp   blo
    dec                                 call         jcs   bcc  
                    сдвига              ccs          jmi   bhis 
   стековые                             cmi          jcc   bne  
                     rlc                ccc          jne   beq
    push             rol                cne          jpl
    pop              rrc                cpl          jpe
                     ror                cpe          jpo
                     asl                cpo          jeq
                     asr                ceq          br
                     lsr                rst          bcs

                                 7
                                                     
И, наконец инструкции с двумя аргументами, как правило в качестве
аргументов имеют приемник и источник. Основной  формат  команды с
такими инструкциями следующий:

         CODE    src, dst
где 
         CODE  - мнемоника инструкции
         src   - операнд источник
         dst   - операд приемник

Инструкции с двумя аргументами:

  обмена         загрузки

    ex             mov
    
арифметики       работы с
 и логики         битами

    add            bit
    adc            bis
    sub            bic
    sbc
    and         ввода/вывода
    or
    xor            in
    cmp            out


IX. Сообщения и диагностика ошибок

    При  работе  с кросс ассемблером Вы можете получить ряд диаг-
ностических сообщений:

    Zilog Z-80 High Speed Cross Assembler Version 1.2
    Copyright (c) 1990, 1991 Oleinik W.L. (OWLsoft)

    Usage: z80as [-l] [-n] file

    -l generate listing file
    -n not generate HEX file

Это сообщение выдается в случае, когда кросс ассемблер запускает-
ся без аргументов в командной строке.

    Options -x: ignored.

    Опция  х  игнорируется - возникает в том случае, когда в  ко-
мандной  строке была введена опция -x (x - любой символ кроме  l,
n).

   FileName: cannot open

Входной файл с именем FileName отсутствует.    

   FileName: cannot creat

                                 8

Невозможно открыть выходной файл с именем FileName.

    Out of space!

Может возникнуть при трансляции очень больших программ и,если при
этом в системе мало свободной оперативной памяти.

Кроме этих  сообщений  при  трансляции  производится  диагностика 
ошибок и на терминал выводятся сообщения в формате:

    x dddd

где x     - буква-код ошибки
    dddd  - номер строки, в которой она была обнаружена

В листиг программы также помещается  сообщение  об  встретившейся
ошибке. В начало строки с ошибкой прописывается код в формате:

    xce

где x, c, e - возможные коды ошибки (до 3 ошибок в строке).

Коды ошибок ткактуются следующим образом:

    a - ошибка адресации
    i - ошибка в директивах условной трансляции
    m - многократное определение
    o - неверный код операции
    q - сомнительный синтаксис
    u - неопределенный символ
    p - ошибка прохода (переопределение символа на 2 проходе)
    r - операнд не абсолютного типа
    t - переполнение (потеря бит)
    z - длина кода превышает 128 байт

X. Литература

М.Рафикузаман.  Микропроцессоры  и машинное проектирование микро-
процессорных систем. В 2-книгах,Пер. с англ. -М.: Мир, 1988, 311 с.


