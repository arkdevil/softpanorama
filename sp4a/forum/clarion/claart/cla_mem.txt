
          Как бороться с памятью в Clarion-программах?


     Рассмотрим ряд  рекомендаций пользователю,  который  получил
сообщение "INSUFFICIENT MEMORY", во время загрузки или исполнения
Clarion-программы. Конечно можно воспользоваться одним из советов
Clarion Software  Corp. и заменить ваш компьютер на более мощный,
но учитывая,  что у  нас наиболее распостраненной рабочей лошадью
является    PC AT    в    "стандартной"    конфигурации,    будем
ориентироваться на данную модель. В контексте данных рекомендаций
напомним, что  "стандартная" конфигурация предполагает AT на базе
286 процессора,  с 1Мб  ОЗУ и  видеоадаптером EGA или VGA ( 256Кб
видеопамять ). Другие параметры не важны.

     Рекомендации относятся к версии 2.1.

     Можно  выделить   следующие  факторы,   которые   определяют
требования к  памяти.  Во-первых,  размер  свободного  участка  в
Conventional Memory  (первые 640Кб  памяти), который используется
для размещения  и работы  прикладной программы; во-вторых, размер
самой Clarion-программы  (т.е. вашего  .EXE  модуля);  в-третьих,
динамические запросы памяти во время исполнения программы.

     В соответствии  с этим  предлагаются три  подхода к  решению
проблемы:

     - увеличить размер свободной памяти, доступной программе;

     - уменьшить размер .EXE модуля;

     - управлять размещением динамических объектов программы.

     Рассмотрим каждый из них.



               1. Увеличение размера свободной памяти.

     Для начала  уберите все  лишние резидентные  программы  типа
калькуляторов,  будильников   и  т.п.   Перед  запуском  Clarion-
программы выйдите из Norton Commander.

     Если эти  простые действия  не помогли, рекомендуем обратить
ваше внимание  на 5-ые  версии DOS:  IBM DOS,  MS DOS или DR DOS.
Общим свойством  5-тых версий  DOS является возможность размещать
часть ядра  операционной системы  в High  Memory (первые  64Kб  в
адресном   пространстве   2-ого   мегабайта).   За   счет   этого
освобождается  место   в  Conventional   Memory  для   прикладных
программ. Чтобы  задействовать эту  возможность, вставьте  в  ваш
CONFIG.SYS следующие команды (если у вас стоит 5-ая версия):

     - для IBM DOS или MS DOS:

DOS=HIGH
DEVICE=HIMEM.SYS

     - для DR DOS:

HIDOS=ON
DEVICE=HIDOS.SYS

     Для IBM  DOS это  дополнительно  даст  прикладной  программe
около 40Kб.  Освобождаемая DR DOS память несколько меньше, но при
этом в  DR DOS  командами HILOAD  или HIINSTALL  можно  загрузить
необходимые резидентные  программы в  Upper Memory  (память между
640Kб и  1Mб). Правда, задействовать Upper Memory можно только на
компьютерах использующих NEATовские или им подобные микросхемы. В
результате на  данных компьютерах  суммарно  DR  DOS  освобождает
большую область  памяти,  чем  IBM  или  MS  DOS  (о  возможности
задействовать Upper Memory в IBM или MS DOS автору не известно).

     В любом  случае, 5-ые версии DOS на PC AT с 1Mб ОЗУ позволят
увеличить  размер  свободной  памяти,  доступной  вашей  Clarion-
программе и, возможно, решат вашу проблему.

     Другой способ увеличения размера свободной памяти основан на
том, что  Clarion-программа стандартно  использует  видеоадаптеры
только   в   текстовом   режиме.   Поэтому   часть   видеопамяти,
используемая в  графическом режиме,  может быть отдана прикладной
программе. Такую  возможность обеспечивает программа VIDRAM фирмы
Quarterdeck Office  System.  VIDRAM  отдает  участок  графической
памяти, начинающийся  с адреса  640Kб, операционной  системе  как
основную память.  Тем самым  размер памяти,  доступный прикладной
программе,  увеличивается   на  96Kб.   Чтобы  задействовать  эту
возможность (при  наличии у вас VIDRAM), выполните перед запуском
Clarion-программы  команду   VIDRAM ON  или  вставьте  ее  в  ваш
AUTOEXEC.BAT. Для  использования адаптера  в  графическом  режиме
выполните команду VIDRAM OFF.



               2. Уменьшение размера .EXE модуля.


     Самое эффективное решение для уменьшения размера .EXE модуля
-  сделать   его  оверлейным.   Напомним,  что  Designer  создает
приложение  с   MAP-структурой  без  оверлеев.  В  среде  Clarion
отсутствуют инструментальные  средства для планирования оверлеев,
так  что  этот  процесс  разработчик  должен  выполнить  вручную.
Определенную помощь  может оказать  таблица перекрестных  ссылок,
выдаваемая утилитой  Crossrefer. Кроме  того,  ряд  третьих  фирм
предлагают  инструментальные  средства  для  автоматизации  этого
процесса. В  частности,  московская  AmberSoft  Group  поставляет
программу оптимизации оверлеев, которая формирует дерево вызовов,
создает  оверлейную   MAP-структуру,   обеспечивает   оптимизацию
размера оверлея.

     Другой путь  уменьшения размера  .EXE  модуля  -  уменьшение
корневого   сегмента.   Как   правило,   Clarion-файлы   являются
глобальными данными  приложения для чего их описание содержится в
главной программе, которая  находится в корневом сегменте. Если в
описании Clarion-файла  указан параметр  CREATE, то  это  требует
дополнительной  памяти  для  хранения  информации,  помещаемой  в
заголовок файла  .DAT при  его  создании.  Размер  дополнительной
памяти пропорционален  числу полей  в записи  файла и  количеству
используемых  ключей.  Следовательно,  убрав  параметр  CREATE  в
описании  файла,   вы  уменьшаете   размер  корневого   сегмента.
Суммарный выигрыш  определяется  числом  Clarion-файлов  в  вашем
приложении.

     А  как   в  таком  случае  будет  создавать  файлы  конечный
пользователь, если того требует технология вашего приложения? Для
этого можно рекомендовать следующие пути:

     - создавать  файлы утилитой  Filer, которую  вместе с  .CLA-
файлом, содержащим  описание  файлов,  вы  включаете  в  комплект
поставки вашего  приложения (в  скобках заметим, что лицензионное
соглашение разрешает  передавать  конечному  пользователю  Filer,
Converter, Sorter, Scaner);

     - поставлять отдельную программу, используемую для начальной
установки  БД,  в  которой  Clarion-файлы  описаны  с  параметром
CREATE, в отличии от основной программы;

     -   поставлять   "стартовую"   БД,   файлы   которой   будут
копироваться оператором  COPY(file,new file) во всех тех случаях,
где должен  использоваться оператор  CREATE(file). "Стартовая" БД
может содержать не только "пустые" файлы, но и включать некоторое
их обязательное наполнение.



                 3. Переменные окружения CLAVMx.


     Если вам удалось загрузить Clarion-программу, не забудьте ее
протестировать,  т.к.   сообщение  "INSUFFICIENT   MEMORY"  может
появиться во  время исполнения.  Это связано  с тем, что во время
выполнения   Clarion-программа   может   создавать   динамические
объекты, запрашивая  память для  их размещения.  В качестве таких
объектов могут  выступать таблицы памяти (Memory Table), буферы и
кэши для  файлов, образы "подвешенных" (закрываемых) окон экрана.
По умолчанию  память для  их размещения  выделяется в  оставшейся
свободной  после загрузки .EXE модуля Conventional Memory.

     Начиная с  версии 2.1,  для размещения динамических объектов
кроме  Conventional   Memory  может   использоваться  память   на
виртуальном и  жестком дисках.  Где и  в какой последовательности
использовать  память   для   размещения   динамических   объектов
определяют переменные  окружения CLAVMx, где x принимает значение
от 0  до 4,  т.е. может  быть до  пяти таких  переменных: CLAVM0,
CLAVM1, CLAVM2,  CLAVM3 и  CLAVM4. Если переменные не определены,
то используется только свободная Conventional Memory.

     Значение переменной  CLAVMx определяет  место размещения,  а
номер переменной  (значение x) - приоритет использования. Сначала
динамические объекты  размещаются там, где это указано переменной
CLAVM0, после  того как  определенная  CLAVM0  память  заполнена,
используется память заданная CLAVM1 и т.д.

     Значение переменных  CLAVMx задается  командой SET  в  вашем
AUTOEXEC.BAT.  Для   указания  на   виртуальный  диск  переменная
задается  так:  SET  CLAVMx=<путь>,<размер>,M.  Для  указания  на
жесткий диска:  SET CLAVMx=<путь>,<размер>. Где <путь> определяет
идентификатор  диска   и  используемую   директорию,  а  <размер>
задается в  килобайтах. Третий параметр (латинская M) определяет,
что диск является виртуальным.

     Для указания на Conventional Memory переменная задается так:
SET CLAVMx=MEMORY,<размер>,  где   <размер>  определяет   область
Conventional Memory  в килобайтах,  которая НЕ  используется  для
размещения динамических  объектов (резервируется).  Это связано с
тем, что  для каждого  объекта, размещаемого  на виртуальном  или
жестком диске, в Conventional Memory создается блок управления от
32 до 48 байт длиной и память резервируется для этих целей. Особо
отметим, что  блок управления создается для каждой ЗАПИСИ таблицы
памяти. Поэтому  при использовании больших таблиц памяти возможна
ситуация,  когда   места  для   размещения   собственно   таблицы
достаточно, а  для  блоков  управления  памяти  не  хватает,  что
приводит к сообщению "INSUFFICIENT MEMORY". Выход:  резервировать
достаточно места  или не  использовать  Conventional  Memory  для
размешения динамических объектов вовсе.

     Если ваша  Clarion-программа слетает  из-за  большого  числа
открытых     экранов,      проблема     решается      установкой:
SET CLAVM0=c:\,1024, т.е.  укажите  для  размещения  динамических
объектов корневую директорию жесткого диска размером в мегабайт.

     Для "стандартной"  PC AT фрагмент  вашего AUTOEXEC.BAT может
выглядеть так:

     SET CLAVM0=d:\,300,M
     SET CLAVM1=MEMORY,15
     SET CLAVM2=c:\,1024


     Надеюсь эти  рекомендации помогут в укращении ваших Clarion-
программ. Возможно вы используете другие методы борьбы с памятью,
поделитесь ими с нами.


     Евгений Галочкин, фирма ИНСАЙТ.
