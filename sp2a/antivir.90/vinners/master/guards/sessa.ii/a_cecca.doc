                                                       А.В.Сесса



         НЕЙТРАЛИЗАЦИЯ БУТОВЫХ ВИРУСОВ ПРИ ЗАГРУЗКЕ ДОС



     Пользуясь принятой в компьютерной вирусологии медико-биоло-

гической терминологией, осмелюсь утверждать о существовании эко-

логической ниши в мире антивирусных программ. Обитателей этого

мира обычно делят на три класса програм, в зависимомти от способа

борьбы с вирусами. Класс программ поиска и уничтожения известных

вирусов наиболее представителен и динамичен. Он постоянно попол-

няется новыми детекторами и фагами, оперативно отслеживая появле-

ние вирусов. Второй класс включает резидентные программы-фильтры,

контролирующие состояние некоторых векторов прерываний. Программы

этой группы универсальны, т.е. не зависят от типов вирусов, поэ-

тому их число невелико и растет только за счет дублирования или

совершенствования существующих программ. Третий класс - программы

следящие за целостностью файлов - объединяет ревизоры, проверяю-

щие файлы на предмет изменения контрольной суммы или других пара-

метров и внедряемые в исполняемый файл вакцины. Принцип работы

вакцины состоит в том, что она предварительно помещается в защи-

щаемую программу, запоминая при этом некоторые критичные характе-

ристики "здоровой" программы, а при запуске защищенной программы

проверяет состояние исполняемого файла. Внедряемая вакцина, хоть

и имеет некоторые недостатки, остается одним из лучших антивирус-

ных средств, так как позволяет своевременно обнаружить появление

неизвестного ранее вируса. Здесь, в классе ревизоров и вакцин и

обнаружена "экологическая ниша" - наряду с существованием нес-

кольких типов вакцин для защиты файлов (PROTECT Д.Стефанкова,

HEALTH М.Поляка, СТРАЖ Ф.Шерстюка, STAMPER А.Чижова) до настояще-

го времени отсутствовали (или были не известны) подобные средства

для защиты от поражающих загрузчики бутовых вирусов. Этот факт

отмечается в публикациях о защите информации от  вирусов - тот же

Стефанков в статье "Пятница, 13-е" весьма скептически относится к

возможности cоздания такого средства. Однако, потребность в буто-

вой вакцине растет, особенно с появлением в СССР столь опасного

вируса как DISK KILLER (а зарубежные публикации извещают о появ-

лении еще более жестокого вируса INDONESIAN HACKERS, физически

форматирующего жесткий диск путем непосредственного управления

контроллером).

     Идея вакцины против бутовых вирусов изложена в статье Ф.Шер-

стюка "Вирусы и антивирусы на IBM-совместимых ПК". Предлагается

контролировать загрузчик с помощью специального драйвера, храня-

щего копию загрузчика и истинного значения вектора жизненно важ-

ного дискового прерывания Int13. Видимо, автор предполагал, что в

зараженной операционной системе Int13 будет указывать в область

вируса, но на самом деле к моменту выполнения драйверов ДОС пере-

адресует вектор дискового прерывания в свою область оперативной

памяти, независимо от наличия вируса. Контроль зараженности путем

сравнения загрузчика с эталонной копией тоже некорректен по той

причине, что, перехватывая прерывание на чтение BOOT-сектора, ви-

рус может подставить вместо зараженного загрузчика здоровую ко-

пию, обычно хранящуюся в "хвосте" вируса (такой "фокус" проделы-

вают вирусы группы BRAIN/ASHAR). Правда, воспользовавшись недо-

кументированной функцией 13 прерывания Int2F можно определить,

кто был держателем Int13 до загрузки ДОС, и тем самым обнаружить

присутствие бутового вируса. Но нейтрализовать к этому моменту

можно только ранее известные и изученные вирусы, что, кстати, и

делают некоторые программы, относящиеся к первому классу. Вакци-

на же должна защищать систему и от неизвестных ранее вирусов.

     На основании изложенного делаем вывод, что бутовая вакцина

должна выполняться до загрузки операционной системы - т.е. либо в

процессе выполнения программы загрузчика, либо по ее окончании до

передачи управления загружаемому сегменту BIOSа. Размещение до-

полнительной программы в загрузчике затруднено из-за ограниченно-

го размера BOOT-сектора, хотя можно пойти "неспортивным" путем

занятия под загрузчик еще одного-двух секторов так, как это дела-

ют вирусы. Другим местом размещения вакцины (прошу потенциальных

создателей вирусов закрыть уши!) могут служить полости в загружа-

емом сегменте BIOSа - файле IO.SYS MS DOS (или IBMBIO.COM для PC

DOS). В этом случае при запуске операционной системы управление

сначала будет передано вакцине и лишь после ее отработки - ДОСу.

Преимущества выполнения вакцины до передачи управления операцион-

ной системе очевидны:

     - вирус может быть пойман "на горячем" - Int13 будет указы-

вать в занятую вирусом область памяти;

     - возможна полная "стерилизация" резидентного вируса путем

восстановления истинных взятых из ROM-BIOS значений перехваченных

вирусом векторов прерываний;

     - вирус нейтрализуется еще "тепленьким" - не вооруженным ап-

паратом функций ДОС и ни разу не получившим управления, что зна-

чительно снижает опасность поражения файловой системы;

     - отпадает необходимость в хранении эталонной копии BOOT-

сектора, так как образ "здорового" загрузчика к моменту выполне-

ния вакцины еще находится в памяти;

     - наконец, не расходуются дополнительные ресурсы оператив-

ной и дисковой памяти.

     Основной недостаток подобной вакцины - немобильность, т.е.

привязка к конкретным версиям ДОС и ROM-BIOS, но он может быть

преодолен путем использования инсталлирующей программы, учитыва-

ющей некоторое разнообразие версий операционной системы и вариан-

тов загрузчиков. Однако, при разработке вакцины, размещаемой в

файле IO.SYS, возникла проблема определения местонахождения здо-

ровой копии загрузчика в памяти. Дело в том, что вирусы не ут-

руждают себя переносом настоящего загрузчика в нулевой сегмент

ОЗУ, а при запуске загружаемого фрагмента BIOS'а сегментный адрес

загрузчика будет потерян. Еще большей неприятностью оказался тот

факт, что некоторые загрузчики при выполнении затирают 11 байт в

области своей программы. Все это привело к необходимости размеще-

ния вакцины или ее фрагмента в загрузчике. Для этой цели была

создана оригинальная программа загрузки, которая при том что она

в два раза короче стандартных загрузчиков, во-первых, работает, а

во вторых, универсальна, т.е. пригодна для загрузки любого из-

вестного варианта ДОС. Единственным ограничением оказалось ис-

пользование нового загрузчика с DR DOS, так как эта операционная

система использует хитрый загрузчик, позволяющий размещать сис-

темные файлы в любом месте диска. Но при соблюдении принятого в

MS DOS правила размещения системных файлов в самом начале диска,

новый загрузчик справляется и с DR DOS'ом.

     Освободившиеся в ВООТ-секторе место (около 200 байт) было

отведено вакцине. Желание избежать кропотливой работы по изуче-

нию способов внедрения вакцины в различные варианты файлов

IO.SYS, IBMBIO.COM и DRBIOS.COM заставило меня поместить всю

программу вакцины в загрузчик. В этом случае можно предовратить

перенос вирусов и несистемными дискетами. Но при вакцинировании

дискет возникает проблема о преодолении немобильности вакцины.

К счастью, фирма IBM и другие зарубежные разработчики ПЭВМ поза-

ботились об этом, используя для большинства прерываний стандарт-

ные точки входа в ROM-BIOS и к тому же разместив в ПЗУ таблицу с

адресами этих точек (к сожалению, эта благодарность не относится

к разрабочикам BIOS отечественных ПЭВМ - так в "Нейроне" исполь-

зован свой адрес обработчика Int9, а в ЕС-1840 кроме использова-

ния своих точек входа для трех прерываний, умудрились исковер-

кать содержащую адреса этих точек таблицу). Тем не менее выбран-

ный для вакцины перечень контроллируемых прерываний позволяет ей

работать на всех известных мне типах ПЭВМ. Особо следует отме-

тить преодоление немобильности, связанной с нестандартным адресом

обработчика Int13 для жестких дисков. Этот адрес определяется на

этапе инсталляции вакцины на жесткий диск и сохраняется в соот-

ветствующем месте программы. Для гибких дисков используется стан-

дартная точка входа F000:EC59. В настоящей версии вакцины выпол-

няется контроль прерываний Int8, Int13 и Int1С, но при необходи-

мости можно будет добавить фрагмент контроля еще одного вектора.

     Рассмотрим подробнее функционирование бутовой вакцины, полу-

чившей название "ВИТАМИН-Б". Вакцина состоит из инсталлирующей

программы VITAMINB.COM и двух формируемых ею фрагментов внедряе-

мых на место системного загрузчика и в MBR-сектор жеского диска.

     При инсталляции идентифицируются версия операционной системы

и информация в существующем загрузчике. При обнаружении неизвест-

ной версии ДОС или некорректного загрузчика выводится предупреж-

дающее сообщение (рекомендуется проверить неопознанный загрузчик

на возможное наличие вируса). Полученые сведения вместе со адре-

сом обработчика тринадцатого прерывания сохраняются в новом вак-

цинированном загрузчике или MBR.

     Процесс заражения вакцинированного диска бутовым вирусом ни-

чем не отличается от заражения обычных дисков - вирус переносит

содержимое BOOT-сектора в свободное место диска, а на место за-

грузчика помещает свое тело.

     При загрузке зараженной системы первой получает управление

находящаяся в BOOT-секторе программа инсталляции вируса, при этом

будет перехвачено прерывание Int13 и,возможно, некоторые другие

прерывания. После этого считывается спрятанный вирусом BOOT-сек-

тор и следует нормальная загрузка ДОС, первой фазой которой будет

запуск вакцинированного загрузчика. Вакцина первым делом нейтра-

лизует вирус, восстанавливая важнейшие вектора прерываний. При

обнаружении следов работы вируса на экран выводится значение

векторов захваченных прерываний, после чего на экране появится

предупреждающее сообщение с предложеним о восстановлении загруз-

чика. При желании провести исследование вируса пользователь может

отказаться от удаления вируса и продолжить загрузку. В этом слу-

чае и в памяти и на диске останутся безобидные копии "стерилизо-

ванного" вируса. Заметим, что традиционный путь переноса бутовых

вирусов - загрузка с рабочей дискеты, "забытой" в дисководе А: -

будет блокирован, если все ваши дискеты будут предварительно

вакцинированы "ВИТАМИНОМ-Б".

     Аналогично работает вакцинированный MBR, с той разницей, что

для размещения программы вакцины все же пришлось использовать до-

полнительный сектор недоступной ДОСу нулевой дорожки. Это связано

с тем, что были обнаружены программы записывающие свою информацию

в свободную область MBR-сектора.

     Вакцина была успешно испытана на разных типах ПЭВМ с исполь-

зованием бутовых вирусов BALL, BRAIN/ASHAR, STONED и DISK KILLER.



     ЛИТЕРАТУРА:



1. Д.Стефанков. Пятница, 13-е.//Интерфейс.-1990.-N1.-С.38-40.

2. И.Ш.Карасик. Классификация антивирусных программ.//Интерком-

   пьютер.-1990.-N2.-С.40-45.

3. Ф.Н.Шерстюк. Вирусы и антивирусы на IBM-совместимых ПК.//Ин-

   теркомпьютер.-1990.-N2.-С.46-47.
