                       
		       
		       
		       
		       
		       
		       
		       
		       
		       
		       
		       
		       
               CHECK21 - резидентный фильтр,контролирующий
        изменение процедуры обработки прерывания 21h (функции DOS) -
                              версия 4.5
			      
			      
			      
	В данном руководстве приведено описание новых (по сравнению с
	версией 3.3) возможностей фильтра, а также полный набор сообще-
	ний программы .
	
	
	
	
	Для ознакомления с основными возможностями см. документацию по
	версии 3.3 ("Софтпанорама" No.1,1990)


.

                               - 2 -
  	                                          	      
                           Характеристики.
			   


	Размер на диске                   - 9180 б
	
	Размер резидента :
			   min            - около 8192 б
			   max            - около 56 к
	
	Максимальное количество записей 
                     таблицы в памяти :   - около 3330

	Количество свободных записей 
	таблицы в памяти после загрузки 
	программы :                       - 25 (если позволяют ограни-
	                                        чения на размер резидента)
					     
	Поддерживаемый файл               - \CHECK21A.DAT
	
	Максимальное количество разрешений
	на переустановку 21h вектора
	прерывания одной программой,
	устанавливаемое .DAT файлом       - 255
	
	Изменяемые прерывания             - 08h,20h,21h,27h,a3h
	
	
	
	
. 

                               - 3 -



                         Новые возможности.
			 
	Расширения этой версии относятся к двум направлениям :
	
		-  новые способы контроля
		
		-  обеспечение дружественной работы фильтра.
		
   В первом направлении сделаны довольно незначительные доработки,ка-
сающиеся контроля системного 21h прерывания (замечу,что местооположение 
системной процедуры обработки 21h прерывания меняется как для разных
машин, так и для разных версий DOS).

   Данная версия фильтра контролирует системную процедуру 21h прерыва-
ния для версий DOS :
                    3.10,3.30,4.00
		    


   Более значительная работа проделана во втором направлении.
Именно благодаря этому размер программы вырос до 9 к.Мне остается на-
деяться,что Ваше неудовольствие ростом размера программы будет пропор-
ционально удовлетворению от работы с новыми возможностями сервиса.

   Отныне фильтр поддерживает сопутствующий файл данных CHECK21A.DAT
(должен содержаться в корневом каталоге).
   Файл данных хранит список названий программ,для которых доподлинно
известно,что они переустанавливают 21h вектор прерывания через 25h 
функцию DOS.
   Можно указать и количество таких переустановок.
   Одной программе в файле отводится одна или две строки.В первой 
строке указывается название файла (с расширением).Должны использо-
ваться ТОЛЬКО ЗАГЛАВНЫЕ БУКВЫ.
   Если следующая строка имеет первый значимый символ '/',то она 
используется для указания количества разрешений переустановки 21h
вектора программой,определенной в предыдущей строке.
   В противном случае принимается умалчиваемое значение 1 и текущая   
строка считается строкой определения названия следующей программы.
   После '/' должны следовать 3 цифры - они определяют число - количество
разрешений переустановки.
   В качестве разделителей приняты следующие символы :
   
   1) пробел (20h)
   2) переход на новую строку : возврат каретки,перевод строки (вместе)
      - 0dh,0ah
   3) конец файла (1ah)
   
   Для дальнейшего удачного автоматического добавления строк,файл 
      должен оканчиваться следующими 3 байтами :
      0dh,0ah,1ah (переход на новую строку и конец файла).
      
  
. 
                               - 4 -  
      
      
      
   Пример файла CHECK21A.DAT :
   
VIRBLOCK.COM
EXAMPLE.EXE
/255
/201
<EOF>            
   		    
   Это означает,что программе VIRBLOCK.COM разрешена 1 переустановка,
программе EXAMPLE.EXE - 255 переустановок,программе /201 - 1 переуста-
новка.
   Такой файл используется в процессе загрузки фильтра для заполнения 
таблицы в памяти.Каждая строка таблицы имеет длину 13 байтов :
12 байтов - название файла (пробелы справа) и 1 байт - количество
разрешений на переустановку - отсюда и ограничение на максимальное их
число - 255.
   Программа имеет возможность пополнять как файл данных,так и таблицу
в памяти.Для этого в резиденте оставляется место для 25 строчек табли-
цы - 325 байтов.Вряд ли за 1 сеанс работы у Вас появится больше 25 но-
вых программ,изменяющих 21h прерывание через 21h функцию DOS.
   Для проведения точной проверки введена некая стековая структура,
немного изменены функция DOS EXEC (что не понравится программе AIDSTEST),
функции DOS и прерывания (20h,27h),отвечающие за прекращение программы.
   Зато это помогло избежать неоднозначностей,возникающих при запуске
процессом-отцом процесса-сына, даже если процесс-отец в любой момент за-
пускает самого себя и имеет официальное разрешение на некоторое коли-
чество переустановок 21h прерывания.
   Глубина стека - 10(10 поколений).
   
                         Борьба CHECK21 и CE1800R.
		       
   После замечания жюри конкурса антивирусных программ мною еще не один
раз была проведена проверка CHECK21 на вирусе "Черный мститель".И ни разу
полный "отбор" прерывания не наблюдался.
   Более того,именно CHECK21 помог мне избежать эпидемии вируса "Черный
мститель".Вирус находился в рекламном мультфильме в файле с нестандартным
расширением (.PDR,система построения мультфильмов "Story board",запуск
из небольшого EXE-файла выполняемого файла с расширением .PDR).
   Многие детекторы,например SCAN,не сканируют файлы с нестандартными
расширениями.
   CHECK21 выполняет наиболее важные проверки в 08h прерывании (таймер).
В 21h прерывании выводятся сообщения,в нем также выполняется процедура
"всплытия".
   "Черный мститель" использует для всплытия 27h прерывание,частота вы-
зова которого несравненно меньше.
   Поэтому время незамеченного пребывания CE1800R наверху ограничивается
промежутком между двумя вызовами прерывания 08h - около 0.05 сек.Только
одно следующее 21h прерывание может быть использовано вирусом для не-
санкционированных действий.
   Причем,в этом же прерывании при попадании на участок CHECK21 будет
выведено сообщение и,при правильной реакции пользователя,участок вируса
в 21h прерывании будет нейтрализован.


. 
                               - 5 -


               Замечание по использованию файла исключений.     


   В случае заражения программы,которая указана в файле исключений,несо-
ответствие количества реально сделанных переустановок с числом,указанным
в файле,будет выявленно и появится сообщение весьма грозного характера.
   И это неудивительно,ведь большинство известных вирусов получают первыми
управление и делают "легальную" - с точки зрения проверки - переустановку.
   Лучшее,что можно сделать при появлении такого сообщения - выполнить 
перезагрузку чистой системы и "проинспектировать" подозрительные файлы.


                            Перспективы.     
			    
   В ближайшем будущем появится поддержка еще одного файла данных -
CHECK21B.DAT - для программ,которые меняют вектор прерывания прямой
записью.Возможно улучшение контроля системной процедуры обработки пре-
рывания 21h.


.
                               - 6 -      
			    
                         Сообщения программы.   
			 
			 

   При запуске резидента добавлен вывод сообщения о количестве строк,
сформированных для таблицы в памяти.При обнаружении любой дисковой ошиб-
ки,формируется сообщение "Disk error".

   Более подробно о сообщениях резидента : 

1.   При поступлении запроса на переустановку 21h вектора прерывания 
  через 25h функцию DOS формируется меню на 4 пункта с сообщением :
  
  "About to change 21h interrupt vector (DOS Fn 25h) File :название"
  
   4 пункта следующие :
   
   a) "Allow" - просто разрешить переустановку;
   
   b) "Ban & terminate" - запретить переустановку и прекратить выполнение
      текущей программы;
      
   c) "Ban & not terminate" - запретить переустановку,но не прекращать
      выполнение текущей программы;
      
   d) "Allow & save filename" - разрешить переустановку,пополнить как
      таблицу в памяти,так и файл CHECK21A.DAT.
      
     Если выбран 4 пункт меню,формируется новое сообщение :
     
   "Current drive :x.CHECK21A.DAT must be in current drive (root 
    directory).Press letter key to change letter drive,'Enter' to save,
    'Esc' to cansel."
    
    Нажав допустимую букву,Вы поменяете текущее устройство.Появится 
    новое сообщение :
    
    "Current drive :x.Press 'Enter' to save,'Esc' to cansel."
    
    Это позволит сделать текущим диск с файлом CHECK21A.DAT в корневом
    каталоге.
    Заметьте : менять текущее устройство можно лишь 1 раз.
    Но нажав 'Esc',можно вернуться в меню,предварительно восстановив
    содержимое дисковых устройств (если менялись дискеты).
    В этом случае формируется специальное сообщение :
    
    "Now restore contents of disk drives and press 'Enter'"
    
    Это сообщение формируется также после работы резидента с файлом 
    данных.
    
    
    
.
                               - 7 -
    
    
    Работа резидента с файлом данных и с таблицей в памяти может давать
    разные результаты.
    Это отражено в следующих сообщениях :
    
    "No free disk space to update CHECK21A.DAT"
    
    "CHECK21A.DAT file was updated succesfully."
    
    "Disk error.Press 'R' to retry ,'C' to create new CHECK21A.DAT,
      'Enter' to save filename to memory table ,'Esc' to canscel"
    
    "Memory table is full."
    
    "Memory table was updated succesfully."
    
2.   Следующее сообщение информирует об изменении 21h вектора прямой
   записью.
   
   "ATTENTION ! INT21H was changed without your allowance.Press 'Enter'
    to reset your interrupt vector."
    
    Именно это сообщение выводится при борьбе с вирусом CE1800R.

3.   Остальные сообщения - сообщения тревоги :

   a) "BE VERY CAREFULL ! 21h interrupt procedure was changed by 
       direct writing of instructions.Now interrupt procedure
       was restored.Press 'Enter' to continue."
    
   b) "ATTENTION ! Current prefix of INT21H hasn't 4-byte address of 
       old int21h procedure.That's why int21h was reset to previous
       address.Press 'Enter' to continue."
       
   c) "ATTENTION ! 21h interrupt vector was changed,but before CHECK21-
      INT-prefix call was restored to previous value.Press 'Enter'
      to continue."
      
   d) "With great probability you have an active virus in memory.
       The best way is to restart your computer."
       
   Последнее сообщение выводится при обнаружении превышения количества
   реально сделанных переустановок 21h вектора прерывания через 25h 
   функцию DOS над декларированным количеством,записанным в таблице в
   памяти.
   
   
   
   Надеюсь,CHECK21 будет Вашим надежным помощником в борьбе с вирусами.

   Свои замечания по работе фильтра Вы можете сообщить по телефону
   517-02-05 (суббота,воскресенье).
   
   
   Двоеглазов Игорь                                          24.03.90
       














