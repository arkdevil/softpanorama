
  ▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒

                             KEYMAC -
              резидентный драйвер клавишных макросов
                с довольно широкими возможностями
        и претензией на универсальность (не без оснований)

                      Версия 2.34, 03.06.93.


 ╔═════════ S H A R E W A R E ═════════════════════════════════╗
 ║    Эту программу можно свободно копировать и передавать при ║
 ║ условиях, что программа распространяется в оригинальном ви- ║
 ║ де и из распространения не извлекается коммерческая выгода. ║
 ║ Вы можете использовать эту программу бесплатно в течение 2  ║
 ║ недель, после чего, если хотите продолжать ею пользоваться, ║
 ║ передайте или перешлите регистрационный взнос в размере     ║
 ║ указанной ниже суммы по адресу:                             ║
 ║ 274006, г. Черновцы, ул. Рязанская, 24, кв.4 Юцису М.С.     ║
 ║ Сумма регистрации: до 1 авг. 1993 г. - 400 укр. крб. (или в ║
 ║ рублях - по курсу), после 1.8.93 - $5, или в крб. (рублях)- ║
 ║ эквивалентная 1/8 доллара по текущему курсу. :-)            ║
 ║ Для коммерческого использования связывайтесь с автором.     ║
 ╚═════════════════════════════════════════════════════════════╝



                            В него можно положить что хочешь.
                            Это Очень Полезная Вещь.

                                           Один известный Медведь




   ОЧЕНЬ СОВЕТУЮ ПРОЧИТАТЬ ИЛИ ПРОСМОТРЕТЬ ЭТОТ ТЕКСТ ДО КОНЦА,
           ЧТОБЫ ИСПОЛЬЗОВАТЬ ВСЕ ВОЗМОЖНОСТИ ПРОГРАММЫ


                             Пролог.

     Многие программы (MultiEdit,  Лексикон,  Turbo Debugger 2.0 и
т.п.) позволяют запоминать последовательность нажатий клавиш и вы-
зывать ее одним нажатием клавиши или "аккорда".  Увы, такие редак-
торы,  как встроенный в Norton Commander, QuickC, Sidekick и т.д.,
этого не могут. Кроме того, многие редакторы (даже Borland C++) не
поддерживают  расширенную  клавиатуру (F11,F12,  Ctrl-вверх/вниз и
т.п.).  Программа KEYMAC и сделана для того, чтобы "забивать" мак-
ропоследовательности под клавиши и перепрограммировать клавиатуру.
С помощью этой программы можно также  перепрограммировать  клавиши
для определенных программ, отключить (или переназначить) сочетания
типа Ctrl-Alt-Del или Ctrl-Break (но тогда вы лишитесь возможности
"теплой" перезагрузки или прерывания программы), ввести такие "эк-
зотические"    комбинации,    как    LeftAlt-RightAlt-Space    или
Ctrl-Alt-Ins,  и  даже выйти из положения,  если отказала жизненно
важная клавиша (у меня был такой случай с PgUp).  Можно  назначить
любой клавише и небольшую процедуру в машинных кодах. Макросы вво-
дятся через командную строку или из текстового файла в специальном
формате, а  также  находясь в любой программе - при нажатии специ-
альной клавиши "Определить макро" (так сказать, on-line).

    Достоинства:

    - В  отличие от подобных возможностей драйвера ANSI.SYS KEYMAC
оперирует более широким набором клавиш, а главное - ANSI действует
только на программы, работающие через DOS, а Norton Commander, как
и Quick C и большинство других программ, уже не реагируют на пере-
назначенные клавиши. KEYMAC же работает на уровне BIOS.
    - KEYMAC различает не только левый и  правый  Shift'ы,   но  и
Ctrl'ы и Alt'ы (на 101/102-клавишной клавиатуре). Причем делает он
это ненавязчиво (если не надо, то не различает).
    - Различает "серые" и "белые" стрелки, Ins, Home  и т.д.  (уже
"навязчиво"), правильно  обрабатывает SysRq и Pause с любыми соче-
таниями Ctrl, Alt, Shift.
    - Для  84-клавишной  клавиатуры может имитировать нажатие кла-
виш, которых там нет (F11 и F12, например), в том случае, конечно,
если это  "интересует" работающую в это момент прикладную програм-
му. Hапример, так:  Ctrl-Alt-F9 = F11,  Ctrl-Alt-F10 = F12. Таким
же макаром можно подменять неработающие клавиши.
    - Макросы можно неограниченно подгружать после первого запуска
(благодаря специальной организации управления памятью). Нормально
снимается программой RELEASE не только "целиком", но и "по частям"
при многократной загрузке в память.
    - Простой синтаксис  входного файла;  никакой  предварительной
компиляции.
    - Не так много места занимает в памяти (3.3К  без  самих  мак-
росов, а под DOS 3.xx - 3.8К). Для сравнения: подобная этой (но не
совсем) программа SMACS из пакета Turbo Professional  занимает 73K
памяти. Что-то я еще слышал о системах Borland SuperKey  и ProKey,
но, увы, только слышал.
    - Макросы  могут  автоматически  активизироваться  при запуске
программы, указанной пользователем (например, NCMAIN, LEXICON,QC),
быть активными во время ее работы и "спать",  когда  эта программа
не работает.  (См. раздел "Группы".) Можно одновременно определять
несколько таких групп. Группы можно активизировать и "вручную", по
горячей клавише, имея таким образом несколько раскладок клавиатуры.
    - Существует  возможность  создавать  собственные  макросы  на
ассемблере в виде кода,  который вставляется в макрос и на который
передается управление с возвратом.

    Недостатки:
    - Принципиально невозможно перепрограммировать "горячую клави-
шу" вызова многих резидентных pop-up программ,  таких как Sidekick
и т.п.
    - Макросы не вкладываются друг в друга. Поэтому в режиме запи-
си нажатий клавиш они не вызываются.
    - Нет "менюшного" интерфейса (впрочем, это - дело вкуса).
    - И другие мелочи, которые я еще, наверно, не выявил.


                   Действие I. Макроопределения.

    KEYMAC загружает из файла или прямо из командной строки макро-
определения (это "пакетный режим"). Они имеют вид:

<левая_часть>  <правая_часть>

    Начнем с примера:

<csP>  pkunzip <cEnter><Enter>

    означает, что при нажатии комбинации клавиш Ctrl-Shift-P  (лю-
бой  Ctrl-любой  Shift-P)  имитируется  набор  на клавиатуре слова
"pkunzip "  с  пробелом  на  конце,   затем    нажатие   сочетания
<Ctrl-Enter>, что соответствует в Norton Commander'е передаче име-
ни файла из-под курсора в командную строку, и клавиши Enter.

    В  начале  строки может быть один или несколько пробелов и/или
табуляций. Между левой и правой частями должен быть  хотя бы  один
пробел (табуляция).

    Левая часть  описывает  "горячую клавишу" вызова макро и имеет
вид:
     <[префикс]клавиша> .

     Префикс обозначает нажатие клавиш  Ctrl,  Shift,  Alt  (далее
shift-клавиши)  и  состоит  из  букв  c,s,a  (соответственно Ctrl,
Shift, Alt) и/или сочетаний lc, rc, ls, rs, la, ra (l - left - ле-
вый, r - right - правый).
    "Клавиша" - это или любой ASCII-символ с кодом от 32  (пробел)
до 126 (~), или название специальной клавиши: Tab, Esc, Ins и т.д.
Список всех этих названий выводится с помощью ключа /?? (можно пе-
ренаправить вывод в файл). (Подробнее см. раздел "Параметры".)
    Названия можно усекать до трех первых букв (или больше), кроме
тех,  что  начинаются  на  "Grey":  их  можно усекать до семи букв
(трех,  не считая "Grey").  Верхний/нижний регистр в названиях  не
различаются. Можно писать и "Gray" по-американски :-).
    Названия взяты в основном из Multi-Edit.

    Кроме названия клавиши, можно поставить на это же место число-
вой сканкод клавиши. (Программа считает его кодом, а не названием,
если он начинается с цифры.) Это полезно для клавиатур, на которых
есть нестандартные клавиши,  напр.,  "Macro".  Автору клавиатуры с
"Macro" еще,  к сожалению,  не попадались. Могу назвать клавиатуры
от ЕС-1830 (клавиши "ИНФ" и "РУС/ЛАТ"), "Искры" ("РУС/ЛАТ" и др.),
NEC MultiSpeed (клавиши "Help" и "PopUp"). Код может быть десятич-
ным (начинается с цифры, но не 0), шестнадцатеричным (начинается с
"0x") и восьмеричным (начинается с 0).  Так, клавиша "Macro" имеет
код  <0x6f>,  или  <111>.  Для определения кода клавиши есть много
разных программ; здесь помещена моя программа INT9.COM.
    Примечание: сканкоды  от  0x80  (128) до 0xFF (255) ставить не
рекомендую.  Они _не_ будут восприниматься  как  обозначающие  от-
пускание клавиши, а будут означать, что перед соответствующей кла-
вишей (сканкод минус 128) должен генерироваться код e0 (как у "се-
рых стрелок" и т.п.). Эта их обработка может в будущих версиях по-
меняться.

    В префиксе  буквы  могут  сочетаться любым образом.  Например,
<laraZ> означает "левый Alt-правый Alt-Z",  <rslcGreyUp> - "правый
Shift- левый Ctrl-серая стрелка вверх" (на 101-клавишной клавиату-
ре). Если нет букв l и r, то это значит "любой": <caZ> сработает и
при нажатии левых Ctrl-Alt, и правого Ctrl-левого Alt и т.д.

    Примеры "горячих клавиш":
    <cae> или <acE> = Ctrl-Alt-E
    <c >  = Ctrl-Пробел
    <cent> или <center> или <cEnter> = Ctrl-Enter

    Правая часть описывает макропоследовательность, которую KEYMAC
будет  порождать при нажатии "горячей клавиши". Она состоит из це-
почки, в которую входят:

    1) ASCII-символы: любые, кроме ASCII 0 (NUL), ASCII 13  (возв-
рат  каретки CR) и ASCII 10 (перевод строки LF), а также специаль-
ного символа '<'. (Символ '>' может входить.)

    2) Названия клавиш и "аккордов", взятые в скобки <>. Это могут
быть: символьные клавиши, специальные клавиши  и  их  сочетания  с
shift-клавишами аналогично левой части, только буква (c,a,s) может
быть  только  одна, и буквы l и r не допускаются. Чтобы включить в
макрос специальный символ '<', его надо взять в скобки: <<>.
    ( Примечание: ASCII-символы вне скобок трактуются как не имею-
щие сканкода,  т.е.  как бы набранные на цифровой клавиатуре с по-
мощью клавиши Alt. Это редко бывает важно, но если почему-либо они
не  будут восприниматься,  то следует каждый из них взять в скобки
<>, тогда у них будет сканкод. )
    У всего,  что  находится  в  угловых  скобках <>,  прописные и
строчные буквы НЕ РАЗЛИЧАЮТСЯ.

    3)  Специальные  клавишные  команды,  такие как "Начать запись
макроса", "Отключить KEYMAC" и др. Подробнее см. в разделе "Коман-
ды".

    Пример макропоследовательности:

    #include <<>.h><lf><lf><lf>

набирает текст "#include <.h>" и  три  раза  левую  стрелку,  т.е.
устанавливает курсор на точку, чтобы далее вставить имя файла.

    Особенности:

    - При  вызове  макроса  с  несколькими shift-клавишами (напр.,
Ctrl-Alt-P) не рекомендуется эти клавиши (в примере  Ctrl  и  Alt)
нажимать "слишком одновременно",  т.к. есть шансы, что одна из них
не успеет обработаться. Требуемый интервал между ними ничтожен, но
не бесконечно мал. И уж, конечно, основная клавиша (в примере "P")
должна быть нажата после shiftов.

    - На результат вызова макро не влияет текущее состояние перек-
лючателей CapsLock, NumLock, ScrollLock, если прикладная программа
сама их не проверяет.

    - Код, соответствующий расширениям 101/102-клавишной клавиату-
ры ("серые" стрелки и т.п.),  вырабатывается только  тогда,  когда
прикладная программа запрашивает соответствующую расширенную функ-
цию прерывания BIOS INT 16 (т.е.,  если программа "хочет" получить
такой код), в противном случае вместо кодов "серых" клавиш выраба-
тываются коды "белых".  Это не касается лишь F11, F12 и их сочета-
ний с shift'ами и некоторых других сочетаний клавиш.  (Точнее -  у
которых код, возвращаемый расширенной функцией, не содержит E0.)

    - В качестве основной  "горячей  клавиши"  можно  использовать
также и сами shift-клавиши (указав Lf-левый, Rt-правый). При этом,
если есть еще и префикс, то клавиши из него должны нажиматься пер-
выми.  Например,  для  комбинации <laRtAlt> надо,  удерживая левый
Alt,  нажать правый,  а не наоборот (конечно,  вы можете при  этом
ввести макро и с сочетанием <raLfAlt>).  Для этого случая названия
shift-клавиш тоже выдаются по вызову "KM /??" .  Они НЕ такие, как
в префиксе.

    - При повторном определении макроса под той же клавишей в  той
же группе - старый стирается. (О группах см. ниже.)

    - При отсутствии правой части (т.е.,  "пустой макрос") нажатие
"горячей клавиши" (указанной в левой части) просто ничего не выра-
батывает,  и данная комбинация "забивается" (в т.ч. Ctrl-Alt-Del и
т.п.).

    - Из-за возможности сокращений в двух случаях могут быть  нак-
ладки: <caP>,  т.е. Ctrl-Alt-P, воспримется как <CapsLock>, сокра-
щенный до трех букв. То же для Shift-Ctrl-R - <scR> -<ScrollLock>.
В этих случаях используйте соответственно <acP> и <csR>.

    - Максимальная длина макроса - 255 нажатий клавиш.


                     Действие II. Группы.

     Группа - это несколько макросов, которым присвоено общее имя.
Это имя подчиняется такому же синтаксису, как имена файлов ДОС без
расширений (8 символов и т.д.).  Макросы, включенные в группу, ак-
тивны (включены) во время работы программы с таким же именем,  как
имя этой группы (точнее - когда эта программа является для DOS те-
кущим процессом),  и "спят" (игнорируются) во все остальное время.
Например, если макросы включаются в группу NCMAIN, то они срабаты-
вают  только  во время работы Norton Commander.  Если запустить из
"Нортона" программу (напр., редактор),  то эти макросы "засыпают",
пока нортон снова не получит управление.

    Включаются макросы в группу с помощью ключа  командной  строки
/gd (Group Define). Подробнее см. раздел "Командная строка".

    Если при запуске имя группы не указывается, то макросы включа-
ются в  так называемую общую группу,  или безымянную,  или фоновую
(как вам больше нравится).  Эта группа активна ВСЕГДА наряду с те-
кущей группой. При наличии одного и того же макроса и в фоновой, и
в текущей группе срабатывает тот из них, который был запущен ПОЗЖЕ.

    Любую группу  можно  включать  и выключать "вручную" (принуди-
тельно): из командной строки (ключ /gf или /g+)  или  по  "горячей
клавише" (когда  в макросе встречается команда <Group имя> ).  Имя
группы может и не совпадать ни с каким именем запускаемой програм-
мы. Тогда она включается только вручную. Можно определить несколь-
ко таких групп и переключаться между ними по горячим клавишам: по-
лучается многофункциональная клавиатура!


                 Действие III. Командная строка.

    В командную строку можно помещать в любом порядке:
    - макросы,
    - имена входных файлов,
    - параметры (ключи), которые начинаются с символа '/' или '-'.
    Все это разделяется пробелами.
    В  командной строке и в файлах все ключи и макросы обрабатыва-
ются по очереди.

    При запуске  без  параметров   программа   обрабатывает   файл
KEYMAC.KMC в текущей директории или в директории,  указанной в пе-
ременной окружения KMCPATH,  а если его не находит - выдает справ-
ку.  При повторном запуске  (если  KEYMAC  уже  резидентный)  файл
KEYMAC.KMC ищется только в текущей директории.

    Макроc в командной строке имеет вид, описанный в первом разде-
ле.  Он должен быть заключен в кавычки "". Обычно удобнее все мак-
росы загружать из файла.
    Входной файл может содержать все то же, что и командная  стро-
ка.  Каждое  макро  должно  находиться  в отдельной строке. Пустые
строки игнорируются. Макросы в файле  НЕ  заключаются  в  кавычки.
Каждый  ключ тоже должен быть в отдельной строке. Как частный слу-
чай ключа, может стоять комментарий (см.  ниже).  Можно  также  из
файла вызвать другой файл, в этом случае обработка происходит так,
как  если  бы текст второго файла был вставлен на месте строки его
вызова. Рекомендуется использовать в этом случае ключ /f, чтобы не
путать вызов файла с макросом (программа пытается обработать стро-
ку как макро, если находит в ней пробел).

    Максимальная длина строки во входном файле - 2047 символов.
    Если в имени файла не указано расширение, то по умолчанию  да-
ется  .KMC. Если не указан путь (path) и диск, то файл ищется сна-
чала в текущей директории, потом в списке директорий, указанном  в
переменной  окружения KMCPATH, если таковая имеется, потом в своей
собственной, откуда запускался KEYMAC.

               Параметры (ключи) командной строки:

/? или ? или любой недействительный параметр -
             Выводит справку о командной строке, кроме групповых
             ключей.
/g?          Выводит справку по групповым ключам.
/??          Выводит список всех принятых названий клавиш и команд.
          Пояснение к списку:
              <Cntr> - center - "пятерка" на доп. циф. клавиатуре;
              <Bs> - backspace - забой ("пробел назад");
              <Rt> - right, <Lf> - left, <Dn> - down, <Up> - up -
              - стрелки соответственно вправо, влево, вниз и вверх.

/fфайл       (File) Обрабатывает файл с указанным именем, как описано
                    выше.

/d клавиша[,группа]
            (Delete) Удаляет указанный макрос,  если  он  есть,  и
            освобождает память.  Если группа не указана, то макрос
            ищется в общей (безымянной) группе. Параметр "клавиша"
            - это  клавиша вызова,  стоящая в левой части макроса,
            но без угловых скобок  <>.  Параметр  "группа"  -  имя
            группы. Регистр значения не имеет.
                В командной строке пробелов после d и запятой быть
            не должно. В файле можно ставить пробелы (табуляции).
                Вместо любого параметра можно  ставить  звездочку,
            означающую "все":  все  макросы  указанной  группы или
            макрос под указанной клавишей из всех групп.
                Примеры:
                              km /dcsp
                - удалить  макрос  <csP>  (CtrlShift-P)  из  общей
            группы.
                              km /dax,qc
                - удалить макрос <ax> (Alt-X) из группы QC.
                              km /daf10,*
                - удалить макросы Alt-F10 из всех групп. (Звездоч-
            ку удобнее набирать вместо имени,  поэтому можно  этим
            пользоваться для удаления конкретного макроса, если он
            есть только в одной группе.)
                              km /d*,ncmain
                - удалить  все макросы из группы NCMAIN.  При этом
            группа по-прежнему определена, хоть это и бесполезно.

            При удалении группы макросов (указана звездочка) выво-
       дится информация о количестве фактически удаленных макросов.

/s         (Status) Выводит информацию о текущем статусе, а именно:
             - количество резидентных порций KEYMAC;
             - количество загруженных макросов;
             - количество определенных групп;
             - объем свободной памяти для макросов (ранее зарезерви-
            рованной по ключу командной строки /m) - суммарный и
            максимальный объем непрерывной области;
             - состояние   параметров-переключателей  /b,  /i,  /w
             (см.ниже).

/l         (List)  Выводит  список  всех загруженных на данный мо-
             мент макросов.  Вывод  делается  в  формате,  который
             KEYMAC "переваривает": его можно перенаправить в файл
             и оттуда загружать (удалив первые строки).
/lg[имя]   (List Group) То же, но только из указанной группы. Если
             имя не указано, то обрабатывается только общая группа.

/lk клавиша[,группа]
           (List Key) Выводит список макросов, назначенных данной
             клавише. Синтаксис клавиши и группы - такой же, как в
             параметре /d.  Если у клавиши нет префикса,  то выво-
             дятся макросы для всех  префиксов,  если  есть  -  то
             только для заданного.

     Параметры /l и /s дают информацию  только  о  резидентных
кусках. Если вы попробуете, например, такой вариант:
     km  bc /l /s
то файл bc.kmc загрузится, но в выводе информации это не будет от-
ражено.

/m[n]       (Memory) Резервирует место в памяти для помещения туда
                 макросов в будущем.
                 При каждом запуске, если требуется определить но-
                 вые макросы, KEYMAC оставляет резидентный кусочек
                 с  этими  макроопределениями.  При этом к тому же
                 тратится лишняя память на PSP и  окружение.  Если
                 же в памяти для макросов уже было выделено место,
                 то макросы помещаются туда,  и новый  резидентный
                 кусок не создается.
                     Резервирует n байт памяти.  Для справки: одно
                 макроопределение занимает  (6+2*n) байт,  где n -
                 число нажатий клавиш в нем.
                     Реально резервируемое число может быть больше
                 указанного.  Это иногда происходит,  когда KEYMAC
                 видит, что остается свободная память в PSP, кото-
                 рая все равно пропадает.
                     В ранних версиях  программы  этот  ключ  имел
                 другой вид,  который здесь НЕ описывается. Но для
                 совместимости  программа  его  тоже  воспринимает
                 (если внутри параметра n есть запятая).

/n          Не использовать ранее выделенную память.При этом также
                 не проверяется  наличие  ранее  загруженных  мак-
                 росов,  и  все  новые макросы загружаются в новый
                 участок памяти.
                     Это полезно,  например,  если 1-й раз  KEYMAC
                 загружается  с  резервированием памяти,  а во 2-й
                 раз подгружаются макросы из файла,  и вы не хоти-
                 те, чтобы они заняли ранее отведенное место.

/q         (Quiet) Подавляет вывод всех сообщений, кроме сообщений
                 об ошибках. Полезно, если KEYMAC загружается из
                 CONFIG.SYS.   "km /q"  эквивалентно  "km >nul" .

/off или /-  Выключает KEYMAC.
/on  или /+  Включает его обратно. См. также команду <Toggle> в
             разделе "Команды".

/r или /r+   Переключает на вывод русских сообщений (по умолчанию-
             английские). Действует только во время этого запуска.

/r-          Отключает параметр /r, напр., если он был задан в пе-
             ременной окружения KEYMAC

/b или /b-   Отключает некоторые звуковые сигналы, которые могут
             показаться назойливыми
/b+          Включает их обратно

    Следующие два параметра можно включать или выключать не только
из командной  строки,  но и прямо из текста макро (по ходу его вы-
полнения) при помощи команды <Option> (см. раздел "Команды").

/w или /w+   Включает  режим  совместимости  с   командами   стиля
             WordStar типа  Ctrl-K-B,  которые  есть  в редакторах
             Sidekick, QuickC,  TurboC,  Borland C++ и др.
       Дело в том, что в таких командах при быстром нажатии второй
             клавиши ('B') можно оставить нажатым Ctrl, и если су-
             ществует  макрос  KEYMAC  под клавишей Ctrl-B,  то он
             сработает, хотя его никто об этом не просил. Поэтому,
             когда /w включено, то: если нажимается какая-либо кла-
             виша,  кроме shift-клавиш,  то программа считает, что
             эти  клавиши  немедленно отпускаются (т.е.,  обнуляет
             "shift-статус").  Таким образом,  перед вызовом макро
             все клавиши должны быть отпущены.
/w-          Отключает режим WordStar-совместимости.

/i или /i+ (Interrupt) Включает режим работы напрямую через преры-
             вание INT 16h,  а  не через буфер клавиатуры.  Иногда
             прикладная программа очищает буфер, а потом ждет кла-
             вишу. Тут-то мы ей и подсовываем очередную клавишу из
             макроса.  Рекомендуется включать этот параметр, когда
             видно,  что выполнение макроса обрывается,  не доходя
             до  конца.  В  этом  случае  рекомендуется вставить в
             текст макро команду <Option i+> и в конец- <Option i->.

/i-          Выключает параметр /i

        Работа через буфер (/i-),  вообще говоря, более корректна,
             а через прерывания (/i+) - часто  более  надежна,  но
             менее совместима.

/            (С пробелом, табуляцией или '/'.) Игнорируется.
//           В командной строке бесполезен, а в файле за ним может
                 следовать комментарий.

/k      (Keep) Сохраняет сегмент окружения ДОС, когда KEYMAC оста-
             ется резидентным. При этом, конечно, несколько увели-
             чивается объем занимаемой памяти.
                Это сделано  для  некоторых некорректно работающих
             программ.  Используйте, если при запуске ваша система
             зависает,  или  если  вы  хотите,  чтобы ваша любимая
             программа просмотра памяти (VTSR, -D3, PEEK) правиль-
             но  выдавала имя KM.EXE . (Другие программы и так его
             выдадут правильно.)

/u     (Unload) Выгружает KEYMAC из памяти (все порции) и
             восстанавливает прерывания, если это возможно.
      Этот параметр должен быть единственным в командной
      строке. В файл .kmc вставлять его нельзя.


                       Групповые параметры

/g?          Справка по групповым параметрам

/gd[имя] (Group Define)
                  Определяет группу с указанным именем. Все после-
             дующие макросы (только во время этого запуска KEYMAC)
             будут включены в эту группу, пока не встретится в ко-
             мандной строке или в файле ключ /gd с  другим  именем
             или без имени.  Если имя опущено,  то все последующие
             макросы включаются в общую группу.  Если имя уже было
             определено ранее   (напр.,  при  предыдущих  запусках
             KEYMAC), то новая группа не определяется, а последую-
             щие макросы будут включаться в эту ранее определенную
             группу.
             Если параметр,  указанный в /gd, не задан явно, то он
             действителен только на время текущего запуска KEYMAC.

                   Пример:  /gdNCMAIN

                В файле имя группы можно отделить пробелами, в ко-
            мандной строке - нельзя (пробел разделяет параметры).
                Регистр букв везде,  где указывается  имя  группы,
            роли не играет.
                При определении новой группы обязательно создается
            новая резидентная порция KEYMAC, даже если была свобо-
            дная зарезервированная память.

/gl      (Group List) Выводит список всех определенных групп

/gf[имя] или /g+[имя] (Force Group)

             Принудительно включает  текущей  группу  с  указанным
             именем. Она остается текущей,  пока не будет отменена
             командой /g- ,  или не будет  принудительно  включена
             другая группа.  При этом указанная группа должна быть
             уже определена.   Клавишная   команда  <Group  [имя]>
             (см.ниже) делает то же самое.
             Если имя  опущено,  то принудительно включается общая
             группа,  которая и так всегда включена.  На деле  это
             просто запрещает автоматическое включение групп, т.е.
             отключает макросы из  всех  групп,  кроме  безымянной
             (общей).

/g-          Отключает принудительную группу, т.е. возвращается в
             автоматический режим.


                 Действие IV. Клавишные команды.

    Наличие клавишных  команд  существенно  расширяет  возможности
KEYMAC. В том числе,  программой KEYMAC с помощью клавишных команд
можно управлять  с клавиатуры и "изнутри" макропоследовательности.
Если в тексте макропоследовательности встречается команда,  то она
выполняется  немедленно,  не дожидаясь,  пока прикладная программа
пожелает считать символ с клавиатуры.  Как в режиме /i,  так и /i-
команда выполняется только после того,  как  прикладная  программа
считает предыдущий  символ  или выполнится предыдущая команда.  (В
версиях до 2.30 это было справедливо только при /i.) Перед  коман-
дой  KEYMAC ждет,  пока не очистится буфер клавиатуры,  т.е.  пока
прикладная программа не обработает предыдущие  символы,  чтобы  не
нарушать порядок выполнения макроса. Это равносильно тому, что ко-
манда <Wait> (см. ниже) выполняется автоматически перед любой дру-
гой командой (но не клавишей).

    Имена команд, кроме тех, для которых есть одноименные клавиши,
нельзя, конечно,  использовать  как  "горячие клавиши" вызова мак-
росов в левой части макроопределения (ввиду отсутствия их на  кла-
виатуре).

    Команды (можно сокращать до первых трех букв):

    <NumLock>, <CapsLock>, <ScrollLock> -
делают те же переключения, что соответствующие клавиши.  Внимание,
пользователи  XT и PC: индикаторы ("лампочки") на вашей клавиатуре
программа переключать не может (это возможно на AT), поэтому лучше
эти команды на PC и XT не использовать, т.к. состояние индикаторов
не будет соответствовать действительности.
    Выполнение этих команд никак не влияет на восприятие клавиш  в
макроопределениях:       при      указании      последовательности
"asd<CapsLock>fghj" Вы увидите набранную строку "asdfghj" и  вклю-
ченный режим CapsLock (или выключенный, если он был включен).

    <Break>, <Pause> и <PrtSc> (PrintScreen) -
делают то же, что соответствующие клавиши. Можно  также  использо-
вать  в  качестве тех же команд сочетания <cBreak>, <cScrollLock>
(Break); <cNumLock> (Pause); <sPrtSc>, <sGrey*>, <sSysRq> (PrtSc).
     (Внимание: <PrtSc>  и  <Break>  нельзя  использовать  в левой
части макроопределения как "горячие клавиши", т.к. на 84-клавишной
клавиатуре  "PrtSc"  и "Break" написаны соответственно на клавишах
<Grey*> и <ScrollLock>, а на 101-клавишной клавиатуре - на <SysRq>
и <Pause>, так что используйте названия этих клавиш.)

    Особенность: при вторичном нажатии клавиши,  определенной  как
<Pause>, режим паузы отменяется,  в отличие от "настоящей" клавиши
Pause.

    <Beep> -
соответствует своему названию (подача звукового сигнала). Это вве-
дено на всякий случай.

    <Unbeep> -
бывает иногда полезно при "залипшем" звуке. Отключает звук (только
однократно при нажатии, а не насовсем).

    <Toggle> (переключатель) -
временно отключает KEYMAC (все макросы игнорируются),  а при  пов-
торном нажатии той же клавиши или комбинации - снова включает. При
этом подается звуковой сигнал:  нисходящий - выкл.,  восходящий  -
вкл. Опция /b (см.) отключает сигнал.

    <Record>  (записывать) -
команда немедленной диалоговой записи макро в "прозрачном" режиме,
т.е. нажатые при записи клавиши тут же передаются прикладной прог-
рамме. Для записи макро необходимо:
     1. Запустить KEYMAC заранее с параметром /m (см.) для  резер-
вирования памяти.
     2.  Для  записи  нажать определенную вами клавишу Record. При
этом подается  "двойной" звуковой сигнал (ключ /b его отключает).
Однотонный сигнал говорит об отсутствии места в памяти.
     3. Нажать клавишу, под которой вы хотите запомнить макро. По-
дается опять звуковой сигнал (тройной).
     4. Далее нажимать клавиши. Они  будут  запоминаться,  переда-
ваться программе, в которой вы находитесь, и сопровождаться корот-
ким звуком (не отключается ключом /b).
     5. По окончании  нажать  опять  ту  же  клавишу  (комбинацию)
<Record>.  Подается опять двойной сигнал, и теперь при нажатии оп-
ределенной вами  новой клавиши будет воспроизводиться эта последо-
вательность.
     Если сигнал раздастся раньше, то это означает "исчерпано мес-
то в памяти, запись прекращена".
     Ограничения:
     Таким путем нельзя  определить  макросы  под  shift-клавишами
(такие как, напр., <laRtCtrl>), т.к. при выполнении вышеописанного
пункта 3 программа,  учитывая нажатие shift-клавиш,  ждет  нажатия
"настоящей" клавиши.
     Нельзя также включить в записываемое макро ни одну из Команд,
описанных в этом разделе.
     Во время  записи  остальной KEYMAC отключается,  и макросы не
срабатывают.
     Макросы, введенные таким способом, включаются в ОБЩУЮ ("фоно-
вую") группу.

     <Reboot> (Перезагрузка) -
выполняет теплую перезагрузку (Ctrl-Alt-Del).

     <Unshift> -
имитирует отпускание клавиш  Shift,  Ctrl,  Alt  (сбрасывая  соот-
ветствующие  флаги  клавиатуры) для особо умных программ (Lexicon,
QuickC),  которые не только читают код  клавиши,  но  и  проверяют
состояние  клавиш  Shift,  Ctrl,  Alt (эти клавиши в момент вызова
макроса обычно нажаты).
     <Unshift n> , где 0<=n<=15 -
устанавливает флаги клавиатуры,  имитируя нажатие Shift, Ctrl, Alt
(хоть и называется UNshift).  "Нажатые" shift-клавиши как бы удер-
живаются до тех пор,  пока не поступит повторная команда <Unshift>
(без параметра  - сброс,  с параметром - переустановка флагов) или
не будет физически нажаты и отпущены соответствующие клавиши.  Так
что не забудьте сбросить флаги в конце макроса командой <Unshift>.
  Значение n:
     1 - правый Shift
     2 - левый Shift
     4 - Ctrl
     8 - Alt
     Можно имитировать одновременное нажатие этих клавиш, суммируя
соответствующие числа, только я не встречал программы, которой это
бы требовалось (кроме Quick C, где есть Ctrl-Shift-F1 и т.п.).

     <Group [имя]> -
принудительно включает группу с указанным именем, аналогично ключу
командной строки /gf или /g+.  Повторное нажатие этой же клавиши -
отключает принудительную группу (аналогично /g-).  Если имя опуще-
но, то работает аналогично /g+ без имени, повторное нажатие - ана-
логично /g-.

      <Option параметр> , параметр = {w|i}[+|-]
работает аналогично ключам /i и  /w.  Если  указан  '+',  параметр
включается (прямо на ходу при выполнении макроса),  '-' - выключа-
ется,  не указан знак - переключается в противоположное состояние.
Примеры:
     <Option w+>
     <opt i>
     В командной строке отсутствие знаков +/- имеет  другой  смысл
(см.)!

     <Wait> (Ожидать) -
приостанавливает выполнение макроса до очистки буфера,  т.е.  пока
прикладная программа не считает из буфера все клавиши,  которые мы
ей подсунули.  Затем возобновляет "генерацию" макроса.  Начиная  с
версии 2.30,  эта  команда  автоматически  выполняется перед любой
другой командой (но не клавишей).

     <NOP> (Нет операции) -
ничего не делает, но приостанавливает выполнение макроса до следу-
ющего обращения прикладной программы к 16-му прерыванию.  Примене-
ние - см. макросы для "Лексикона" в файле KEYMAC.KMC.

     <Disk> или <Drive> -
выдает букву текущего диска DOS в верхнем  регистре.  На  него  не
действует команда ASSIGN. Извините, работает только в MS-DOS 5.00!
(В бета-версии 6.00 - тоже.)

     <Dir> или <Path> -
выдает текущий каталог текущего диска DOS в  верхнем  регистре.  В
начале стоит '\', в конце - нет. Если текущий каталог корневой, то
'\' не выдается (т.е.  вообще ничего не выдается).  Таким образом,
макропоследовательность "<Disk>:<Dir>\"  всегда  будет  иметь  вид
"D:\DIR1\DIR2\". Извините, работает только в MS-DOS 5.00! (В бета-
версии 6.00 - тоже.)

     <Inline 'файл'>  или  <Inline список_байтов> -
вставляет в тело макроса машинный код. Когда KEYMAC при выполнении
макроса натыкается  на эту команду,  он передает управление на со-
держащийся в ней код (а код,  если хочет жить, должен в конце вер-
нуть управление KEYMAC :-).

     Это довольно мощная возможность,  но она ограничена тем, что,
как правило,  из этого  кода  нельзя  обращаться  в  ДОС:  макросы
действую независимо от ДОС и ее 28-го прерывания. Кроме того, раз-
мер кода не может превышать 508 байт.  Но  иногда  бывает  полезно
иметь под рукой горячую клавишу, которая что-то делает с дисплеем,
принтером, звуком, портами, BIOS и т.п.
    Теперь вам не надо специально  для  этого  писать  резидентную
программу с обработчиком клавиатуры, которая к тому же будет зани-
мать лишнюю память! Достаточно написать только ТЕЛО такой програм-
мы и подключить его к KEYMAC. Иными словами, вы своим кодом можете
непосредственно расширять KEYMAC.

    Команды <Beep>, <Unbeep>, <Reboot>, <Break>, <PrtSc> теперь
реализованы как  встроенные в программу inline-коды,  и если вы их
не используете, то память они не занимают.

    О правилах написания кода см. раздел "Программный интерфейс".

    В первой форме команды Inline указывается имя двоичного файла,
который при обработке этой строки с макросом целиком загружается в
память в тело макроса. Если расширения нет, по умолчанию ставится
.BIN .  Имя должно быть в апострофах или кавычках (если макрос оп-
ределяется в командной строке, то в апострофах, т.к. кавычка - это
конец параметра командной строки). Правый апостроф/кавычку ставить
необязательно.
               Пример:  <rarcT>  <Inline 'time'> .
    Программа ищет bin-файлы по тому же пути, что и файлы .kmc .

    Множество мелких bin-файлов  хранить  неудобно,  поэтому  есть
возможность вставлять код прямо в макрос в виде списка  шестнадца-
теричных чисел-байтов.  Они разделяются любыми из символов:  "про-
бел", "точка с запятой", "запятая", "табуляция".
               Пример:  <aSysRq>  <Inline cd 05 ca>
- этот код содержит: "INT 5 / RETF", что то же самое, что команда
<PrtSc>.
    Такой список байтов можно получить,  если  загрузить  bin-файл
через <Inline>  (назначив его какой-то клавише) и заставить KEYMAC
вывести этот макрос:  запустить KM с параметром  /lk клавиша  (без
пробела!) и направить вывод в файл.


         Действие V. Переменные окружения (environment).

    Введены две переменные, которые с помощью DOS-команды SET пе-
редают информацию KEYMAC'у "за кулисами".

    1. SET KEYMAC=параметры
    Вводит параметры командной строки по умолчанию. Обрабатывается
при КАЖДОМ запуске программы в первую очередь (до командной  стро-
ки).  Ограничение: здесь нельзя определить макро. Но можно указать
файл.
    Пример:    set keymac=/k /r
               set keymac=auto.kmc

    В последнем случае файл auto.kmc буде загружаться КАЖДЫЙ РАЗ.

    2. SET KMCPATH=путь
    Указывает путь поиска файлов .kmc, чтобы не держать их в общей
куче. О порядке поиска см. раздел 3. Синтаксис пути аналогичен пе-
ременной DOS "path".


                Действие VI. Сообщения об ошибках.

    1. Syntax error
Синтаксическая ошибка в тексте макро. В том числе: неверно набран-
ное название клавиши; пробел внутри названия клавиши  или  сочета-
ния; попытка поставить в правой части более одного префикса к кла-
више или префикс, различающий левые и правые shift-клавиши (содер-
жащий 'l' или 'r').
    2. Invalid key combination
В  правой  части макроопределения оказалось недопустимое сочетание
клавиш, не имеющее своего кода (напр., <sEsc> - Shift-Escape)  или
сочетание shift-клавиши с командой.
    3. Cannot find file
Указанный файл не найден.
    4. Invalid UNSHIFT parameter
Неверный параметр команды Unshift в тексте макроса. Он должен быть
от 0 до 15.
    5. Invalid OPTION parameter
Неверный параметр команды <Option> в тексте макроса.
    6. Group was not defined
Группа, указанная в качестве параметра команды <Group>  или  ключа
/gf (/g+), не была определена.
    7. Option '/u' must be alone in command line
Параметр /u должен быть единственным в командной строке.
    8. Invalid REPEAT parameter
Неверный параметр команды <REPEAT>. Он должен быть от 1 до 255.
    9. Nothing to REPEAT
После команды <Repeat> ничего нет; нечего повторять.
    10. Dir/Drive commands valid only under MS-DOS 5.00
Команды <Dir>(<Path>) и <Drive>(<Disk>) работают только
в MS-DOS 5.00 (коммерческой версии).
    11. Macro too long
Размер макроса превышает 255 нажатий (510 байт).
    12. Invalid INLINE parameter
Неверный параметр команды <Inline> в тексте макроса.
    13. Inline code too large
Размер встроенного кода превышает 508 байт.
    14. Cannot open inline-code file
Не найден файл, указанный в команде <Inline>.
    15. Cannot REPEAT INLINE
Перед <Inline> не может стоять префикс <Repeat> (по крайней мере,
в этой версии).


                  Эпилог. Техническая информация.

    Программа перехватывает 9-е и 16-е прерывания,  а в DOS 3.x  -
еще  и  21-е.  Написана на Microsoft C с ассемблерными вставками и
специальными мерами для снижения объема резидентной части програм-
мы.


                      Программный интерфейс
                      ---------------------

     1.  Проверка "посторонней программой" наличия KEYMAC в памяти.

      mov ax, 0ce00h   ; "CE" означает вопрос: це е?
      int 16h

      Возвращает:
  Если "цього нема", то в AL должен остаться 0.
  Если KEYMAC уже загружен, то возвращается:
 ax - версия (al - до точки, ah - после точки, напр. 3002h = 2.30)
 es - сегмент кода резидентной части,  равный  PSP+10h.  (Впрочем,
это вам и не нужно.)


      2. Написание кода, встраиваемого в макрос "in-line".

    (О том, как его туда встроить, см. описание команды <Inline>.)

    1). Код  вызывается  из  KEYMAC дальним вызовом,  поэтому кон-
чаться он должен инструкцией RETF.

    2). Размер кода не должен превышать 508 байт. Если же в макро-
се, кроме этого кода, есть еще клавиши или команды,  то  каждая из
них отнимает у максимального размера еще по 2 байта.

    3). Код должен сохранять регистры   DS,  SS,  SP,  BP, DI, SI.

    4). У вас есть возможность,  кроме каких-то действий, передать
из  этого  кода  в  KEYMAC  на  "выполнение"  ASCIIZ-строку  (т.е.
ASCII-строку, оканчивающуюся нулем), которую он немедленно воспри-
мет как часть макроса.  Строка должна быть сформирована в теле ва-
шего кода (можно зарезервировать место инструкцией db), а ее адрес
(без сегмента,  только смещение) нужно сообщить KEYMAC'у,  записав
его по адресу ss:sp+4; значение SP берется на момент начала выпол-
нения вашего кода.  По умолчанию там стоит 0,  что значит,  что вы
ничего  не  возвращаете.  Примеры  - в файлах time.asm,  date.asm,
tolower.asm, toupper.asm.
    Если вы ничего не возвращаете, то забудьте об этом пункте.

    5). Ваш код после загрузки в память попадет в заранее  не  из-
вестное место,  поэтому, если он манипулирует данными, об абсолют-
ной адресации не может быть и речи. Чтобы обратиться к данным, на-
ходящимся  внутри  тела  кода,  можно использовать какой-нибудь из
трюков типа  CALL  $+3  / POP BX (и в BX получаем адрес инструкции
POP BX). Помните: код  может  перемещаться и после загрузки!  Это
происходит при удалении предыдущего (по памяти) макроса.

    6). Данные  в теле вашего кода статические,  и KEYMAC в них не
лезет. Это можно использовать для организации переключателей  типа
"туда-сюда" (toggle).  Например, можно сделать, чтобы одна и та же
клавиша включала узкую печать, а при повторном нажатии - возвраща-
ла принтер в нормальный режим.

    7). BIOS-сервис клавиатуры INT 16h можно использовать, в отли-
чие от вызовов DOS. Избегайте последнего, т.к. KEYMAC не следит за
занятостью DOS.

    8). Двоичный файл с кодом можно создать  одним  из  нескольких
путей:
   а) asm-файл (.model tiny) ->.obj ->.exe ->.bin (через exe2bin);
   б) asm-файл (.model tiny / .startup) ->.obj ->.com (с помощью
ключа линкера /t)
    (директива ORG несущественна, т.к. место кода в памяти заранее
неизвестно);
   в) набрав код прямо в отладчике ДОС DEBUG и сохранив его в фай-
ле (используя команды DEBUG  a, n, r cx  и  w).

    Как видите,  KEYMAC - уже не просто драйвер, сокращающий число
нажатий  клавиш или перепрограммирующий клавиатуру,  а резидентное
ядро для создания своих мини-pop-up-программ.


       Этапы большого пути (т.е. History), приблизительно:
       ---------------------------------------------------

0.xx - Пробные версии.
1.00, 31 Aug 91 -
       Первая версия.
1.01 - Исправлены ошибки.
1.10, 28 Mar 92 -
       Еще исправлены ошибки;  изменен алгоритм  нахождения  рези-
       дентных порций (и убрано INT 0CEh, дававшее несовместимость
       с Turbo Basic'ом и др.).
2.00-2.01, 25 Jun 92 -
       Работа с группами; ключи /gd, /gl, /gf, /g+, /g-, /lg;
       команды <Group>,  <Reboot>,  <Wait>,  <Unshift>,  <Option>;
       ключи /+, /-, /b+, /b-, /i, /w, /k, /s; проверка на наличие
       в памяти другой версии.
2.20, 27 Dec 92 -
       Использование по возможности памяти в PSP; улучшение работы
       <Wait>;  изменение звуковых сигналов; оптимизация резидент-
       ного кода;  сообщения об ошибках выводятся на stderr,  а не
       stdout; команды <Repeat>, <NOP>, <Unbeep>, <Disk>, <Drive>,
       <Dir>,  <Path>; допустимо <Gray..> вместо <Grey..>; изменен
       ключ /m;  новые ключи /u, /n, /d; возможность указать в ле-
       вой части числовой сканкод.
2.21, 22 Feb 93 -
       Исправлены мелкие ошибки (не всегда хотел выполнять <Drive>
       и <Dir>, не всегда вылавливал некоторые ошибки пользователя
       и пр.).
2.30, 11 Apr 93 -
       Возможность встроенного в макрос  машинного  кода;  команда
       <Inline>; перевод  в  inline-вид  команд  <PrtSc>,  <Beep>,
       <Unbeep>,  <Break>,  <Reboot>;  автоматический <Wait> перед
       любой командой; обработка  "shift-серых стрелок";  уменьшен
       резидентный размер; сообщения на русском; ключи /r, /q,/?r,
       /lk; //-комментарий; исправлена еще одна ошибка, из-за кото-
       рой при окончании записи нажатий клавиш система иногда зави-
       сала.
2.31,  5 May 93 -
       Разрешено выполнение <Dir>/<Drive> в DOS 6.00 (и выше).
2.32, 19 May 93 -
       Допускается вызов INT 16h из inline-кода.
2.33, 26 May 93 -
       Исправлена ошибка, из-за которой KEYMAC не обрабатывал име-
       на групп длиной 8 символов.
2.34,  3 Jun 93 -
       <Path>(<Dir>) корректно работает на сетевых и subst-дисках.


  ==================================================

      Юцис Михаил Сухарович
      г.Черновцы, ул.Рязанская, 24/4
      тел. (037-22) 2-55-51 (д.) (звонить вечером),
                    2-53-00 (р.)

