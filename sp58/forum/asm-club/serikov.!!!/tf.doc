                             1. Введение

    Эту программу я написал, отчаявшись форматировать ассемблерные
  тексты к читабельному виду вручную.  Спешу оговориться, что я не
  ставил перед собой задачу исчерпывающего анализа текстов.  Хочу также
  возразить тем, кто считает оформление исходных текстов исключительной
  прерогативой программиста, процессом не поддающимся автоматизации. Я
  постарался создать сравнительно простую программу реализующую ряд
  наиболее очевидных принципов.  Перед вами вариант программы в
  четвертый раз переработтаный от начала и до конца, прошедший
  длительные испытания.


                        2. Ассеммблерный бланк

    Под ассемблерным бланком понимется строка следующего вида:

     имя       поле команды    поле операндов   ; поле комменария
     поля      или директивы
     данных
   └─────────┴───────────────┴────────────────┴───────────────────┘

    Любое из указанных полей может быть перенесено (и не один раз) на
  следующую строку.
    Метка всегда оформляется в виде отдельной строки.  Эта строка может
  содержать комментарий.
    Некоторые директивы ассемблера (ASSUME, LOCAL) пишутся с первой первой
  позиции.
    Если строка содержит только комментарий, он выносится в первую позицию.
    В поле операндов терминальные символы разделяются пробелами.
  Из этого правмла существует ряд исключений, например:
        mov     ax, es: [bp + di] + (3 * 4)
    С COMMENT-ом я не делаю ничего.

                  3. Распознавание деклараций данных

    Инструкции декларации данных ассемблера форматер просто помнит.
  Имена типов данных задаваемые директивой TYPEDEF заносятся во внутреннюю
  таблицу. Чтобы декларации структурных переменных не путать с вызовом
  макросов, имена структур и записей тоже заносятся в таблицу. Если
  указанного имени в таблице не существует, предположение о смысле
  строк вида а b <c> делается на основании опции /O: макровызов, если /O
  указана, структурная переменная - в противном случае. Для просмотра
  включаемых фалов следует указать опцию /I.


                      4. Макрозакономерности

    Опция /Bnnn (или ее умолчание) задает в единицах табуляции минимальные
  значения ширин полей имени, комманды и операндов. Если в тексте
  встречались более длинные имена, то поле имени расширяется. По полям
  команды и операндов накапливается статистика. Если доля диапазона длин
  округленных до следующей позиции табуляции превышает коэфициент
  задаваемый опцией /C (или ее умолчанием), данному полю приписывается
  соответствующая ширина.
    Поддерживается три типа вложенностей:
      MACRO (найвысший приоритет)
      Условного ассемблирования
      Управления выполнением
    Завершение вложенности с большим приоритетом снимает все менее
  приоритетные, напрмер:
  _my_if        macro   op: req
        ifdef   op
  endm

 ifdef  m1
                .IF     m1 == 0
 else
                .IF     ax == 0
 endif

    Пустые строки количеством больше двух не выводятся.


                      4. Операции с файлами

    Файлы обрабатываются по рекурсивной схеме и загружаются в память
  целиком. Максимальный объем исходного фала не может превышать 65535
  байтов. Выходные данные сперва записываются в файл TF.TMP, создаваемый в
  том же каталоге, что и исходный файл. Если промежуточный файл записан
  успешно, исходный файл удаляется, а рабочий - переименовывается в
  исходный. Таким образом вы не потеряете файл при любом сбое.

                       5. Командная строка

        /I    -   Задает трассировку включаемых (include) файлов
        /O    -   Орентирует форматер на стиль работы с макросами MASM 5
        /Bnnn -   Задает стартовый бланк в единицах табуляции
        /Cn   -   Задает попроговый коэфициент
        /Tn   -   Задает интервал табуляции исходного (и выходного) файла


                          7. Сообщения.

       Assembler texts formater
          Written by Igor A. Serikov, Kiev, Ukraine, Sept 28 1993

    Это сообщение выдается при каждом запуске программы.

       Usage:
               TF [options] <source_file_name[.asm]> [options]
       Options:
               /I    - Including files trace
               /O    - MASM 5.1 compatible format
               /Bnnn - Blank definition (default 213)
               /Cn   - Balance coefficient (default 5)
               /Tn   - Tabulation interval (default 8)

       View file TF.DOC for full documantation

    Это сообщение выдается при запуске программы без параметров или их
  неверного задания.

           File 'file_spec', nnn line(s)

    Это сообщение выдается при завершении анализа любого файла.

       Nothing to do

    Это означает, что исходный файл пуст.

       Format comleted Ok, file 'file_spec' contain nnn line(s)

    Этим сообщением заканчивается работа программы.

       Duplicate parameter definition

       File name 'file_spec' is invalid

       can not search file 'file_spec'

    Первые два сообщения в любом случае, а третье в подавляющем
  большинстве случаев являются следтвием неверного указания параметров.

       File 'file_spec' has unoperable attributes

    Появление этого сообщения, скорее всего, говорит о том, что исходный
  файл имеет атрибут READ_ONLY.

       No string terminator in line nnn, file 'file_spec'

    Программа не нашла символов ' " > до конца строки.

       Missing COMMENT delimiter in file 'file_spec'

    Программа не нашла символа завершения COMMENT до конца файла.

       Invalid eol sequence in line nnn, file 'file_spec

    Обнаружена неверная последовательность CRLF.

       Internal table overflow

       Too many MACRO/CONDITIONAL_ASSEMBLY intstructions in line nnn, file 'file_spec'

       Stack overflow

       Insufficient memory for loading 'file_spec'

    Если эти сообщения появились при запуске программы с опцией /I,
  можно попробовать их избежать запустив ее без опции /I.

       can not create work file

       can not delete old source file

       can not rename work file, your source text is in file TF.TMP now

       can not set file attributes

    Разберитесь со своей операционной системой.


                  8. Физическое представление данных

    Для разделения полей используется символ табуляции. Все символы с
  кодами ASCII 00h-08h и 0ah-20h заменяются пробелами.  Табуляции
  учитываются в строках ("" "" <<>>) и в комментариях.  В комментариях
  табуляции расставляются оптималным образом, в строках они заменяются
  пробелами. Символ EOF записывается вне зависимости от его присутствия
  в исходном файле.


                        9. Методы реализации

    Форматер использует 3-х проходную схему обработки текста. При каждом
  проходе вызывается один и тот же сканер, который при обнаружении
  семантических единиц вызывает подпрограммы соответствующие данному
  проходу. Между проходами функции распределены так:
    1-й проход - трассировка основного и включаемых файлов с
  построением таблиц;
        2-й проход - трассировка только основного файла с накоплением
  статистики по длинам полей;
        3-й проход - трассировка только основного файла с выводом данных.

    Используются следующие типы терминальных символов:
        EOF, EOL, COMMENT, STRING, WORD, TERM_SYM

    Программа просмотра текста возвращает:
        тип терминального сммвола,
        указатель на него,
        указатель на предшествующее ему продолжение ("хвост"),
        номер позиции табуляции для начала "хвоста".

    Просмотр на слово вперед реализован так:
        get word
        <...>
        push parameters
        get word
        <...>
        exchange parameters
        <...>
        pop parameters
        <...>

    Просмотр на 2 слова вперед реализован так:
        get word
        <...>
        push parameters
        get word
        <...>
        push parameters
        get word
        <...>
        exchange parameters
        <...>
        pop parameters
        <...>
        pop parameters
        <...>

                    10. Как со мной связаться

    Мой домашний телефон (044) 263-45-16. Звоните с 9 до 11 вечера.


                           Ж е л а ю  у д а ч и !

                              Игорь Сериков

