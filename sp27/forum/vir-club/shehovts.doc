Cофтпанорама 1990, No.7 (11) ** VIR-CLUB **  Составитель: Н.Н.БЕЗРУКОВ
***********************************************************************
                                      Приводимые в данном разделе замет-
                                 ки  выражают  мнение авторов,  которое,
                                 естественно, может не совпадать с  точ-
                                 кой зрения составителя.
***********************************************************************




                                                           Шеховцов Александр
                        Несколько советов создателям
                           АНТИВИРУСНЫХ ПРОГРАММ.


  При разработке и тестировании своего вирусного детектора мне пришлось стол-
кнуться с проблемой оценки качества антивирусного программного продукта (АПП).
Действительно, когда получаешь очередной антивирус или создаешь его сам, как
оценить его работоспособность и надежность? Если не считать банальных тестов
на скорость просмотра файлов, все остальные критерии - лишь эмпирические.
  Надеюсь, мои советы о том, как надо и как не надо создавать подобные
программы помогут и их авторам при разработке новых версий, и пользователям
при выборе набора антивирусных средств для защиты своего компьютера. Я понимаю,
что не смогу охватить все проблемы и надеюсь, что данная заметка положит начало
статьям других программистов и пользователей на эту волнующую всех нас тему.
  В основном в этой заметке я коснусь АПП класса вирусных докторов и
детекторов.


                       1. С чего начать.

  Обыкновенно АПП создается, когда программист обнаружит у себя на компьютере
новый вирус, против которого оказались бессильны все имеющиеся АПП.
  Мой Вам совет : не делате этого. Рынок АПП достаточно полон и многие
программисты убивают кучу времени на создание антивирусов. Ну так зачем же
тратить время на очередной антивирус-однодневку? Лучше сообщите автору Вашего
любимого АПП, а большинство из них вставляют свои координаты в программы,
и он пришлет Вам новую версию своей программы за короткое время.
  Если же Вы решили посоревноваться с другими создателями АПП, то сначала
спросите себя: "А чем мой антивирус заинтересует пользователя? Есть ли в нем
изюминка?". И вот когда Вы сможете ответить себе утвердительно - приступайте!



                       2. Самотестирование на заражаемость.

  Любой АПП должен уметь проверить себя на зараженность вирусом. Без подобной
самозащиты программа бесполезна и попросту опасна.
  Что нужно учесть:

  1) Самотестирование следует производить в момент загрузки программы. Многие
     АПП очень смешно ведут себя после запуска с дискеты. Пользователь уже
     вынул дискету, вставил другую, пытается использовать АПП для поиска
     вирусов на ней, а он, бедняга, сначала ищет на дискете себя чтобы
     протестироваться. В результате : либо зависание, либо леденящее душу
     сообщение о новом вирусе.

  2) Существуют утилиты, которые пакуют EXE файлы, уменьшая их в размерах.
     Следовательно, возможен и вирус, после заражения которым программа может
     даже уменьшится в размерах! Поэтому, если АПП выводит пользователю разницу
     между своим текущим и "истинным" размером, то он должен учитывать данный
     случай, а не сбивать с толку при уменьшении на 1 Кб сообщением о том, что
     он якобы увеличился на 64 Кб.

  3) Некоторые вирусы умеют перехватывать те прерывания MS DOS, которые
     возвращают длину файла и вычитать из длины зараженного файла длину вируса.
     В результате АПП будет обманут, получив свой "истинный" размер.
     Отсюда вывод : следует контролировать размер программы хотя бы двумя
     разными пособами: через FCB и через Handle (дескриптор) файла. Лучше всего
     найти свой оригинальный способ, недокументированное прерывание, например.

  4) Ясно, что мало только тестировать свой размер. Следует проверять и собст-
     венную точку входа (первый исполняемый оператор), и несколько "секретных"
     байт в начале, середине и конце своего АПП. Опыт показал, что наибольшей
     вирусной устойчивостью обладают АПП - "многостаночники" самотестирования.


                       3. Поиск вирусов в оперативной памяти.

  Многие АПП проверяют память на наличие в ней вирусов. Я скептически отношусь
к этому и предпочитаю загружаться с незараженной дискеты перед поиском вирусов,
но все же замечу:

  1) Если АПП ищет в памяти вирусы по их кодовым цепочкам (маскам, сигнатурам),
     то он может нарваться на коды, оставленные в памяти предыдущим АПП.
     Довольно смешно (или грустно?) смотреть как детектор SCAN находит в памяти
     компьютера не менее 3-х "вирусов" после отработавшего детектора VL 1.6.
     Отсюда мораль : завершая работу, убери за собой, то есть сотри из памяти
     все эти коды.

  2) Более печальный и, к сожалению, тоже реальный случай, это когда АПП,
     тестируя память, находит там себя со своими сигнатурами и считает их
     кодами вируса.
     Советую проверить, не способны ли Ваши антивирусы так оконфузиться?

  3) АПП "интеллектуального" уровня ищут в памяти вирус по любимым вирусами
     командам, например:

                        CMP AX , 4BH   ; в прерывание 21 идет запрос на
                                       ; выполнение программы
     или
                        CMP AH , 4B00H ; то же самое

     Результат : появился вирус, в котором данный кусок выглядит так :

                        INC AX
                        CMP AX,4CH
                        DEC AX

     Вывод : либо не изощряйтесь в интеллектуальности, либо не рассказывайте
     другим о том, по каким таким признакам Вы ищете вирусы в памяти.


                       4. Поиск вирусов в BOOT.


   Следует или не следует проверять начальный загрузчик на вирусы - дело вкуса,
я предпочитаю иметь дистрибутив MS DOS на заклеенных дискетах и не позволяю
на моем компьютере загружаться с дискет. Но если АПП предлагает такую проверку,
то следует знать, что:

   1) В очередной версии MS DOS начальный загрузчик может слегка измениться,
      например использовать свободные раньше байты. Кроме того, дискета,
      которую исследует АПП, может вообще не быть системной. Поэтому, если
      BOOT выглядит не так, как ожидает антивирус, это еще не означает наличие
      BOOT-вируса. Мне знаком АПП, который превратил в мусор BOOT на дискете,
      отформатированной в MS DOS 4.01, а затем с вероятностью 1/2 предлагал
      излечить эту дискету еще раз ("Нет уж, спасибо" - отвечал я ему).

   2) Не используйте и не создавайте АПП явно занудливого типа. Если
      пользователь не захотел лечить BOOT - ну и ладно, и не стоит подобно
      одному из АПП выдавать сообщение:

               "Ваш BOOT заражен начиная с i-го байта. Излечить?"

      для каждого i от 1 до 512 (Да! Есть и такой антивирус.).


                       5. Поиск вирусов в файлах.

  Смысл работы любого детектора или доктора - поиск вирусов в файле. Можно
даже утверждать, что он является критическим местом в подобных АПП и в первую
очередь должен оптимизироваться. На сегодняшний день разброс в скорости поиска
для различных популярных АПП бывает пяти-шестикратным. Поэтому сравнивайте
работу своего АПП с несколькими другими, чтобы определить его место в общей
"скоростной" таблице.
  Однако, скорость еще не самое главное. Как ни странно, очень многие АПП дают
сбой при весьма простых ситуациях, например:

   1) При попытке излечить файл с атрибутом Hidden (скрытый) АПП хотя и
      нейтрализует вирус, но оставляет его в файле в виде бесполезного хвоста
      (файл не сокращается до исходных размеров). Попав на такое в первый раз,
      я был ошарашен и запустил на этот недолеченный файл другой АПП. Тот,
      в свою очередь, тоже попытался показать свои способности и в результате
      я получил воистину незараженный файл, поскольку его размер стал
      равен 0 (ноль) байт.

   2) При попытке излечить файл на защищенной от записи дискете АПП вылетает
      по Runtime error. Ну это просто несерьезно!

   3) При сканировании файлов с атрибутами ReadOnly (только чтение) на винче-
      стере АПП вылетает по Runtime error. Почему???

   4) АПП отказывается исследовать файлы на защищенной от записи дискете,
      поскольку пытается открыть файл сразу для чтения и записи.

   5) АПП излечивает только файлы размером до 65 Кб, в остальных вирусов не
      замечая. Связано такое поведение с тем, что программист по ошибке
      вместо типа LONG (длинное слово) для длины файла использовал тип
      WORD или UNSIGNED (простое слово).

   6) Как оказалось, кроме стандартного признака "MZ" для EXE-файлов MS DOS
      преспокойно воспринимает и "ZM". Учтите, что некоторые вирусы уже
      знают об этом, а большинство антивирусов - пока нет. Это приводит к
      тому, что в подобных EXE-файлах АПП вирусов не обнаружит и может даже
      заявить, что это - COM-файл с расширением EXE.


  Вывод может быть только один : при создании АПП тщательно прочитайте ту
часть документации, в которой говорится о работе с файловой системой, а также
следите за сообщениями о недокументируемых свойствах MS DOS.
  Что же касается готовых АПП, то их следует тестировать при указанных выше
ситуациях, чтобы эти АПП не подвели Вас в критический момент.


                       6. Поиск вирусов по файловому дереву.


  На сегодняшний день почти не осталось АПП, которые бы не позволяли проскани-
ровать все файловое дерево в поисках зараженных файлов, а многие АПП готовы
и все диски просмотреть, только пожелайте.
  Однако и здесь есть свои подводные камни:

  1) Не забывайте, что пользователь может создать у себя на диске дерево
     такой вложенности, что длина полного имени исследуемого файла достигнет
     максимума, допустимого в MS DOS. Иногда АПП, написанные на ассемблере,
     упускают это из виду и не добираются до самых глубин файлового дерева.

  2) В MS DOS имена файлов и каталогов имеют один и тот же "синтаксис", то есть
     могут состоять из собственно имени и расширения, разделенных точкой. Не
     следует забывать об этом наподобие одного антивируса, который не позволяет
     ввести точку, когда запрашивает имя каталога для поиска зараженных файлов.

  3) Самым удобным способом определения существования и типа логического диска
     является использование DOS-функции 32H (см. Tech-HELP, например).
     Вот только функция эта НЕДОКУМЕНТИРОВАННАЯ, а значит, может измениться
     в следующих версиях MS DOS. Пока же она работает вплоть до версии 4.01
     включительно.

  4) Если Ваш АПП собрался просканировать все логические диски (обыкновенно
     начиная с C:), то не следует полагать, что его работа должна прекратиться,
     если очередной диск уже недоступен. Возможна ситуация, когда, например,
     диск E: недоступен и якобы не существует, а диски F: и G: вполне доступны
     и могут быть просканированы. Следовательно, если АПП собрался исследовать
     все диски, пусть он честно исследует их все подряд, с C: до Z:.

     Примечание для особо любознательных :
           диск E: можно сделать недоступным, например дав команду

                             ASSIGN E: A:

           и вытащив дискету из дисковода A:.



                       7. Финтифлюшки.

  Под финтифлюшками я понимаю те свойства АПП, которые выглядят очень
заманчиво, особенно для неискушенного пользователя, а на самом деле
оборачиваются пшиком в лучшем случае. Особенно часто такое бывает у АПП,
написанных на ассемблере и имеющих COM-формат. Видимо их авторы из того, что
на ассемблере можно написать что угодно, делают вывод, что можно создать
всемогущую программу.
  Итак, что же должно вызывать сомнение :

  1) Самоизлечиваемость программы от любого вируса.

     Согласитесь, это звучит громко, но на самом деле есть вирусы, которые
     шифруют часть зараженной программы. Если на этот вирус нарвется такой АПП,
     то он (АПП) просто покончит с собой. Возможно, так ему и надо, но ведь
     Вы так рассчитывали иметь панацею...

  2) Самоустановка в себя новых сигнатур (масок) вирусов без вмешательства
     пользователя.

     Такой АПП просто исследует самого себя, обнаружив на себе вирус самоизле-
     чивается (см. пункт 1), а часть кодов нового вируса запоминает и потом
     использует при поиске вируса.
     Все это неплохо с виду, но дело в том, что вирусы хранят в себе и
     изменяющиеся коды, например дату заражения, число инсталляций или имя
     зараженного файла. Кроме того они еще могут кодировать часть своего тела.
     Следовательно, довольно часто эта самоустановка будет просто самообманом.

  3) Излечение любого нового вируса "по аналогии".

     АПП "просит" зараженный файл, сравнивает его с "дистрибутивом" и по
     аналогии лечит от этого вируса все остальные файлы.
     Здесь замечания те же, что и в пунктах 1 и 2. И, более того, когда я
     тестировал один такой АПП, просто дописав в конец файла какой-то текст, то
     этот АПП был настолько сбит с толку новым "вирусом", что начал превращать
     в "кашу" все те файлы, которые (конечно, с тем же текстом в конце для
     чистоты эксперимента) я подсовывал ему на излечение. А ведь дозапись
     в конец файла может сделать какая-либо вирусная вакцина...


  Мой Вам совет : не вводите подобные финтифлюшки в свои АПП и игнорируйте их
или даже считайте недостатком в используемых Вами АПП.





                                       29 августа 1990 г.



