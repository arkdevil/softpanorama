                                WinVieW
                              версия 1.00
                         (C) В.С. Рабец, 1994
    Написан на основе исходников драйвера RConsole Вадима Брайченко

Возможности WinVieW:
    Кодировка кириллицы 866 и Windows
    Русская, белорусская и украинская клавиатура
    Поддерживает видеорежимы со шрифтами 8x16, 8x14 и 8x8
    Переключает таблицу верхнего регистра символов в соответствии с текущей
        кодировкой, что позволяет вести регистронезависимый поиск текста
    Удобный ввод псевдографики и символов #240-#255
    Индикация режимов работы рамкой
    Переключение на клавиатуру ЛАТ при выходе из пользовательской программы
    Изображения кодов 00 и FF отличны от пробела
    Возможность задания номера прерывания для связи с резидентом
    Одновременно все три общепринятых способа переключения КИР-ЛАТ:
        правый Ctrl, два шифта, левый-правый Ctrl-Shift.

Минимальные требования к системе:
    Процессор i286
    EGA
    101-клавишная клавиатура
    DOS 3.3
Рекомендуется более продвинутая конфигурация, позволяющая загружать WinVieW
 командой LH.

■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                          Глава для пользователя

Сводку ключей Вы можете получить, набрав WinVieW /?

╒════════════ Опции командной строки: ════════════════════════════════════════╕
│ /? или /H - этот экран               /E - English help                      │
│ /^ - НЕ использовать Правый_Ctrl     /B - изображать символы 0 и FF пробелом│
│ /C - НЕ поддерживать таблицу UpCase  /I - НЕ индицировать режим рамкой      │
│ /K -установить украинскую клавиатуру /L - установить белорусскую клавиатуру │
│ /R - /U + установить фонт ROM        /U - выгрузить резидент                │
│ /S - сохранять скан-коды клавиш      /X - НЕ отслеживать завершение программ│
└─────────────────────────────────────────────────────────────────────────────┘

Ключ /H - синоним /?
Ключ /E выдает тот же справочный экран, но на английском (или близком к
        английскому) языке.
Ключи могут разделяться знаками "/" или "-".
Все ключи работают только при первом запуске WinVieW. Повторный запуск WinVieW
    с другими ключами никак не влияет на резидентную копию драйвера.
Большинство ключей можно сделать постоянно активными настройщиком WVW_tune.

ПЕРЕКЛЮЧЕНИЕ КОДИРОВОК:
    WinVieW может работать в трех режимах:
       кириллица в кодировке 866,
       кириллица в кодировке Windows,
       кодировка ROM, т.е. зашитая в ПЗУ компьютера.
    В режиме ROM клавиатура не кириллизуется, и весь видеосервис происходит
       без участия драйвера.
    Переключение кодировок:
       Ctrl-Shiht-F12 - 866
       Ctrl-Shiht-F11 - Windows
       Ctrl-Shiht-F10 - ROM
    В графических видеорежимах кодировка не переключается (при запуске драй-
     вера, однако, независимо от видеорежима устанавливается кодировка 866).
    Вместе с экранным шрифтом переключается и DOS'овская таблица верхнего
     регистра. Это позволяет вести регистронезависимый поиск текста, напри-
     мер в Volkov Commander'е или Нортоновским TS. В режиме ROM включается
     таблица, бывшая до загрузки WinVieW. Эта же таблица восстанавливается
     при выгрузке драйвера ключами /U или /R. ПРИ ВЫГРУЗКЕ WinVieW НЕ КЛЮЧА-
     МИ /u, /r, А СРЕДСТВАМИ Volkov Commander'а ИЛИ ПРОГРАММАМИ ТИПА Release
     ИСХОДНАЯ ТАБЛИЦА, ЕСТЕСТВЕННО,  Н Е   В О С С Т А Н А В Л И В А Е Т С Я.
     Отменяет переключение таблицы ключ /C.
    DOS'овские таблицы для сортировки и верхнего регистра имен файлов
     драйвер не поддерживает.
    Шрифты в WinVieW можно заменить настройщиком WVW_tune.
     Шрифты проектировались так, чтобы они хорошо выглядели в режиме 866.
     К несчастью, в кодировке Windows заглавные русские буквы находятся в
     позициях псевдографики, для которых, как известно, на VGA в режиме
     шрифта 9x16 восьмой столбец матрицы символа копируется в девятый.
     В результате некоторые широкие заглавные русские буквы (особенно Ф,Ы,Ю)
     в режиме Windows выглядят несколько коряво.
!!! Исправления Win-текстов вне создавших их редакторов могут привести
!!!  к потере текста!

ПЕРЕКЛЮЧЕНИЕ КЛАВИАТУРЫ:
    WinVieW поддерживает два независимых типа переключения клавиатуры:
       переключение типа кириллицы, не влияющее на состояние КИР-ЛАТ,
       и переключение КИР-ЛАТ, не влияющее на текущую национальность.
    Переключение типа кириллицы:
       Ctrl-Alt-F7 - белорусская клавиатура
       Ctrl-Alt-F8 - русская
       Ctrl-Alt-F9 - украинская
    Переключение КИР-ЛАТ:
       Правый Ctrl или Два Шифта - переключение состояния КИР-ЛАТ
       Ctrl-правыйShift - кириллица
       Ctrl-левыйShift  - латинская клавиатура
    В режиме ROM клавиатура не переключается и не кириллизуется.
    В состоянии ЛАТ, независимо от рус-бел-укр, всегда работает ПЗУ-раскладка
     клавиатуры, т.е. собственную латинскую раскладку драйвер не поддерживает.
    Ключ /^ отменяет переключатель "правый Ctrl".
    Ключи /L и /K устанавливают сразу после запуска драйвера соответственно
     белорусскую и украинскую клавиатуру (по умолчанию - русская), независи-
     мо от этого после запуска всегда установлено состояние ЛАТ.
    Раскладка клавиатуры - в традициях Windows. Т.к. такую раскладку можно
     считать стандартной, её изменение не предусмотрено.

ПОДРОБНО О ПЕРЕКЛЮЧЕНИЯХ:
    Все переключения происходят по ОТПУСКАНИЮ клавиши.
        Ниже подробно расписаны условия всех переключений.
    Правый Ctrl: нажатие-отпускание правого Ctrl
                 при НЕ нажатых Shift, Alt, левый Ctrl, CapsLock.
    Два Шифта: при НЕ нажатых Alt, Ctrl, CapsLock и одном нажатом Shift:
               нажатие другого Shift и отпускание любого Shift.
    Ctrl-правыйShift: при НЕ нажатых Shift, Alt, CapsLock и любом нажатом Ctrl:
               нажатие правого Shift, и отпускание Shift или Ctrl.
    Ctrl-левыйShift: аналогично Ctrl-правыйShift.
    Ctrl-Shift-Fxx: нажатие-отпускание Fxx при нажатых левых Ctrl и Shift,
                    при НЕ нажатых Alt и CapsLock.
    Ctrl-Alt-Fx: нажатие-отпускание Fx при любых нажатых Ctrl и Alt,
                    при НЕ нажатых Shift и CapsLock.
    Любые посторонние нажатия-отжатия отменяют переключение.
    Следует иметь ввиду (здесь и в разделе ПСЕВДОГРАФИКА), что при нажатом Ctrl
     BIOS не реагирует на нажатие CapsLock, пока не будет отпущен Ctrl.

РАМКА: Режимы работы WinVieW индицируются цветом рамки:

    Клавиатура:   РУССКАЯ    БЕЛОРУССКАЯ    УКРАИНСКАЯ
       866-ЛАТ     чёрный    тёмно-синий   тёмно-зелёный
       866-КИР  тёмно-серый     синий         зелёный
       Win-ЛАТ    красный    красно-синий  красно-синий
       Win-КИР  ярко-красный     ярко-красно-синий

    Цвета рамки для вышеприведенных режимов можно переопределить из WVW_tune.
    При выходе в режим ROM устанавливается чёрная рамка.
    WinVieW перерисовывает рамку только при загрузке-выгрузке, при изменении
     видеорежима, при нажатиях Ctrl-Shift-Fxx и Ctrl-Alt-Fx, при ИЗМЕНЕНИИ
     режима КИР-ЛАТ. Например, если клавиатура находится в состоянии КИР,
     какая-то программа изменила цвет рамки, и Вы нажали Ctrl-правыйShift -
     цвет рамки не восстановится. Простейший путь восстановления рамки -
     двойное нажатие правого Ctrl или CapsLock.
    В режиме ROM рамка, как и всё видео, не управляется драйвером.
    О рамке в режиме псевдографики читайте в разделе ПСЕВДОГРАФИКА.
    Ключ /I отменяет поддержку рамки.

ПСЕВДОГРАФИКА:
    При нажатии и УДЕРЖИВАНИИ CapsLock, независимо от текущего режима,
     включается режим ввода псевдографики. Он индицируется ярко-белой рамкой.
     Как только Вы начали ввод псевдографики, рамка становится жёлтой -
     это означает, что после отпускания CapsLock его состояние ON-OFF
     восстановится.
    Псевдографика вводится с малой цифровой клавиатуры, клавишами цифр и ".",
     расположение которых позволяет очень легко запомнить раскладку на них
     символов псевдографики. В зависимости от состояния левых Shift, Alt и
     Ctrl, вводятся следующие знаки:

     Нажатые переключатели         Знаки     Клавиши
                               псевдографики
     CapsLock:                     ┌┬┐        789
                                   ├┼┤        456
                                   └┴┘        123
                                   ─ │        0 .

     CapsLock + левый Shift:       ╔╦╗        789
                                   ╠╬╣        456
                                   ╚╩╝        123
                                   ═ ║        0 .

     CapsLock + левый Ctrl:        ╒╤╕        789
                                   ╞╪╡        456
                                   ╘╧╛        123
                                   ═ │        0 .

     CapsLock + левые Ctrl-Shift:  ╓╥╖        789
                                   ╟╫╢        456
                                   ╙╨╜        123
                                   ─ ║        0 .

     CapsLock + левый Alt          ▓▀█        789
      независимо от Shift и Ctrl:  ▌▒▐        456
                                    ▄░        123
                                   ¤ ■        0 .

    Очень легко запомнить раскладку: знаки на клавишах 1-9 образуют решетку
     со всеми возможными пересечениями, клавиша 0 (расположенная горизонталь-
     но) - горизонтальная черта, клавиша "." - вертикальная.
     В простейшем случае, когда нажата только CapsLock, все линии одиночные.
     CapsLock+Ctrl - горизонтальные линии двойные. Shift всегда инвертирует
     одиночные-двойные линии. CapsLock+Alt - знаки на клавишах 8, 4,6, 2 об-
     разуют рамку, а на нечётных клавишах расположены заполненные знаки в по-
     рядке возрастания степени заполнения (на "1" располагается знак FF).
    Знак ¤ вводится не на всех клавиатурах.

    Кроме того, в режиме псевдографики клавишами "серый -" и "серый +" можно
     вводить белорусские и украинские буквы и другие символы последней колонки
     таблицы 866:

     Нажатые переключатели          Серый -  Серый +
      CapsLock:                       ґ        і
      CapsLock + левый Shift:         Ґ        І
      CapsLock + левый Ctrl:          є        ·
      CapsLock + левые Ctrl-Shift:    Є        ї
      CapsLock + левый Alt
       независимо от Shift и Ctrl:    √        Ї

    Легко запомнить, что украинские буквы находятся на "сером -", белорусская
     буква и точки - на "сером +".

    Независимо от режима 866-Windows-ROM, в режиме псевдографики всегда
     вводятся одни и те же коды, т.е. ввод псевдографики в режиме Windows не
     имеет смысла (в кодировке Windows вообще нет знаков псевдографики).
    К сожалению, в некоторых программах, в частности в Borland Pascal 7.0,
     ввод псевдографики работает не полностью, более того, клавиши
     "0"(Ins) и "."(Del) на малой цифровой клавиатуре работают в этом
     режиме как обычно в BP 7.0: вставка-удаление выделенного блока.
     Совершенно очевидно, что в свете наличия таких программ ввод псевдогра-
     фики нужно было написать немножко по-другому, но на стадии написания
     WinVieW я как-то упустил из виду этот момент (хорошая мысля приходит
     опосля). В Лексиконе, Volkov Commander'е и многих других не изощрённых
     редакторах псевдографика работает нормально.
    Кроме индикации режима псевдографики, яркая рамка при нажатии CapsLock,
     как мне кажется, помогает заметить нередкие [для меня] случаи, когда
     вместо шифта палец попадает на CapsLock.

ЗАВЕРШЕНИЕ ПРОГРАММ:
     WinVieW при завершении любой программы переключает клавиатуру в состоя-
      ние ЛАТ (в том числе и в режиме ROM). Это удобно, например, при выходе
      из редактора с русским текстом (т.к. в DOS, как правило, используется
      латинская клавиатура).
    Ключ /X отменяет отслеживание завершения программ. WinVieW с этим ключом
     не перехватывает вектора int 20h и int 21h, что повышает вероятность вы-
     грузки WinVieW после запуска других резидентов. Кроме того, Volkov
     Commander ver. 4.00.038 при некоторых сочетаниях запущенных из него
     резидентов при своем завершении не выгружает резиденты, но восстанавли-
     вает вектор int 21h. В результате блок отслеживания завершений WinVieW
     оказывается наполовину отключённым, и драйвер уже нельзя выгрузить, т.к.
     вектор int 21h изменён. Ключ /X снимает эту проблему.

ВЫГРУЗКА WinVieW:
    Ключ /U выгружает WinVieW с сохранением текущего шрифта, ключ /R - с
     восстановлением шрифта ROM.
    При выгрузке восстанавливается исходная таблица верхнего регистра и
     устанавливается чёрная рамка.
    Выгрузка возможна только если запущенные после WinVieW программы не из-
     менили вектора перехваченных WinVieW прерываний. WinVieW перехватывает
     int 9, int 10h, без ключа /X - int 20h и int 21h, а также прерывание
     для поиска своей резидентной копии (2Fh, если не переопределено).

ДРУГИЕ ВОЗМОЖНОСТИ WinVieW:
    В шрифтах WinVieW код 00 изображается маленьким ноликом, а код FF (255) -
     маленькой заглавной F. Крайне редкие программы выводят 00 или FF вместо
     пробела, так что эта возможность почти никогда не мешает. Ключ /B очи-
     щает изображение 00 и FF (т.е. они выглядят стандартно - как пробел).
    По умолчанию WinVieW для всех перекодируемых символов (кириллица и
     псевдографика) подставляет в буфер клавиатуры скан-код 0. Ключ /S со-
     храняет скан-коды клавиш (не понятно, зачем это может понадобиться).
    О переопределении прерывания для поиска резидентной копии читайте в
     следующей главе.

 ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! ! !

WinVieW написан в духе DOS, т.е. пользователь не ограждён от возможности
 наделать себе неприятностей:
 1) Правка из DOS документа WinWord с изменением его длины приводит к
    невозможности загрузки его в WinWord.
 2) В Borland Pascal 7.0 (и возможно, в каких-то других программах)
    ввод псевдографики из WinVieW частично не работает, а клавиши
    "0"(Ins) и "."(Del) на малой цифровой клавиатуре работают в этом
    режиме как обычно в BP: вставка-удаление выделенного блока. Т.е. при
    попытке ввода псевдографики Вы можете случайно удалить выделенный
    блок, не заметив этого.
 3) Переключение режима 866-Windows сопровождается перезаписью одной из
    таблиц DOS. WinVieW проверяет, действительно ли эта таблица нахо-
    дится в DOS. Но в принципе можно сделать резидент, перехватывающий
    эту таблицу и прикидывающийся DOS'ом (адрес владельца - 8). При
    выгрузке такого резидента WinVieW затрет загруженную на его место
    программу.
    Сама по себе перезапись таблицы, как и любое другое вмешательство в
    операционную (если так можно выразиться о DOS) систему, потенциально
    опасно.
 4) Возможность переназначить прерывание для связи с резидентом анало-
    гична возможности нажать Ctrl-Alt-Del.
 5) Любая резидентная программа сама по себе опасна. Страшнее резидента
    может быть только надпись "Any key" на кнопке RESET.

■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                    Глава для продвинутого пользователя

ПЕРЕНАЗНАЧЕНИЕ ВЕКТОРА ДЛЯ СВЯЗИ С РЕЗИДЕНТОМ:
    WinVieW ищет свою резидентную копию по алгоритму, близкому к описанному
     А. Дударенко (СофтПанорама 41, dudarenk.a41): перебираются функции
     80h-FFh прерывания 2F с AL=0, пока на выходе не будет AL=0FFh и ES:DI
     установлен на строку с именем WinVieW.
    Прерывание 2F можно заменить на другое (например, если Вы хотите выгру-
     жать WinVieW из-под другого резидента, перехватившего int 2F).
     Номер прерывания задается ключом /0F12#
     где 0,F,1,2 - соответственно символы с номерами 00,FF,01 и 02,
     а # - символ с номером нового прерывания (должен быть больше 15h).
    На справочном экране текущее прерывание для связи с резидентом показано
     в нижнем левом углу после слова "ComInt". Настройщиком оно не изменяет-
     ся во избежание неприятностей для неопытных пользователей. В WVW.com
     версии 1.00 его значение хранится в байте по смещению 3FBCh.
    Из-за некоторой непродуманности драйвера при использовании для этих це-
     лей прерывания 21h становится невозможно выгрузить WinVieW без ключа /X,
     т.к. в этом случае int 21h перехватывается дважды.

■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
                             Технические детали

    При выгрузке WinVieW прерывание 43h не восстанавливается, прерывание 1Fh
     восстанавливается только если оно не было перехвачено другой программой.

    Размер резидента WinVieW:
     на VGA - 15,600 байт (15.2 Kb)
     на EGA - 10,352 байт (10.2 Kb)
    Ключ /C уменьшает размер резидента на 384 байта (0.375 Kb).
    Для сравнения: размер резидентов кириллизованных Display.sys+Keyb.com
     для MS DOS 6.2 на VGA - 8,304+6,336=14,640 байт (14.3 Kb).

    Несмотря на громоздкость обработчика int 09, он не вызывает какого-либо
     заметного замедления работы программ - даже 10 одновременно загруженных
     копий WinVieW при автоповторе стрелок расширенной клавиатуры с NumLock=ON.
     (При нажатии расширенной стрелки с NumLock=ON int 9 вызывается 4 раза -
     клавиатура посылает сначала код нажатия Shift (для нейтрализации NumLock),
     затем код нажатия стрелки, причем каждый из этих кодов предваряется пре-
     фиксом расширенной клавиатуры).

■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■

        02-05-94                     В.С. Рабец

                           e-mail:   rabets@icph20.sherna.msk.su

                            Адрес:   142 432
                                     Московская обл.
                                     Ногинский р-н
                                     п. Черноголовка
                                     Школьный б-р, 18, кв. 241
                                     Рабцу В.С.
