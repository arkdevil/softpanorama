
         4. Методы обнаружения и удаления компьютерных вирусов
         ═════════════════════════════════════════════════════

        Меры по противодействию компьютерным вирусам можно разделить  на
несколько групп:

        а) профилактика заражения вирусом и уменьшение предполагаемого
           ущерба от такого заражения;
        б) методика использования антивирусных программ, в том числе
           обезвреживание и удаление известного вируса;
        в) способы обнаружения и удаления неизвестного вируса.


                 4.1 Профилактика заражения компьютера
                 ═════════════════════════════════════

        Одним из основных  методов борьбы с  вирусами является, как  и в
медицине, своевременная профилактика. Компьютерная профилактика  состоит
из небольшого количества правил, соблюдение которых значительно  снижает
вероятность заражения вирусом и утери каких-либо данных.

                            Правило первое
                            --------------
        Лучше покупать дистрибутивные  копии программного обеспечения  у
официальных продавцов, чем бесплатно  или почти бесплатно копировать  их
из других источников. Этим значительно снижается вероятность  заражения,
хотя известны случаи покупки инфицированных дистрибутивных дискет.

        Как следствие из первого правила вытекает необходимость хранения
дистрибутивных  копий  программного  обеспечения  (в  том  числе   копий
операционной системы), причем копии желательно хранить на защищенных  от
записи дискетах.

                            Правило второе
                            --------------
        Периодически  сохраняйте  файлы,  с  которыми ведется работа, на
внешний носитель, например дискеты (я это делаю ежедневно). Такие  копии
носят название backup-копий.  Затраты на копирование  файлов, содержащих
исходные тексты программ,  базы данных, документацию  значительно меньше
затрат на восстановление этих файлов при проявлении вирусом  агрессивных
свойств или при сбое компьютера.

        При наличии стриммера или какого-либо другого внешнего  носителя
большого объема имеет смысл делать backup всего содержимого  винчестера.
Но поскольку время  на создание подобной  копии значительно больше,  чем
время,  затрачиваемое  на  сохранение  только  рабочих  файлов, то имеет
смысл делать такие копии реже.

                            Правило третье
                            --------------
        Старайтесь  не  запускать  непроверенные  файлы,  в  том   числе
полученные  из  компьютерной   сети.   Желательно  использовать   только
программы,  полученные  из  надежных  источников.   Перед запуском новых
программ обязательно проверьте их одним или несколькими антивирусами.

        Желательно,  также   чтобы  при   работе  с   новым  программным
обеспечением  в  памяти  резидентно  находился  какой-либо  антивирусный
монитор.  Если запускаемая программа заражена вирусом, то такой  монитор
поможет обнаружить вирус и остановить его распространение.

        Как  следствие  из  третьего  правила  вытекает  необходимость в
ограничении круга  лиц, допущенных  к работе  на конкретном  компьютере.
Как правило, наиболее часто подвержены заражению "многопользовательские"
персональные компьютеры (например, установленные в компьютерных  классах
институтов).

                           Правило четвертое
                           -----------------
        Пользуйтесь  утилитами  проверки  целостности  информации. Такие
утилиты  сохраняют  в  специальных  базах  данных информацию о системных
областях дисков (или  целиком системные области)  и информацию о  файлах
(контрольные  суммы,  размеры,  атрибуты,  даты  последней   модификации
файлов  и  т.д.).  Периодически  сравнивайте  информацию,  хранящуюся  в
подобной  базе  данных, с   реальным  содержимым  винчестера,  так   как
практически  любое несоответствие  может  служить  сигналом  о появлении
вируса или "троянской" программы.


           4.2 Методика использования антивирусных программ
           ════════════════════════════════════════════════

        Перед  использованием  антивирусных  программ  крайне желательно
загрузиться с резервной копии  DOS, расположенной на заведомо  чистой от
вирусов и защищенной от записи  дискете. Это необходимо для того,  чтобы
застраховаться  от  присутствия  резидентного  вируса,  так как он может
блокировать  работу   антивируса  или   использовать  его   работу   для
инфицирования проверяемых  файлов. Перезагрузка  компьютера должна  быть
холодной, так как некоторые вирусы "выживают" при теплой перезагрузке.

        Желательно,  чтобы  антивирусные  программы,  используемые   для
проверки, были самых последних версий. Желательно также, чтобы хоть одна
из них была отечественного производства,так как процесс эмиграции вируса
в другие  страны и  иммиграции антивирусных  программ занимает  довольно
большое время.  Поэтому  наиболее оперативно на появление  нового вируса
реагируют только отечественные антивирусные программы.

        Если обнаружены зараженные файлы, то следует:

        а) распечатать их список;
        б) если для этих файлов нет backup-копии, то сохранить их на
           дискеты;
        в) при помощи антивирусной программы восстановить зараженные
           файлы и затем проверить их работоспособность и соответствие
           backup-копии (если есть);
        г) если восстановление файлов произошло не вполне корректно, то
           их следует уничтожить и переписать с backup-копий, если же
           копий нет, то восстановить зараженные файлы с дискет и
           попытаться дезактивировать их при помощи другого антивируса.

        Следует  отметить,  что  качество  восстановления файлов многими
антивирусными программами  оставляет желать  лучшего. Многие  популярные
антивирусы частенько необратимо портят файлы вместо их лечения.  Поэтому
если потеря  файлов нежелательна,  то выполнять  пункты а)-г)  следует в
полном объеме.

        Необходимо  обращать  особое  внимание   на  чистоту  файлов   в
архивированных данных (ZIP, ARC, ICE и прочие архивные файлы) и в  самих
backup-копиях программного  обеспечения, так  как архивы  и backup-копии
являются  основными  поставщиками  давно  известных вирусов. Вирус может
годами  "сидеть"   в  дистрибутивной   копии  какого-либо   программного
продукта  и  неожиданно  проявиться  при  установке  программ  на  новом
компьютере.

        Никто  не  может  гарантировать  полного уничтожения всех  копий
компьютерного вируса, так  как файловый вирус  может поразить не  только
выполняемые файлы, но и оверлейные модули с расширениями имени, отличным
от исполняемых  файлов. Загрузочный  вирус может  остаться на какой-либо
дискете и внезапно проявиться при случайной попытке перезагрузить с нее.
Поэтому целесообразно  некоторое время  после удаления  вируса постоянно
пользоваться резидентным антивирусным монитором. Если вирус резидентный,
то следует выяснить, как он выглядит на карте оперативной памяти,и после
дезактивации вируса периодически  просматривать карту памяти  на предмет
обнаружения этого вируса.

        И  последнее  замечание.  Не  каждый  сбой  компьютера  является
проявлением вируса, поэтому почаще вспоминайте поговорку "не так страшен
черт, как его малюют". К тому же поражение вирусом не самое плохое,  что
может случиться с компьютером.


                  4.3 Обнаружение неизвестного вируса
                  ═══════════════════════════════════

        В  этом  разделе  рассматриваются  ситуации,  с  которыми  может
столкнуться  пользователь  в  том  случае,  если  его  компьютер поражен
вирусом,  но  ни  одна  из  известных  ему антивирусных программ не дала
положительного результата.   Где и  как искать  вирус?   Какие при  этом
необходимы  инструментальные   средства  и   какими  методами    следует
пользоваться?


                  4.3.1 Обнаружение файлового вируса
                  ══════════════════════════════════

        Как  известно,  вирусы  делятся  на резидентные и нерезидентные.
Встречавшиеся  мне  до  сих  пор  резидентные  вирусы отличались гораздо
большим  коварством  и  изощренностью,  чем  нерезидентные.  Поэтому для
начала рассмотрим  простейший случай - поражение компьютера  неизвестным
нерезидентным   вирусом.   Такой   вирус   активизируется   при  запуске
какой-либо  зараженной  программы,  совершает  все,  что  ему  положено,
передает управление  программе-носителю и  в дальнейшем  ( в  отличие от
резидентных вирусов) не будет мешать ее работе.  Для обнаружения  такого
вируса необходимо побайтно  сравнить дистрибутивные копии  (упоминание о
важности хранения  таких копий  уже стало  банальностью) с используемыми
программами.  В  настоящее  время  разработано  достаточно  много утилит
такого сравнения файлов,  самая простейшая из  них ( утилита  COMP.COM )
содержится в DOS.

        Существуют  специальные  утилиты,  которые  не только сравнивают
содержимое  файлов  и  их  параметров  (длина, атрибуты, время последней
модификации),  но  и  сообщают  о  наличии в разных файлах повторяющихся
одинаковых участков кода или проверяют файлы на наличие "подозрительных"
команд  (например,  утилита  Mask  Locator  Александра  Шеховцова).Такие
утилиты  очень  удобны,   но  иногда  начинают   "ругаться"  на   широко
распространенные упаковщики EXE-файлов и некоторые файлы DOS, к тому  же
они плохо обнаруживают вирусы, часть кода которых зашифрована.

        Можно  также  просмотреть  дамп  выполняемых файлов. В некоторых
случаях можно сразу обнаружить присутствие вируса по наличии в его  коде
текстовых  строк.  Многие  вирусы,  например,  содержат  строки: ".COM",
"*.COM","*.*","MZ","COMMAND"  и  т.д.  Существует  и  еще  один   способ
визуального определения  зараженного вирусом  файла. Он  основан на том,
что выполняемые файлы, исходный текст которых написан на языке  высокого
уровня, имеют вполне определенную  структуру: сегмент кода программы,  а
сразу за  ним -  сегмент данных,  причем в  начале этого  сегмента стоит
строка-копирайт  фирмы-изготовителя  компилятора.  Если  в  дампе такого
файла  за  сегментом  данных  следует  еще  один участок кода, то вполне
вероятно, что файл заражен вирусом.

        Рекомендуется  запустить   одну  из   резидентных   антивирусных
программ-мониторов  и  следить  за  ее  сообщениями  о  "подозрительных"
действиях программ  (запись в  COM- или  EXE-файлы,  запись на  диск  по
абсолютному  адресу  и  т.п.).   Существуют  мониторы, которые не только
перехватывают  такие  действия,  но  и  сообщают  адрес, откуда поступил
"подозрительный" вызов (к  таким мониторам относится  -D.COM). Обнаружив
подобное сообщение, следует  выяснить от какой  программы оно пришло,  и
проанализировать ее коды при помощи резидентного дизассемблера (например,
-UTIL.COM).


                 4.3.2 Обнаружение загрузочного вируса
                 ═════════════════════════════════════

        В загрузочных секторах дисков расположены как правило  небольшие
программы, назначение  которых состоит  в определении  размеров и границ
логических  дисков  (для  MBR  винчестера)  или  загрузке   операционной
системы  (для   Boot-сектора).    Дампы  таких   программ  приведены   в
Приложении 2.

        Следует  прочитать  содержимое  сектора,  "подозрительного"   на
наличие  вируса.  Для   этой  цели  лучше   использовать  программы   из
"Нортоновских утилит".

        Некоторые  загрузочные  вирусы  практически  сразу  обнаруживают
свое присутствие различными текстовыми строками (например, вирус "Stone"
содержит  строки: "Your  PC  is  now  Stoned!",  "LEGALISE MARIJUANA!").
Некоторые   вирусы,   поражающие   Boot-секторы   дисков,    проявляются
отсутствием строк, обязательно присутствующих  в Boot-секторе.  К  таким
строкам  относятся  строка-заголовок   Boot-сектора,  содержащая   номер
версии  DOS  или  название  фирмы-производителя программного обеспечения
(например, строка "MSDOS3.3"); имена системных файлов (например,  строка
"IO SYSMSDOS SYS"); строки сообщений об ошибках.

        Стандартный  загрузчик,  расположенный  в  MBR,  занимает меньше
половины сектора, и многие  вирусы, поражающие  MBR винчестера, довольно
просто заметить по увеличению длины кода, расположенного в секторе MBR.

        Однако  существуют  вирусы,  которые  внедряются в загрузчик без
изменения  его  текстовых  строк  и  с  минимальными  изменениями   кода
загрузчика  (например,  вирусы,  изменяющие  при инфицировании MBR всего
три  байта  Disk  Partition  Table,  соответствующие  адресу   активного
загрузочного сектора). Для идентификации такого вируса придется провести
более  детальное  исследование  кодов  загрузочного  сектора  вплоть  до
полного анализа алгоритма работы его кода.

        Приведенные  рассуждения  основываются  на  том,что  стандартные
загрузчики (программы, записываемые операционной системой в  загрузочные
секторы) реализуют стандартные алгоритмы загрузки операционной системы и
оформляются   в   соответствии   с   ее   стандартами.   Если  же  диски
отформатированы утилитами,  не входящими  в состав  DOS (например,  Disk
Manager),  то  для  обнаружения  в  них  вируса следует проанализировать
алгоритм работы и оформление загрузчиков, создаваемых такой утилитой.



        Рассмотренные  выше  методы  обнаружения  файловых и загрузочных
вирусов подходят  для большинства  как резидентных,  так и нерезидентных
вирусов.  Однако  эти  методы  не  срабатывают,  если  вирус выполнен по
технологии  "стелс",  что  делает  бесполезным использование резидентных
мониторов, утилит сравнения файлов и чтения секторов.


              4.3.3 Обнаружение резидентной части вируса
              ══════════════════════════════════════════

        Если  в  компьютере  обнаружены  следы  деятельности  вируса, но
видимых изменений в файлах  и системных секторах дисков  не наблюдается,
то вполне возможно,  что компьютер поражен  одним из "стелс"-вирусов.  В
этом случае лучше  загрузить DOS с  заведомо чистой от  вирусов дискеты,
содержащей  резервную  копию  DOS,  и  действовать  как  и при поражении
нерезидентным вирусом. Однако иногда это нежелательно, а в ряде  случаев
невозможно  (известны,  например,  случаи  покупки  новых   компьютеров,
зараженных  вирусом).   Тогда  придется   обнаружить  и   нейтрализовать
резидентную часть вируса,  выполненную по технологии  "стелс". Возникает
вопрос:  где  в  памяти  и  как  искать вирус или его резидентную часть?
Существует несколько способов инфицирования памяти.

        1. Вирус может проникнуть в таблицу векторов прерываний
        -------------------------------------------------------

        Лучший  способ  обнаружить  такой  вирус  состоит  в  том, чтобы
просмотреть  карту  распределения  памяти,  которая  отображает   список
резидентных программ (пример такой карты приведен в табл.4.1). Подробная
карта  памяти  сообщает  информацию  о  всех  блоках, на которые разбита
память:   адрес блока  управления памятью  MCB, имя  программы-владельца
блока  и  ее  адрес  префикса  программного  сегмента  (PSP)  и   список
перехватываемых блоком векторов прерываний.

        При  наличии  вируса  в  таблице  векторов  прерываний  утилиты,
отображающие карту распределения  памяти (например, -D.COM,  -UTIL.COM),
начинают "шуметь".

   Таблица 4.1. Карта распределения незараженной памяти

  ╔═════╤═════╤═══════╤═════════════╤═══════════════════╗
  ║Адрес│Адрес│Размер │Имя программы│Номера векторов    ║
  ║блока│ PSP │блока  │владельца    │прерываний         ║
  ║ MCB │     │MCB(Кб)│блока MCB    │                   ║
  ╟─────┼─────┼───────┼─────────────┼───────────────────╢
  ║0E9A │0E9B │  3,20K│ COMMAND.COM │ 22,24,2E          ║
  ║0F6E │0F6F │  0,04K│блок свободен│                   ║
  ║0F72 │0E9B │  0,15K│ COMMAND.COM │                   ║
  ║0F7D │0F85 │ 23,20K│ -D.COM      │ 10,1B,1C,23,26,27 ║
  ║     │     │       │             │ 28,2F,40,EF,FF    ║
  ║1545 │1546 │  0,10K│блок свободен│                   ║
  ║154D │154E │  3,90K│ PLUCK.COM   │ 09,13,16,21       ║
  ║164B │0E9B │549,30K│ COMMAND.COM │ 30,EE,F2,F3,F4,F5 ║
  ║     │     │       │             │ F6,F7,F8,FE       ║
  ╚═════╧═════╧═══════╧═════════════╧═══════════════════╝


   Таблица 4.2. Таблица векторов прерываний поражена вирусом

  ╔═════╤═════╤═══════╤═════════════╤═══════════════════╗
  ║Адрес│Адрес│Размер │Имя программы│Номера векторов    ║
  ║блока│ PSP │блока  │владельца    │прерываний         ║
  ║ MCB │     │MCB(Кб)│блока MCB    │                   ║
  ╟─────┼─────┼───────┼─────────────┼───────────────────╢
  ║0E9A │0E9B │  3,20K│ COMMAND.COM │ 22,24,2E,EB       ║
  ║0F6E │0F6F │  0,04K│блок свободен│                   ║
  ║0F72 │0E9B │  0,15K│ COMMAND.COM │                   ║
  ║0F7D │0F86 │ 23,20K│ -D.COM      │ 10,1B,23,26,27,28 ║
  ║     │     │       │             │ 2F,40,CA,D3       ║
  ║1546 │1547 │  0,10K│блок свободен│                   ║
  ║154E │154F │  3,90K│ PLUCK.COM   │ 09,13,16,91       ║
  ║164C │0E9B │549,30K│ COMMAND.COM │ 30,85,89,8E,90,93 ║  ──┐
  ║     │     │       │             │ 95,97,98,9D,9E,9F ║    │
  ║     │     │       │             │ A2,A7,A9,AB,AE,AF ║    │
  ║     │     │       │             │ B1,B3,BB,BE,BF,C0 ║    ├─ "Шум"
  ║     │     │       │             │ C4,C9,CE,CF,D0,D1 ║    │
  ║     │     │       │             │ D2,D4,D5,D8,D9,DA ║    │
  ║     │     │       │             │ DB,DD,DF,E0,E4,E5 ║    │
  ║     │     │       │             │ E6,E7,E8,E9,EA,ED ║    │
  ║     │     │       │             │ EE,F3,F4,F5,F7,F8 ║    │
  ║     │     │       │             │ F9                ║  ──┘
  ╚═════╧═════╧═══════╧═════════════╧═══════════════════╝


        Другой,  более  надежный,  но  требующий  высокой   квалификации
пользователя  способ,   -  просмотреть   таблицу  векторов   с   помощью
дизассемблера. Если при этом будут обнаружены коды  какой-то  программы,
то код вируса (или участок кода) найден.



        2. Вирус  может  несколькими  способами   встроиться  в  DOS:  в
           произвольный системный драйвер,  в системный буфер,  в другие
           рабочие области DOS (например, в область системного стека или
           в свободные места таблиц DOS и BIOS)
        ----------------------------------------------------------------

        Известен единственный способ инфицирования вирусом произвольного
системного  драйвера:   прикрепление  тела  вируса  к файлу, содержащему
драйвер, и модификация  заголовка поражаемого драйвера.   В этом  случае
вирус  можно  обнаружить  при  просмотре  карты  распределения   памяти,
содержащей  список  системных   драйверов.  Если  при   этом  в   списке
присутствует драйвер,  который не  описан в  файле CONFIG.SYS,  то он  и
может быть вирусом.

        Вирус, встраивающийся в системный буфер, должен уменьшать  общее
число  буферов,  в  противном  случае  он  будет  уничтожен последующими
операциями считывания с  диска. Достаточно несложно  написать программу,
которая подсчитывает число буферов, реально присутствующих в системе,  и
сравнивает   полученный   результат   со   значением   команды  BUFFERS,
расположенной в файле CONFIG.SYS  (если команда BUFFERS отсутствует,  то
со  значением,  устанавливаемым  DOS  по  умолчанию).  Подобная проверка
прекрасно работает (100% попаданий) в антивирусной программе -V.EXE.

        Существует  достаточно  способов  внедрения  вируса  в системные
таблицы или область стека DOS. Однако реализация этих способов потребует
от автора вируса досконального знания  различных версий DOS.  К  тому же
свободного места в DOS не так уж много, и поэтому написание полноценного
"стелс"-вируса такого типа маловероятно. Если же все-таки подобный вирус
появится,то обнаружить его код можно дизассемблированием "подозрительных" 
на наличие вируса участков DOS.



        3. Вирус может проникнуть в область программ в виде:
        ----------------------------------------------------
             а) отдельной резидентной программы или отдельного блока
                памяти (MCB);
             б) внутри или "приклеившись" к какой-либо резидентной
                программе.

        Если  вирус  внедряется  в  отведенную  для  прикладных программ
область памяти в виде нового  блока, создавая для себя собственный  MCB,
или как отдельная  резидентная  программа,  то его можно  обнаружить при
просмотре подробной карты распределения памяти, отображающей адреса всех
блоков MCB. Обычно такой вирус выглядит как отдельный блок памяти (табл.
4.3), не  имеющий имени  и перехватывающий  одно или  несколько векторов
прерываний (например, int 8h, int 13h, int 1Ch или int 21h).

   Таблица 4.3. Вирус в области пользовательских программ

  ╔═════╤═════╤═══════╤═════════════╤═══════════════════╗
  ║Адрес│Адрес│Размер │Имя программы│Номера векторов    ║
  ║блока│ PSP │блока  │владельца    │прерываний         ║
  ║ MCB │     │MCB(Кб)│блока MCB    │                   ║
  ╟─────┼─────┼───────┼─────────────┼───────────────────╢
  ║0E9A │0E9B │  3,20K│ COMMAND.COM │ 22,24,2E          ║
  ║0F6E │0F6F │  0,04K│блок свободен│                   ║
  ║0F72 │0E9B │  0,15K│ COMMAND.COM │                   ║
  ║10D1 │10DA │ 23,20K│ -D.COM      │ 10,1B,23,26,27,28 ║
  ║     │     │       │             │ 2F,40             ║
  ║17AF │17B0 │  1,70K│      ?      │ 08     <────┐     ║
  ║1820 │0E9B │539,30K│ COMMAND.COM │ 30,31       │     ║
  ║9F04 │0000 │  3,90K│      ?      │ 1C,21  <──┐ │     ║
  ╚═════╧═════╧═══════╧═════════════╧═══════════│═│═════╝
                                                │ │
              Обнаружен вирус "Yankee Doodle". ─┘ │
              Обнаружен вирус "Jerusalem".     ───┘


        Вирус  может  "приклеиться"  к  программам,  которые  резидентно
размещены в памяти.  В  этом случае обнаружить его сложнее  - необходимо
знать  реальную  длину   программ,  размещенных  в   памяти,  и   список
прерываний, которые они перехватывают.


        4. Вирус может проникнуть за границу памяти, выделенной под DOS
        ---------------------------------------------------------------

        Все  загрузочные  и  некоторые  файловые вирусы располагаются за
пределами  памяти,   выделенной  для   DOS,  уменьшая   значение  слова,
расположенного по  адресу [0040:0013].   Обнаружить такие  вирусы  очень
просто - достаточно  узнать емкость оперативной  памяти и сравнить  ее с
реальной. Если вместо 640 или  512 Кб система сообщит меньшее  значение,
то следует просмотреть дизассемблером "отрезанный" участок памяти.  Если
на этом  участке будут  обнаружены коды  какой-то программы,  то, скорее
всего, вирус найден.

Внимание! В некоторых компьютерах, использующих расширенную память,
          емкость оперативной памяти уменьшается на 1 Кб.


        5. Вирус может встраиваться в конкретные, заведомо резидентные
           программы
        --------------------------------------------------------------

        Возможно  инфицирование  вирусом  файлов  DOS,  которые являются
резидентными  (например,  IO.SYS,  MSDOS.SYS,  COMMAND.COM), загружаемых
драйверов (ANSY.SYS, COUNTRY.SYS, RAMDRIVE.SYS) и др.  Обнаружить  такой
вирус гораздо сложнее вследствие малой скорости его распространения, но,
однако, вероятность атаки подобного вируса значительно меньше.

        Предлагается способ, который может облегчить выявление вируса  в
подобной  ситуации.  Он  основан  на  следующем  свойстве -  подавляющее
большинство  вирусов  для  обнаружения  незараженных файлов или секторов
дисков  перехватывают  прерывания  int  13h  или  int 21h, встраиваясь в
обработчик прерывания. В таком случае для обнаружения вируса  достаточно
просмотреть   текст   (команды   ассемблера)   обработчиков    указанных
прерываний (например, при помощи программы -UTIL.COM). Правда, для того,
чтобы отличить  вирус от  обычных программ,  требуется достаточный  опыт
работы с вирусами и  некоторое представление о структуре  обработчика на
незараженном компьютере.


        Конечно,  возможны  и  другие,  достаточно экзотические, способы
инфицирования памяти вирусом,  например, внедрение вируса  в видеопамять
(что уже встречалось), но подобные вирусы встречаются достаточно редко.


                      4.4 Анализ алгоритма вируса
                      ═══════════════════════════

          Когда вирус выделен из  памяти или  обнаружен зараженный файл,
дальнейшие действия ясны - предстоит проделать анализ  алгоритма вируса,
т.е. выяснить:

        а) способ(ы) его размножения;
        б) характер возможных повреждений, которые вирус нанес
           информации, хранящейся на дисках;
        в) метод лечения оперативной памяти и зараженных файлов
           (секторов).

        При  решении  этих  задач  не  обойтись  без  дизассемблера  или
отладчика  (например,  отладчиков  Quaid  Analyzer,  Advanced   Trace86,
FULSCREEN DEBUG или дизассемблеров DisDoc и Sourcer).

        И   отладчики   и   дизассемблеры   имеют   и   положительные  и
отрицательные черты - каждый выбирает то, что он считает более  удобным.
Несложные короткие  вирусы быстро  "вскрываются" стандартным  отладчиком
DEBUG, при анализе  объемных и высокосложных  (типа вируса "V-4096")  не
обойтись без  дизассемблера.   Если необходимо  быстро обнаружить  метод
восстановления пораженных файлов,  то достаточно пройтись  отладчиком по
началу  вируса  до  того  места,  где  он  восстанавливает   загруженную
программу перед тем, как передать ей управление (фактически именно  этот
алгоритм чаще всего используется при лечении вируса). Если же  требуется
получить детальную  картину работы  вируса или  хорошо документированный
листинг,   то   кроме   дизассемблера   Sourcer   и   его    возможности
восстанавливать перекрестные ссылки здесь вряд ли что поможет. К тому же
следует учитывать,  что во-первых,  некоторые вирусы  достаточно успешно
блокируют попытки  протрассировать их  коды, а  во-вторых, при  работе с
отладчиком  существует  ненулевая  вероятность  того, что вирус вырвется
из-под контроля.

        На мой взгляд,  наиболее удобным для  хранения и анализа  вируса
является   файл,   содержащий   его   (вируса)   тело.  Если  необходимо
проанализировать  часть  оперативной  памяти,  то  при  помощи некоторых
утилит  (например,  -UTIL.COM)  довольно  просто  выделить  участок, где
расположен вирус и скопировать этот  участок на диск. Если же  требуется
анализ сектора  MBR или  Boot-сектора, то  скопировать их  в файлы можно
при помощи популярных "Нортоновских утилит".


        При анализе  файлового вируса  необходимо выяснить,  какие файлы
поражает вирус, в какое место  (места) в файле записывается код  вируса,
в каком объеме возможно  восстановление файла (полностью или  частично),
в каком месте вирус хранит восстанавливаемую информацию.

        При  анализе  загрузочного  вируса  основной  задачей   является
выяснение  адреса   (адресов)  сектора,   в  котором   вирус   сохраняет
первоначальный загрузочный сектор (если, конечно, вирус сохраняет его).

        Для резидентного вируса также необходимо выделить участок  кода,
создающий резидентную  копию вируса  и вычислить  возможные адреса точек
входа в перехватываемые  вирусом прерывания. Необходимо  также выяснить,
каким образом и где в оперативной памяти выделяет вирус место для  своей
резидентной  копии:  записывается  ли  вирус  по фиксированным адресам в
системные области DOS  и BIOS, уменьшает  размер памяти, выделенной  под
DOS (слово по адресу [0000:0413]), создает для себя специальный MCB-блок,
либо использует какой-либо другой способ.


        Существуют особые  случаи, когда  анализ вируса  может оказаться
очень сложной  для пользователя  задачей,  например  при анализе вируса-
"призрака".В этом случае лучше обратиться к специалисту по анализу кодов
программ.


                4.5 Восстановление пораженных объектов
                ══════════════════════════════════════

        При поражении компьютера  произвольным вирусом могут  возникнуть
следующие задачи: дезактивация  резидентной памяти, лечение  загрузочных
секторов  (MBR,  Boot),   обход  подкаталогов  всех   дисков,  поиск   и
восстановление зараженных файлов.


                 4.5.1 Дезактивация оперативной памяти
                 ═════════════════════════════════════

        При лечении оперативной памяти следует обнаружить коды вируса  и
изменить их  таким образом,  чтобы вирус  в дальнейшем  не мешал  работе
антивирусной программы.

        Оптимальный алгоритм обнаружения кодов вируса зависит от способа
инфицирования  вирусом  оперативной  памяти.  Если вирус записывает свою
резидентную копию по фиксированным адресам, то и искать ее нужно по этим
адресам.  Если  вирус  создает  для  своей  TSR-копии новый MCB-блок, то
следует пройти все MCB-блоки, начиная с первого и кончая последним, и  в
каждом блоке  по фиксированным  адресам искать  коды вируса.  Если вирус
записывается  за  пределами  памяти  DOS, предварительно уменьшая размер
выделенной  под  DOS  памяти,  то  следует  провести полное сканирование
"отрезанного" от DOS участка.Практически для всех способов инфицирования
вирусом  оперативной  памяти  подходит  метод  трассировки   прерываний,
рассмотренный в описании семейства вирусов "Yankee".

        После  того  как  определены  адреса  TSR-копии  вируса, следует
исправить его коды таким образом, чтобы полностью нейтрализовать влияние
вируса на процесс  поиска и лечения  зараженных файлов.   Например, если
вирус заражает файлы  при их открытии,  то это может  выглядеть примерно
следующим образом:

Исходный код вируса                   Код дезактивированного вируса
-------------------                   -----------------------------
. . . .     . . . . .                 . . . .      . . . . .
80 FC 3D    CMP   AH,3Dh              80 FC 3D     CMP   AH,3Dh
74 xx       JE    Infect_File         90           NOP
E9 xx xx    JMP   Continue            90           NOP
. . . .     . . . . .                 E9 xx xx     JMP   Continue
                                      . . . .      . . . . .

        При дезактивации TSR-копии  вируса следует учитывать,  что вирус
может  предпринимать  специальные  меры  для  восстановления своих кодов
(например,  некоторые  вирусы  семейства  "Yankee"),  и  в  этом  случае
придется нейтрализовать и механизм самовосстановления вируса.


               4.5.2 Восстановление загрузочных секторов
               ═════════════════════════════════════════

        Восстановление секторов в большинстве случаев является  довольно
простой операцией и проделывается при помощи "Нортоновских утилит".  При
заражении  компьютера  вирусом  со  сложным  алгоритмом основной задачей
становится определение адреса  сектора, в котором  находится сохраненный
вирусом оригинальный загрузочный сектор.  Некоторые вирусы не  сохраняют
старое содержимое сектора, в  этом случае придется восстанавливать  коды
загрузочного  сектора  по  какому-либо  образцу  (например, по образцам,
приведенным в Приложении 2).

        При  восстановлении  системных  загрузчиков  следует   соблюдать
особую  осторожность,  поскольку  результатом  неправильного исправления
сектора MBR или Boot-сектора может быть потеря всей информации на  диске
(дисках).  Поэтому   даже  довольно   простую  процедуру   считывания  и
восстановления  оригинального  загрузочного  сектора следует обязательно
проверить на корректность. Простейшей проверкой является наличие в конце
загрузочного сектора сигнатуры AA55h.


                      4.5.3 Восстановление файлов
                      ═══════════════════════════

        При лечении файлов следует учесть следующие правила:

        а) необходимо протестировать и вылечить все выполняемые
           файлы (COM, EXE, оверлеи) во всех каталогах всех дисков вне
           зависимости от атрибутов файлов (т.е. файлы read-only,
           системные и скрытые);
        б) желательно сохранить неизменными атрибуты и дату последней
           модификации файла;
        в) следует учесть возможность многократного поражения файла
           вирусом ("бутерброд" из вирусов).

        Само лечение файла  производится в большинстве  случаев довольно
просто. Если вирус записывается в конец файла,то необходимо восстановить
старое начало файла  (у EXE-файлов особое  внимание следует обратить  на
корректность полей восстанавливаемых заголовков) и затем отрезать  вирус
от файла (пример программы, восстанавливающей файлы, пораженные  вирусом
"Vienna-648", приведен в  Приложении 2). Если  вирус записался в  начало
файла,  то  следует  переписать  старое  содержимое  файла в его (файла)
начало и укоротить файл.

        В более  сложных случаях  (особенно, если  вирус зашифрован  или
выполнен по технологии  "призрак") процедура восстановления  файла может
существенно усложниться.

