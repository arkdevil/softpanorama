*******FREEWARE********FREEWARE********FREEWARE********FREEWARE*******


        В июльском номере СОФТПАНОРАМЫ была перепечатана просто отличная
статья  -  "Как  извлечь  максимум  из  системной  памяти  DOS  в высших
адресах".  Думаю,  что  она  привлекла  внимание многих. А вот небольшая
программа  hdump.com  Олейника  (увы,  без  указания инициалов), имеющая
прямое отношение  к излагаемому  в статье  материалу, почему-то  не была
снабжена даже  малюсеньким файлом  типа readme.  Вышеназванные материалы
привлекли  внимание  автора  этих  строк  потому,  что  являясь   (пока)
сторонником DOS версии 3.30, он в течение продолжительного времени искал
возможность  использовать  HMA  для  небольших  TSR-программ.  Кое-какую
информацию удалось  "наскрести", чем  и хотелось  бы сегодня поделиться.
Поскольку  автор  не  является  профессиональным  программистом в полном
смысле этого слова, то указания на возможные "ляпы" в изложении примет с
благодарностью и вниманием.
        Для того, чтобы прикладная программа получила доступ к HMA, она,
как  правило,   выполняет  несколько   обязательных  действий.   Сначала
вызывается подфункция 00h (AL=00h)  прерывания DOS 2Fh с  мультиплексным
номером 43h (AH=43h), содержание других регистров при этом произвольное.
В случае, если в регистре AL возвращается число 80h - драйвер  HIMEM.SYS
действительно установлен.  На следующем  шаге вызывается  подфункция 10h
(AL=10h) того же  прерывания с тем  же мультиплексным номером.  Значения
возвращаемые в регистрах ES и BX являются полным адресом (ES -  сегмент,
BX - смещение) диспетчера памяти HMA. Всю дальнейшую работу - требование
предоставления HMA, ее освобождение, активирование и отключение адресной
шины  А20  -  выполняют  функции  диспетчера,  которые вызываются по его
полному адресу и соответствующему значению, занесенному в регистр AH.
        Функция  01  (AH=01h)  диспетчера  HMA запрашивает использование
некоторой части  (или полностью)  HMA, причем  количество требуемых байт
должно быть  предварительно занесено  в регистр  DX. В  случае успешного
выполнения функции в регистре AX возвращается значение 01h, если это  не
так - HMA уже используется. Функция 03 (AH=03h) активирует адресную шину
А20 микропроцессора i80286, ее безошибочное выполнение также  определяет
возвращаемое значение 01h  в регистре AX.  После этого требуемый  размер
памяти  можно  считать  выделенным.  Функции  02  (AH=02h) и 04 (AH=04h)
обратны  по  своим  действиям  функциям  рассмотренным  выше,  то   есть
освобождают HMA и дезактивируют адресную шину А20.
        Так  как  автор  испытывает  к  группе  Compact-Soft   искреннюю
симпатию (особенно  к продуктам  Игоря А.  Свиридова), то,  не выдумывая
велосипед, "приспособил" отличную программу Alarm (Created by Sia),  для
использования в HMA, внеся дополнительно незначительные изменения. Текст
программы Alarm.asm  был опубликован,  поэтому в  файле alrm_hma.~sm дан
некий "скелет" программы достаточный для понимания того, как  разместить
процедуру обработки  прерывания в  HMA. Упомянутая  выше программа hdump
может помочь вам при отладке,  хотя сам автор использовал обычный debug.
При совпадении показаний часов реального времени и показаний"будильника"
звучит гудок динамика и левом верхнем углу экрана появляются   мерцающие
(желтые  на  красном)  показания  "будильника".  После  нажатия на любую
клавишу  гудок  прекращается  и  в  левом верхнем углу экрана появляется
старое  изображение (только для текстовых режимов).



                        Андрей Е. Борзенко
                        р.т. (095)-556-42-25
                        г.Жуковский
