
                                                   Л. Г. Б у н и ч

              Программа сравнения исходных текстов
              ------------------------------------

                 Редакция:  1.1  (август 1990)


                    1. Назначение программы

   Программа SMCOMP (Source Modules COMParison)  осуществляет "ин-
теллектуальное" сравнение текстовых файлов, отмечая  вставки, уда-
ления и изменения строк. По своим возможностям  и  предоставляемым
удобствам она лучше стандартной утилиты FC, входящей в MS-DOS. Ос-
новой при написании SMCOMP послужили одноименная  утилита  автора,
написанная на PL/1  для ОС ЕС,  и  аналогичные по функциям утилиты
CMP (RSX-11) и DIFF (UNIX) на СМ-4.

   Сравнение текстов - важная и часто встречающаяся операция.  Она
необходима, например, в следующих задачах:

    - сопровождение комплексов программ;
    - исследование новых редакций программного обеспечения;
    - восстановление испорченных программ или данных;
    - подготовка документации на программные средства.

   Перечислим некоторые особенности программы SMCOMP.

   1. Программа выводит на экран или в файл протокол,  по которому
      можно составить ясное представление о степени различия срав-
      ниваемых текстов. В протоколе отмечаются номера строк.

   2. Формируется код завершения: нуль, если оба текста идентичны.

   3. Предусмотрены два формата протокола:

      (A) Краткий протокол различий (по умолчанию).
      (B) Полный протокол.  В этом режиме  целиком распечатывается
          второй из сравниваемых файлов, причем все его строки, не
          совпадающие  со строками  первого файла,  будут помечены
          слева символами "!!" (восклицательные знаки).

   4. Сравнение строк может быть "плавающим", т.е.  не   учитывать
      сдвиги, лишние пробелы и символы табуляции.

   Покажем на примере стандартный формат протокола:

┌────────────────────────────────────────────────────────────────┐
│   Программа сравнения тeкcтoв ред. 1.1  Бунич Л.Г.             │
│                                                                │
│    -- размещены два буфера сравнения по 300 строк каждый --    │
│    -- параметры сравнения:  pr=100  nc=3 --                    │
│                                                                │
│ Первый файл (T1): SMCOMP.C                                     │
│ Второй файл (T2): D:\WORK\SMCOMP.C                             │
│                                                                │
│ ------ П p o т o к o л   c p a в н e н и я --------            │
│                                                                │
│ ** Строки 1-3 (T1) и 1-3 (T2) совпадают                        │
│ ** Несовпадение:                                               │
│                                                                │
│ T1     4│   *            ред.  1.1  (август  1990)             │
│                                                                │
│ T2     4│   *            ред.  1.0  (июнь  1990)               │
│                                                                │
│ ** Строки 5-77 (T1) и 5-77 (T2) совпадают                      │
│ ** B файле T2 отсутствуют строки:                              │
│                                                                │
│ T1    78│prpar:                                                │
│       79│    if (strcmp(w.buf+1, "PR") != 0) goto ParamError;  │
│       80│    w.p++; getword(&w);                               │
│       81│    sscanf(w.buf, "%u", &prl);                        │
│       82│    goto OptLoop;                                     │
│                                                                │
│ ** Строки 83-88 (T1) и 78-83 (T2) совпадают                    │
│ ** Несовпадение:                                               │
│                                                                │
│ T1    89│    printf("\tNC=длина фрагмента совпадения\n");      │
│       90│    printf("\tPR=предел печати несовпавших строк\n"); │
│                                                                │
│ T2    84│    printf("\tNC=длина фрагмента совпадения\n");      │
│                                                                │
│ ** Строки 91-248 (T1) и 85-242 (T2) совпадают                  │
│ ** Итого в T1 248 строк, в T2 242 строк                        │
└────────────────────────────────────────────────────────────────┘

   Разрешается свободное распространение и использование программы
SMCOMP в некоммерческих целях  и в неизмененном виде.  Разрешается
также по согласованию с разработчиком доработка системы  при усло-
вии, что текст и описание  всех  модификаций  предоставляются; ав-
торские права за авторами доработок признаются без ограничений.

   Тел. для справок:   591-90-00 служ.

                       Москва


                       2. Запуск программы

   Программа запускается командой:

       SMCOMP  первый_файл  второй_файл  [параметры]...

   Вообще говоря, надо указать оба сравниваемых  файла.  Если тре-
буется, укажите пути к ним и устройства. Часто  бывает,  что   оба
файла называются одинаково, но находятся в разных  оглавлениях;  в
этом случае можно опустить имя второго файла, т.е.  задать  только
его оглавление, заканчивающееся символом  '\' (обратная косая),  а
если к тому же второй файл находится в текущем оглавлении, то мож-
но вообще этот операнд не указывать.

   Например, приведенный протокол был  получен командой:

       smcomp  smcomp.c  d:\work\

   С тем же успехом можно было дать команду:

       smcomp  d:\work\smcomp.c

но в этом случае файлы в протоколе будут "переставлены".

   Отметим,  что в режиме печати полного протокола выводится текст
только второго файла. Например, при сравнении новой редакции текс-
та со старой вам следует указать первым файлом СТАРЫЙ текст.

   Если запустить SMCOMP, указав только ее имя, программа  выводит
краткую подсказку и заканчивает работу с кодом завершения 0.

   По умолчанию программа выводит протокол на экран. Чтобы вывести
его в файл, воспользуйтесь средством переназначения MS-DOS, напри-
мер:

      smcomp instr.doc instr.bak > instr.lst

   Тогда весь протокол пойдет в файл INSTR.LST.
   Программа вырабатывает код завершения:

      0  (все записи совпали)
      2  (не все записи совпали)
      8  (заданы ошибочные параметры)

   Параметры программы необязательны и описаны в пункте 4.


                       3. Алгоритм работы

   Программа организует два буфера сравнения - по буферу  для каж-
дого файла. Затем начинается параллельный  просмотр  файлов.   Как
только обнаружено несовпадение, программа просматривает файлы впе-
ред, чтобы выяснить, где они снова совпадают.

   Несовпавшие фрагменты считаются законченными, если за ними сле-
дуют несколько совпавших строк.  Совпадение одной строки  в  обоих
файлах может быть случайным (например, пустые строки  присутствуют
почти во всех файлах), поэтому необходимо проверить совпадение не-
скольких строк подряд. Количество строк, которое  заставляет прог-
рамму признать несовпадение законченным, по умолчанию равно трем и
может быть задано среди параметров работы.

   Если  в пределах буферов  нет совпадающих  (в указанном смысле)
строк, программа распечатывает буфера и прекращает работу.

   В настоящей редакции  программы  каждый буфер  содержит  до 300
строк, а длина строки может быть до 100  символов  (лишние игнори-
руются).

   Вам  может  оказаться  полезным  режим  "плавающего"  сравнения
строк, при котором строки, отличающиеся только сдвигами слов, счи-
таются одинаковыми. В этом режиме строки перед  сравнением подвер-
гаются нормализации:

     - символы табуляции заменяются на пробелы;
     - пробелы в начале и конце строки удаляются;
     - несколько пробелов подряд заменяются на один.

   Пример: следующие тексты совпадают в "плавающем" режиме:

┌───(Первый текст)───────┬──────────(Второй текст)────────┐
│     if (x<0)           │         if  (x<0)              │
│     x=-1;              │             x=-1;              │
│     else x=1;          │           else    x=1 ;        │
└────────────────────────┴────────────────────────────────┘


                  4. Параметры работы программы

   Каждый параметр  начинается  с косой черты (/)  или минуса (-).
Перед минусом должен быть по крайней мере один пробел, перед косой
чертой он не обязателен. Параметры могут быть указаны перед имена-
ми файлов, после них или даже между ними.
   Набирать параметры можно строчными или заглавными буквами.
   Допустимые режимы:

      /NC=n  - количество строк, которое заставляет программу при-
               знать  несовпадение  законченным (по умолчанию  3).
               Другими словами, строки считаются совпавшими,  если
               совпадают не только они сами,  но и (NC - 1) преды-
               дущих строк.

      /PR=p  - максимальное число  печатаемых строк  в несовпавших
               фрагментах (по умолчанию 100).

      /PR=M  - в этом режиме  печатается  полный протокол различий
               (см. выше).

      /FLoat - плавающий режим сравнения (сокращенно: /FL).

   Вместо знака равенства в параметрах может быть двоеточие.
   Примеры задания режимов:

      SMCOMP A:MYPROG.C
             (сравнение с одноименным файлом в текущем оглавлении)

      smcomp vvod.bak vvod.prg/pr=m
             (полная распечатка последней редакции программы с по-
              меткой  изменений;  старый файл  должен быть  указан
              первым, а новый - вторым)

      Smcomp -pr:40 -nc:7 -fl readme.doc  D:\OLD\
