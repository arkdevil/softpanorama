Корнеев Максим  т.: (095)133-4635(д),(095)251-2946(р),(095)213-4416(р);
RELCOM: maxim@ulter.pccentre.msk.su;
117415 Москва пр-т Вернадского д 59 кв 57




                Библиотека функций работы с Extended памятью.

                        Руководство пользователя.


        1. НАЗНАЧЕНИЕ БИБЛИОТЕКИ

        Функциии библиотеки позволяют использовать блоки Extended памяти в
какачестве временных буферов хранения данных.
        Начиная с версии бибилиотеки 2.5 при недостатке свободной Extended
памяти автоматически происходит свопинг даных диск. При этом синтаксис команд
не изменяется. Признаком свопирования на диск является отрицательный handle
выделенного блока.
        Библиотека написана на Turbo Asembler'е для большой модели
памяти.
        Библиотека предназначена для использования с Turbo C 2.0 или более
поздними версиями.


        2. ТРЕБОВАНИЯ К СИСТЕМЕ

        Для работы с библиотекой функций необходимо:
        - IBM совместимая PC;
        - MS DOS 3.0 или более позняя;
        - в файле CONFIG.SYS должен загружаться HIMEM.SYS (при необходимости
          использования Extended).

        При использовании интегрированной среды компилятора Borland C++ 3.0 или
более поздней версии для отладки, необходимо учитывать что компилятор использует
Extended память для своих целей.


        3. ОПИСАНИЕ ФУНКЦИЙ БИБЛИОТЕКИ

-------------------------------------------------------------------------------
EMS_Open                                                               EMS_Open
-------------------------------------------------------------------------------

Функция                 Подготовка DOS к работе c Extended, сохраняет исходное
                        состояние системы.

Синтаксис               #include "ems_lib.h"
                        extern int EMS_Open(void)

Прототип в              EMS_LIB.H

Описание                Проверяет версию DOS, включает адресную шину
                        позволяющую использовать Extended, запоминает исходное
                        состояние системы, открывает файл для свопинга.

Возвращаемое значение   0 - успешное завершение
                        1 - система не инициализирована

Смотри                  EMS_Close


-------------------------------------------------------------------------------
EMS_Close                                                       EMS_Close
-------------------------------------------------------------------------------

Функция                 Восстановление исходного состояния DOS.

Синтаксис               #include "ems_lib.h"
                        extern int EMS_Close(void)

Прототип в              EMS_LIB.H

Описание                Восстанавливает состоянние адресной шины, которое было
                        до ипользования функции EMS_Open, закрывает файл
                        свопинга.

Возвращаемое значение   0 - успешное завершение
                        1 - система не инициализирована

Смотри                  EMS_Open


-------------------------------------------------------------------------------
Get_Free_Size                                                   Get_Free_Size
-------------------------------------------------------------------------------

Функция                 Возвращает размер наибольшего свободного блока.

Синтаксис               #include "ems_lib.h"
                        extern int Get_Free_Size(void)

Прототип в              EMS_LIB.H

Описание                Возвращает размер наибольшего свободного блока Extended
                        памяти, после вызова функции переменная Total_EXT
                        показывает общий размер доступной Extended памяти.

Возвращаемое значение   Размер наибольшего свободного блока Extended памяти,
                        если успешное завершение;
                        EMS_Error содержит код ошибки или 0.


Смотри                  EMS_Alloc, EMS_Free, EMS_Realloc.

-------------------------------------------------------------------------------
EMS_Alloc                                                       EMS_Alloc
-------------------------------------------------------------------------------

Функция                 Выделяет блок Extended памяти.

Синтаксис               #include "ems_lib.h"
                        extern long EMS_Alloc(int Kbyte)

Прототип в              EMS_LIB.H

Описание                Выделяет блок Extended памяти, при ошибке переменная
                        EMS_Error содержит код ошибки. При вызове функции нужно
                        указать неоходимый размер памяти в килобайтах. Проверяет
                        наличие свободного блока запрошеного размера, при нехватке
                        памяти выделяется первый блок не меньшего размера (или
                        добавляется новый, запрошенного размера) в файле
                        свопинга.

Возвращаемое значение   0 - если ошибка, иначе - hаndlе выделеннго блока памяти.

Смотри                  EMS_Free, EMS_Realloc.


-------------------------------------------------------------------------------
EMS_Realloc                                                     EMS_Realloc
-------------------------------------------------------------------------------

Функция                 Изменяет размер выделенного блока Extended памяти.

Синтаксис               #include "ems_lib.h"
                        extern int EMS_Realloc(unsigned int EMS_Handle,
                                                 unsigned int Kbyte)

Прототип в              EMS_LIB.H

Описание                Изменяет размер ранее выделенного блока Extended
                        памяти. Функции передается handle изменяемого блока и
                        новый размер блока.
                        Работа с файлом не поддерживается.

Возвращаемое значение   0 - успешное завершение,
                        иначе - код ошибки.

Смотри                  EMS_Alloc, EMS_Free.


-------------------------------------------------------------------------------
EMS_Free                                                        EMS_Free
-------------------------------------------------------------------------------

Функция                 Освобождает Extended память.

Синтаксис               #include "ems_lib.h"
                        extern int EMS_Free(unsigned int EMS_Handle)

Прототип в              EMS_LIB.H

Описание                Освобождает ранее занятую Extended память, или блок
                        в файле свопинга. Функции передается hаndlе освобождаемого
                        блока.


Возвращаемое значение   0 - успешное завершение,
                        иначе - код ошибки.

Смотри                  EMS_Realloc, EMS_Alloc.


-------------------------------------------------------------------------------
Send_To_Ext                                                     Send_To_Ext
-------------------------------------------------------------------------------

Функция                 Пересылает данные в Extended память.

Синтаксис               #include "ems_lib.h"
                        extern int Send_To_Ext(unsigned int EMS_Handle,
                                        char *Ptr, unsigned long Byte)

Прототип в              EMS_LIB.H

Описание                Пересылает данные в Extended память или в файл. Функции
                        передаются:  handle блока, в который пересылаются
                        данные; адрес данных, в обычной памяти; количество
                        пересылаемых данных, в байтах. Количество пересылаемых
                        байт должно быть четным, в противном случае, количество
                        пересылаемых данных увеличивается на единицу.


Возвращаемое значение   0 - успешное завершение,
                        иначе - код ошибки.

Смотри                  Send_To_Mem.


-------------------------------------------------------------------------------
Send_To_Mem                                                     Send_To_Mem
-------------------------------------------------------------------------------

Функция                 Пересылает данные из Extended памяти в обычную память.

Синтаксис               #include "ems_lib.h"
                        extern int Send_To_Mem(unsigned int EMS_Handle,
                                        char *Ptr, unsigned long Byte)

Прототип в              EMS_LIB.H

Описание                Пересылает данные из Extended памяти, или из файла, в
                        обычную память.  Функции передаются: handle блока, в
                        который пересылаются данные; адрес данных, в обычной
                        памяти; количество пересылаемых данных, в байтах.


Возвращаемое значение   0 - успешное завершение,
                        иначе - код ошибки.

Смотри                  Send_To_Ext.


-------------------------------------------------------------------------------
Get_XMS_Ver                                                     Get_XMS_Ver
-------------------------------------------------------------------------------

Функция                 Получает номер версии драйвера XMS.

Синтаксис               #include "ems_lib.h"
                        extern unsigned int Get_XMS_Ver(void)


Прототип в              EMS_LIB.H

Описание                Получает номер версии XMS, и системную информации о
                        наличии HMA (1M to 1M + 64K):
                        - переменная Internal_Rever содержит внутренний
                          исправленный номер;
                        - переменная HMA_Exist равна 1, если сущесвует HMA,
                          и 0, если HMA не сущесвует.
                        Работа с файлом не поддерживается.



Возвращаемое значение   Номер весии XMS.

Смотри


-------------------------------------------------------------------------------
EMS_Lock                                                        EMS_Lock
-------------------------------------------------------------------------------

Функция                 Локирует блок Extended памяти.

Синтаксис               #include "ems_lib.h"
                        extern int EMS_Lock(unsigned int EMS_Handle);


Прототип в              EMS_LIB.H

Описание                Локирует блок Extended памяти, возвращает его линейный
                        адрес.
                        Работа с файлом не поддерживается.


Возвращаемое значение   0 - успешное завершение, Addres_Line линейный адрес
                        локированного блока;
                        иначе - код ошибки.


Смотри                  EMS_Unlock


-------------------------------------------------------------------------------
EMS_Unlock                                                      EMS_Unlock
-------------------------------------------------------------------------------

Функция                 Разлокирует блок Extended памяти.

Синтаксис               #include "ems_lib.h"
                        extern int EMS_Unlock(unsigned int EMS_Handle);


Прототип в              EMS_LIB.H

Описание                Разлокирует блок Extended памяти.
                        Работа с файлом не поддерживается.


Возвращаемое значение   0 - успешное завершение;
                        иначе - код ошибки.

Смотри                  EMS_Lock


-------------------------------------------------------------------------------
Get_Handle_Info                                         Get_Handle_Info
-------------------------------------------------------------------------------

Функция                 Получает информацию о handle'аx.

Синтаксис               #include "ems_lib.h"
                        extern int Get_Handle_Info(unsigned int EMS_Handle);


Прототип в              EMS_LIB.H

Описание                Получает информацию о handle'аx: Block_Lock_Count -
                        счетчик локированных блоков;
                        Num_Free_Hand_Left - количество свободных handle'ов;
                        Block_Size - размер блока в килобайтах.
                        Работа с файлом не поддерживается.

Возвращаемое значение   0 - успешное завершение;
                        иначе - код ошибки.

Смотри

-------------------------------------------------------------------------------


        4. КОДЫ ОШИБОК

      ┌──────┬────────────────────────────────────────────────────────────────┐
      │ код  │     ошибка                                                     │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 01h  │  не корректная вкрсия DOS                                      │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 02h  │  свободной Extended памяти       меньше чем запрошено          │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 03h  │  невозможно открыть временный файл                             │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 04h  │  ошибка при записи в файл                                      │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 80h  │  невыполнимая функция                                          │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 81h  │  обнаружен Vdisk                                               │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 82h  │  ошибка при включении линии А20                                │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 8Eh  │  общаая ошибка драйвера                                        │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 8Fh  │  неисправиная ошибка драйвера                                  │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 90h  │  HMA не обнаружена                                             │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 91h  │  HMA уже занята                                                │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 92h  │  значение DX меньше прараметра /HMAMIN (измените в CONFIG.SYS: │
      │      │          HIMEM.SYS /HMAMIN=n)                                  │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 93h  │  невозможно зарезервировать HMA                                │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ 94h  │  невозможно включить линию А20                                 │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A0h  │  вся Extended память уже зарезервированна                      │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A1h  │  нет больше свободных заголовков (handle) блоков Extended памят│
      │      │  (укажите в CONFIG.SYS большее значение n: HIMEM.SYS /HANDLES=n│
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A2h  │  неверный handle                                               │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A3h  │  handle  источника неверный                                    │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A4h  │  адрес источника неверный                                      │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A5h  │  handle  блока-приемника неверный                              │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A6h  │  адрес блока-приемника неверный                                │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A7h  │  неверно указана длина                                         │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A8h  │  перемещение ошибочно перекрывается                            │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ A9h  │  процесс прошел ошибочно                                       │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ AAh  │  блок не локирован                                             │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ ABh  │  блок локирован                                                │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ ACh  │  переполнен счетчик локирований блоков                         │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ ADh  │  локирование невозможно                                        │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ B0h  │  имеется только маленький UMB                                  │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ B1h  │  нет свободных UMB                                             │
      ├──────┼────────────────────────────────────────────────────────────────┤
      │ B2h  │  номер сегмента UMB неверен                                    │
      └──────┴────────────────────────────────────────────────────────────────┘
